input {
  # 从 Beats 接收日志
  beats {
    port => 5044
  }

  # 从 TCP 接收日志
  tcp {
    port => 5000
    codec => json_lines {
      target => "[event]"
      decode_size_limit_bytes => 20971520
    }
  }

  # 从 HTTP 接收日志
  http {
    port => 8080
    codec => json { target => "[event]" }
  }
}

filter {
  # JSON 解析（仅当未由 codec 解析时）
  if [message] and ![event] and [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
      target => "[event]"
      tag_on_failure => ["_jsonparsefailure"]
    }
  }

  # 时间戳处理
  date {
    match => [
      "timestamp",
      "ISO8601",
      "yyyy-MM-dd HH:mm:ss.SSS",
      "dd/MMM/yyyy:HH:mm:ss Z"
    ]
    target => "@timestamp"
    tag_on_failure => ["_dateparsefailure"]
  }

  # 统一添加应用标识
  mutate {
    add_field => {
      "application" => "windblog"
    }
  }

  # PHP 错误日志处理
  if [type] == "php-error" {
    grok {
      match => { "message" => "\[%{HTTPDATE:timestamp}\] %{LOGLEVEL:level}: %{GREEDYDATA:error_message}" }
      tag_on_failure => ["_phperrorgrokfailure"]
    }
  }

  # 访问日志处理
  if [type] == "access" {
    grok {
      match => {
        "message" => '%{IPORHOST:client_ip} - %{DATA:user} \[%{HTTPDATE:timestamp}\] "%{WORD:method} %{URIPATHPARAM:request} HTTP/%{NUMBER:http_version}" %{NUMBER:status_code:int} %{NUMBER:bytes:int} "%{DATA:referer}" "%{DATA:user_agent}"'
      }
      tag_on_failure => ["_accessgrokfailure"]
    }
  }
}

output {
  # 输出到 Elasticsearch（启用 ILM，用户名硬编码为 elastic）
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    user => "elastic"
    password => "${ELASTIC_PASSWORD}"

    ilm_enabled => true
    ilm_rollover_alias => "windblog-logs"
    ilm_policy => "windblog-logs-policy"
    ilm_pattern => "000001"

    manage_template => false

    # 提高健壮性：连接/重试参数
    retry_initial_interval => 5
    retry_max_interval => 60
    timeout => 60
    pool_max => 100
  }

  # 调试输出（生产环境需注释，测试时可开启查看日志格式）
  # stdout { codec => rubydebug }
}
