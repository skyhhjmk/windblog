input {
  # 从 Beats 接收日志
  beats {
    port => 5044
  }

  # 从 TCP 接收日志
  tcp {
    port => 5000
    codec => json
  }

  # 从 HTTP 接收日志
  http {
    port => 8080
    codec => json
  }
}

filter {
  # 解析 JSON 格式的日志
  if [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
    }
  }

  # 添加时间戳
  date {
    match => [ "timestamp", "ISO8601" ]
    target => "@timestamp"
  }

  # 添加标签
  mutate {
    add_field => {
      "application" => "windblog"
    }
  }

  # 处理 PHP 错误日志
  if [type] == "php-error" {
    grok {
      match => {
        "message" => "\[%{HTTPDATE:timestamp}\] %{LOGLEVEL:level}: %{GREEDYDATA:error_message}"
      }
    }
  }

  # 处理访问日志
  if [type] == "access" {
    grok {
      match => {
        "message" => "%{IPORHOST:client_ip} - - \[%{HTTPDATE:timestamp}\] \"%{WORD:method} %{URIPATHPARAM:request} HTTP/%{NUMBER:http_version}\" %{NUMBER:status_code} %{NUMBER:bytes}"
      }
    }
  }
}

output {
  # 输出到 Elasticsearch
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    user => "elastic"
    password => "${ELASTIC_PASSWORD}"
    index => "windblog-logs-%{+YYYY.MM.dd}"
    codec => json
  }

  # 调试输出到控制台（可选）
  # stdout {
  #   codec => rubydebug
  # }
}
