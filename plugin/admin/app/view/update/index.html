<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <title>系统更新 - WindBlog</title>
    <link href="/app/admin/component/layui/css/layui.css?v=2.8.12" rel="stylesheet"/>
    <link href="/app/admin/component/pear/css/pear.css" rel="stylesheet"/>
    <link href="/app/admin/admin/css/reset.css" rel="stylesheet"/>
    <style>
        .update-panel {
            margin-bottom: 20px;
        }

        .version-info {
            background: #f6f8fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .version-item {
            margin-bottom: 10px;
        }

        .version-label {
            font-weight: bold;
            margin-right: 10px;
        }

        .update-btn {
            margin-top: 10px;
        }

        .log-container {
            background: #f6f8fa;
            padding: 15px;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }

        .status-success {
            color: #52c41a;
        }

        .status-error {
            color: #f5222d;
        }

        .status-warning {
            color: #faad14;
        }

        .channel-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .channel-item {
            padding: 10px 20px;
            border: 1px solid #e8e8e8;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .channel-item.active {
            background: #1890ff;
            color: white;
            border-color: #1890ff;
        }

        /* 修复选择框样式 */
        #version-select {
            height: 38px;
            line-height: 38px;
            border: 1px solid #e6e6e6;
            border-radius: 4px;
            padding: 0 10px;
        }
    </style>
</head>
<body class="pear-container">
<div class="layui-card">
    <div class="layui-card-header">系统更新管理</div>
    <div class="layui-card-body">

        <!-- 版本信息展示 -->
        <div class="version-info">
            <div class="version-item">
                <span class="version-label">当前版本：</span>
                <span id="current-version">--</span>
            </div>
            <div class="version-item">
                <span class="version-label">最新版本：</span>
                <span id="latest-version">--</span>
            </div>
            <div class="version-item">
                <span class="version-label">更新状态：</span>
                <span id="update-status">--</span>
            </div>
        </div>

        <!-- 更新通道选择 -->
        <div class="layui-form-item">
            <label class="layui-form-label">更新通道</label>
            <div class="layui-input-block channel-selector">
                <div class="channel-item active" data-channel="release">稳定版 (release)</div>
                <div class="channel-item" data-channel="pre-release">预发布版 (pre-release)</div>
                <div class="channel-item" data-channel="dev">开发版 (dev)</div>
            </div>
        </div>

        <!-- 镜像源配置 -->
        <div class="layui-form-item">
            <label class="layui-form-label">更新镜像源</label>
            <div class="layui-input-inline" style="width: 500px;">
                <input class="layui-input" id="mirror-input" name="mirror" placeholder="https://github.com/skyhhjmk/windblog"
                       type="text">
            </div>
            <div class="layui-form-mid layui-word-aux">
                <a class="layui-btn layui-btn-sm" href="javascript:;" id="save-mirror">保存</a>
                <a class="layui-btn layui-btn-sm layui-btn-normal" href="javascript:;" id="test-mirror">测试连接</a>
            </div>
        </div>

        <!-- 操作按钮组 -->
        <div class="update-btn">
            <button class="layui-btn layui-btn-primary" id="check-update">检查更新</button>
            <button class="layui-btn layui-btn-danger" id="execute-update">执行更新</button>
            <button class="layui-btn layui-btn-warm" id="run-migration">执行数据库迁移</button>
            <button class="layui-btn" id="view-logs">查看更新日志</button>
        </div>

        <!-- 可用版本列表 -->
        <div class="layui-form-item">
            <label class="layui-form-label">可用版本</label>
            <div class="layui-input-block">
                <select id="version-select" lay-filter="version-select" style="width: 300px;">
                    <option value="">更新到最新版本</option>
                </select>
            </div>
        </div>

        <!-- 更新日志 -->
        <div class="layui-card" id="logs-panel" style="margin-top: 20px; display: none;">
            <div class="layui-card-header">更新日志</div>
            <div class="layui-card-body">
                <div class="log-container" id="update-logs"></div>
            </div>
        </div>
    </div>
</div>

<!-- 加载层 -->
<div id="loading" style="display: none;">
    <div style="text-align: center; padding: 20px;">
        <i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"
           style="font-size: 36px; color: #1890ff;"></i>
        <p style="margin-top: 10px;">操作执行中...</p>
    </div>
</div>

<script src="/app/admin/component/layui/layui.js?v=2.8.12"></script>
<script>
    layui.use(['layer', 'form'], function () {
        var layer = layui.layer;
        var form = layui.form;
        var $ = layui.jquery;

        // 当前选择的通道
        var currentChannel = 'release';
        var loadingIndex = null;

        // 初始化
        function init() {
            // 只调用一次checkUpdate()即可获取所有必要信息
            checkUpdate();
        }

        // 检查更新
        function checkUpdate() {
            loadingIndex = layer.load(2, {time: 10000});
            $.get('/app/admin/update/check', {channel: currentChannel}, function (res) {
                layer.close(loadingIndex);
                if (res.code === 0) {
                    $('#current-version').text(res.data.current_version);
                    $('#latest-version').text(res.data.latest_version);

                    // 更新默认镜像源
                    if (res.data.default_mirror) {
                        $('#mirror-input').val(res.data.default_mirror);
                    }

                    if (res.data.has_new_version) {
                        $('#update-status').html('<span class="status-success">有新版本可用</span>');
                        // 加载可用版本列表
                        loadAvailableVersions(res.data.available_versions);
                        layer.msg('发现新版本: ' + res.data.latest_version, {icon: 6});
                    } else {
                        $('#update-status').html('<span class="status-warning">当前已是最新版本</span>');
                        layer.msg('当前已是最新版本', {icon: 5});
                    }
                } else {
                    layer.msg(res.msg || '检查更新失败', {icon: 5});
                }
            }, 'json').fail(function () {
                layer.close(loadingIndex);
                layer.msg('网络错误，检查更新失败', {icon: 5});
            });
        }

        // 加载可用版本列表
        function loadAvailableVersions(versions) {
            var select = $('#version-select');
            select.empty();
            select.append('<option value="">更新到最新版本</option>');

            if (versions && versions.length > 0) {
                versions.forEach(function (version) {
                    select.append('<option value="' + version + '">' + version + '</option>');
                });
            }
            form.render('select');
        }

        // 执行更新
        function executeUpdate() {
            var version = $('#version-select').val();
            var mirror = $('#mirror-input').val().trim();

            layer.confirm('确定要执行更新吗？更新过程中请勿关闭页面或刷新！', {
                btn: ['确定更新', '取消'],
                icon: 3
            }, function () {
                loadingIndex = layer.load(2, {time: 300000}); // 5分钟超时

                $.post('/app/admin/update/execute', {
                    version: version,
                    channel: currentChannel,
                    mirror: mirror
                }, function (res) {
                    layer.close(loadingIndex);
                    if (res.code === 0) {
                        layer.msg('更新成功！', {icon: 6});
                        // 刷新版本信息
                        loadCurrentVersion();
                        // 显示更新日志
                        showLogs(res.data.log || []);
                    } else {
                        layer.msg('更新失败：' + (res.msg || '未知错误'), {icon: 5});
                        // 显示错误日志
                        showLogs(res.data.log || []);
                    }
                }, 'json').fail(function () {
                    layer.close(loadingIndex);
                    layer.msg('网络错误，更新失败', {icon: 5});
                });
            });
        }

        // 执行数据库迁移
        function runMigration() {
            layer.confirm('确定要执行数据库迁移吗？', {
                btn: ['确定执行', '取消'],
                icon: 3
            }, function () {
                loadingIndex = layer.load(2, {time: 60000}); // 1分钟超时

                $.post('/app/admin/update/migrate', {}, function (res) {
                    layer.close(loadingIndex);
                    if (res.code === 0) {
                        layer.msg('数据库迁移成功！', {icon: 6});
                        // 显示迁移日志
                        showLogs(res.data.migrations || []);
                    } else {
                        layer.msg('数据库迁移失败：' + (res.msg || '未知错误'), {icon: 5});
                        // 显示错误日志
                        showLogs(res.data.migrations || []);
                    }
                }, 'json').fail(function () {
                    layer.close(loadingIndex);
                    layer.msg('网络错误，迁移失败', {icon: 5});
                });
            });
        }

        // 保存镜像源
        function saveMirror() {
            var mirror = $('#mirror-input').val().trim();
            if (!mirror) {
                layer.msg('请输入镜像源地址', {icon: 5});
                return;
            }

            $.post('/app/admin/update/set-mirror', {mirror: mirror}, function (res) {
                if (res.code === 0) {
                    layer.msg('镜像源保存成功', {icon: 6});
                } else {
                    layer.msg('保存失败：' + (res.msg || '未知错误'), {icon: 5});
                }
            }, 'json');
        }

        // 测试镜像源连接
        function testMirror() {
            var mirror = $('#mirror-input').val().trim();
            if (!mirror) {
                layer.msg('请输入镜像源地址', {icon: 5});
                return;
            }

            loadingIndex = layer.load(2, {time: 10000});
            $.get('/app/admin/update/check', {channel: currentChannel, mirror: mirror}, function (res) {
                layer.close(loadingIndex);
                if (res.code === 0) {
                    layer.msg('镜像源连接成功', {icon: 6});
                } else {
                    layer.msg('连接失败：' + (res.msg || '未知错误'), {icon: 5});
                }
            }, 'json').fail(function () {
                layer.close(loadingIndex);
                layer.msg('网络错误，测试失败', {icon: 5});
            });
        }

        // 显示更新日志
        function showLogs(logs) {
            var logsPanel = $('#logs-panel');
            var logsContainer = $('#update-logs');

            logsContainer.empty();
            if (logs && logs.length > 0) {
                logs.forEach(function (log) {
                    var logClass = '';
                    if (log.includes('ERROR') || log.includes('错误')) {
                        logClass = 'status-error';
                    } else if (log.includes('SUCCESS') || log.includes('成功')) {
                        logClass = 'status-success';
                    } else if (log.includes('WARNING') || log.includes('警告')) {
                        logClass = 'status-warning';
                    }
                    logsContainer.append('<div class="' + logClass + '">' + log + '</div>');
                });
            } else {
                logsContainer.append('<div>暂无日志记录</div>');
            }

            logsPanel.show();
        }

        // 事件监听
        $(document).ready(function () {
            init();

            // 通道选择
            $('.channel-item').on('click', function () {
                $('.channel-item').removeClass('active');
                $(this).addClass('active');
                currentChannel = $(this).data('channel');
                checkUpdate();
            });

            // 检查更新按钮
            $('#check-update').on('click', function () {
                checkUpdate();
            });

            // 执行更新按钮
            $('#execute-update').on('click', function () {
                executeUpdate();
            });

            // 执行数据库迁移按钮
            $('#run-migration').on('click', function () {
                runMigration();
            });

            // 保存镜像源按钮
            $('#save-mirror').on('click', function () {
                saveMirror();
            });

            // 测试镜像源按钮
            $('#test-mirror').on('click', function () {
                testMirror();
            });

            // 查看日志按钮
            $('#view-logs').on('click', function () {
                $.get('/app/admin/update/logs', function (res) {
                    if (res.code === 0) {
                        showLogs(res.data.logs || []);
                    } else {
                        layer.msg('获取日志失败', {icon: 5});
                    }
                }, 'json');
            });
        });
    });
</script>
</body>
</html>
