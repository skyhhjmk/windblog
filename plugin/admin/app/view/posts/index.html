<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>数据表格</title>
    <link rel="stylesheet" href="/app/admin/component/pear/css/pear.css"/>
    <script src="/app/admin/component/layui/layui.js?v=2.8.12"></script>
    <script src="/app/admin/component/pear/pear.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 pear-container">
<div class="layui-card rounded-lg shadow-sm">
    <div class="layui-card-body">
        <!-- 切换选项卡 -->
        <div class="flex border-b border-gray-200 mb-5" id="postTab">
            <div class="tab-item px-4 py-2 cursor-pointer text-blue-500 border-b-2 border-blue-500 font-medium" data-type="normal">文章列表</div>
            <div class="tab-item px-4 py-2 cursor-pointer text-gray-500 hover:text-gray-700 font-medium" data-type="trash">垃圾箱</div>
        </div>

        <form id="postForm" class="layui-form" action="">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label font-medium">文章标题</label>
                    <div class="layui-input-inline">
                        <input type="text" name="realName" placeholder="请输入文章标题" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label font-medium">文章别名</label>
                    <div class="layui-input-inline">
                        <input type="text" name="username" placeholder="请输入文章别名" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline" id="statusFilter">
                    <label class="layui-form-label font-medium">文章状态</label>
                    <div class="layui-input-inline">
                        <select name="status" class="layui-input">
                            <option value="">全部状态</option>
                            <option value="draft">草稿</option>
                            <option value="published">已发布</option>
                            <option value="archived">已归档</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline ml-[50px]">
                    <button class="pear-btn pear-btn-md pear-btn-primary" lay-submit lay-filter="post-query">
                        <i class="layui-icon layui-icon-search"></i>
                        查询
                    </button>
                    <button type="reset" class="pear-btn pear-btn-md">
                        <i class="layui-icon layui-icon-refresh"></i>
                        重置
                    </button>
                </div>
            </div>
        </form>

        <!-- 隐藏的输入字段，用于传递是否显示垃圾箱的状态 -->
        <input type="hidden" id="isTrashed" name="isTrashed" value="false">
    </div>

    <!-- 搜索表单的脚本 -->
    <script>
        // 确保表单提交正常工作
        layui.use('form', function() {
            var form = layui.form;

            // 表单验证和提交处理
            form.on('submit(post-query)', function(data) {
                return false; // 阻止表单跳转提交，改为Ajax提交
            });
        });
    </script>
</div>
<div class="layui-card rounded-lg shadow-sm">
    <div class="layui-card-body">
        <table id="post-table" lay-filter="post-table"></table>
    </div>
</div>

<script type="text/html" id="post-toolbar">
    <!-- 正常文章列表工具栏 -->
    <div id="normalToolbar">
        <button class="pear-btn pear-btn-primary pear-btn-md" lay-event="add">
            <i class="layui-icon layui-icon-add-1"></i>
            新增
        </button>
        <button class="pear-btn pear-btn-danger pear-btn-md" lay-event="batchRemove">
            <i class="layui-icon layui-icon-delete"></i>
            删除
        </button>
    </div>

    <!-- 垃圾箱工具栏 -->
    <div id="trashToolbar" class="hidden">
        <button class="pear-btn pear-btn-success pear-btn-md" lay-event="batchRestore">
            <i class="layui-icon layui-icon-refresh-1"></i>
            恢复
        </button>
        <button class="pear-btn pear-btn-danger pear-btn-md" lay-event="batchForceDelete">
            <i class="layui-icon layui-icon-delete"></i>
            永久删除
        </button>
    </div>
</script>

<script type="text/html" id="post-bar">
    <!-- 正常文章操作按钮 -->
    <div class="normal-actions flex space-x-1">
        <button class="pear-btn pear-btn-primary pear-btn-sm" lay-event="edit"><i
                class="layui-icon layui-icon-edit"></i></button>
        <button class="pear-btn pear-btn-danger pear-btn-sm" lay-event="remove"><i
                class="layui-icon layui-icon-delete"></i></button>
        <button class="pear-btn pear-btn-sm" id="more_{{d.id}}"><i class="layui-icon layui-icon-triangle-d"></i></button>
    </div>

    <!-- 垃圾箱文章操作按钮 -->
    <div class="trash-actions flex space-x-1 hidden">
        <button class="pear-btn pear-btn-success pear-btn-sm" lay-event="restore"><i
                class="layui-icon layui-icon-refresh-1"></i></button>
        <button class="pear-btn pear-btn-danger pear-btn-sm" lay-event="forceDelete"><i
                class="layui-icon layui-icon-delete"></i></button>
    </div>
</script>

<script type="text/html" id="trash-post-bar">
    <!-- 垃圾箱文章操作按钮 -->
    <div class="trash-actions flex space-x-1">
        <button class="pear-btn pear-btn-success pear-btn-sm" lay-event="restore"><i
                class="layui-icon layui-icon-refresh-1"></i></button>
        <button class="pear-btn pear-btn-danger pear-btn-sm" lay-event="forceDelete"><i
                class="layui-icon layui-icon-delete"></i></button>
    </div>
</script>

<script type="text/html" id="post-status">
    {{#if (d.status == 'draft') { }}
    <span class="px-2 py-1 text-xs rounded bg-yellow-100 text-yellow-800">草稿</span>
    {{# }else if(d.status == 'published'){ }}
    <span class="px-2 py-1 text-xs rounded bg-green-100 text-green-800">已发布</span>
    {{# }else if(d.status == 'archived'){ }}
    <span class="px-2 py-1 text-xs rounded bg-gray-100 text-gray-800">已归档</span>
    {{# } }}
</script>

<!-- 删除时间模板 -->
<script type="text/html" id="post-deleteTime">
    {{#if (d.deleted_at) { }}
    <span class="text-gray-500 text-sm">{{layui.util.toDateString(d.deleted_at, 'yyyy-MM-dd HH:mm:ss')}}</span>
    {{# } }}
</script>

<script type="text/html" id="post-createTime">
    <span class="text-gray-600">{{layui.util.toDateString(d.created_at, 'yyyy-MM-dd HH:mm:ss')}}</span>
</script>

<div style="display: none;">
    <div class="layer-top">
        <br/>
        <h3>上侧弹层内容...</h3>
    </div>
</div>

<script>
    layui.use(['table', 'form', 'jquery', 'drawer', 'dropdown'], function () {
        let table = layui.table;
        let form = layui.form;
        let $ = layui.jquery;
        let drawer = layui.drawer;
        let dropdown = layui.dropdown;

        let MODULE_PATH = "/app/admin/posts/";

        // 表单切换功能
        formToggle({
            elem: "#postForm",
        });

        function formToggle(options) {
            var defaultsOpt = {
                isExpand: false,
                prefixIcon: "layui-icon",
                toggleIcon: ['layui-icon-down', 'layui-icon-up'],
                toggleText: ['展开', '折叠'],
            }
            var opt = $.extend({}, defaultsOpt, options);
            var elem = opt.elem; // 绑定的表单元素,必填
            var min = opt.min; // 最小显示数,默认显示一行
            var isExpand = opt.isExpand; // 初始展开
            var prefixIcon = opt.prefixIcon + " "; // 图标前缀
            var toggleIcon = opt.toggleIcon; // 折叠和展开时的图标类[unExpandIcon, ExpandIcon]
            var toggleText = opt.toggleText; // 折叠和展开时的文本

            var eleDOM = $(elem + " .layui-inline");
            var firstElTop = eleDOM.first().offset().top;
            var targetEl = eleDOM.filter(function (index) {
                var isGtMin = (index + 1) > min;
                var isGtFirstElTop = $(this).offset().top > firstElTop;
                var isNeqLast = (index + 1) != eleDOM.length;
                return min ? isGtMin && isNeqLast : isGtFirstElTop && isNeqLast;
            });

            var unExpandIcon = prefixIcon + toggleIcon[0];
            var expandIcon = prefixIcon + toggleIcon[1];
            var unExpandText = toggleText[0];
            var expandText = toggleText[1];
            var btnSelector = elem + " .expand";
            $(btnSelector).append("<i></i>")
            if (targetEl.length > 0) {
                if (isExpand) {
                    $(btnSelector).prepend("<span>" + expandText + "</span>");
                    $(btnSelector + ">i").addClass(expandIcon);
                } else {
                    $(btnSelector).prepend("<span>" + unExpandText + "</span>")
                    $(btnSelector + ">i").addClass(unExpandIcon)
                    targetEl.addClass("layui-hide");
                }
                $(btnSelector).click(function () {
                    isExpand = !isExpand;
                    if (isExpand) {
                        $(btnSelector + ">span").html(expandText);
                        $(btnSelector + ">i").removeClass(unExpandIcon).addClass(expandIcon);
                        targetEl.removeClass("layui-hide")
                    } else {
                        $(btnSelector + ">span").html(unExpandText);
                        $(btnSelector + ">i").removeClass(expandIcon).addClass(unExpandIcon);
                        targetEl.addClass("layui-hide")
                    }
                })
            }
        }

        // 普通模式下的列配置
        let normalCols = [
            [{
                type: 'checkbox'
            },
                {
                    title: 'ID',
                    field: 'id',
                    align: 'center',
                    width: 100
                },
                {
                    title: '文章标题',
                    field: 'title',
                    align: 'center'
                },
                {
                    title: '文章状态',
                    field: 'status',
                    align: 'center',
                    width: 100,
                    templet: '#post-status'
                },
                {
                    title: '创建时间',
                    field: 'created_at',
                    align: 'center',
                    width: 160,
                    templet: '#post-createTime'
                },
                {
                    title: '操作',
                    toolbar: '#post-bar',
                    align: 'left',
                    width: 160,
                    fixed: 'right'
                }
            ]
        ];

        // 垃圾箱模式下的列配置
        let trashCols = [
            [{
                type: 'checkbox'
            },
                {
                    title: 'ID',
                    field: 'id',
                    align: 'center',
                    width: 100
                },
                {
                    title: '文章标题',
                    field: 'title',
                    align: 'center'
                },
                {
                    title: '删除时间',
                    field: 'deleted_at',
                    align: 'center',
                    width: 160,
                    templet: '#post-deleteTime'
                },
                {
                    title: '操作',
                    toolbar: '#trash-post-bar',
                    align: 'left',
                    width: 160,
                    fixed: 'right'
                }
            ]
        ];

        // 获取当前是否显示垃圾箱
        let currentMode = 'normal';
        let currentTable = null;

        // 渲染表格的函数
        function renderTable(mode) {
            currentMode = mode;
            let isTrashed = mode === 'trash';

            // 更新隐藏字段
            $('#isTrashed').val(isTrashed ? 'true' : 'false');

            // 更新选项卡样式
            if (isTrashed) {
                $('.tab-item').eq(0).removeClass('text-blue-500 border-b-2 border-blue-500').addClass('text-gray-500');
                $('.tab-item').eq(1).removeClass('text-gray-500').addClass('text-blue-500 border-b-2 border-blue-500');
            } else {
                $('.tab-item').eq(1).removeClass('text-blue-500 border-b-2 border-blue-500').addClass('text-gray-500');
                $('.tab-item').eq(0).removeClass('text-gray-500').addClass('text-blue-500 border-b-2 border-blue-500');
            }

            // 显示或隐藏状态筛选器
            $('#statusFilter').toggle(!isTrashed);

            // 显示或隐藏相应的工具栏
            $('#normalToolbar').toggle(!isTrashed);
            $('#trashToolbar').toggle(isTrashed);

            // 获取当前搜索条件
            let searchData = form.val('postForm');
            searchData.isTrashed = isTrashed ? 'true' : 'false';

            // 明确添加状态字段（确保在所有浏览器中都能正确获取）
            if (!searchData.status) {
                searchData.status = $('select[name="status"]').val() || '';
            }

            // 重新渲染表格
            if (currentTable) {
                currentTable.reload({
                    url: 'list',
                    where: searchData,
                    cols: isTrashed ? trashCols : normalCols,
                    toolbar: isTrashed ? '#trash-post-toolbar' : '#post-toolbar',
                    page: { curr: 1 }
                });
            } else {
                currentTable = table.render({
                    elem: '#post-table',
                    url: 'list',
                    where: searchData,
                    page: true,
                    cols: isTrashed ? trashCols : normalCols,
                    skin: 'line',
                    toolbar: isTrashed ? '#trash-post-toolbar' : '#post-toolbar',
                    defaultToolbar: [{
                        layEvent: 'refresh',
                        icon: 'layui-icon-refresh',
                    }, 'filter', 'print', 'exports'],
                    done: function (res, curr, count) {
                        console.log('Table render done:', {res, curr, count, isTrashed});

                        // 移除之前的手动显示/隐藏逻辑，因为现在使用了独立的模板
                        if (!isTrashed) {
                            // 只有在普通模式下才渲染下拉菜单
                            for (var i = 0; i < res.data.length; i++) {
                                dropdown.render({
                                    elem: '#more_' + res.data[i].id,
                                    data: [{
                                        title: 'menu item11',
                                        id: 100
                                    }, {
                                        title: 'menu item22',
                                        id: 101
                                    }, {
                                        title: 'menu item33',
                                        id: 102
                                    }],
                                    id: '#more_' + res.data[i].id,
                                    click: function (obj) {
                                        layer.tips('点击了：' + obj.title, this.elem, {
                                            tips: [1, '#5FB878']
                                        })
                                    }
                                });
                            }
                        }
                    }
                });
            }
        }

        // 初始渲染表格
        renderTable('normal');

        // 选项卡切换事件
        $('.tab-item').on('click', function() {
            // 更新选项卡样式
            $('.tab-item').removeClass('text-blue-500 border-b-2 border-blue-500').addClass('text-gray-500');
            $('.tab-item').removeClass('hover:text-gray-700');
            $(this).removeClass('text-gray-500').addClass('text-blue-500 border-b-2 border-blue-500');
            $(this).addClass('hover:text-gray-700');

            let mode = $(this).data('type');
            renderTable(mode);
        });

        table.on('tool(post-table)', function (obj) {
            if (obj.event === 'remove') {
                window.remove(obj);
            } else if (obj.event === 'edit') {
                window.edit(obj);
            } else if (obj.event === 'restore') {
                window.restore(obj);
            } else if (obj.event === 'forceDelete') {
                window.forceDelete(obj);
            }
        });

        table.on('toolbar(post-table)', function (obj) {
            if (obj.event === 'add') {
                window.add();
            } else if (obj.event === 'refresh') {
                window.refresh();
            } else if (obj.event === 'batchRemove') {
                window.batchRemove(obj);
            } else if (obj.event === 'batchRestore') {
                window.batchRestore(obj);
            } else if (obj.event === 'batchForceDelete') {
                window.batchForceDelete(obj);
            }
        });

        form.on('submit(post-query)', function (data) {
            // 确保搜索时保持当前的表格模式
            let formData = form.val('postForm');
            // 明确获取状态值
            formData.status = $('select[name="status"]').val() || '';
            formData.isTrashed = $('#isTrashed').val() || 'false';
            console.log('Form data being submitted:', formData);

            // 直接重载表格而不是重新渲染
            if (currentTable) {
                currentTable.reload({
                    where: formData,
                    page: {curr: 1}
                });
            }
            return false;
        });

        form.on('switch(post-enable)', function (obj) {
            layer.tips(this.value + ' ' + this.name + '：' + obj.elem.checked, obj.othis);
        });

        window.add = function () {
            parent.layui.admin.addTab('post-editor', '新增文章', '/app/admin/editor/vditor');
        }

        window.edit = function (obj) {
            // 确保obj和obj.data存在，且id为数字
            if (obj && obj.data && typeof obj.data.id === 'number') {
                parent.layui.admin.addTab('post-editor-' + obj.data.id, '编辑文章：' + obj.data.title, `/app/admin/editor/vditor/${obj.data.id}`);
            } else {
                console.error('编辑文章时缺少有效的文章ID:', obj);
                alert('无法编辑文章，缺少有效ID');
            }
        }

        window.remove = function (obj) {
            layer.confirm('确定要将该文章移至垃圾箱吗？', {
                icon: 3,
                title: '提示'
            }, function (index) {
                layer.close(index);
                let loading = layer.load();
                $.ajax({
                    url: MODULE_PATH + "remove/" + obj.data['id'],
                    dataType: 'json',
                    type: 'delete',
                    success: function (result) {
                        layer.close(loading);
                        if (result.code === 0) {
                            layer.msg(result.msg, {
                                icon: 1,
                                time: 1000
                            }, function () {
                                obj.del();
                            });
                        } else {
                            layer.msg(result.msg, {
                                icon: 2,
                                time: 1000
                            });
                        }
                    }
                })
            });
        }

        // 恢复文章
        window.restore = function (obj) {
            layer.confirm('确定要恢复该文章吗？', {
                icon: 3,
                title: '提示'
            }, function (index) {
                layer.close(index);
                let loading = layer.load();
                $.ajax({
                    url: MODULE_PATH + "restore/" + obj.data['id'],
                    dataType: 'json',
                    type: 'post',
                    success: function (result) {
                        layer.close(loading);
                        if (result.code === 0) {
                            layer.msg(result.msg, {
                                icon: 1,
                                time: 1000
                            }, function () {
                                obj.del();
                                // 切换到正常文章列表
                                $('.tab-item').eq(0).click();
                            });
                        } else {
                            layer.msg(result.msg, {
                                icon: 2,
                                time: 1000
                            });
                        }
                    }
                })
            });
        }

        // 永久删除文章
        window.forceDelete = function (obj) {
            layer.confirm('确定要永久删除该文章吗？此操作不可恢复！', {
                icon: 3,
                title: '警告'
            }, function (index) {
                layer.close(index);
                let loading = layer.load();
                $.ajax({
                    url: MODULE_PATH + "forceDelete/" + obj.data['id'],
                    dataType: 'json',
                    type: 'delete',
                    success: function (result) {
                        layer.close(loading);
                        if (result.code === 0) {
                            layer.msg(result.msg, {
                                icon: 1,
                                time: 1000
                            }, function () {
                                obj.del();
                            });
                        } else {
                            layer.msg(result.msg, {
                                icon: 2,
                                time: 1000
                            });
                        }
                    }
                })
            });
        }

        window.batchRemove = function (obj) {
            let data = table.checkStatus(obj.config.id).data;
            if (data.length === 0) {
                layer.msg("未选中数据", {
                    icon: 3,
                    time: 1000
                });
                return false;
            }
            let ids = "";
            for (let i = 0; i < data.length; i++) {
                ids += data[i].id + ",";
            }
            ids = ids.substr(0, ids.length - 1);
            layer.confirm('确定要将这些文章移至垃圾箱吗？', {
                icon: 3,
                title: '提示'
            }, function (index) {
                layer.close(index);
                let loading = layer.load();
                $.ajax({
                    url: MODULE_PATH + "batchRemove/" + ids,
                    dataType: 'json',
                    type: 'delete',
                    success: function (result) {
                        layer.close(loading);
                        if (result.code === 0) {
                            layer.msg(result.msg, {
                                icon: 1,
                                time: 1000
                            }, function () {
                                table.reload('post-table');
                            });
                        } else {
                            layer.msg(result.msg, {
                                icon: 2,
                                time: 1000
                            });
                        }
                    }
                })
            });
        }

        // 批量恢复文章
        window.batchRestore = function (obj) {
            let data = table.checkStatus(obj.config.id).data;
            if (data.length === 0) {
                layer.msg("未选中数据", {
                    icon: 3,
                    time: 1000
                });
                return false;
            }
            let ids = "";
            for (let i = 0; i < data.length; i++) {
                ids += data[i].id + ",";
            }
            ids = ids.substr(0, ids.length - 1);
            layer.confirm('确定要恢复这些文章吗？', {
                icon: 3,
                title: '提示'
            }, function (index) {
                layer.close(index);
                let loading = layer.load();
                $.ajax({
                    url: MODULE_PATH + "batchRestore/" + ids,
                    dataType: 'json',
                    type: 'post',
                    success: function (result) {
                        layer.close(loading);
                        if (result.code === 0) {
                            layer.msg(result.msg, {
                                icon: 1,
                                time: 1000
                            }, function () {
                                table.reload('post-table');
                                // 切换到正常文章列表
                                $('.tab-item').eq(0).click();
                            });
                        } else {
                            layer.msg(result.msg, {
                                icon: 2,
                                time: 1000
                            });
                        }
                    }
                })
            });
        }

        // 批量永久删除文章
        window.batchForceDelete = function (obj) {
            let data = table.checkStatus(obj.config.id).data;
            if (data.length === 0) {
                layer.msg("未选中数据", {
                    icon: 3,
                    time: 1000
                });
                return false;
            }
            let ids = "";
            for (let i = 0; i < data.length; i++) {
                ids += data[i].id + ",";
            }
            ids = ids.substr(0, ids.length - 1);
            layer.confirm('确定要永久删除这些文章吗？此操作不可恢复！', {
                icon: 3,
                title: '警告'
            }, function (index) {
                layer.close(index);
                let loading = layer.load();
                $.ajax({
                    url: MODULE_PATH + "batchForceDelete/" + ids,
                    dataType: 'json',
                    type: 'delete',
                    success: function (result) {
                        layer.close(loading);
                        if (result.code === 0) {
                            layer.msg(result.msg, {
                                icon: 1,
                                time: 1000
                            }, function () {
                                table.reload('post-table');
                            });
                        } else {
                            layer.msg(result.msg, {
                                icon: 2,
                                time: 1000
                            });
                        }
                    }
                })
            });
        }

        window.refresh = function (param) {
            renderTable(currentMode);
        }
    })
</script>
</body>

</html>