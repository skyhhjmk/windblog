<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¼–è¾‘-{{ title }}</title>
    <link rel="stylesheet" href="/app/admin/component/pear/css/pear.css" />
    <link rel="stylesheet" href="/assets/css/all.min.css">
    <script src="/assets/js/highlight.min.js"></script>
    <link rel="stylesheet" href="/assets/css/github-dark.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vditor/3.11.1/index.min.css"
          integrity="sha512-Tj6qPPqMhdET85Eu0Hy663goieFRcOde8i0J3DT8L+wb0sSDfgzPwoAYW63yijDXFzrzxOSvPuXfjHqL07hVcg=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vditor/3.11.1/index.min.js"
            integrity="sha512-oWE+EVJHubnxaqkZy5k5ZBs/TSNarmZyNhHevcfDIqhTza3rlwj1r5Vn8E+KiUPJMmCke08/W7HpN4qj/uHwmQ=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vditor/3.11.1/css/content-theme/light.min.css"
          integrity="sha512-o50pASvlcfHhtl2lTNfVkSBCgBSO2YeMZmRs1F7P6dD8m6XWWRr7nx9wbum75mBfMTeU8S+OQuIfkzLbLkk/Jw=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"
            integrity="sha512-LQNxIMR5rXv7o+b1l8+N1EZMfhG7iFZ9HhnbJkTp4zjNr5Wvst75AqUeFDxeRUa7l5vEDyUiAip//r+EFLLCyA=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css"
          integrity="sha512-fHwaWebuwA7NSF5Qg/af4UeDx9XqUpYpOGgubo3yWu+b2IQR4UeQwbb42Ti7gVAjNtVoI/I9TEoYeu9omwcC6g=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.9.0/mermaid.min.js"
            integrity="sha512-OAr6bl1pt/FD0oVcuPzJ9VIMso+HQhHoodVI7mnDst19p8rNkNiraPLsDCYVhit3Mjd6B7AUHFsoDhq3dDeI7g=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body class="pear-container">
<div class="layui-card">
    <div class="layui-card-body">
        <div class="max-w-6xl mx-auto px-4 py-8 h-full">
            <!-- ç¼–è¾‘å™¨å®¹å™¨ -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <!-- æ ‡é¢˜ -->
                <h1 class="text-2xl font-bold text-gray-800 mb-6">{{ post.title }}</h1>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="flex flex-wrap gap-4 mb-6">
                    <button id="preview-btn"
                            class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        é¢„è§ˆ
                    </button>
                    <button id="save-btn"
                            class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50">
                        ä¿å­˜
                    </button>
                    <button id="clear-btn"
                            class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-200 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">
                        æ¸…é™¤ç¼“å­˜
                    </button>
                </div>

                <!-- ç¼–è¾‘å™¨åŒºåŸŸ -->
                <div id="vditor"></div>
            </div>
        </div>
    </div>
</div>

<script src="/app/admin/component/layui/layui.js"></script>
<script src="/app/admin/component/pear/pear.js"></script>
<script>
    let vditor;
    let postId = {{ post.post_id }};

    // åˆå§‹åŒ– Vditor
    document.addEventListener('DOMContentLoaded', function () {
        vditor = new Vditor('vditor', {
            height: 'auto',
            minHeight: 300,
            counter: {
                enable: true,
            },
            // cdn: 'https://cdnjs.cloudflare.com/ajax/libs/vditor/3.11.1', // æ— æ³•ä½¿ç”¨cfå…¬å…±cdnï¼Œæ²¡æœ‰distç›®å½•
            mode: 'sv', // åˆ†å±
            toolbarConfig: {
                pin: true,
            },
            comment: {
                enable: false, // ä¸å¥½ç”¨
            },
            cache: {
                enable: true,
                id: postId,
            },
            preview: {
                markdown: {
                    sanitize: true,
                },
                hljs: {
                    enable: true,
                    defaultLang: 'bash',
                    style: 'github-dark',
                    lineNumber: true,
                },
                theme: {
                    path: 'https://cdn.jsdelivr.net/npm/vditor/dist/css/content-theme'
                }
            },
            upload: {
                accept: 'image/*',
                url: '/app/admin/posts/upload-image',
                fieldName: 'image',
                max: 50 * 1024 * 1024,
                filename(name) {
                    return name.replace(/\?|\\|\/|:|\||<|>|\*|\[|\]|\s+/g, '-')
                },
                linkToImgUrl: '/app/admin/posts/upload-image',
                handler(files) {
                    const data = new FormData()
                    data.append('image', files[0])

                    fetch('/app/admin/posts/upload-image', {
                        method: 'POST',
                        body: data,
                    }).then(response => response.json()).then(data => {
                        if (data.success === 1) {
                            vditor.insertValue(`![](${data.file.url})`)
                        } else {
                            alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ' + data.message)
                        }
                    }).catch(err => {
                        alert('ç½‘ç»œé”™è¯¯: ' + err)
                    })
                }
            },
            hint: {
                // emojiPath: 'https://cdn.jsdelivr.net/npm/vditor/dist/images/emoji',
                emoji: {
                    "+1": "ğŸ‘",
                    "-1": "ğŸ‘",
                    "heart": "â¤ï¸",
                    "smile": "ğŸ˜„",
                    "laughing": "ğŸ˜†",
                    "smirk": "ğŸ˜",
                    "expressionless": "ğŸ˜‘",
                    "tired_face": "ğŸ˜«",
                    "sleeping": "ğŸ˜´",
                    "flushed": "ğŸ˜³",
                    "scream": "ğŸ˜±",
                    "rage": "ğŸ˜¡",
                    "smiling_imp": "ğŸ˜ˆ",
                    "sunglasses": "ğŸ˜",
                    "thumbsup": "ğŸ‘",
                    "thumbsdown": "ğŸ‘",
                    "ok_hand": "ğŸ‘Œ",
                    "punch": "ğŸ‘Š",
                    "wave": "ğŸ‘‹",
                    "clap": "ğŸ‘",
                    "open_hands": "ğŸ‘",
                    "pray": "ğŸ™",
                    "eyes": "ğŸ‘€",
                    "zzz": "ğŸ’¤",
                    "poop": "ğŸ’©",
                    "muscle": "ğŸ’ª",
                    "trumpet": "ğŸº",
                    "cake": "ğŸ°",
                    "coffee": "â˜•",
                    "bomb": "ğŸ’£",
                    "gem": "ğŸ’",
                    "ring": "ğŸ’",
                    "rocket": "ğŸš€",
                    "train": "ğŸš‹",
                    "bike": "ğŸš²",
                    "bus": "ğŸšŒ",
                    "airplane": "âœˆï¸",
                    "rocket2": "ğŸš€",
                    "moon": "ğŸŒ™",
                    "star2": "ğŸŒŸ",
                    "sunny": "â˜€ï¸",
                    "rainbow": "ğŸŒˆ",
                    "snowman": "â›„",
                    "zap": "âš¡",
                    "fire": "ğŸ”¥",
                    "ghost": "ğŸ‘»",
                    "alien": "ğŸ‘½",
                    "robot": "ğŸ¤–",
                    "skull": "ğŸ’€",
                    "heart_eyes": "ğŸ˜",
                    "kiss": "ğŸ˜˜",
                    "sweat": "ğŸ˜“",
                    "sob": "ğŸ˜­",
                    "joy": "ğŸ˜‚",
                    "tongue": "ğŸ˜›",
                    "v": "âœŒï¸",
                    "santa": "ğŸ…",
                    "christmas_tree": "ğŸ„",
                    "gift": "ğŸ",
                    "jack_o_lantern": "ğŸƒ",
                    "bamboo": "ğŸ",
                    "grapes": "ğŸ‡",
                    "watermelon": "ğŸ‰",
                    "ramen": "ğŸœ",
                    "soccer": "âš½",
                    "football": "ğŸˆ",
                    "basketball": "ğŸ€",
                    "dart": "ğŸ¯",
                    "slot_machine": "ğŸ°",
                    "8ball": "ğŸ±",
                    "game_die": "ğŸ²",
                    "spades": "â™ ï¸",
                    "clubs": "â™£ï¸",
                    "hearts": "â™¥ï¸",
                    "diamonds": "â™¦ï¸",
                    "clubhouse": "ğŸ›–",
                    "house": "ğŸ ",
                    "city_sunrise": "ğŸŒ‡",
                    "bridge_at_night": "ğŸŒ‰",
                    "ferris_wheel": "ğŸ¡",
                    "roller_coaster": "ğŸ¢",
                    "ship": "ğŸš¢",
                    "speedboat": "ğŸš¤",
                    "sailboat": "â›µ",
                    "anchor": "âš“",
                    "rocketship": "ğŸš€",
                    "flying_saucer": "ğŸ›¸",
                    "helicopter": "ğŸš",
                    "steam_locomotive": "ğŸš‚",
                    "car": "ğŸš—",
                    "taxi": "ğŸš•",
                    "busstop": "ğŸš",
                    "fuelpump": "â›½",
                    "rotating_light": "ğŸš¨",
                    "triangular_flag_on_post": "ğŸš©",
                    "crossed_flags": "ğŸŒ",
                    "waving_black_flag": "ğŸ´",
                    "waving_white_flag": "ğŸ³ï¸",
                    "rainbow-flag": "ğŸ³ï¸â€ğŸŒˆ",
                    "pirate_flag": "ğŸ´â€â˜ ï¸"
                }
            }
        })

        // è®¾ç½®åˆå§‹å†…å®¹
        const content = {{ post.content ? post.content|json_encode|raw : '""' }};
        if (content && content !== "") {
            // ç­‰å¾…ç¼–è¾‘å™¨å®Œå…¨åˆå§‹åŒ–åå†è®¾ç½®å†…å®¹
            setTimeout(function() {
                vditor.setValue(content);
            }, 100);
        }
    })

    // é¢„è§ˆæŒ‰é’®äº‹ä»¶
    document.getElementById('preview-btn').addEventListener('click', function () {
        if (vditor) {
            vditor.preview()
        }
    });

    // ä¿å­˜æŒ‰é’®äº‹ä»¶
    document.getElementById('save-btn').addEventListener('click', function () {
        if (vditor) {
            // å‘é€åˆ°æœåŠ¡å™¨ä¿å­˜
            fetch('/app/admin/posts/save-content', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                },
                body: JSON.stringify({
                    post_id: postId,
                    content: vditor.getValue()
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        alert('ä¿å­˜æˆåŠŸ');
                        localStorage.removeItem('vditor' + postId);
                    } else {
                        alert('ä¿å­˜å¤±è´¥: ' + data.msg);
                    }
                })
                .catch(error => {
                    alert('ä¿å­˜å¤±è´¥: ' + error.message);
                });
        }
    });

    // æ¸…é™¤ç¼“å­˜æŒ‰é’®äº‹ä»¶
    document.getElementById('clear-btn').addEventListener('click', function () {
        if (confirm('ç¡®å®šè¦æ¸…é™¤è‡ªåŠ¨ä¿å­˜çš„å†…å®¹å—ï¼Ÿ')) {
            if (vditor) {
                vditor.clearCache()
                alert('å·²æ¸…é™¤è‡ªåŠ¨ä¿å­˜çš„å†…å®¹');
            }
        }
    });
</script>
</body>
</html>