<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>插件管理</title>
    <link rel="stylesheet" href="/app/admin/component/pear/css/pear.css"/>
    <script src="/app/admin/component/layui/layui.js?v=2.8.12"></script>
    <script src="/app/admin/component/pear/pear.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
    /* 仅操作列垂直居中与间距优化，不影响其他列 */
    .layui-table-view .layui-table td { vertical-align: middle; }
    .layui-table-view .layui-table td .layui-table-cell .op-actions {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        height: 100%;
    }
    .layui-table-view .layui-table td .layui-table-cell .op-actions .pear-btn {
        vertical-align: middle;
    }
    
    /* 权限弹窗样式 */
    .perm-section {
        margin-bottom: 15px;
        padding: 10px;
        border: 1px solid #e6e6e6;
        border-radius: 4px;
    }
    .perm-section-title {
        font-weight: bold;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .perm-badge {
        display: inline-block;
        padding: 2px 6px;
        margin: 2px;
        background-color: #f0f0f0;
        border-radius: 3px;
        font-size: 12px;
    }
    .perm-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
    }
    .perm-table th, .perm-table td {
        padding: 6px;
        border: 1px solid #e6e6e6;
        text-align: center;
    }
    .perm-table th {
        background-color: #f8f8f8;
    }
    </style>
</head>
<body class="bg-gray-100 pear-container">
<div class="layui-card rounded-lg shadow-sm">
    <div class="layui-card-body">
        <form id="pluginForm" class="layui-form" action="">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label font-medium">关键词</label>
                    <div class="layui-input-inline">
                        <input type="text" name="q" id="q" placeholder="名称/标识/作者/描述" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label font-medium">状态</label>
                    <div class="layui-input-inline">
                        <select name="status" id="status" class="layui-input">
                            <option value="all">全部</option>
                            <option value="enabled">已启用</option>
                            <option value="disabled">未启用</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline ml-[50px]">
                    <button class="pear-btn pear-btn-md pear-btn-primary" lay-submit lay-filter="plugin-query">
                        <i class="layui-icon layui-icon-search"></i>
                        查询
                    </button>
                    <button type="reset" class="pear-btn pear-btn-md">
                        <i class="layui-icon layui-icon-refresh"></i>
                        重置
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="layui-card rounded-lg shadow-sm">
    <div class="layui-card-body">
        <table id="plugin-table" lay-filter="plugin-table"></table>
    </div>
</div>

<script type="text/html" id="plugin-toolbar">
    <div class="layui-btn-container flex items-center gap-2 flex-wrap">
        <button class="pear-btn pear-btn-primary pear-btn-md" lay-event="add">
            <i class="layui-icon layui-icon-add-1"></i>
            新增插件
        </button>
        <button class="pear-btn pear-btn-warm pear-btn-md" lay-event="batchEnable">
            <i class="layui-icon layui-icon-play"></i>
            批量启用
        </button>
        <button class="pear-btn pear-btn-md" lay-event="batchDisable">
            <i class="layui-icon layui-icon-pause"></i>
            批量停用
        </button>
        <button class="pear-btn pear-btn-danger pear-btn-md" lay-event="batchUninstall">
            <i class="layui-icon layui-icon-delete"></i>
            批量卸载
        </button>
    </div>
</script>

<script type="text/html" id="plugin-status">
    {{# if(d.enabled){ }}
    <span class="px-2 py-1 text-xs rounded bg-green-100 text-green-800">已启用</span>
    {{# } else { }}
    <span class="px-2 py-1 text-xs rounded bg-gray-100 text-gray-800">未启用</span>
    {{# } }}
</script>

<script type="text/html" id="plugin-bar">
    <div class="op-actions flex items-center justify-center space-x-2">
        {{# if(d.enabled){ }}
        <button class="pear-btn pear-btn-warm pear-btn-sm" lay-event="disable"><i class="layui-icon layui-icon-pause"></i></button>
        {{# } else { }}
        <button class="pear-btn pear-btn-primary pear-btn-sm" lay-event="enable"><i class="layui-icon layui-icon-play"></i></button>
        {{# } }}
        <button class="pear-btn pear-btn-neutral pear-btn-sm" lay-event="permissions"><i class="layui-icon layui-icon-set"></i></button>
        <button class="pear-btn pear-btn-danger pear-btn-sm" lay-event="uninstall"><i class="layui-icon layui-icon-delete"></i></button>
    </div>
</script>

<script>
layui.use(['table', 'form', 'jquery', 'layer'], function () {
    var table = layui.table;
    var form = layui.form;
    var $ = layui.jquery;
    var layer = layui.layer;

    var MODULE_PATH = "/app/admin/plugin-system/";

    function currentParams() {
        var formData = form.val('pluginForm');
        // 兜底获取
        formData.q = formData.q || ($('#q').val() || '');
        formData.status = formData.status || ($('#status').val() || 'all');
        return {
            q: (formData.q || '').trim(),
            status: formData.status || 'all'
        };
    }

    var currentTable = null;
    var lastParams = {};

    function renderTable() {
        lastParams = currentParams();
        if (currentTable) {
            currentTable.reload({
                url: MODULE_PATH + "list",
                where: lastParams,
                page: { curr: 1 }
            });
            return;
        }
        currentTable = table.render({
            elem: '#plugin-table',
            url: MODULE_PATH + 'list',
            where: lastParams,
            page: true,
            skin: 'line',
            toolbar: '#plugin-toolbar',
            defaultToolbar: [{
                layEvent: 'refresh',
                icon: 'layui-icon-refresh',
            }, 'filter', 'print', 'exports'],
            cols: [[
                { type: 'checkbox' },
                { field: 'name', title: '名称', align: 'center', minWidth: 160, sort: true },
                { field: 'slug', title: '标识', align: 'center', minWidth: 140, sort: true },
                { field: 'version', title: '版本', align: 'center', width: 100, sort: true },
                { field: 'author', title: '作者', align: 'center', width: 140, sort: true },
                { field: 'requires_php', title: 'Requires PHP', align: 'center', width: 120, sort: true },
                { field: 'requires_at_least', title: 'Requires at least', align: 'center', width: 140, sort: true },
                { field: 'enabled', title: '状态', align: 'center', width: 120, templet: '#plugin-status', sort: true },
                { title: '操作', toolbar: '#plugin-bar', align: 'center', width: 180, fixed: 'right' }
            ]],
            request: { pageName: 'page', limitName: 'limit' }
        });
    }

    // 查询提交
    form.on('submit(plugin-query)', function (data) {
        renderTable();
        return false;
    });

    // 工具栏事件
    table.on('toolbar(plugin-table)', function (obj) {
        if (obj.event === 'add') {
            layer.msg('新增插件：请接入安装/上传流程', { icon: 1, time: 1200 });
        } else if (obj.event === 'refresh') {
            if (currentTable) {
                currentTable.reload({ where: lastParams });
            }
        } else if (obj.event === 'batchEnable') {
            batchOperate('enable', '确认批量启用所选插件？');
        } else if (obj.event === 'batchDisable') {
            batchOperate('disable', '确认批量停用所选插件？');
        } else if (obj.event === 'batchUninstall') {
            batchOperate('uninstall', '确认批量卸载所选插件？此操作不可恢复！');
        }
    });

    // 行工具事件
    table.on('tool(plugin-table)', function (obj) {
        var data = obj.data;
        if (obj.event === 'enable') {
            // 启用弹窗，展示声明权限明细与当前授权状态
            fetch(MODULE_PATH + 'permissions?slug=' + encodeURIComponent(data.slug))
                .then(function (r) { return r.json(); })
                .then(function (res) {
                    if (res.code !== 0) { layer.msg('获取权限信息失败', {icon:2}); return; }
                    var info = res.data || {};
                    var html = renderEnablePermDialog(data.slug, info);
                    layer.open({
                        type: 1,
                        title: '启用插件并确认权限',
                        area: ['600px', '460px'],
                        content: html,
                        btn: ['启用', '取消'],
                        yes: function (index) {
                            layer.close(index);
                            post(MODULE_PATH + 'enable', { slug: data.slug }).then(function(res) {
                                if (res.code === 0 && typeof window.parent.loadPluginMenus === 'function') {
                                    // 插件启用成功后，重新加载插件菜单
                                    window.parent.loadPluginMenus();
                                }
                                doneReload('已启用', '启用失败')(res);
                            });
                        }
                    });
                });
        } else if (obj.event === 'disable') {
            layer.confirm('确认停用该插件？', { icon: 3, title: '提示' }, function (index) {
                layer.close(index);
                post(MODULE_PATH + 'disable', { slug: data.slug }).then(doneReload('已停用', '停用失败'));
            });
        } else if (obj.event === 'uninstall') {
            layer.confirm('确认卸载该插件？此操作不可恢复！', { icon: 3, title: '警告' }, function (index) {
                layer.close(index);
                post(MODULE_PATH + 'uninstall', { slug: data.slug }).then(doneReload('已卸载', '卸载失败'));
            });
        } else if (obj.event === 'permissions') {
            fetch(MODULE_PATH + 'permissions?slug=' + encodeURIComponent(data.slug))
                .then(function (r) { return r.json(); })
                .then(function (res) {
                    if (res.code !== 0) { layer.msg('获取权限信息失败', {icon:2}); return; }
                    var info = res.data || {};
                    var html = renderPermMainDialog(data.slug, info);
                    layer.open({
                        type: 1,
                        title: '权限管理',
                        area: ['500px', '300px'],
                        content: html
                    });
                });
        }
    });

    // 启用插件时的权限确认弹窗
    function renderEnablePermDialog(slug, info) {
        var declared = info.declared || [];
        var granted = info.granted || [];
        var pending = info.pending || [];
        
        // 合并所有权限并去重
        var allPerms = [...new Set([...declared, ...granted, ...pending])];
        
        // 生成权限列表
        var permList = '';
        if (allPerms.length > 0) {
            permList = '<div class="perm-section">' +
                '<div class="perm-section-title">' +
                '<span>插件声明的权限</span>' +
                '</div>' +
                '<div>';
            
            allPerms.forEach(function(perm) {
                var isGranted = granted.indexOf(perm) !== -1;
                var badgeClass = isGranted ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                var badgeText = isGranted ? '已授权' : '未授权';
                
                permList += '<span class="perm-badge ' + badgeClass + '">' + perm + ' (' + badgeText + ')</span>';
            });
            
            permList += '</div></div>';
        } else {
            permList = '<div class="perm-section">' +
                '<div class="perm-section-title">' +
                '<span>插件未声明任何权限</span>' +
                '</div>' +
                '</div>';
        }
        
        var html = 
            '<div class="p-4">' +
            '<div class="mb-4 text-sm text-gray-600">' +
            '启用插件前请确认其权限。未授权的权限将被拒绝执行。' +
            '</div>' +
            permList +
            '</div>';
            
        return html;
    }

    // 主权限弹窗（显示数量和打开子窗口的按钮）
    function renderPermMainDialog(slug, info) {
        var declared = info.declared || [];
        var granted = info.granted || [];
        var pending = info.pending || [];
        
        var html =
            '<div id="perm-main-popup" class="p-4">' +
                '<div class="perm-section">' +
                    '<div class="perm-section-title">' +
                        '<span>声明权限</span>' +
                        '<span>' + declared.length + ' 项</span>' +
                    '</div>' +
                    '<button class="pear-btn pear-btn-primary pear-btn-sm" onclick="openDeclaredPermDialog(\'' + slug + '\')">查看详细</button>' +
                '</div>' +
                '<div class="perm-section">' +
                    '<div class="perm-section-title">' +
                        '<span>已授权</span>' +
                        '<span>' + granted.length + ' 项</span>' +
                    '</div>' +
                    '<button class="pear-btn pear-btn-primary pear-btn-sm" onclick="openGrantedPermDialog(\'' + slug + '\')">查看详细</button>' +
                '</div>' +
                '<div class="perm-section">' +
                    '<div class="perm-section-title">' +
                        '<span>待授权</span>' +
                        '<span>' + pending.length + ' 项</span>' +
                    '</div>' +
                    '<button class="pear-btn pear-btn-primary pear-btn-sm" onclick="openPendingPermDialog(\'' + slug + '\')">查看详细</button>' +
                '</div>' +
            '</div>';
            
        // 将slug存储到全局变量，供子窗口使用
        window.currentSlug = slug;
        window.currentPermInfo = info;
        
        return html;
    }

    // 声明权限弹窗
    function renderDeclaredPermDialog(slug, info) {
        var declared = info.declared || [];
        var granted = info.granted || [];
        var stats = info.stats || {};
        
        var rows = declared.map(function(p) {
            var s = stats[p] || {calls:0, denied:0};
            var isGranted = granted.indexOf(p) !== -1;
            var status = isGranted ? '已授权' : '未授权';
            var btn = isGranted
                ? '<button class="pear-btn pear-btn-danger pear-btn-xs perm-revoke-one" data-perm="'+p+'">撤销</button>'
                : '<button class="pear-btn pear-btn-primary pear-btn-xs perm-grant-one" data-perm="'+p+'">授权</button>';
            return '<tr><td>'+p+'</td><td>'+status+'</td><td>'+s.calls+'</td><td>'+s.denied+'</td><td>'+btn+'</td></tr>';
        }).join('');
        
        var html =
            '<div id="declared-perm-popup" class="p-4">' +
                '<table class="perm-table">' +
                    '<thead>' +
                        '<tr><th>权限</th><th>状态</th><th>调用</th><th>拒绝</th><th>操作</th></tr>' +
                    '</thead>' +
                    '<tbody>' + rows + '</tbody>' +
                '</table>' +
                '<div class="flex gap-2 mt-3">' +
                    '<button class="pear-btn pear-btn-primary pear-btn-sm" id="perm-grant-all">全部授权</button>' +
                    '<button class="pear-btn pear-btn-danger pear-btn-sm" id="perm-revoke-all">全部撤销</button>' +
                '</div>' +
            '</div>';
            
        setTimeout(function() {
            bindDeclaredPermEvents(slug, info);
        }, 0);
        
        return html;
    }

    // 已授权权限弹窗
    function renderGrantedPermDialog(slug, info) {
        var granted = info.granted || [];
        var stats = info.stats || {};
        
        var rows = granted.map(function(p) {
            var s = stats[p] || {calls:0, denied:0};
            return '<tr><td>'+p+'</td><td>'+s.calls+'</td><td>'+s.denied+'</td><td><button class="pear-btn pear-btn-danger pear-btn-xs perm-revoke-one" data-perm="'+p+'">撤销</button></td></tr>';
        }).join('');
        
        var html =
            '<div id="granted-perm-popup" class="p-4">' +
                '<table class="perm-table">' +
                    '<thead>' +
                        '<tr><th>权限</th><th>调用</th><th>拒绝</th><th>操作</th></tr>' +
                    '</thead>' +
                    '<tbody>' + rows + '</tbody>' +
                '</table>' +
                '<div class="flex gap-2 mt-3">' +
                    '<button class="pear-btn pear-btn-danger pear-btn-sm" id="perm-revoke-all">全部撤销</button>' +
                '</div>' +
            '</div>';
            
        setTimeout(function() {
            bindGrantedPermEvents(slug, info);
        }, 0);
        
        return html;
    }

    // 待授权权限弹窗
    function renderPendingPermDialog(slug, info) {
        var pending = info.pending || [];
        var stats = info.stats || {};
        
        var rows = pending.map(function(p) {
            var s = stats[p] || {calls:0, denied:0};
            return '<tr><td>'+p+'</td><td>'+s.calls+'</td><td>'+s.denied+'</td><td><button class="pear-btn pear-btn-primary pear-btn-xs perm-grant-one" data-perm="'+p+'">授权</button></td></tr>';
        }).join('');
        
        var html =
            '<div id="pending-perm-popup" class="p-4">' +
                '<table class="perm-table">' +
                    '<thead>' +
                        '<tr><th>权限</th><th>调用</th><th>拒绝</th><th>操作</th></tr>' +
                    '</thead>' +
                    '<tbody>' + rows + '</tbody>' +
                '</table>' +
                '<div class="flex gap-2 mt-3">' +
                    '<button class="pear-btn pear-btn-primary pear-btn-sm" id="perm-grant-all">全部授权</button>' +
                '</div>' +
            '</div>';
            
        setTimeout(function() {
            bindPendingPermEvents(slug, info);
        }, 0);
        
        return html;
    }

    // 绑定声明权限弹窗事件
    function bindDeclaredPermEvents(slug, info) {
        // 全部授权
        document.getElementById('perm-grant-all') && (document.getElementById('perm-grant-all').onclick = function() {
            var declared = info.declared || [];
            // 确保权限列表是字符串数组
            var permissions = declared.map(function(p) { return String(p); });
            post(MODULE_PATH + 'grantPermissions', { slug: slug, permissions: permissions })
                .then(function(r) {
                    layer.msg(r.code===0?'全部授权成功':'授权失败',{icon:r.code===0?1:2});
                    // 重新加载权限信息
                    if (r.code === 0) {
                        refreshAllPermDialogs(slug);
                    }
                });
        });
        
        // 全部撤销
        document.getElementById('perm-revoke-all') && (document.getElementById('perm-revoke-all').onclick = function() {
            var declared = info.declared || [];
            // 确保权限列表是字符串数组
            var permissions = declared.map(function(p) { return String(p); });
            post(MODULE_PATH + 'revokePermissions', { slug: slug, permissions: permissions })
                .then(function(r) {
                    layer.msg(r.code===0?'全部撤销成功':'撤销失败',{icon:r.code===0?1:2});
                    // 重新加载权限信息
                    if (r.code === 0) {
                        refreshAllPermDialogs(slug);
                    }
                });
        });
        
        // 单项授权
        document.querySelectorAll('.perm-grant-one').forEach(function(el) {
            el.onclick = function() {
                var perm = el.getAttribute('data-perm');
                post(MODULE_PATH + 'grantPermission', { slug: slug, permission: perm })
                    .then(function(r) {
                        layer.msg(r.code===0?('已授权 '+perm):'授权失败',{icon:r.code===0?1:2});
                        // 重新加载权限信息
                        if (r.code === 0) {
                            refreshAllPermDialogs(slug);
                        }
                    });
            };
        });
        
        // 单项撤销
        document.querySelectorAll('.perm-revoke-one').forEach(function(el) {
            el.onclick = function() {
                var perm = el.getAttribute('data-perm');
                post(MODULE_PATH + 'revokePermission', { slug: slug, permission: perm })
                    .then(function(r) {
                        layer.msg(r.code===0?('已撤销 '+perm):'撤销失败',{icon:r.code===0?1:2});
                        // 重新加载权限信息
                        if (r.code === 0) {
                            refreshAllPermDialogs(slug);
                        }
                    });
            };
        });
    }

    // 绑定已授权权限弹窗事件
    function bindGrantedPermEvents(slug, info) {
        // 全部撤销
        document.getElementById('perm-revoke-all') && (document.getElementById('perm-revoke-all').onclick = function() {
            var granted = info.granted || [];
            // 确保权限列表是字符串数组
            var permissions = granted.map(function(p) { return String(p); });
            post(MODULE_PATH + 'revokePermissions', { slug: slug, permissions: permissions })
                .then(function(r) {
                    layer.msg(r.code===0?'全部撤销成功':'撤销失败',{icon:r.code===0?1:2});
                    // 重新加载权限信息
                    if (r.code === 0) {
                        refreshAllPermDialogs(slug);
                    }
                });
        });
        
        // 单项撤销
        document.querySelectorAll('.perm-revoke-one').forEach(function(el) {
            el.onclick = function() {
                var perm = el.getAttribute('data-perm');
                post(MODULE_PATH + 'revokePermission', { slug: slug, permission: perm })
                    .then(function(r) {
                        layer.msg(r.code===0?('已撤销 '+perm):'撤销失败',{icon:r.code===0?1:2});
                        // 重新加载权限信息
                        if (r.code === 0) {
                            refreshAllPermDialogs(slug);
                        }
                    });
            };
        });
    }

    // 绑定待授权权限弹窗事件
    function bindPendingPermEvents(slug, info) {
        // 全部授权
        document.getElementById('perm-grant-all') && (document.getElementById('perm-grant-all').onclick = function() {
            var pending = info.pending || [];
            // 确保权限列表是字符串数组
            var permissions = pending.map(function(p) { return String(p); });
            post(MODULE_PATH + 'grantPermissions', { slug: slug, permissions: permissions })
                .then(function(r) {
                    layer.msg(r.code===0?'全部授权成功':'授权失败',{icon:r.code===0?1:2});
                    // 重新加载权限信息
                    if (r.code === 0) {
                        refreshAllPermDialogs(slug);
                    }
                });
        });
        
        // 单项授权
        document.querySelectorAll('.perm-grant-one').forEach(function(el) {
            el.onclick = function() {
                var perm = el.getAttribute('data-perm');
                post(MODULE_PATH + 'grantPermission', { slug: slug, permission: perm })
                    .then(function(r) {
                        layer.msg(r.code===0?('已授权 '+perm):'授权失败',{icon:r.code===0?1:2});
                        // 重新加载权限信息
                        if (r.code === 0) {
                            refreshAllPermDialogs(slug);
                        }
                    });
            };
        });
    }

    function doneReload(successText, failText) {
        return function (res) {
            layer.msg(res.code === 0 ? successText : (failText + '：' + (res.msg || '')), { icon: res.code === 0 ? 1 : 2, time: 1000 }, function () {
                if (currentTable) {
                    currentTable.reload({ where: lastParams });
                }
                // 如果操作成功且是启用操作，重新加载插件菜单
                if (res.code === 0 && successText === '已启用' && typeof window.parent.loadPluginMenus === 'function') {
                    window.parent.loadPluginMenus();
                }
            });
        };
    }

    function batchOperate(op, confirmText) {
        var data = table.checkStatus('plugin-table').data;
        if (!data || data.length === 0) {
            layer.msg("未选中数据", { icon: 3, time: 1000 });
            return;
        }
        var slugs = data.map(function (d) { return d.slug; }).filter(Boolean);
        layer.confirm(confirmText, { icon: 3, title: '提示' }, function (index) {
            layer.close(index);
            var loading = layer.load();
            // 顺序执行，避免过多并发
            var seq = Promise.resolve();
            slugs.forEach(function (slug) {
                seq = seq.then(function () {
                    return post(MODULE_PATH + op, { slug: slug });
                });
            });
            seq.then(function () {
                layer.close(loading);
                layer.msg('操作完成', { icon: 1, time: 1000 }, function () {
                    if (currentTable) {
                        currentTable.reload({ where: lastParams });
                    }
                    // 如果有启用操作，重新加载插件菜单
                    if (op === 'enable' && typeof window.parent.loadPluginMenus === 'function') {
                        window.parent.loadPluginMenus();
                    }
                });
            }).catch(function (e) {
                layer.close(loading);
                layer.msg('部分操作失败', { icon: 2, time: 1200 });
                if (currentTable) {
                    currentTable.reload({ where: lastParams });
                }
                // 如果有启用操作，重新加载插件菜单
                if (op === 'enable' && typeof window.parent.loadPluginMenus === 'function') {
                    window.parent.loadPluginMenus();
                }
            });
        });
    }

    function post(url, data) {
        // 处理权限数组参数
        var formData = new FormData();
        for (var key in data) {
            if (data.hasOwnProperty(key)) {
                if (key === 'permissions' && Array.isArray(data[key])) {
                    // 对于权限数组，添加多个同名参数
                    data[key].forEach(function(perm) {
                        formData.append('permissions[]', perm);
                    });
                } else {
                    formData.append(key, data[key]);
                }
            }
        }
        
        return fetch(url, {
            method: 'POST',
            body: formData
        }).then(function (r) { return r.json(); });
    }

    // 刷新所有权限弹窗
    function refreshAllPermDialogs(slug) {
        fetch(MODULE_PATH + 'permissions?slug=' + encodeURIComponent(slug))
            .then(function (r) { return r.json(); })
            .then(function (res) {
                if (res.code !== 0) { 
                    layer.msg('刷新权限信息失败', {icon:2}); 
                    return; 
                }
                window.currentPermInfo = res.data || {};
                
                // 更新主弹窗
                var mainPopup = document.getElementById('perm-main-popup');
                if (mainPopup) {
                    var newMainHtml = renderPermMainDialog(slug, window.currentPermInfo);
                    // 提取内容部分（去除外层div标签）
                    var content = newMainHtml.replace(/<div id="perm-main-popup"[^>]*>/, '').replace('</div>', '');
                    mainPopup.innerHTML = content;
                }
                
                // 更新声明权限弹窗
                var declaredPopup = document.getElementById('declared-perm-popup');
                if (declaredPopup) {
                    var newDeclaredHtml = renderDeclaredPermDialog(slug, window.currentPermInfo);
                    var content = newDeclaredHtml.replace(/<div id="declared-perm-popup"[^>]*>/, '').replace('</div>', '');
                    declaredPopup.innerHTML = content;
                    bindDeclaredPermEvents(slug, window.currentPermInfo);
                }
                
                // 更新已授权权限弹窗
                var grantedPopup = document.getElementById('granted-perm-popup');
                if (grantedPopup) {
                    var newGrantedHtml = renderGrantedPermDialog(slug, window.currentPermInfo);
                    var content = newGrantedHtml.replace(/<div id="granted-perm-popup"[^>]*>/, '').replace('</div>', '');
                    grantedPopup.innerHTML = content;
                    bindGrantedPermEvents(slug, window.currentPermInfo);
                }
                
                // 更新待授权权限弹窗
                var pendingPopup = document.getElementById('pending-perm-popup');
                if (pendingPopup) {
                    var newPendingHtml = renderPendingPermDialog(slug, window.currentPermInfo);
                    var content = newPendingHtml.replace(/<div id="pending-perm-popup"[^>]*>/, '').replace('</div>', '');
                    pendingPopup.innerHTML = content;
                    bindPendingPermEvents(slug, window.currentPermInfo);
                }
                
                // 重新渲染表格
                renderTable();
            });
    }

    // 全局函数，供弹窗按钮调用
    window.openDeclaredPermDialog = function(slug) {
        var info = window.currentPermInfo || {};
        var html = renderDeclaredPermDialog(slug, info);
        var index = layer.open({
            type: 1,
            title: '声明权限',
            area: ['700px', '500px'],
            content: html
        });
        window.declaredPermDialogIndex = index;
    };

    window.openGrantedPermDialog = function(slug) {
        var info = window.currentPermInfo || {};
        var html = renderGrantedPermDialog(slug, info);
        var index = layer.open({
            type: 1,
            title: '已授权权限',
            area: ['600px', '400px'],
            content: html
        });
        window.grantedPermDialogIndex = index;
    };

    window.openPendingPermDialog = function(slug) {
        var info = window.currentPermInfo || {};
        var html = renderPendingPermDialog(slug, info);
        var index = layer.open({
            type: 1,
            title: '待授权权限',
            area: ['600px', '400px'],
            content: html
        });
        window.pendingPermDialogIndex = index;
    };

    // 初始化渲染
    form.render();
    renderTable();
});
</script>
</body>
</html>