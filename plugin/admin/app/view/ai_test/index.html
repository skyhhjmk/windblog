<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
    <title>AI效果测试</title>
    <link rel="stylesheet" href="/app/admin/component/layui/css/layui.css?v=2.8.12"/>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50">
<div class="max-w-7xl mx-auto p-6">
    <div class="bg-white rounded-lg shadow-md">
        <div class="border-b border-gray-200 px-6 py-4">
            <h1 class="text-2xl font-bold text-gray-800">AI 效果测试</h1>
            <p class="text-sm text-gray-500 mt-1">选择AI提供者、修改提示词、附加媒体图片进行测试</p>
        </div>

        <div class="p-6 space-y-6">
            <!-- 提供者选择 -->
            <div class="space-y-3">
                <label class="block text-sm font-medium text-gray-700">AI 提供者</label>
                <select id="provider-select"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">加载中...</option>
                </select>
                <div class="text-sm p-3 bg-gray-100 rounded-lg border border-gray-200 hidden" id="provider-info">
                </div>
            </div>

            <!-- 任务类型 -->
            <div class="space-y-3">
                <label class="block text-sm font-medium text-gray-700">任务类型</label>
                <select id="task-select"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="chat">对话 (Chat)</option>
                    <option value="summarize">摘要 (Summarize)</option>
                    <option value="translate">翻译 (Translate)</option>
                    <option value="generate">生成 (Generate)</option>
                </select>
            </div>

            <!-- 提示词模板 -->
            <div class="space-y-3">
                <label class="block text-sm font-medium text-gray-700">提示词模板</label>
                <div class="flex gap-2">
                    <select id="template-select"
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">选择模板...</option>
                    </select>
                    <button id="btn-save-template"
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                        保存当前
                    </button>
                    <button id="btn-delete-template"
                            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                        删除
                    </button>
                </div>
            </div>

            <!-- 提示词输入 -->
            <div class="space-y-3">
                <label class="block text-sm font-medium text-gray-700">提示词</label>
                <textarea id="prompt-input" rows="6" placeholder="输入你的提示词..."
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"></textarea>
            </div>

            <!-- 媒体库图片选择 -->
            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <label class="block text-sm font-medium text-gray-700">附加图片（多模态支持）</label>
                    <div class="flex gap-2">
                        <button id="btn-select-media"
                                class="text-sm px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                            <i class="layui-icon layui-icon-picture"></i> 选择图片
                        </button>
                        <button id="btn-clear-selection"
                                class="text-sm px-3 py-1 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                            <i class="layui-icon layui-icon-delete"></i> 清空
                        </button>
                    </div>
                </div>

                <div id="selected-images"
                     class="flex flex-wrap gap-2 min-h-[60px] border border-gray-200 rounded-lg p-3 bg-gray-50">
                    <div class="text-sm text-gray-400">未选择图片</div>
                </div>
            </div>

            <!-- 高级选项 -->
            <details class="border border-gray-200 rounded-lg p-4">
                <summary class="cursor-pointer font-medium text-gray-700">高级选项</summary>
                <div class="mt-4 space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">温度 (Temperature)</label>
                        <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.7" class="w-full">
                        <div class="text-sm text-gray-500 text-center">
                            <span id="temperature-value">0.7</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">最大 Tokens</label>
                        <input id="max-tokens" placeholder="留空使用提供方配置" type="number"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="enable-stream" checked
                                   class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <span class="text-sm font-medium text-gray-700">启用流式输出（防止响应超时）</span>
                        </label>
                    </div>
                </div>
            </details>

            <!-- 测试按钮 -->
            <div>
                <button id="btn-test"
                        class="w-full px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition shadow-md hover:shadow-lg">
                    测试 AI 效果
                </button>
            </div>

            <!-- 结果显示 -->
            <div id="result-panel" class="hidden space-y-3">
                <label class="block text-sm font-medium text-gray-700">AI 响应结果</label>
                <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                    <div id="result-content" class="prose max-w-none"></div>
                </div>
                <div id="result-meta" class="text-xs text-gray-500 space-y-1"></div>
            </div>
        </div>
    </div>
</div>

<script src="/app/admin/component/layui/layui.js?v=2.8.12"></script>
<script>
    layui.use(['layer'], function () {
        var layer = layui.layer, $ = layui.$;

        var providers = [];
        var selectedImages = [];
        var selectedMediaData = []; // 存储媒体完整数据
        var templates = [];
        var pollInterval = null; // 轮询定时器
        var currentTaskId = null; // 当前任务ID

        // 加载提供者列表
        function loadProviders() {
            $.get('/app/admin/ai/test/providers', function (res) {
                if (res && res.code === 0 && res.data) {
                    providers = res.data.available || [];
                    var select = $('#provider-select');
                    select.html('');
                    providers.forEach(function (p) {
                        select.append('<option value="' + p.id + '">' + p.name + ' (' + p.id + ')</option>');
                    });
                    if (res.data.current) {
                        select.val(res.data.current);
                        select.trigger('change');
                    }
                    }
            });
        }

        // 提供者选择变更联动
        $('#provider-select').on('change', function () {
            var val = $(this).val();
            var infoDiv = $('#provider-info');
            infoDiv.addClass('hidden').html('');

            if (!val) return;

            var provider = providers.find(function (p) {
                return p.id === val;
            });
            if (provider && provider.type === 'group' && provider.provider_status) {
                var html = '<div class="font-medium mb-2 text-gray-700">轮询组详情 (策略: ' + provider.strategy + ')</div>';
                html += '<div class="space-y-1">';
                provider.provider_status.forEach(function (p) {
                    var statusClass = p.is_blacklisted ? 'text-red-500 font-bold' : (p.enabled ? 'text-green-600' : 'text-gray-400');
                    var statusText = p.status_text || (p.enabled ? '正常' : '禁用');
                    if (p.is_blacklisted) statusText = '熔断中 (' + statusText + ')';

                    html += '<div class="flex justify-between items-center text-xs">';
                    html += '<span>' + p.name + ' <span class="text-gray-400">(' + p.id + ')</span></span>';
                    html += '<span class="' + statusClass + '">权重:' + p.weight + ' | ' + statusText + '</span>';
                    html += '</div>';
                });
                html += '</div>';
                infoDiv.html(html).removeClass('hidden');
            }
        });

        // 加载模板列表
        function loadTemplates() {
            $.get('/app/admin/ai/test/templates', function (res) {
                if (res && res.code === 0 && res.data) {
                    templates = res.data;
                    var select = $('#template-select');
                    select.html('<option value="">选择模板...</option>');
                    templates.forEach(function (t) {
                        select.append('<option value="' + t.id + '">' + t.name + '</option>');
                    });
                }
            });
        }

        // 打开媒体选择器
        function openMediaSelector() {
            console.log('AI Test: 打开媒体选择器');
            layer.open({
                type: 2,
                title: '选择图片',
                content: '/app/admin/media/selector?multiple=1',
                area: ['95%', '90%'],
                success: function (layero, index) {
                    console.log('AI Test: layer弹窗打开成功', {layero: layero, index: index});
                    // 设置回调函数
                    var callback = function (data) {
                        console.log('AI Test: 媒体选择器回调被调用', {data: data});
                        if (!data) {
                            console.log('AI Test: 回调数据为空');
                            return;
                        }

                        // 处理数据：将单个对象转为数组
                        var items = Array.isArray(data) ? data : [data];
                        console.log('AI Test: 开始添加图片', items.length + ' 个');

                        // 批量添加图片
                        items.forEach(function (item) {
                            if (item && item.id && !selectedImages.includes(item.id)) {
                                selectedImages.push(item.id);
                                selectedMediaData.push(item);
                                console.log('AI Test: 添加图片', item);
                            }
                        });

                        console.log('AI Test: 图片添加完成，当前共', selectedImages.length, '个');
                        renderSelectedImages();
                        layer.close(index);
                    };
                    $("#layui-layer" + index).data("callback", callback);
                    console.log('AI Test: 回调函数已设置', $("#layui-layer" + index).data("callback"));
                }
            });
        }


        // 渲染已选图片
        function renderSelectedImages() {
            console.log('AI Test: 渲染图片', selectedMediaData);
            var container = $('#selected-images');
            container.html('');

            if (selectedImages.length === 0) {
                container.html('<div class="text-sm text-gray-400">未选择图片</div>');
                return;
            }

            selectedMediaData.forEach(function (media, idx) {
                var wrapper = $('<div class="relative inline-block"></div>');

                // 构建图片URL
                var imageUrl = media.thumb_url || media.url || '';
                // 如果没有完整URL，尝试从文件路径构建
                if (!imageUrl && media.file_path) {
                    imageUrl = '/uploads/' + media.file_path;
                }
                if (!imageUrl && media.thumb_path) {
                    imageUrl = '/uploads/' + media.thumb_path;
                }

                console.log('AI Test: 图片URL', {media: media, imageUrl: imageUrl});

                // 图片缩略图
                var img = $('<img class="w-20 h-20 object-cover rounded-lg border-2 border-blue-300" />');
                img.attr('src', imageUrl);
                img.attr('alt', media.original_name || media.filename || media.name || '');
                img.attr('title', media.original_name || media.filename || media.name || '');

                // 删除按钮
                var removeBtn = $('<button class="absolute -top-2 -right-2 w-6 h-6 bg-red-600 text-white rounded-full flex items-center justify-center hover:bg-red-700 transition shadow-lg">×</button>');
                removeBtn.on('click', function () {
                    selectedImages.splice(idx, 1);
                    selectedMediaData.splice(idx, 1);
                    renderSelectedImages();
                });

                wrapper.append(img);
                wrapper.append(removeBtn);
                container.append(wrapper);
            });
        }

        // 选择媒体按钮
        $('#btn-select-media').on('click', function () {
            openMediaSelector();
        });

        // 清除选择
        $('#btn-clear-selection').on('click', function () {
            if (selectedImages.length === 0) {
                layer.msg('没有需要清除的图片', {icon: 0});
                return;
            }
            layer.confirm('确定要清空所有已选图片吗？', {icon: 3}, function (index) {
                selectedImages = [];
                selectedMediaData = [];
                renderSelectedImages();
                layer.close(index);
                layer.msg('已清空', {icon: 1});
            });
        });

        // 模板选择
        $('#template-select').on('change', function () {
            var id = $(this).val();
            if (!id) return;

            var template = templates.find(function (t) {
                return t.id === id;
            });
            if (template) {
                $('#prompt-input').val(template.prompt);
                $('#task-select').val(template.task);
            }
        });

        // 保存模板
        $('#btn-save-template').on('click', function () {
            var prompt = $('#prompt-input').val();
            if (!prompt) {
                layer.msg('请输入提示词', {icon: 2});
                return;
            }

            layer.prompt({title: '模板名称', formType: 0}, function (name, idx) {
                layer.close(idx);

                $.ajax({
                    url: '/app/admin/ai/test/save-template',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        name: name,
                        prompt: prompt,
                        task: $('#task-select').val()
                    }),
                    success: function (res) {
                        if (res && res.code === 0) {
                            layer.msg('保存成功', {icon: 1});
                            loadTemplates();
                        } else {
                            layer.msg(res.msg || '保存失败', {icon: 2});
                        }
                    }
                });
            });
        });

        // 删除模板
        $('#btn-delete-template').on('click', function () {
            var id = $('#template-select').val();
            if (!id) {
                layer.msg('请先选择模板', {icon: 2});
                return;
            }

            layer.confirm('确定删除该模板？', {icon: 3}, function (idx) {
                layer.close(idx);

                $.ajax({
                    url: '/app/admin/ai/test/delete-template',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({id: id}),
                    success: function (res) {
                        if (res && res.code === 0) {
                            layer.msg('删除成功', {icon: 1});
                            loadTemplates();
                            $('#template-select').val('');
                        } else {
                            layer.msg(res.msg || '删除失败', {icon: 2});
                        }
                    }
                });
            });
        });

        // 温度滑块
        $('#temperature').on('input', function () {
            $('#temperature-value').text($(this).val());
        });

        // 轮询任务状态
        function pollTaskStatus(taskId, loadingIndex) {
            var pollCount = 0;
            var maxPolls = 60; // 最多轮询60次 (120秒)

            // 清除之前的轮询
            if (pollInterval) {
                clearInterval(pollInterval);
            }

            pollInterval = setInterval(function () {
                pollCount++;

                // 超时保护
                if (pollCount > maxPolls) {
                    clearInterval(pollInterval);
                    pollInterval = null;
                    currentTaskId = null;
                    layer.close(loadingIndex);
                    layer.msg('任务处理超时，请稍后重试', {icon: 2});
                    return;
                }

                // 查询任务状态
                $.ajax({
                    url: '/app/admin/ai/test/task-status?task_id=' + taskId,
                    method: 'GET',
                    success: function (res) {
                        if (res && res.code === 0 && res.data) {
                            var status = res.data.status;

                            if (status === 'pending') {
                                layer.msg('任务排队中...', {icon: 16, time: 1000});
                            } else if (status === 'processing') {
                                layer.msg('AI处理中...', {icon: 16, time: 1000});
                            } else if (status === 'completed') {
                                // 任务完成
                                clearInterval(pollInterval);
                                pollInterval = null;
                                currentTaskId = null;
                                layer.close(loadingIndex);

                                // 显示结果
                                var result = res.data.result || {};
                                $('#result-panel').removeClass('hidden');
                                $('#result-content').html('<pre class="whitespace-pre-wrap">' + (result.result || '') + '</pre>');

                                var meta = [];
                                if (result.model) meta.push('模型: ' + result.model);
                                if (result.usage) {
                                    if (result.usage.total_tokens) {
                                        meta.push('Tokens: ' + result.usage.total_tokens);
                                    }
                                    if (result.usage.prompt_tokens && result.usage.completion_tokens) {
                                        meta.push('(输入: ' + result.usage.prompt_tokens + ' / 输出: ' + result.usage.completion_tokens + ')');
                                    }
                                }
                                if (result.finish_reason) meta.push('完成原因: ' + result.finish_reason);
                                if (result.provider) meta.push('执行提供方: ' + (result.provider_name ? result.provider_name + ' (' + result.provider + ')' : result.provider));

                                $('#result-meta').html(meta.map(function (m) {
                                    return '<div>' + m + '</div>';
                                }).join(''));

                                layer.msg('测试完成', {icon: 1});
                            } else if (status === 'failed') {
                                // 任务失败
                                clearInterval(pollInterval);
                                pollInterval = null;
                                currentTaskId = null;
                                layer.close(loadingIndex);
                                layer.msg(res.data.error || '任务处理失败', {icon: 2});
                            }
                        } else {
                            // 查询失败
                            clearInterval(pollInterval);
                            pollInterval = null;
                            currentTaskId = null;
                            layer.close(loadingIndex);
                            layer.msg(res.msg || '查询任务状态失败', {icon: 2});
                        }
                    },
                    error: function () {
                        console.log('轮询请求失败，继续尝试...');
                    }
                });
            }, 2000); // 每2秒轮询2次
        }

        // 测试AI
        $('#btn-test').on('click', function () {
            var provider = $('#provider-select').val();
            var task = $('#task-select').val();
            var prompt = $('#prompt-input').val();
            var enableStream = $('#enable-stream').is(':checked');

            if (!provider) {
                layer.msg('请选择AI提供者', {icon: 2});
                return;
            }

            if (!prompt) {
                layer.msg('请输入提示词', {icon: 2});
                return;
            }

            // 如果已有任务在处理，提示用户
            if (currentTaskId && pollInterval) {
                layer.confirm('已有任务正在处理，是否取消并提交新任务？', {icon: 3}, function (index) {
                    clearInterval(pollInterval);
                    pollInterval = null;
                    currentTaskId = null;
                    layer.close(index);
                    submitTask(); // 提交新任务
                });
                return;
            }

            submitTask();

            function submitTask() {
                var options = {
                    temperature: parseFloat($('#temperature').val())
                };
                var maxTokensRaw = ($('#max-tokens').val() + '').trim();
                var maxParsed = parseInt(maxTokensRaw, 10);
                if (maxTokensRaw !== '' && !isNaN(maxParsed) && maxParsed > 0) {
                    options.max_tokens = maxParsed;
                }

                var loading = layer.msg('提交任务中...', {icon: 16, shade: 0.3, time: 0});

                $.ajax({
                    url: '/app/admin/ai/test/test',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        provider: provider,
                        task: task,
                        prompt: prompt,
                        images: selectedImages,
                        options: options
                    }),
                    success: function (res) {
                        if (res && res.code === 0 && res.data && res.data.task_id) {
                            // 任务提交成功，开始轮询
                            currentTaskId = res.data.task_id;
                            layer.msg(res.data.message || '任务已提交', {icon: 1, time: 1000});

                            // 更新loading提示
                            layer.close(loading);
                            loading = layer.msg('AI处理中...', {icon: 16, shade: 0.3, time: 0});

                            // 开始轮询任务状态
                            pollTaskStatus(currentTaskId, loading);
                        } else {
                            layer.close(loading);
                            layer.msg(res.msg || '任务提交失败', {icon: 2});
                        }
                    },
                    error: function () {
                        layer.close(loading);
                        layer.msg('请求失败', {icon: 2});
                    }
                });
            }
        });

        // 初始化
        loadProviders();
        loadTemplates();
        renderSelectedImages();
    });
</script>
</body>

</html>
