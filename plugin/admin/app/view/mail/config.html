<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>邮件平台配置</title>
  <link rel="stylesheet" href="/app/admin/component/layui/css/layui.css?v=2.8.12"/>
  <link rel="stylesheet" href="/app/admin/component/pear/css/pear.css"/>
  <link rel="stylesheet" href="/app/admin/admin/css/reset.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/themes/base/jquery-ui.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>
  <style>
    .container { display: flex; gap: 20px; margin-top: 10px; }
    .list { flex: 1; min-height: 400px; border: 1px dashed #dcdcdc; border-radius: 4px; padding: 10px; background-color: #f8f8f8; }
    .available { width: 320px; border: 1px solid #dcdcdc; border-radius: 4px; background-color: #fff; }
    .available-widgets { border: 1px solid #dcdcdc; border-radius: 4px; background-color: #ffffff; }
    .available-widgets-header { padding: 10px 15px; background-color: #f2f2f2; border-bottom: 1px solid #e6e6e6; font-weight: bold; }
    .available-widgets-content { max-height: 600px; overflow-y: auto; }
    .available-widget-item { padding: 10px 15px; border-bottom: 1px solid #f2f2f2; cursor: pointer; transition: background-color 0.3s; }
    .available-widget-item:hover { background-color: #f2f2f2; }
    .available-widget-item:last-child { border-bottom: none; }
    .item { margin-bottom: 12px; border: 1px solid #e6e6e6; border-radius: 4px; background-color: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .item-header { padding: 10px 15px; background-color: #f2f2f2; border-bottom: 1px solid #e6e6e6; cursor: move; display:flex; justify-content:space-between; align-items:center; }
    .item-content { padding: 15px; }
    .tools { display:flex; gap:6px; }
    .tool { color:#999; cursor:pointer; }
    .tool:hover { color:#666; }
    .sortable-placeholder { background-color:#f0f9ff; border:2px dashed #409eff; height:80px; margin-bottom:12px; border-radius:4px; }
    .hint { color:#888; font-size:12px; }
    .save-section { margin-top: 20px; text-align: right; }
  </style>
</head>
<body class="pear-container">
<div class="layui-card">
  <div class="layui-card-header"><h3>邮件平台配置</h3></div>
  <div class="layui-card-body">
    <div class="hint">支持 PHPMailer 的全部平台：mail、sendmail、qmail、smtp、smtps。推荐使用 DSN 字符串配置，示例：smtp://user:pass@smtp.example.com:587?encryption=tls</div>

    <div class="container">
      <!-- 左侧：平台列表 -->
      <div class="list" id="provider-list" style="flex:1;">
        <div class="text-center text-muted" style="padding:30px;">
          <i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop" style="font-size:36px;"></i>
          <p>加载中...</p>
        </div>
      </div>
      <!-- 右侧：策略与可用类型面板 -->
      <div class="available-widgets" style="width:320px;">
        <div class="available-widgets-header"><strong>平台选择策略</strong></div>
        <div class="available-widgets-content">
          <div class="item-content">
            <div class="layui-form">
              <div class="layui-form-item">
                <label class="layui-form-label">策略</label>
                <div class="layui-input-block">
                  <select id="strategy" class="layui-select">
                    <option value="weighted">加权随机</option>
                    <option value="rr">加权轮询</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="available-widgets-header" style="margin-top:10px;"><strong>可用平台类型</strong></div>
        <div class="available-widgets-content" id="available-types">
          <div class="available-widget-item available-type" data-type="smtp">SMTP/smtps</div>
          <div class="available-widget-item available-type" data-type="mail">mail()</div>
          <div class="available-widget-item available-type" data-type="sendmail">sendmail</div>
          <div class="available-widget-item available-type" data-type="qmail">qmail</div>
          <div class="hint" style="padding:8px 12px;">点击类型快速添加一条配置，或拖拽至左侧列表。</div>
        </div>
      </div>
    </div>

    <div class="save-section">
      <button class="pear-btn pear-btn-primary" id="btn-save">保存配置</button>
    </div>
  </div>
</div>

<script src="/app/admin/component/layui/layui.js?v=2.8.12"></script>
<script src="/app/admin/component/pear/pear.js"></script>
<script src="/app/admin/admin/js/permission.js"></script>
<script>
layui.use(['layer','form'], function(){
  var layer = layui.layer, form = layui.form, $ = layui.$;

  var providers = [];
  var strategy = 'weighted';

  function uid() {
    return 'p_' + Math.random().toString(36).slice(2, 10);
  }

  function load() {
    $.get('/app/admin/mail/providers', function(res){
      if(res && res.code === 0) {
        var data = res.data || {};
        providers = data.providers || [];
        strategy = data.strategy || 'weighted';
        $('#strategy').val(strategy);
        render();
      } else {
        layer.msg((res && res.msg) || '加载失败', {icon:2});
      }
    }).fail(function(){ layer.msg('请求失败', {icon:2}); });
  }

  function render() {
    var html = '';
    if(!providers.length) {
      html = '<div class="text-center text-muted" style="padding:30px;">暂无配置，点击右侧添加</div>';
    } else {
      providers.forEach(function(p){
        html += itemHtml(p);
      });
    }
    $('#provider-list').html(html);
    initSortable();
  }

  function itemHtml(p) {
    var enabled = p.enabled !== false;
    var name = p.name || ('未命名('+ (p.type||'dsn') +')');
    var weight = p.weight || 1;
    var html = '<div class="item" data-id="'+ p.id +'">';
    html += '<div class="item-header"><span>'+ name +'</span><div class="tools">';
    html += '<span class="tool tool-test" title="测试"><i class="layui-icon layui-icon-release"></i></span>';
    html += '<span class="tool tool-edit" title="编辑"><i class="layui-icon layui-icon-edit"></i></span>';
    html += '<span class="tool tool-del" title="删除"><i class="layui-icon layui-icon-delete"></i></span>';
    html += '</div></div>';
    html += '<div class="item-content">';
    html += '<div class="layui-form">';
    html += '<div class="layui-form-item"><label class="layui-form-label">名称</label><div class="layui-input-block"><input type="text" class="layui-input ip-name" value="'+ (p.name||'') +'"></div></div>';
    html += '<div class="layui-form-item"><label class="layui-form-label">权重</label><div class="layui-input-inline"><input type="number" min="0" class="layui-input ip-weight" value="'+ weight +'"></div><div class="layui-form-mid">0 表示临时禁用</div></div>';
    html += '<div class="layui-form-item"><label class="layui-form-label">启用</label><div class="layui-input-block"><input type="checkbox" class="ip-enabled" '+ (enabled?'checked':'') +'></div></div>';
    html += '<fieldset class="layui-elem-field"><legend>DSN</legend><div class="layui-field-box"><input type="text" class="layui-input ip-dsn" value="'+ (p.dsn||'') +'" placeholder="如：smtp://user:pass@smtp.example.com:587?encryption=tls"></div></fieldset>';
    html += '<div class="hint">若不使用 DSN，可留空，使用下方类型配置</div>';
    html += '<div class="layui-form-item"><label class="layui-form-label">类型</label><div class="layui-input-inline"><select class="ip-type"><option value="smtp" '+((p.type||'smtp')==='smtp'?'selected':'')+'>smtp</option><option value="smtps" '+((p.type||'')==='smtps'?'selected':'')+'>smtps</option><option value="mail" '+((p.type||'')==='mail'?'selected':'')+'>mail</option><option value="sendmail" '+((p.type||'')==='sendmail'?'selected':'')+'>sendmail</option><option value="qmail" '+((p.type||'')==='qmail'?'selected':'')+'>qmail</option></select></div></div>';
    html += '<div class="layui-form-item"><label class="layui-form-label">Host</label><div class="layui-input-inline"><input type="text" class="layui-input ip-host" value="'+ (p.host||'') +'"></div><label class="layui-form-label">Port</label><div class="layui-input-inline"><input type="number" class="layui-input ip-port" value="'+ (p.port||'') +'"></div></div>';
    html += '<div class="layui-form-item"><label class="layui-form-label">用户名</label><div class="layui-input-inline"><input type="text" class="layui-input ip-username" value="'+ (p.username||'') +'"></div><label class="layui-form-label">密码</label><div class="layui-input-inline"><input type="password" class="layui-input ip-password" value="'+ (p.password||'') +'"></div></div>';
    html += '<div class="layui-form-item"><label class="layui-form-label">加密</label><div class="layui-input-inline"><select class="ip-encryption"><option value="">none</option><option value="tls" '+((p.encryption||'')==='tls'?'selected':'')+'>tls</option><option value="ssl" '+((p.encryption||'')==='ssl'?'selected':'')+'>ssl</option></select></div></div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    return html;
  }

  function initSortable() {
    if ($.fn.sortable && $('#provider-list').length) {
      $('#provider-list').sortable({
        handle: '.item-header',
        placeholder: 'sortable-placeholder',
        tolerance: 'pointer',
        opacity: 0.7,
        revert: 150,
        update: function(){ syncFromDom(); }
      }).disableSelection();
    }
    // 可用类型点击添加
    $(document).off('click', '.available-type').on('click', '.available-type', function(){
      addProvider($(this).data('type'));
    });
    // 初始化右侧类型拖拽到左侧列表
    initDragAndDrop();
    // 操作事件
    $(document).off('click', '.tool-del').on('click', '.tool-del', function(){
      var id = $(this).closest('.item').data('id');
      providers = providers.filter(function(p){ return p.id !== id; });
      render();
    });
    $(document).off('click', '.tool-edit').on('click', '.tool-edit', function(){
      // 无特别编辑态，直接在卡片内编辑
      layer.msg('已在卡片内编辑', {icon:1});
    });
    $(document).off('click', '.tool-test').on('click', '.tool-test', function(){
      var $card = $(this).closest('.item');
      var id = $card.data('id');
      layer.prompt({title:'输入测试收件人邮箱', formType:0}, function(val, idx){
        layer.close(idx);
        var body = { provider: id, to: val, subject: 'Mail Provider Test', text: 'This is a test mail.' };
        var loading = layer.msg('测试中...', {icon:16, shade:0.1, time:0});
        $.ajax({
          url: '/app/admin/mail/provider-test',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(body)
        }).done(function(res){
          layer.close(loading);
          layer.msg(res && res.code===0 ? '测试成功' : ('失败: ' + ((res && res.msg)||'')), {icon: res && res.code===0 ? 1 : 2});
        }).fail(function(){
          layer.close(loading);
          layer.msg('请求失败', {icon:2});
        });
      });
    });

    // 输入变更同步
    $(document).off('change', '.item-content input,.item-content select').on('change', '.item-content input,.item-content select', function(){
      syncFromDom();
    });
  }

  // 可用平台类型拖拽到左侧列表
  function initDragAndDrop() {
    if ($.fn.draggable) {
      $('.available-type').draggable({
        connectToSortable: '#provider-list',
        helper: 'clone',
        revert: 'invalid',
        cursor: 'move',
        start: function(event, ui) {
          $(this).addClass('dragging');
        },
        stop: function(event, ui) {
          $(this).removeClass('dragging');
          // 若成功拖入左侧列表，则添加一条配置
          if (ui.helper.closest('#provider-list').length > 0) {
            var t = $(this).data('type');
            addProvider(t);
          }
        }
      });
    }
  }

  function syncFromDom() {
    var updated = [];
    $('#provider-list .item').each(function(){
      var id = $(this).data('id');
      var $c = $(this).find('.item-content');
      updated.push({
        id: id,
        name: $c.find('.ip-name').val().trim(),
        weight: parseInt($c.find('.ip-weight').val()||'1', 10) || 0,
        enabled: $c.find('.ip-enabled').is(':checked'),
        dsn: $c.find('.ip-dsn').val().trim(),
        type: $c.find('.ip-type').val(),
        host: $c.find('.ip-host').val().trim(),
        port: parseInt($c.find('.ip-port').val()||'0',10)||0,
        username: $c.find('.ip-username').val().trim(),
        password: $c.find('.ip-password').val(),
        encryption: $c.find('.ip-encryption').val()
      });
    });
    providers = updated;
  }

  function addProvider(type) {
    var p = { id: uid(), name: '新平台', type: type||'smtp', weight: 1, enabled: true, dsn: '' };
    providers.push(p);
    render();
  }



  $('#btn-save').on('click', function(){
    syncFromDom();
    strategy = $('#strategy').val();
    var idx = layer.msg('保存中...', {icon:16, shade:0.1, time:0});
    $.ajax({
      url: '/app/admin/mail/providers-save',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ strategy: strategy, providers: providers })
    }).done(function(res){
      layer.close(idx);
      if(res && res.code === 0) {
        layer.msg('保存成功', {icon:1});
      } else {
        layer.msg('保存失败：' + ((res && res.msg)||''), {icon:2});
      }
    }).fail(function(){
      layer.close(idx);
      layer.msg('请求失败', {icon:2});
    });
  });

  load();
});
</script>
</body>
</html>