<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>邮件设置</title>
  <link rel="stylesheet" href="/app/admin/component/layui/css/layui.css?v=2.8.12"/>
  <link rel="stylesheet" href="/app/admin/component/pear/css/pear.css"/>
  <link rel="stylesheet" href="/app/admin/admin/css/reset.css"/>
</head>
<body class="pear-container">
<div class="layui-card">
  <div class="layui-card-header">邮件设置</div>
  <div class="layui-card-body">
    <form class="layui-form" lay-filter="form-mail">
      <fieldset class="layui-elem-field">
        <legend>策略设置</legend>
        <div class="layui-field-box">
          <div class="layui-form-item">
            <label class="layui-form-label">选择策略</label>
            <div class="layui-input-inline">
              <select name="mail_strategy" lay-filter="mail_strategy">
                <option value="weighted">加权随机</option>
                <option value="rr">加权轮询</option>
              </select>
            </div>
            <div class="layui-form-mid">说明：仅影响平台选择策略。具体平台在“配置”页管理。</div>
          </div>
        </div>
      </fieldset>



      <fieldset class="layui-elem-field">
        <legend>邮件队列命名</legend>
        <div class="layui-field-box">
          <div class="layui-form-item">
            <label class="layui-form-label">Exchange</label>
            <div class="layui-input-inline">
              <input type="text" name="rabbitmq_mail_exchange" placeholder="mail_exchange" autocomplete="off" class="layui-input">
            </div>
            <label class="layui-form-label">RoutingKey</label>
            <div class="layui-input-inline">
              <input type="text" name="rabbitmq_mail_routing_key" placeholder="mail_send" autocomplete="off" class="layui-input">
            </div>
          </div>
          <div class="layui-form-item">
            <label class="layui-form-label">Queue</label>
            <div class="layui-input-inline">
              <input type="text" name="rabbitmq_mail_queue" placeholder="mail_queue" autocomplete="off" class="layui-input">
            </div>
          </div>
          <div class="layui-form-item">
            <label class="layui-form-label">DLX Exchange</label>
            <div class="layui-input-inline">
              <input type="text" name="rabbitmq_mail_dlx_exchange" placeholder="mail_dlx_exchange" autocomplete="off" class="layui-input">
            </div>
            <label class="layui-form-label">DLQ</label>
            <div class="layui-input-inline">
              <input type="text" name="rabbitmq_mail_dlx_queue" placeholder="mail_dlx_queue" autocomplete="off" class="layui-input">
            </div>
          </div>
          <div class="hint">说明：更改命名后请重启相关进程（MailWorker）以确保生效。</div>
        </div>
      </fieldset>

      <div class="layui-form-item">
        <div class="layui-input-block">
          <button class="layui-btn" lay-submit lay-filter="btn-save-all">保存设置</button>
          <button type="button" class="layui-btn layui-btn-primary" id="btn-reload">刷新统计</button>
        </div>
      </div>
    </form>

    <fieldset class="layui-elem-field">
      <legend>队列监控</legend>
      <div class="layui-field-box">
        <table class="layui-table">
          <colgroup>
            <col width="180"><col>
          </colgroup>
          <tbody id="queueTable">
            <tr><td>exchange</td><td>-</td></tr>
            <tr><td>routingKey</td><td>-</td></tr>
            <tr><td>queue</td><td>-</td></tr>
            <tr><td>queue_depth</td><td>-</td></tr>
            <tr><td>dlx</td><td>-</td></tr>
            <tr><td>dlq</td><td>-</td></tr>
            <tr><td>dlq_depth</td><td>-</td></tr>
          </tbody>
        </table>
        <div style="color:#888;" id="lastTime"></div>
      </div>
    </fieldset>
  </div>
</div>

<script src="/app/admin/component/layui/layui.js?v=2.8.12"></script>
<script src="/app/admin/component/pear/pear.js"></script>
<script src="/app/admin/admin/js/permission.js"></script>
<script>
layui.use(['form','layer'], function(){
  var form = layui.form, layer = layui.layer, $ = layui.$;

  function load(){
    // 加载策略
    $.get('/app/admin/mail/strategy-get', function(res){
      if(res && res.code === 0 && res.data){
        form.val('form-mail', { mail_strategy: res.data.mail_strategy || 'weighted' });
      } else {
        layer.msg((res && res.msg) || '加载策略失败', {icon:2});
      }
    }).fail(function(){
      layer.msg('请求失败', {icon:2});
    });

    // 加载队列命名
    $.get('/app/admin/mail/config', function(res){
      if(res && res.code === 0 && res.data){
        form.val('form-mail', res.data || {});
      } else {
        layer.msg((res && res.msg) || '加载队列配置失败', {icon:2});
      }
    }).fail(function(){
      layer.msg('请求失败', {icon:2});
    });

    reloadStats();
  }

  form.on('submit(btn-save-all)', function(obj){
    var data = obj.field || {};
    var bodyStrategy = { mail_strategy: data.mail_strategy || 'weighted' };
    var bodyQueue = {
      rabbitmq_mail_exchange: data.rabbitmq_mail_exchange || '',
      rabbitmq_mail_routing_key: data.rabbitmq_mail_routing_key || '',
      rabbitmq_mail_queue: data.rabbitmq_mail_queue || '',
      rabbitmq_mail_dlx_exchange: data.rabbitmq_mail_dlx_exchange || '',
      rabbitmq_mail_dlx_queue: data.rabbitmq_mail_dlx_queue || ''
    };
    var idx = layer.msg('保存中...', {icon:16, shade:0.1, time:0});
    var req1 = $.ajax({
      url: '/app/admin/mail/strategy-save',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(bodyStrategy)
    });
    var req2 = $.ajax({
      url: '/app/admin/mail/config-save',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(bodyQueue)
    });
    $.when(req1, req2).done(function(r1, r2){
      layer.close(idx);
      var ok1 = r1 && r1[0] && r1[0].code === 0;
      var ok2 = r2 && r2[0] && r2[0].code === 0;
      if (ok1 && ok2) {
        layer.msg('保存成功', {icon:1});
        reloadStats();
      } else {
        var msg1 = (r1 && r1[0] && r1[0].msg) || '';
        var msg2 = (r2 && r2[0] && r2[0].msg) || '';
        var msg = ['策略', '队列'].filter(function(_, i){ return [ok1, ok2][i] === false; }).join(' / ');
        layer.msg('部分失败：' + (msg1 || msg2 || msg), {icon:2});
      }
    }).fail(function(){
      layer.close(idx);
      layer.msg('请求失败', {icon:2});
    });
    return false;
  });

  $('#btn-reload').on('click', function(){ reloadStats(); });



  function reloadStats(){
    $.get('/app/admin/mail/queue-stats', function(d){
      if(d && d.data){
        var map = d.data;
        var el = document.getElementById('queueTable');
        el.innerHTML = '';
        [
          ['exchange', map.exchange],
          ['routingKey', map.routingKey],
          ['queue', map.queue],
          ['queue_depth', map.queue_depth],
          ['dlx', map.dlx],
          ['dlq', map.dlq],
          ['dlq_depth', map.dlq_depth],
        ].forEach(function(pair){
          var tr = document.createElement('tr');
          var td1 = document.createElement('td'); td1.textContent = pair[0];
          var td2 = document.createElement('td'); td2.textContent = (pair[1]===undefined||pair[1]===null)?'-':String(pair[1]);
          tr.appendChild(td1); tr.appendChild(td2);
          el.appendChild(tr);
        });
        document.getElementById('lastTime').textContent = 'Last update: ' + new Date().toLocaleString();
      }
    });
  }

  load();
});
</script>
</body>
</html>