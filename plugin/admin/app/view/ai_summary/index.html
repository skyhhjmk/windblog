<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
    <title>AI摘要管理</title>
    <link rel="stylesheet" href="/app/admin/component/layui/css/layui.css?v=2.8.12"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .config-field {
            margin-bottom: 1rem;
        }

        .provider-card {
            border: 2px solid #e5e7eb;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
            background: white;
        }

        .provider-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.1);
        }

        .provider-card.active {
            border-color: #10b981;
            background-color: #d1fae5;
        }

        /* 统计表格行hover效果 */
        #statsTable tr {
            transition: background-color 0.2s;
        }

        #statsTable tr:hover {
            background-color: #f9fafb;
        }
    </style>
</head>
<body class="bg-gray-50">
<div class="max-w-7xl mx-auto p-6">
    <div class="bg-white rounded-lg shadow-md">
        <div class="border-b border-gray-200 px-6 py-4">
            <h1 class="text-2xl font-bold text-gray-800">AI 摘要管理</h1>
            <p class="text-sm text-gray-500 mt-1">管理AI提供者、配置模型参数、设置提示词</p>
        </div>
        <div class="p-6">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8">
                    <button class="tab-btn border-b-2 border-blue-500 py-4 px-1 text-sm font-medium text-blue-600"
                            data-tab="overview">概览
                    </button>
                    <button class="tab-btn border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300"
                            data-tab="config">API配置
                    </button>
                    <button class="tab-btn border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300"
                            data-tab="prompt">Prompt配置
                    </button>
                </nav>
            </div>
            <div class="mt-6">
                <!-- Tab 1: Overview -->
                <div class="tab-content" id="overview-tab">
                    <!-- 状态统计 -->
                    <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">状态统计</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        状态
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        数量
                                    </th>
                                </tr>
                                </thead>
                                <tbody id="statsTable" class="divide-y divide-gray-200">
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">无摘要 (none)</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">-</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 使用统计 -->
                    <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">使用统计</h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                                <div class="text-sm text-gray-600">总 Token 消耗</div>
                                <div class="text-2xl font-bold text-blue-600" id="total-tokens">0</div>
                            </div>
                            <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                                <div class="text-sm text-gray-600">成功生成</div>
                                <div class="text-2xl font-bold text-green-600" id="success-count">0</div>
                            </div>
                        </div>
                        <div class="space-y-2" id="provider-usage"></div>
                    </div>

                    <!-- 最近错误 -->
                    <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">最近错误</h3>
                        <div class="space-y-2" id="recent-errors">
                            <div class="text-sm text-gray-500">暂无错误记录</div>
                        </div>
                    </div>

                    <!-- 最近成功 -->
                    <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">最近成功生成</h3>
                        <div class="space-y-2" id="recent-success">
                            <div class="text-sm text-gray-500">暂无记录</div>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button type="button"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                                id="btn-refresh-stats">
                            <i class="fas fa-sync-alt mr-2"></i>刷新统计
                        </button>
                        <button class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition"
                                id="btn-reset-stuck"
                                type="button">
                            <i class="fas fa-redo mr-2"></i>重置卡住的任务
                        </button>
                    </div>
                </div>

                <!-- Tab 2: API Configuration -->
                <div class="tab-content hidden" id="config-tab">
                    <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">选择 AI 提供方</h3>
                        <div class="mb-4">
                            <label class="inline-flex items-center mr-6">
                                <input checked class="mr-2" name="selection_type" type="radio" value="provider">
                                <span class="text-sm font-medium text-gray-700">单个提供方</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input class="mr-2" name="selection_type" type="radio" value="group">
                                <span class="text-sm font-medium text-gray-700">轮询组</span>
                            </label>
                        </div>

                        <!-- 单个提供方列表 -->
                        <div id="providersContainer" class="space-y-4">
                            <div class="text-gray-500">加载中...</div>
                        </div>

                        <!-- 轮询组列表 -->
                        <div class="space-y-4 hidden" id="pollingGroupsContainer">
                            <div class="text-gray-500">加载中...</div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg border border-gray-200 p-6" id="providerConfigSection"
                         style="display:none;">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">提供者配置 <span id="currentProviderName"
                                                                                              class="text-sm text-gray-500"></span>
                        </h3>
                        <form id="providerConfigForm" class="space-y-4">
                            <!-- 动态生成配置字段 -->
                        </form>
                        <div class="mt-6 flex gap-3">
                            <button type="button"
                                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                                    id="btn-save-provider-config">保存配置
                            </button>
                            <button type="button"
                                    class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
                                    id="btn-fetch-models" style="display:none;">获取模型列表
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tab 3: Prompt Configuration -->
                <div class="tab-content hidden" id="prompt-tab">
                    <div class="bg-white rounded-lg border border-gray-200 p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">摘要生成 Prompt</h3>
                        <form class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">默认 Prompt</label>
                                <textarea name="ai_summary_prompt" placeholder="请为以下内容生成一个简洁的摘要..."
                                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                          rows="6"></textarea>
                            </div>
                            <div>
                                <button type="button"
                                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                                        id="btn-save-prompt">保存 Prompt
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/app/admin/component/layui/layui.js?v=2.8.12"></script>
<script>
    layui.use(['layer'], function () {
        var layer = layui.layer, $ = layui.$;

        // Tab switching
        $('.tab-btn').on('click', function () {
            var tab = $(this).data('tab');
            $('.tab-btn').removeClass('border-blue-500 text-blue-600').addClass('border-transparent text-gray-500');
            $(this).removeClass('border-transparent text-gray-500').addClass('border-blue-500 text-blue-600');
            $('.tab-content').addClass('hidden');
            $('#' + tab + '-tab').removeClass('hidden');
        });

        var currentProvider = null;
        var providerConfig = {};
        var currentSelection = '';
        var selectionType = 'provider'; // 'provider' or 'group'

        // Load stats
        function loadStats() {
            $.get('/app/admin/ai/summary/stats', function (res) {
                if (res && res.code === 0 && res.data) {
                    var data = res.data;
                    var counters = data.counters || {};

                    // 更新状态统计表格
                    var tbody = $('#statsTable');
                    tbody.html('');
                    [
                        ['无摘要 (none)', counters.none || 0, 'gray'],
                        ['已生成 (done)', counters.done || 0, 'green'],
                        ['失败 (failed)', counters.failed || 0, 'red'],
                        ['刷新中 (refreshing)', counters.refreshing || 0, 'blue'],
                        ['已固化 (persisted)', counters.persisted || 0, 'purple']
                    ].forEach(function (item) {
                        var colorClass = 'text-' + item[2] + '-600';
                        tbody.append('<tr><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">' + item[0] + '</td><td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ' + colorClass + '">' + item[1] + '</td></tr>');
                    });

                    // 更新使用统计
                    $('#total-tokens').text((data.total_tokens || 0).toLocaleString());
                    $('#success-count').text(counters.done || 0);

                    // 更新提供者使用情况
                    var providerUsage = data.provider_usage || {};
                    var providerDiv = $('#provider-usage');
                    providerDiv.html('');
                    if (Object.keys(providerUsage).length > 0) {
                        providerDiv.append('<h4 class="text-sm font-medium text-gray-700 mb-2">提供者使用情况</h4>');
                        Object.keys(providerUsage).forEach(function (provider) {
                            var usage = providerUsage[provider];
                            providerDiv.append('<div class="flex justify-between items-center p-2 bg-gray-50 rounded"><span class="text-sm text-gray-700">' + provider + '</span><span class="text-sm text-gray-600">调用: ' + usage.count + ' 次 | Tokens: ' + usage.tokens.toLocaleString() + '</span></div>');
                        });
                    } else {
                        providerDiv.append('<div class="text-sm text-gray-500">暂无使用记录</div>');
                    }

                    // 更新最近错误
                    var recentErrors = data.recent_errors || [];
                    var errorsDiv = $('#recent-errors');
                    errorsDiv.html('');
                    if (recentErrors.length > 0) {
                        recentErrors.forEach(function (err) {
                            errorsDiv.append('<div class="p-3 bg-red-50 border border-red-200 rounded-lg"><div class="flex justify-between items-start mb-1"><span class="text-sm font-medium text-red-800">文章 ID: ' + err.post_id + '</span><span class="text-xs text-red-600">' + err.failed_at + '</span></div><div class="text-sm text-red-700"><strong>提供者:</strong> ' + err.provider + '</div><div class="text-sm text-red-600 mt-1">' + err.error + '</div></div>');
                        });
                    } else {
                        errorsDiv.append('<div class="text-sm text-gray-500">暂无错误记录</div>');
                    }

                    // 更新最近成功
                    var recentSuccess = data.recent_success || [];
                    var successDiv = $('#recent-success');
                    successDiv.html('');
                    if (recentSuccess.length > 0) {
                        recentSuccess.forEach(function (succ) {
                            successDiv.append('<div class="p-3 bg-green-50 border border-green-200 rounded-lg"><div class="flex justify-between items-start mb-1"><span class="text-sm font-medium text-green-800">文章 ID: ' + succ.post_id + '</span><span class="text-xs text-green-600">' + succ.generated_at + '</span></div><div class="text-sm text-green-700"><strong>提供者:</strong> ' + succ.provider + ' | <strong>模型:</strong> ' + succ.model + '</div><div class="text-sm text-green-600 mt-1">Tokens: ' + succ.tokens + '</div></div>');
                        });
                    } else {
                        successDiv.append('<div class="text-sm text-gray-500">暂无记录</div>');
                    }
                }
            });
        }

        // 切换选择类型
        $('input[name="selection_type"]').on('change', function () {
            selectionType = $(this).val();
            if (selectionType === 'provider') {
                $('#providersContainer').removeClass('hidden');
                $('#pollingGroupsContainer').addClass('hidden');
                loadProviders();
            } else {
                $('#providersContainer').addClass('hidden');
                $('#pollingGroupsContainer').removeClass('hidden');
                loadPollingGroups();
            }
        });

        // Load current selection
        function loadCurrentSelection() {
            $.get('/app/admin/ai/selection/get', function (res) {
                if (res && res.code === 0 && res.data) {
                    currentSelection = res.data.selection || '';
                }
            });
        }

        // Load providers
        function loadProviders() {
            $.get('/app/admin/ai/providers/list', function (res) {
                if (res && res.code === 0 && res.data) {
                    var available = res.data || [];
                    var container = $('#providersContainer');
                    container.html('');

                    if (available.length === 0) {
                        container.html('<div class="text-gray-500">暂无可用提供方，请先到<a href="/app/admin/ai/providers" class="text-blue-600 hover:underline">提供方管理</a>页面创建提供方</div>');
                        return;
                    }

                    available.forEach(function (provider) {
                        var isActive = currentSelection === 'provider:' + provider.id;
                        var card = $('<div class="provider-card' + (isActive ? ' active' : '') + '"></div>');
                        card.append('<h3 class="text-lg font-semibold text-gray-800">' + provider.name + ' <span class="text-xs text-gray-500 font-normal">(' + provider.id + ')</span></h3>');
                        card.append('<p class="text-sm text-gray-600 mt-2">类型: ' + provider.type + '</p>');
                        if (provider.template) {
                            card.append('<p class="text-sm text-gray-600">模板: ' + provider.template + '</p>');
                        }
                        card.append('<p class="text-sm text-gray-600">状态: ' + (provider.enabled ? '<span class="text-green-600">已启用</span>' : '<span class="text-red-600">已禁用</span>') + '</p>');

                        var btnGroup = $('<div class="mt-4 flex gap-2"></div>');
                        var btnSelect = $('<button type="button" class="px-4 py-2 rounded-lg text-sm font-medium transition ' +
                            (isActive ? 'bg-green-100 text-green-800 cursor-not-allowed' : (provider.enabled ? 'bg-blue-600 text-white hover:bg-blue-700' : 'bg-gray-400 text-gray-200 cursor-not-allowed')) + '">' +
                            (isActive ? '当前选择' : '选择此提供方') + '</button>');
                        if (isActive || !provider.enabled) {
                            btnSelect.attr('disabled', true);
                        }
                        btnSelect.on('click', function () {
                            selectProvider(provider.id);
                        });
                        btnGroup.append(btnSelect);

                        var btnConfig = $('<button type="button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg text-sm font-medium hover:bg-gray-300 transition">查看配置</button>');
                        btnConfig.on('click', function () {
                            loadProviderConfig(provider.id);
                        });
                        btnGroup.append(btnConfig);
                        card.append(btnGroup);

                        container.append(card);
                    });
                }
            });
        }

        // Load polling groups
        function loadPollingGroups() {
            $.get('/app/admin/ai/polling-groups/list', function (res) {
                if (res && res.code === 0 && res.data) {
                    var groups = res.data || [];
                    var container = $('#pollingGroupsContainer');
                    container.html('');

                    if (groups.length === 0) {
                        container.html('<div class="text-gray-500">暂无轮询组，请先创建轮询组</div>');
                        return;
                    }

                    groups.forEach(function (group) {
                        var isActive = currentSelection === 'group:' + group.id;
                        var card = $('<div class="provider-card' + (isActive ? ' active' : '') + '"></div>');
                        card.append('<h3 class="text-lg font-semibold text-gray-800">' + group.name + ' <span class="text-xs text-gray-500 font-normal">(ID: ' + group.id + ')</span></h3>');
                        if (group.description) {
                            card.append('<p class="text-sm text-gray-600 mt-2">' + group.description + '</p>');
                        }
                        card.append('<p class="text-sm text-gray-600">策略: ' + (group.strategy === 'polling' ? '轮询' : '故障转移') + '</p>');
                        card.append('<p class="text-sm text-gray-600">状态: ' + (group.enabled ? '<span class="text-green-600">已启用</span>' : '<span class="text-red-600">已禁用</span>') + '</p>');
                        card.append('<p class="text-sm text-gray-600">提供方数量: ' + (group.providers ? group.providers.length : 0) + '</p>');

                        var btnGroup = $('<div class="mt-4 flex gap-2"></div>');
                        var btnSelect = $('<button type="button" class="px-4 py-2 rounded-lg text-sm font-medium transition ' +
                            (isActive ? 'bg-green-100 text-green-800 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700') + '">' +
                            (isActive ? '当前选择' : '选择此组') + '</button>');
                        if (isActive) {
                            btnSelect.attr('disabled', true);
                        }
                        btnSelect.on('click', function () {
                            selectGroup(group.id);
                        });
                        btnGroup.append(btnSelect);
                        card.append(btnGroup);

                        container.append(card);
                    });
                }
            });
        }

        // Select provider
        function selectProvider(providerId) {
            $.ajax({
                url: '/app/admin/ai/selection/set',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({selection: 'provider:' + providerId}),
                success: function (res) {
                    if (res && res.code === 0) {
                        layer.msg('设置成功', {icon: 1});
                        currentSelection = 'provider:' + providerId;
                        loadProviders();
                    } else {
                        layer.msg(res.msg || '设置失败', {icon: 2});
                    }
                }
            });
        }

        // Select polling group
        function selectGroup(groupId) {
            $.ajax({
                url: '/app/admin/ai/selection/set',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({selection: 'group:' + groupId}),
                success: function (res) {
                    if (res && res.code === 0) {
                        layer.msg('设置成功', {icon: 1});
                        currentSelection = 'group:' + groupId;
                        loadPollingGroups();
                    } else {
                        layer.msg(res.msg || '设置失败', {icon: 2});
                    }
                }
            });
        }

        // Load provider config
        function loadProviderConfig(providerId) {
            currentProvider = providerId;
            $('#currentProviderName').text('(' + providerId + ')');

            $.get('/app/admin/ai/providers/detail', {id: providerId}, function (res) {
                if (res && res.code === 0 && res.data) {
                    var provider = res.data;
                    providerConfig = provider.config || {};

                    var formEl = $('#providerConfigForm');
                    formEl.html('');

                    // 显示提供方基本信息
                    var infoDiv = $('<div class="mb-4 p-4 bg-gray-50 rounded-lg"></div>');
                    infoDiv.append('<p class="text-sm text-gray-600"><strong>名称:</strong> ' + provider.name + '</p>');
                    infoDiv.append('<p class="text-sm text-gray-600"><strong>ID:</strong> ' + provider.id + '</p>');
                    infoDiv.append('<p class="text-sm text-gray-600"><strong>类型:</strong> ' + provider.type + '</p>');
                    if (provider.template) {
                        infoDiv.append('<p class="text-sm text-gray-600"><strong>模板:</strong> ' + provider.template + '</p>');
                    }
                    infoDiv.append('<p class="text-sm text-gray-600"><strong>状态:</strong> ' + (provider.enabled ? '<span class="text-green-600">已启用</span>' : '<span class="text-red-600">已禁用</span>') + '</p>');
                    infoDiv.append('<p class="text-sm text-gray-500 mt-2">此页面仅用于查看配置，请到<a href="/app/admin/ai/providers" class="text-blue-600 hover:underline">提供方管理</a>页面进行编辑</p>');
                    formEl.append(infoDiv);

                    // 显示配置信息（JSON格式）
                    if (Object.keys(providerConfig).length > 0) {
                        var configDiv = $('<div class="config-field"></div>');
                        var label = $('<label class="block text-sm font-medium text-gray-700 mb-2">配置信息</label>');
                        configDiv.append(label);

                        var configTable = $('<div class="border border-gray-300 rounded-lg overflow-hidden"></div>');
                        var table = $('<table class="min-w-full divide-y divide-gray-200"></table>');
                        var tbody = $('<tbody class="bg-white divide-y divide-gray-200"></tbody>');

                        Object.keys(providerConfig).forEach(function (key) {
                            var value = providerConfig[key];
                            var displayValue = value;

                            // 隐藏密码类字段
                            if (key.toLowerCase().includes('key') || key.toLowerCase().includes('secret') || key.toLowerCase().includes('password') || key.toLowerCase().includes('token')) {
                                displayValue = '********';
                            } else if (typeof value === 'object') {
                                displayValue = JSON.stringify(value);
                            }

                            var row = $('<tr></tr>');
                            row.append('<td class="px-6 py-3 text-sm font-medium text-gray-700 bg-gray-50">' + key + '</td>');
                            row.append('<td class="px-6 py-3 text-sm text-gray-900">' + displayValue + '</td>');
                            tbody.append(row);
                        });

                        table.append(tbody);
                        configTable.append(table);
                        configDiv.append(configTable);
                        formEl.append(configDiv);
                    } else {
                        formEl.append('<p class="text-sm text-gray-500">暂无配置信息</p>');
                    }

                    // 隐藏保存和获取模型按钮（只读模式）
                    $('#btn-save-provider-config').hide();
                    $('#btn-fetch-models').hide();

                    $('#providerConfigSection').show();
                }
            });
        }

        // Fetch models
        $('#btn-fetch-models').on('click', function () {
            if (!currentProvider) return;

            var formData = {};
            $('#providerConfigForm').find('input, select, textarea').each(function () {
                var name = $(this).attr('name');
                var val = $(this).val();
                if (name) {
                    formData[name] = val;
                }
            });

            var idx = layer.msg('获取模型列表中...', {icon: 16, shade: 0.1, time: 0});
            $.ajax({
                url: '/app/admin/ai/providers/fetch-models',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({provider: currentProvider, config: formData}),
                success: function (res) {
                    layer.close(idx);
                    if (res && res.code === 0 && res.data) {
                        var models = res.data;
                        var fieldKey = $('#btn-fetch-models').data('field-key');
                        var select = $('#providerConfigForm').find('select[name="' + fieldKey + '"]');
                        select.html('');
                        models.forEach(function (model) {
                            select.append('<option value="' + model.id + '">' + model.id + '</option>');
                        });
                        form.render('select');
                        layer.msg('获取成功，共 ' + models.length + ' 个模型', {icon: 1});
                    } else {
                        layer.msg(res.msg || '获取失败', {icon: 2});
                    }
                },
                error: function () {
                    layer.close(idx);
                    layer.msg('请求失败', {icon: 2});
                }
            });
        });

        // Refresh stats button
        $('#btn-refresh-stats').on('click', function () {
            loadStats();
        });

        // Reset stuck tasks button
        $('#btn-reset-stuck').on('click', function () {
            layer.confirm('确定要重置所有超过3分钟的卡住任务吗？', {
                icon: 3,
                title: '确认操作'
            }, function (index) {
                var idx = layer.msg('处理中...', {icon: 16, shade: 0.1, time: 0});
                $.ajax({
                    url: '/app/admin/ai/summary/reset-all-stuck',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({}),
                    success: function (res) {
                        layer.close(idx);
                        layer.close(index);
                        if (res && res.code === 0) {
                            layer.msg(res.msg || '重置成功', {icon: 1});
                            // 刷新统计
                            loadStats();
                        } else {
                            layer.msg(res.msg || '重置失败', {icon: 2});
                        }
                    },
                    error: function () {
                        layer.close(idx);
                        layer.msg('请求失败', {icon: 2});
                    }
                });
            });
        });

        // Load prompt
        function loadPrompt() {
            $.get('/app/admin/ai/summary/prompt', function (res) {
                if (res && res.code === 0 && res.data) {
                    $('textarea[name="ai_summary_prompt"]').val(res.data.prompt || '');
                }
            });
        }

        // Save prompt button
        $('#btn-save-prompt').on('click', function () {
            var prompt = $('textarea[name="ai_summary_prompt"]').val();
            if (!prompt) {
                layer.msg('Prompt不能为空', {icon: 2});
                return;
            }
            $.ajax({
                url: '/app/admin/ai/summary/prompt-save',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({prompt: prompt}),
                success: function (res) {
                    if (res && res.code === 0) {
                        layer.msg('保存成功', {icon: 1});
                    } else {
                        layer.msg(res.msg || '保存失败', {icon: 2});
                    }
                }
            });
        });

        // Initial load
        loadStats();
        loadCurrentSelection();
        loadProviders();
        loadPrompt();
    });
</script>
</body>
</html>
