<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <title>Webman Admin 安装</title>
    <link rel="stylesheet" href="/app/admin/component/pear/css/pear.css" />
    <link rel="stylesheet" href="/app/admin/admin/css/reset.css" />
</head>
<body class="pear-container">
<div class="layui-row layui-col-space10">
    <div class="layui-col-md12">
        <div class="layui-card">
            <div class="layui-card">
                <div class="layui-card-body" style="padding-top: 40px;">
                    <h1 style="text-align:center;margin: 20px 0 40px">Webman Admin 安装</h1>

                    <!-- 环境依赖检查 -->
                    <div class="layui-card" style="max-width: 860px;margin: 0 auto 20px;">
                        <div class="layui-card-header">环境依赖检查</div>
                        <div class="layui-card-body">
                            <div id="dep-check">
                                <div style="margin-bottom:10px;">
                                    <button type="button" class="pear-btn pear-btn-primary" id="dep-reload">重新检测</button>
                                </div>
                                <ul id="dep-list" class="layui-timeline" style="padding-left:10px;"></ul>
                                <div id="dep-tip" class="layui-text" style="margin-top:8px;color:#ff4d4f;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="layui-carousel" id="stepForm" lay-filter="stepForm" style="margin: 0 auto;">
                        <div carousel-item>
                            <div>
                                <form class="layui-form" action="javascript:void(0);" style="margin: 0 auto;max-width: 460px;padding-top: 40px;">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">用户名</label>
                                        <div class="layui-input-block">
                                            <input type="text" placeholder="请填写入用户名" name="user" class="layui-input" lay-verify="required" required value="postgres" autocomplete="off"/>
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">密码</label>
                                        <div class="layui-input-block">
                                            <input type="password" placeholder="请填写入密码" name="password" class="layui-input" autocomplete="off"/>
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">数据库</label>
                                        <div class="layui-input-block">
                                            <input type="text" placeholder="请填写入数据库" name="database" class="layui-input" lay-verify="required" required value="windblog"/>
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">host</label>
                                        <div class="layui-input-block">
                                            <input type="text" placeholder="请填写入数据库host" name="host" class="layui-input" lay-verify="required" required value="127.0.0.1"/>
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">端口</label>
                                        <div class="layui-input-block">
                                            <input type="number" placeholder="请填写入数据库端口" name="port" class="layui-input" required value="5432" />
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">强制覆盖</label>
                                        <div class="layui-input-block">
                                            <input type="checkbox" name="overwrite" lay-skin="primary">
                                        </div>
                                    </div>

                                    <div class="layui-form-item">
                                        <div class="layui-input-block">
                                            <button type="button" class="pear-btn next">跳过此步骤</button>
                                            <button class="pear-btn pear-btn-primary" lay-submit lay-filter="formStep">
                                                &emsp;下一步&emsp;
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div>
                                <form class="layui-form"  action="javascript:void(0);" style="margin: 0 auto;max-width: 460px;padding-top: 40px;">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">用户名</label>
                                        <div class="layui-input-block">
                                            <input type="text" placeholder="请填写入用户名" name="username" class="layui-input" lay-verify="required" required />
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">密码</label>
                                        <div class="layui-input-block">
                                            <input type="password" placeholder="请填写入密码" name="password" class="layui-input"/>
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">确认密码</label>
                                        <div class="layui-input-block">
                                            <input type="password" placeholder="请填再次写入密码" name="password_confirm" class="layui-input"/>
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <div class="layui-input-block">
                                            <button type="button" class="pear-btn pre">上一步</button>
                                            <button class="pear-btn pear-btn-primary" lay-submit lay-filter="formStep2">
                                                &emsp;提交&emsp;
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div>
                                <div style="text-align: center;margin-top: 90px;">
                                    <i class="layui-icon layui-circle pear-back" style="color: white;font-size:30px;font-weight:bold;background: #52C41A;padding: 20px;line-height: 80px;">&#xe605;</i>
                                    <div style="font-size: 24px;color: #333;font-weight: 500;margin-top: 30px;">
                                        安装成功
                                    </div>
                                    <div style="font-size: 14px;color: #666;margin-top: 20px;">需要重启才能生效</div>
                                </div>
                                <div style="text-align: center;margin-top: 50px;">
                                    <button class="pear-btn pear-btn-primary finish">进入后台</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    var color = localStorage.getItem("theme-color-color");
    var second = localStorage.getItem("theme-color-second");
    if (!color || !second) {
        localStorage.setItem("theme-color-color", "#2d8cf0");
        localStorage.setItem("theme-color-second", "#ecf5ff");
    }
</script>

<script src="/app/admin/component/layui/layui.js?v=2.8.12"></script>
<script src="/app/admin/component/pear/pear.js"></script>

<script>
    layui.use(["form", "step","code","element", "popup"], function() {
        var $ = layui.$,
                form = layui.form,
                step = layui.step;

        layui.code();

        // 依赖检测渲染（平铺卡片样式）
        var __depMissing = [];
        function renderDeps(res) {
            __depMissing = Array.isArray(res.data?.missing) ? res.data.missing : [];
            var checks = res.data?.checks || [];

            // 分组：版本、必需扩展、可选扩展、关键函数、目录权限
            var requiredExts = ['pdo','pdo_pgsql','pgsql','openssl','json','mbstring','curl','fileinfo','gd','xmlreader','dom','libxml'];
            var optionalExts = (res.data && Array.isArray(res.data.optional_exts)) ? res.data.optional_exts : ['redis'];
            var fnNames = ['proc_open','exec'];

            var groups = {
                '版本': [],
                '必需扩展': [],
                '可选扩展': [],
                '关键函数': [],
                '目录权限': []
            };

            for (var i = 0; i < checks.length; i++) {
                var c = checks[i], name = c.name;
                if (name.indexOf('php>=') === 0) {
                    groups['版本'].push(c);
                } else if (requiredExts.indexOf(name) >= 0) {
                    groups['必需扩展'].push(c);
                } else if (optionalExts.indexOf(name) >= 0) {
                    groups['可选扩展'].push(c);
                } else if (fnNames.indexOf(name) >= 0) {
                    groups['关键函数'].push(c);
                } else if (name.indexOf('writable') >= 0) {
                    groups['目录权限'].push(c);
                } else {
                    groups['必需扩展'].push(c);
                }
            }

            function tileCard(it) {
                var ok = !!it.ok;
                var bg = ok ? '#52C41A' : '#ff4d4f';
                var bgSoft = ok ? '#f6ffed' : '#fff2f0';
                var msg = it.message ? (' - ' + it.message) : '';
                return (
                    '<div class="layui-col-xs12 layui-col-sm6 layui-col-md4">' +
                        '<div class="layui-card" style="border: 1px solid '+bg+'; background: '+bgSoft+';">' +
                            '<div class="layui-card-body" style="display:flex;align-items:center;gap:14px;">' +
                                '<span class="layui-badge" style="background:'+bg+';color:#fff;min-width:92px;height:28px;line-height:28px;font-size:14px;text-align:center;">' + (ok ? '通过' : '缺失') + '</span>' +
                                '<div>' +
                                    '<div style="font-weight:600;font-size:14px;margin-bottom:4px;color:#333;">'+ it.name +'</div>' +
                                    '<div style="color:'+bg+';font-size:13px;">'+ (ok ? '已满足' : '不可用') + msg +'</div>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>'
                );
            }

            function section(title, items) {
                var html = '';
                html += '<div class="layui-card" style="margin-bottom:12px;">';
                html += '<div class="layui-card-header">'+ title +'</div>';
                html += '<div class="layui-card-body">';
                html += '<div class="layui-row layui-col-space10">';
                for (var j = 0; j < items.length; j++) {
                    html += tileCard(items[j]);
                }
                html += '</div></div></div>';
                return html;
            }

            var html = '';
            html += section('版本', groups['版本']);
            html += section('必需扩展', groups['必需扩展']);
            html += section('可选扩展', groups['可选扩展']);
            html += section('关键函数', groups['关键函数']);
            html += section('目录权限', groups['目录权限']);

            $('#dep-list').html(html);

            // 额外提示 could not find driver 根因
            var tip = '';
            if (__depMissing.includes('pdo') || __depMissing.includes('pdo_pgsql') || __depMissing.includes('pgsql')) {
                tip = '检测到数据库驱动未启用（pdo/pdo_pgsql/pgsql），将导致“could not find driver”。请安装并启用后重试。';
            }
            $('#dep-tip').text(tip);
        }
        function loadDeps() {
            $.getJSON('/app/admin/install/step0', function(res) {
                renderDeps(res);
            });
        }
        $('#dep-reload').on('click', function(){ loadDeps(); });
        loadDeps();

        step.render({
            elem: "#stepForm",
            filter: "stepForm",
            width: "100%",
            stepWidth: "70%",
            height: "500px",
            stepItems: [{
                title: "填写数据库信息"
            }, {
                title: "填写管理员账户"
            }, {
                title: "完成"
            }]
        });

        form.on("submit(formStep)", function(data) {
            // 前置关键驱动校验（前端阻断）
            if (__depMissing && (__depMissing.includes('pdo') || __depMissing.includes('pdo_pgsql') || __depMissing.includes('pgsql'))) {
                layui.popup.failure('缺少数据库驱动（pdo/pdo_pgsql/pgsql）。请安装并启用后重试。');
                return false;
            }
            let loading = layer.load();
            $.ajax({
                url: "/app/admin/install/step1",
                type: "POST",
                dataType: "json",
                data: data.field,
                success: function (res) {
                    if (res.code) {
                        return layui.popup.failure(res.msg);
                    }
                    layui.popup.success("操作成功", function () {
                        step.next("#stepForm");
                    });
                },
                complete: function () {
                    layer.close(loading);
                }
            })
            return false;
        });

        form.on("submit(formStep2)", function(data) {
            let loading = layer.load();
            $.ajax({
                url: "/app/admin/install/step2",
                type: "POST",
                dataType: "json",
                data: data.field,
                success: function (res) {
                    if (res.code) {
                        return layui.popup.failure(res.msg);
                    }
                    //layui.popup.success("安装成功");
                    step.next("#stepForm");
                    layer.close(loading);
                },
                complete: function () {
                    layer.close(loading);
                }
            })
            return false;
        });

        $(".pre").click(function() {
            step.pre("#stepForm");
            return false;
        });

        $(".next").click(function() {
            step.next("#stepForm");
            return false;
        });

        $(".finish").click(function() {
            location.reload();
        });
    })
</script>
</body>
</html>
