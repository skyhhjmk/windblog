<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <title>WindBlog 安装向导</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        [x-cloak] { display: none !important; }
        .step-item { transition: all 0.3s ease; }
        .step-line { transition: all 0.3s ease; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-4xl mx-auto px-4 py-8">
        <!-- 头部 -->
        <div class="text-center mb-12">
            <h1 class="text-3xl font-light text-gray-800 mb-2">WindBlog 安装向导</h1>
            <p class="text-gray-500">请按照步骤完成系统安装</p>
        </div>

        <!-- 步骤指示器 -->
        <div class="mb-12">
            <div class="flex items-center justify-center">
                <div class="flex items-center w-full max-w-2xl">
                    <!-- 步骤 1 -->
                    <div class="flex-1 flex flex-col items-center">
                        <div id="step1-indicator" class="w-10 h-10 rounded-full flex items-center justify-center text-white bg-blue-500 mb-2">
                            <span>1</span>
                        </div>
                        <div class="text-sm text-gray-600">环境检查</div>
                    </div>
                    <div id="step1-line" class="flex-1 h-0.5 bg-gray-300 -mx-2 mb-6"></div>

                    <!-- 步骤 2 -->
                    <div class="flex-1 flex flex-col items-center">
                        <div id="step2-indicator" class="w-10 h-10 rounded-full flex items-center justify-center text-gray-400 bg-gray-200 mb-2">
                            <span>2</span>
                        </div>
                        <div class="text-sm text-gray-600">数据库配置</div>
                    </div>
                    <div id="step2-line" class="flex-1 h-0.5 bg-gray-300 -mx-2 mb-6"></div>

                    <!-- 步骤 3 -->
                    <div class="flex-1 flex flex-col items-center">
                        <div id="step3-indicator" class="w-10 h-10 rounded-full flex items-center justify-center text-gray-400 bg-gray-200 mb-2">
                            <span>3</span>
                        </div>
                        <div class="text-sm text-gray-600">管理员账户</div>
                    </div>
                    <div id="step3-line" class="flex-1 h-0.5 bg-gray-300 -mx-2 mb-6"></div>

                    <!-- 步骤 4 -->
                    <div class="flex-1 flex flex-col items-center">
                        <div id="step4-indicator" class="w-10 h-10 rounded-full flex items-center justify-center text-gray-400 bg-gray-200 mb-2">
                            <span>4</span>
                        </div>
                        <div class="text-sm text-gray-600">完成</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 内容区域 -->
        <div class="bg-white rounded-lg shadow-sm">
            <!-- 步骤 1: 环境检查 -->
            <div id="step1-content" class="p-8">
                <h2 class="text-xl font-light text-gray-800 mb-6">环境依赖检查</h2>

                <div id="dep-loading" class="text-center py-12">
                    <div class="inline-block w-8 h-8 border-4 border-gray-200 border-t-blue-500 rounded-full animate-spin"></div>
                    <p class="text-gray-500 mt-4">正在检测环境...</p>
                </div>

                <div id="dep-results" class="hidden space-y-6">
                    <!-- 检查结果将动态插入这里 -->
                </div>

                <div id="dep-error" class="hidden">
                    <div class="bg-red-50 border border-red-200 rounded p-4 mb-6">
                        <p class="text-red-700" id="dep-error-message"></p>
                    </div>
                </div>

                <div id="dep-actions" class="hidden mt-8 flex justify-between items-center">
                    <button type="button" onclick="checkDependencies()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-50">
                        重新检测
                    </button>
                    <button type="button" id="step1-next" class="px-6 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        下一步
                    </button>
                </div>
            </div>

            <!-- 步骤 2: 数据库配置 -->
            <div id="step2-content" class="p-8 hidden">
                <h2 class="text-xl font-light text-gray-800 mb-6">数据库配置</h2>

                <form id="db-form" class="space-y-6">
                    <!-- 数据库类型 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">数据库类型</label>
                        <div class="grid grid-cols-3 gap-4">
                            <label id="db-pgsql-option" class="relative flex items-center p-4 border-2 border-gray-200 rounded cursor-pointer hover:border-blue-500">
                                <input type="radio" name="type" value="pgsql" class="mr-3" checked>
                                <div>
                                    <div class="font-medium text-gray-800">PostgreSQL</div>
                                    <div class="text-xs text-gray-500">推荐使用</div>
                                </div>
                            </label>
                            <label id="db-mysql-option" class="relative flex items-center p-4 border-2 border-gray-200 rounded cursor-pointer hover:border-blue-500">
                                <input type="radio" name="type" value="mysql" class="mr-3">
                                <div>
                                    <div class="font-medium text-gray-800">MySQL</div>
                                    <div class="text-xs text-gray-500">广泛使用</div>
                                </div>
                            </label>
                            <label id="db-sqlite-option" class="relative flex items-center p-4 border-2 border-gray-200 rounded cursor-pointer hover:border-blue-500">
                                <input type="radio" name="type" value="sqlite" class="mr-3">
                                <div>
                                    <div class="font-medium text-gray-800">SQLite</div>
                                    <div class="text-xs text-gray-500">轻量级</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- 数据库名称/路径 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span id="db-name-label">数据库名称</span>
                        </label>
                        <input type="text" name="database" id="db-database" value="windblog"
                               class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                               required>
                    </div>

                    <!-- 连接信息 (PostgreSQL/MySQL) -->
                    <div id="db-connection-fields">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">主机地址</label>
                                <input type="text" name="host" value="127.0.0.1"
                                       class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                       required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">端口</label>
                                <input type="number" name="port" id="db-port" value="5432"
                                       class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                       required>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">用户名</label>
                                <input type="text" name="user" id="db-user" value="postgres"
                                       class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                       required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">密码</label>
                                <input type="password" name="password"
                                       class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500">
                            </div>
                        </div>
                    </div>

                    <!-- 强制覆盖 -->
                    <div class="flex items-center">
                        <input type="checkbox" name="overwrite" id="db-overwrite" class="mr-2">
                        <label for="db-overwrite" class="text-sm text-gray-600">强制覆盖已存在的数据（谨慎使用）</label>
                    </div>
                </form>

                <div id="db-error" class="hidden mt-4">
                    <div class="bg-red-50 border border-red-200 rounded p-4">
                        <p class="text-red-700" id="db-error-message"></p>
                    </div>
                </div>

                <div class="mt-8 flex justify-between items-center">
                    <button type="button" id="step2-prev" class="px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-50">
                        上一步
                    </button>
                    <div class="flex gap-2">
                        <button type="button" id="step2-skip" class="px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-50">
                            跳过此步骤
                        </button>
                        <button type="button" id="step2-next" class="px-6 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            下一步
                        </button>
                    </div>
                </div>
            </div>

            <!-- 步骤 3: 管理员账户 -->
            <div id="step3-content" class="p-8 hidden">
                <h2 class="text-xl font-light text-gray-800 mb-6">创建管理员账户</h2>

                <form id="admin-form" class="space-y-6 max-w-md">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">用户名</label>
                        <input type="text" name="username"
                               class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                               required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">密码</label>
                        <input type="password" name="password"
                               class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                               required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">确认密码</label>
                        <input type="password" name="password_confirm"
                               class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                               required>
                    </div>
                </form>

                <div id="admin-error" class="hidden mt-4">
                    <div class="bg-red-50 border border-red-200 rounded p-4">
                        <p class="text-red-700" id="admin-error-message"></p>
                    </div>
                </div>

                <div class="mt-8 flex justify-between items-center">
                    <button type="button" id="step3-prev" class="px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-50">
                        上一步
                    </button>
                    <button type="button" id="step3-next" class="px-6 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        完成安装
                    </button>
                </div>
            </div>

            <!-- 步骤 4: 完成 -->
            <div id="step4-content" class="p-8 hidden text-center">
                <div class="py-12">
                    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <svg class="w-10 h-10 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-light text-gray-800 mb-2">安装成功</h2>
                    <p class="text-gray-500 mb-8">系统需要重启才能生效</p>
                    <button type="button" onclick="location.reload()" class="px-8 py-3 bg-blue-500 text-white rounded hover:bg-blue-600">
                        进入后台
                    </button>
                </div>
            </div>
        </div>

        <!-- 加载提示 -->
        <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 flex items-center space-x-4">
                <div class="w-6 h-6 border-4 border-gray-200 border-t-blue-500 rounded-full animate-spin"></div>
                <span class="text-gray-700">处理中，请稍候...</span>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let availableDrivers = {
            pgsql: false,
            mysql: false,
            sqlite: false
        };
        let depCheckData = null;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            checkInstallStatus();
            setupEventListeners();
            setupDatabaseTypeSwitch();
        });

        // 检查安装状态
        function checkInstallStatus() {
            fetch('/app/admin/install/status')
                .then(res => res.json())
                .then(data => {
                    // 如果 install_lock_exists 为 false，说明数据库已配置但管理员未创建
                    if (data.install_lock_exists === false && data.in_container === true) {
                        // 直接跳转到步骤3（管理员创建）
                        goToStep(3);
                    } else {
                        if (data.install_tmp_lock_exists === true) {
                            // 说明创建了数据表但是没创建管理员
                            goToStep(3);
                        }
                        // 否则从步骤1开始
                        checkDependencies();
                    }
                })
                .catch(err => {
                    // 如果状态检查失败，仍然从步骤1开始
                    checkDependencies();
                });
        }

        // 依赖检查
        function checkDependencies() {
            document.getElementById('dep-loading').classList.remove('hidden');
            document.getElementById('dep-results').classList.add('hidden');
            document.getElementById('dep-error').classList.add('hidden');
            document.getElementById('dep-actions').classList.add('hidden');

            fetch('/app/admin/install/step0')
                .then(res => res.json())
                .then(data => {
                    depCheckData = data;
                    renderDependencies(data);
                })
                .catch(err => {
                    document.getElementById('dep-loading').classList.add('hidden');
                    document.getElementById('dep-error').classList.remove('hidden');
                    document.getElementById('dep-error-message').textContent = '检测失败：' + err.message;
                    document.getElementById('dep-actions').classList.remove('hidden');
                });
        }

        // 渲染依赖检查结果
        function renderDependencies(data) {
            document.getElementById('dep-loading').classList.add('hidden');
            document.getElementById('dep-actions').classList.remove('hidden');

            const checks = data.data?.checks || [];
            const groups = {
                'version': { title: 'PHP 版本', items: [] },
                'required': { title: '必需扩展', items: [] },
                'database': { title: '数据库驱动（至少一个可用）', items: [] },
                'optional': { title: '可选扩展', items: [] },
                'functions': { title: '关键函数', items: [] },
                'permissions': { title: '目录权限', items: [] }
            };

            const dbDrivers = ['pdo_pgsql', 'pdo_mysql', 'pdo_sqlite'];
            const requiredExts = ['pdo', 'openssl', 'json', 'mbstring', 'curl', 'fileinfo', 'gd', 'xmlreader', 'dom', 'libxml'];
            const optionalExts = data.data?.optional_exts || ['redis'];
            const functions = ['proc_open', 'exec'];

            // 记录可用的数据库驱动
            availableDrivers.pgsql = false;
            availableDrivers.mysql = false;
            availableDrivers.sqlite = false;

            checks.forEach(check => {
                const name = check.name;
                if (name.startsWith('php>=')) {
                    groups.version.items.push(check);
                } else if (dbDrivers.includes(name)) {
                    groups.database.items.push(check);
                    if (check.ok) {
                        if (name === 'pdo_pgsql') availableDrivers.pgsql = true;
                        if (name === 'pdo_mysql') availableDrivers.mysql = true;
                        if (name === 'pdo_sqlite') availableDrivers.sqlite = true;
                    }
                } else if (requiredExts.includes(name)) {
                    groups.required.items.push(check);
                } else if (optionalExts.includes(name)) {
                    groups.optional.items.push(check);
                } else if (functions.includes(name)) {
                    groups.functions.items.push(check);
                } else if (name.includes('writable')) {
                    groups.permissions.items.push(check);
                }
            });

            let html = '';
            Object.values(groups).forEach(group => {
                if (group.items.length > 0) {
                    html += renderGroup(group.title, group.items);
                }
            });

            document.getElementById('dep-results').innerHTML = html;
            document.getElementById('dep-results').classList.remove('hidden');

            // 检查是否有致命错误
            const hasAnyDbDriver = availableDrivers.pgsql || availableDrivers.mysql || availableDrivers.sqlite;
            const hasPdo = checks.find(c => c.name === 'pdo')?.ok;

            if (!hasAnyDbDriver || !hasPdo) {
                document.getElementById('dep-error').classList.remove('hidden');
                let errorMsg = '';
                if (!hasPdo) {
                    errorMsg = '缺少 PDO 扩展，这是必需的数据库扩展。请安装并启用后重试。';
                } else {
                    errorMsg = '未检测到任何可用的数据库驱动（pdo_pgsql/pdo_mysql/pdo_sqlite）。请至少安装一个数据库驱动后重试。';
                }
                document.getElementById('dep-error-message').textContent = errorMsg;
                document.getElementById('step1-next').disabled = true;
                document.getElementById('step1-next').classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                document.getElementById('dep-error').classList.add('hidden');
                document.getElementById('step1-next').disabled = false;
                document.getElementById('step1-next').classList.remove('opacity-50', 'cursor-not-allowed');
            }

            // 更新数据库选项可用性
            updateDatabaseOptions();
        }

        // 渲染检查组
        function renderGroup(title, items) {
            let html = `<div><h3 class="text-sm font-medium text-gray-700 mb-3">${title}</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mb-6">`;

            items.forEach(item => {
                const ok = item.ok;
                const bgColor = ok ? 'bg-green-50' : 'bg-red-50';
                const borderColor = ok ? 'border-green-200' : 'border-red-200';
                const textColor = ok ? 'text-green-700' : 'text-red-700';
                const status = ok ? '[Y]' : '[N]';

                html += `
                    <div class="${bgColor} ${borderColor} border rounded p-3">
                        <div class="flex items-start">
                            <span class="${textColor} font-bold mr-2">${status}</span>
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-medium text-gray-800 truncate">${item.name}</div>
                                ${item.message ? `<div class="text-xs text-gray-500 mt-1">${item.message}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div></div>';
            return html;
        }

        // 更新数据库选项可用性
        function updateDatabaseOptions() {
            const options = [
                { id: 'db-pgsql-option', driver: 'pgsql', name: 'PostgreSQL' },
                { id: 'db-mysql-option', driver: 'mysql', name: 'MySQL' },
                { id: 'db-sqlite-option', driver: 'sqlite', name: 'SQLite' }
            ];

            let hasSelected = false;
            options.forEach(opt => {
                const element = document.getElementById(opt.id);
                const radio = element.querySelector('input[type="radio"]');

                if (!availableDrivers[opt.driver]) {
                    element.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-50');
                    element.classList.remove('hover:border-blue-500');
                    radio.disabled = true;

                    // 添加不可用提示
                    if (!element.querySelector('.unavailable-badge')) {
                        const badge = document.createElement('div');
                        badge.className = 'unavailable-badge absolute top-2 right-2 text-xs bg-red-100 text-red-600 px-2 py-1 rounded';
                        badge.textContent = '不可用';
                        element.appendChild(badge);
                    }
                } else {
                    element.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-50');
                    element.classList.add('hover:border-blue-500');
                    radio.disabled = false;

                    // 选择第一个可用的
                    if (!hasSelected) {
                        radio.checked = true;
                        hasSelected = true;
                        updateDatabaseFields(opt.driver);
                    }
                }
            });
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 步骤 1
            document.getElementById('step1-next').addEventListener('click', () => goToStep(2));

            // 步骤 2
            document.getElementById('step2-prev').addEventListener('click', () => goToStep(1));
            document.getElementById('step2-skip').addEventListener('click', () => goToStep(3));
            document.getElementById('step2-next').addEventListener('click', submitDatabase);

            // 步骤 3
            document.getElementById('step3-prev').addEventListener('click', () => goToStep(2));
            document.getElementById('step3-next').addEventListener('click', submitAdmin);
        }

        // 数据库类型切换
        function setupDatabaseTypeSwitch() {
            document.querySelectorAll('input[name="type"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    updateDatabaseFields(e.target.value);
                });
            });
        }

        // 更新数据库字段
        function updateDatabaseFields(type) {
            const connectionFields = document.getElementById('db-connection-fields');
            const dbNameLabel = document.getElementById('db-name-label');
            const dbDatabase = document.getElementById('db-database');
            const dbPort = document.getElementById('db-port');
            const dbUser = document.getElementById('db-user');

            if (type === 'sqlite') {
                connectionFields.classList.add('hidden');
                dbNameLabel.textContent = '数据库文件路径';
                dbDatabase.value = 'runtime/windblog.db';
                dbDatabase.placeholder = '例如：runtime/windblog.db';
            } else {
                connectionFields.classList.remove('hidden');
                dbNameLabel.textContent = '数据库名称';
                dbDatabase.value = 'windblog';
                dbDatabase.placeholder = '请输入数据库名称';

                if (type === 'mysql') {
                    dbPort.value = '3306';
                    dbUser.value = 'root';
                } else if (type === 'pgsql') {
                    dbPort.value = '5432';
                    dbUser.value = 'postgres';
                }
            }
        }

        // 切换步骤
        function goToStep(step) {
            // 隐藏当前步骤
            document.getElementById(`step${currentStep}-content`).classList.add('hidden');

            // 显示新步骤
            document.getElementById(`step${step}-content`).classList.remove('hidden');

            // 更新步骤指示器
            updateStepIndicator(step);

            currentStep = step;

            // 滚动到顶部
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // 更新步骤指示器
        function updateStepIndicator(step) {
            for (let i = 1; i <= 4; i++) {
                const indicator = document.getElementById(`step${i}-indicator`);
                const line = document.getElementById(`step${i}-line`);

                if (i < step) {
                    // 已完成
                    indicator.classList.remove('bg-gray-200', 'text-gray-400', 'bg-blue-500');
                    indicator.classList.add('bg-green-500', 'text-white');
                    if (line) line.classList.replace('bg-gray-300', 'bg-green-500');
                } else if (i === step) {
                    // 当前步骤
                    indicator.classList.remove('bg-gray-200', 'text-gray-400', 'bg-green-500');
                    indicator.classList.add('bg-blue-500', 'text-white');
                    if (line) line.classList.replace('bg-green-500', 'bg-gray-300');
                } else {
                    // 未完成
                    indicator.classList.remove('bg-blue-500', 'bg-green-500', 'text-white');
                    indicator.classList.add('bg-gray-200', 'text-gray-400');
                    if (line) line.classList.replace('bg-green-500', 'bg-gray-300');
                }
            }
        }

        // 提交数据库配置
        function submitDatabase() {
            const form = document.getElementById('db-form');
            const formData = new FormData(form);

            showLoading();
            hideError('db-error');

            fetch('/app/admin/install/step1', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                hideLoading();
                if (data.code === 0) {
                    document.getElementById('step2-next').disabled = true;
                    // goToStep(3);
                    showError('db-error', '安装已经成功，但是您的系统环境不支持热重载，请重启 WindBlog 后刷新本页面继续安装');
                } else {
                    showError('db-error', data.msg);
                }
            })
            .catch(err => {
                hideLoading();
                showError('db-error', '请求失败：' + err.message);
            });
        }

        // 提交管理员账户
        function submitAdmin() {
            const form = document.getElementById('admin-form');
            const formData = new FormData(form);

            // 验证密码
            const password = formData.get('password');
            const passwordConfirm = formData.get('password_confirm');

            if (password !== passwordConfirm) {
                showError('admin-error', '两次密码输入不一致');
                return;
            }

            showLoading();
            hideError('admin-error');

            fetch('/app/admin/install/step2', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                hideLoading();
                if (data.code === 0) {
                    goToStep(4);
                } else {
                    showError('admin-error', data.msg);
                }
            })
            .catch(err => {
                hideLoading();
                showError('admin-error', '请求失败：' + err.message);
            });
        }

        // 显示错误
        function showError(id, message) {
            const errorDiv = document.getElementById(id);
            const messageDiv = document.getElementById(id + '-message');
            messageDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        // 隐藏错误
        function hideError(id) {
            document.getElementById(id).classList.add('hidden');
        }

        // 显示加载
        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        // 隐藏加载
        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
    </script>
</body>
</html>
