<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>性能监控</title>
    <link rel="stylesheet" href="/app/admin/component/layui/css/layui.css">
    <link rel="stylesheet" href="/app/admin/component/pear/css/pear.css">
    <style>
        .chart-box { min-height: 360px; background: #fff; padding: 10px; }
        /* 更整洁的快照卡片布局 */
        .kv {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 12px;
        }
        .stat-card {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        }
        .stat-card .card-head {
            padding: 10px 12px;
            font-weight: 600;
            color: #333;
            background: #f7f7f8;
            border-bottom: 1px solid #eee;
        }
        .stat-card .card-body {
            padding: 10px 12px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px 12px;
        }
        .kv-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px dashed #f0f0f0;
            border-radius: 6px;
            padding: 6px 8px;
            background: #fff;
        }
        .kv-row .label { color: #666; }
        .kv-row .value { color: #111; font-weight: 500; }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            background: #edf2ff;
            color: #3b82f6;
            font-size: 12px;
            line-height: 16px;
        }
        /* 兼容历史 .kv .item，避免其他模块受影响 */
        .kv .item { display:none; }
    </style>
</head>
<body class="pear-container">
<div class="layui-card">
    <div class="layui-card-header">性能监控</div>
    <div class="layui-card-body">
        <div class="layui-tab layui-tab-brief" lay-filter="perf-tab">
            <ul class="layui-tab-title">
                <li class="layui-this">Redis状态</li>
                <li>OPcache状态</li>
                <li>分析图表</li>
            </ul>
            <div class="layui-tab-content">
                <!-- Redis -->
                <div class="layui-tab-item layui-show">
                    <div class="kv" id="redis-snapshot"></div>
                    <div id="redis-chart" class="chart-box"></div>
                </div>
                <!-- OPcache -->
                <div class="layui-tab-item">
                    <div class="kv" id="opcache-snapshot"></div>
                    <div id="opcache-chart" class="chart-box"></div>
                </div>
                <!-- 分析 -->
                <div class="layui-tab-item">
                    <div id="analysis-line" class="chart-box"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/app/admin/component/layui/layui.js?v=2.8.12"></script>
<script src="/app/admin/component/pear/pear.js"></script>
<script>
layui.config({
    base: '/app/admin/component/pear/module/'
}).extend({
    echarts: 'echarts'
});
layui.use(['jquery','element','echarts'], function(){
    var $ = layui.jquery, element = layui.element, echarts = layui.echarts;

    // 统一的键/值友好格式化
    function formatKey(k) {
        var map = {
            t: '时间',
            version: '版本',
            used_memory_mb: '内存(MB)',
            connected_clients: '连接数',
            instantaneous_ops_per_sec: '每秒操作',
            keys: '键数量',
            keys_method: '键统计方法',
            hits: '命中',
            misses: '未命中',
            memory_free_mb: '空闲内存(MB)',
            hit_rate: '命中率(%)'
        };
        return map[k] || k;
    }
    function formatVal(k, v) {
        if (v === null || v === undefined) return '-';
        if (typeof v === 'object') v = JSON.stringify(v);
        if (k === 'version') return '<span class="badge">' + v + '</span>';
        if (k === 'used_memory_mb' || k === 'memory_free_mb') return Number(v).toFixed(2);
        if (k === 'instantaneous_ops_per_sec') return v + ' ops/s';
        return v;
    }
    // 更美观的KV渲染（用于OPcache快照等）
    function renderKV(container, data) {
        var $c = $(container); $c.empty();
        var html = '<div class="stat-card"><div class="card-head">快照</div><div class="card-body">';
        if (!data) {
            html += '<div class="kv-row"><span class="label">状态</span><span class="value">暂无数据</span></div>';
            $c.html(html + '</div></div>');
            return;
        }
        var order = ['t','version','used_memory_mb','connected_clients','instantaneous_ops_per_sec','keys','keys_method','hits','misses','memory_free_mb','hit_rate'];
        var keys = Object.keys(data);
        order.concat(keys.filter(function(k){ return order.indexOf(k) < 0; })).forEach(function(k){
            var v = data[k];
            html += '<div class="kv-row"><span class="label">' + formatKey(k) + '</span><span class="value">' + formatVal(k, v) + '</span></div>';
        });
        html += '</div></div>';
        $c.html(html);
    }

    function buildLineOption(title, series, xData) {
        return {
            title: { text: title },
            tooltip: { trigger: 'axis' },
            legend: { data: series.map(function(s){return s.name;}) },
            xAxis: { type: 'category', data: xData },
            yAxis: { type: 'value' },
            series: series
        };
    }

    function loadRedis() {
        var base = '/app/admin/performance/redisStatus';
        $.when(
            $.get(base + '?conn=default'),
            $.get(base + '?conn=cache')
        ).done(function(rd, rc){
            var respD = rd[0], respC = rc[0];
            if (!respD || respD.code !== 0) respD = { data: { snapshot: null, series: [] } };
            if (!respC || respC.code !== 0) respC = { data: { snapshot: null, series: [] } };

            // 快照卡片化并列显示（default / cache）
            var $snap = $('#redis-snapshot'); $snap.empty();
            function buildSnapshotCard(title, data) {
                var inner = '<div class="stat-card"><div class="card-head">' + title + '</div><div class="card-body">';
                if (!data) {
                    inner += '<div class="kv-row"><span class="label">状态</span><span class="value">暂无数据</span></div>';
                } else {
                    var order = ['t','version','used_memory_mb','connected_clients','instantaneous_ops_per_sec','keys','keys_method'];
                    var keys = Object.keys(data);
                    order.concat(keys.filter(function(k){ return order.indexOf(k) < 0; })).forEach(function(k){
                        var v = data[k];
                        if (typeof v === 'object') v = JSON.stringify(v);
                        inner += '<div class="kv-row"><span class="label">' + formatKey(k) + '</span><span class="value">' + formatVal(k, v) + '</span></div>';
                    });
                }
                inner += '</div></div>';
                return inner;
            }
            $snap.html(
                buildSnapshotCard('default', respD.data.snapshot || null) +
                buildSnapshotCard('cache', respC.data.snapshot || null)
            );

            // 同图表叠加 default 与 cache 的内存/键数量
            var pd = (respD.data.series || []).map(function (it) { return { t: it.t, used: it.used_memory_mb, keys: it.keys }; });
            var pc = (respC.data.series || []).map(function (it) { return { t: it.t, used: it.used_memory_mb, keys: it.keys }; });
            var x = (pd.length ? pd : pc).map(function (p) { return p.t; });
            var s = [
                { name: 'default 内存(MB)', type: 'line', smooth: true, data: pd.map(function (p) { return p.used; }) },
                { name: 'cache 内存(MB)', type: 'line', smooth: true, data: pc.map(function (p) { return p.used; }) },
                { name: 'default 键数量', type: 'line', smooth: true, data: pd.map(function (p) { return p.keys; }) },
                { name: 'cache 键数量', type: 'line', smooth: true, data: pc.map(function (p) { return p.keys; }) }
            ];
            echarts.init(document.getElementById('redis-chart')).setOption(buildLineOption('Redis趋势（default vs cache）', s, x));
        });
    }

    function loadOpcache() {
        $.get('/app/admin/performance/opcacheStatus', function(resp){
            if (resp.code !== 0) return;
            renderKV('#opcache-snapshot', resp.data.snapshot || {});
            var points = (resp.data.series || []).map(function(it){ return { t: it.t, hits: it.hits, misses: it.misses, memory_free_mb: it.memory_free_mb }; });
            var x = points.map(function(p){ return p.t; });
            var s = [
                { name:'命中', type:'line', smooth:true, data: points.map(function(p){ return p.hits; }) },
                { name:'未命中', type:'line', smooth:true, data: points.map(function(p){ return p.misses; }) },
                { name:'空闲内存(MB)', type:'line', smooth:true, data: points.map(function(p){ return p.memory_free_mb; }) }
            ];
            echarts.init(document.getElementById('opcache-chart')).setOption(buildLineOption('OPcache趋势', s, x));
        });
    }

    function loadAnalysis() {
        $.get('/app/admin/performance/series', function(resp){
            if (resp.code !== 0) return;
            var r = resp.data.redis || [], o = resp.data.opcache || [];
            var x = r.map(function(it){ return it.t; });
            var s = [
                { name:'Redis内存(MB)', type:'line', smooth:true, data: r.map(function(it){ return it.used_memory_mb; }) },
                { name:'OPcache命中率(%)', type:'line', smooth:true, data: o.map(function(it){ return it.hit_rate; }) }
            ];
            echarts.init(document.getElementById('analysis-line')).setOption(buildLineOption('性能分析', s, x));
        });
    }

    loadRedis(); loadOpcache(); loadAnalysis();
    element.on('tab(perf-tab)', function(){ setTimeout(function(){ 
        echarts.init(document.getElementById('redis-chart')).resize();
        echarts.init(document.getElementById('opcache-chart')).resize();
        echarts.init(document.getElementById('analysis-line')).resize();
    }, 50); });
});
</script>
</body>
</html>