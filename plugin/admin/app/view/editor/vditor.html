<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>æ•°æ®åˆ†æ</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../component/pear/css/pear.css"/>
    <link rel="stylesheet" href="../../demos/css/console2.css"/>
</head>
<body class="pear-container">
    <script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.11.0/axios.min.js"
        integrity="sha512-h9644v03pHqrIHThkvXhB2PJ8zf5E9IyVnrSfZg8Yj8k4RsO4zldcQc4Bi9iVLUCCsqNY0b4WXVV4UB+wbWENA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="/assets/css/all.min.css">
<script src="/assets/js/highlight.min.js"></script>
<link rel="stylesheet" href="/assets/css/github-dark.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vditor/3.11.1/index.min.css"
      integrity="sha512-Tj6qPPqMhdET85Eu0Hy663goieFRcOde8i0J3DT8L+wb0sSDfgzPwoAYW63yijDXFzrzxOSvPuXfjHqL07hVcg=="
      crossorigin="anonymous" referrerpolicy="no-referrer"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vditor/3.11.1/index.min.js"
        integrity="sha512-oWE+EVJHubnxaqkZy5k5ZBs/TSNarmZyNhHevcfDIqhTza3rlwj1r5Vn8E+KiUPJMmCke08/W7HpN4qj/uHwmQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vditor/3.11.1/css/content-theme/light.min.css"
      integrity="sha512-o50pASvlcfHhtl2lTNfVkSBCgBSO2YeMZmRs1F7P6dD8m6XWWRr7nx9wbum75mBfMTeU8S+OQuIfkzLbLkk/Jw=="
      crossorigin="anonymous" referrerpolicy="no-referrer"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"
        integrity="sha512-LQNxIMR5rXv7o+b1l8+N1EZMfhG7iFZ9HhnbJkTp4zjNr5Wvst75AqUeFDxeRUa7l5vEDyUiAip//r+EFLLCyA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css"
      integrity="sha512-fHwaWebuwA7NSF5Qg/af4UeDx9XqUpYpOGgubo3yWu+b2IQR4UeQwbb42Ti7gVAjNtVoI/I9TEoYeu9omwcC6g=="
      crossorigin="anonymous" referrerpolicy="no-referrer"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.9.0/mermaid.min.js"
        integrity="sha512-OAr6bl1pt/FD0oVcuPzJ9VIMso+HQhHoodVI7mnDst19p8rNkNiraPLsDCYVhit3Mjd6B7AUHFsoDhq3dDeI7g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<div class="max-w-6xl mx-auto px-4 py-8 h-full">
    <!-- ç¼–è¾‘å™¨å®¹å™¨ -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        <!-- æ ‡é¢˜ -->
        <h1 id="page-title" class="text-2xl font-bold text-gray-800 mb-6">æ–‡ç« ç¼–è¾‘</h1>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="flex flex-wrap gap-4 mb-6">
            <div class="flex-1">
                <input type="text" id="post-title" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜">
            </div>
            <select id="post-status" class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="draft">è‰ç¨¿</option>
                <option value="published">å·²å‘å¸ƒ</option>
                <option value="archived">å·²å½’æ¡£</option>
            </select>
            <button id="media-selector-btn"
                    class="px-4 py-2 bg-purple-500 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50">
                é€‰æ‹©åª’ä½“
            </button>
            <button id="preview-btn"
                    class="px-4 py-2 bg-blue-500 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                é¢„è§ˆ
            </button>
            <button id="save-btn"
                    class="px-4 py-2 bg-green-500 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50">
                ä¿å­˜
            </button>
            <button id="clear-btn"
                    class="px-4 py-2 bg-red-500 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">
                æ¸…é™¤ç¼“å­˜
            </button>
        </div>

        <!-- ç¼–è¾‘å™¨åŒºåŸŸ -->
        <div id="vditor"></div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // çŠ¶æ€å˜é‡
        let vditor = null;
        let isVditorReady = false;
        let isContentLoaded = false; // æ ‡è®°å†…å®¹æ˜¯å¦å·²åŠ è½½
        
        // è·å–æ–‡ç« IDçš„é€»è¾‘
        // ä»URLè·¯å¾„ä¸­æå–IDï¼Œå…¼å®¹å¤šç§URLæ ¼å¼
        let pathSegments = window.location.pathname.split('/').filter(Boolean); // è¿‡æ»¤æ‰ç©ºå­—ç¬¦ä¸²
        let postId = 0;
        
        // æŸ¥æ‰¾ç¬¦åˆæ¡ä»¶çš„IDï¼ˆåœ¨vditoråé¢çš„æ•°å­—ï¼Œæ”¯æŒæ–°çš„è·¯ç”±ç»“æ„ï¼‰
        for (let i = 0; i < pathSegments.length; i++) {
            if (pathSegments[i] === 'vditor' && i + 1 < pathSegments.length) {
                const potentialId = pathSegments[i + 1];
                if (!isNaN(parseInt(potentialId))) {
                    postId = parseInt(potentialId);
                    break;
                }
            }
        }
        
        // å…¼å®¹æ€§å¤„ç†ï¼šå¦‚æœåœ¨vditoråé¢æ²¡æ‰¾åˆ°IDï¼Œä¹Ÿæ£€æŸ¥editoråé¢ï¼ˆä¸ºäº†å…¼å®¹æ—§çš„URLç»“æ„ï¼‰
        if (postId === 0) {
            for (let i = 0; i < pathSegments.length; i++) {
                if (pathSegments[i] === 'editor' && i + 1 < pathSegments.length) {
                    const potentialId = pathSegments[i + 1];
                    if (!isNaN(parseInt(potentialId))) {
                        postId = parseInt(potentialId);
                        break;
                    }
                }
            }
        }
        
        // å®‰å…¨æ€§æ£€æŸ¥ï¼šç¡®ä¿IDæ˜¯æœ‰æ•ˆçš„æ­£æ•´æ•°
        postId = postId > 0 ? postId : 0;
        
        // è·å–DOMå…ƒç´  - ä½¿ç”¨é˜²å¾¡æ€§ç¼–ç¨‹
        const postTitle = document.getElementById('post-title') || { value: '' };
        const postStatus = document.getElementById('post-status') || { value: 'draft' };
        const pageTitle = document.getElementById('page-title') || { textContent: 'æ–‡ç« ç¼–è¾‘' };
        let defaultContent = `# è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜

## ç« èŠ‚æ ‡é¢˜

è¯·åœ¨è¿™é‡Œè¾“å…¥æ–‡ç« å†…å®¹...

æ”¯æŒ Markdown è¯­æ³•ï¼š

- åˆ—è¡¨é¡¹
- åˆ—è¡¨é¡¹
- åˆ—è¡¨é¡¹

**ç²—ä½“æ–‡æœ¬** *æ–œä½“æ–‡æœ¬* [é“¾æ¥æ–‡æœ¬](https://example.com)

![å›¾ç‰‡æè¿°](https://example.com/image.jpg)

\`\`\`php
// ä»£ç ç¤ºä¾‹
function example() {
    return 'ä»£ç å—';
}
\`\`\``;

        // åˆå§‹åŒ– Vditor
        console.log('åˆå§‹åŒ–ç¼–è¾‘å™¨ï¼Œå½“å‰URL:', window.location.href);
        console.log('æå–çš„æ–‡ç« ID:', postId);
        
        try {
            vditor = new Vditor('vditor', {
            height: 'auto',
            minHeight: 500,
            counter: {
                enable: true,
            },
            // cdn: 'https://cdnjs.cloudflare.com/ajax/libs/vditor/3.11.1', // æ— æ³•ä½¿ç”¨cfå…¬å…±cdnï¼Œæ²¡æœ‰distç›®å½•
            mode: 'sv', // åˆ†å±
            toolbarConfig: {
                pin: true,
            },
            comment: {
                enable: false, // ä¸å¥½ç”¨
            },
            cache: {
                enable: true, // å¯ç”¨localStorageç¼“å­˜
                id: postId || 'new_post_' + Date.now(), // ä½¿ç”¨æ–‡ç« IDæˆ–ä¸´æ—¶IDä½œä¸ºç¼“å­˜é”®
                after: function(html) {
                    // ç¼“å­˜åçš„å›è°ƒå‡½æ•°ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ç¼“å­˜å¤„ç†é€»è¾‘
                    return html;
                }
            },
            preview: {
                markdown: {
                    sanitize: true,
                },
                hljs: {
                    enable: true,
                    defaultLang: 'bash',
                    style: 'github-dark',
                    lineNumber: true,
                }
            },
            upload: {
                accept: 'image/*',
                url: '/app/admin/editor/upload-image',
                fieldName: 'image',
                max: 50 * 1024 * 1024,
                filename(name) {
                    return name.replace(/\?|\\|\/|:|\||<|>|\*|\[|\]|\s+/g, '-')
                },
                linkToImgUrl: '/app/admin/editor/upload-image',
                handler(files) {
                    const data = new FormData()
                    data.append('image', files[0])

                    fetch('/app/admin/editor/upload-image', {
                        method: 'POST',
                        body: data,
                    }).then(response => response.json()).then(data => {
                        if (data.success === 1) {
                            vditor.insertValue(`![](${data.file.url})`)
                        } else {
                            alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ' + data.message)
                        }
                    }).catch(err => {
                        alert('ç½‘ç»œé”™è¯¯: ' + err)
                    })
                }
            },
            hint: {
                // emojiPath: 'https://cdn.jsdelivr.net/npm/vditor/dist/images/emoji',
                emoji: {
                    "+1": "ğŸ‘",
                    "-1": "ğŸ‘",
                    "heart": "â¤ï¸",
                    "smile": "ğŸ˜„",
                    "laughing": "ğŸ˜†",
                    "smirk": "ğŸ˜",
                    "expressionless": "ğŸ˜‘",
                    "tired_face": "ğŸ˜«",
                    "sleeping": "ğŸ˜´",
                    "flushed": "ğŸ˜³",
                    "scream": "ğŸ˜±",
                    "rage": "ğŸ˜¡",
                    "smiling_imp": "ğŸ˜ˆ",
                    "sunglasses": "ğŸ˜",
                    "thumbsup": "ğŸ‘",
                    "thumbsdown": "ğŸ‘",
                    "ok_hand": "ğŸ‘Œ",
                    "punch": "ğŸ‘Š",
                    "wave": "ğŸ‘‹",
                    "clap": "ğŸ‘",
                    "open_hands": "ğŸ‘",
                    "pray": "ğŸ™",
                    "eyes": "ğŸ‘€",
                    "zzz": "ğŸ’¤",
                    "poop": "ğŸ’©",
                    "muscle": "ğŸ’ª",
                    "trumpet": "ğŸº",
                    "cake": "ğŸ°",
                    "coffee": "â˜•",
                    "bomb": "ğŸ’£",
                    "gem": "ğŸ’",
                    "ring": "ğŸ’",
                    "rocket": "ğŸš€",
                    "train": "ğŸš‹",
                    "bike": "ğŸš²",
                    "bus": "ğŸšŒ",
                    "airplane": "âœˆï¸",
                    "rocket2": "ğŸš€",
                    "moon": "ğŸŒ™",
                    "star2": "ğŸŒŸ",
                    "sunny": "â˜€ï¸",
                    "rainbow": "ğŸŒˆ",
                    "snowman": "â›„",
                    "zap": "âš¡",
                    "fire": "ğŸ”¥",
                    "ghost": "ğŸ‘»",
                    "alien": "ğŸ‘½",
                    "robot": "ğŸ¤–",
                    "skull": "ğŸ’€",
                    "heart_eyes": "ğŸ˜",
                    "kiss": "ğŸ˜˜",
                    "sweat": "ğŸ˜“",
                    "sob": "ğŸ˜­",
                    "joy": "ğŸ˜‚",
                    "tongue": "ğŸ˜›",
                    "v": "âœŒï¸",
                    "santa": "ğŸ…",
                    "christmas_tree": "ğŸ„",
                    "gift": "ğŸ",
                    "jack_o_lantern": "ğŸƒ",
                    "bamboo": "ğŸ",
                    "grapes": "ğŸ‡",
                    "watermelon": "ğŸ‰",
                    "ramen": "ğŸœ",
                    "soccer": "âš½",
                    "football": "ğŸˆ",
                    "basketball": "ğŸ€",
                    "dart": "ğŸ¯",
                    "slot_machine": "ğŸ°",
                    "8ball": "ğŸ±",
                    "game_die": "ğŸ²",
                    "spades": "â™ ï¸",
                    "clubs": "â™£ï¸",
                    "hearts": "â™¥ï¸",
                    "diamonds": "â™¦ï¸",
                    "clubhouse": "ğŸ›–",
                    "house": "ğŸ ",
                    "city_sunrise": "ğŸŒ‡",
                    "bridge_at_night": "ğŸŒ‰",
                    "ferris_wheel": "ğŸ¡",
                    "roller_coaster": "ğŸ¢",
                    "ship": "ğŸš¢",
                    "speedboat": "ğŸš¤",
                    "sailboat": "â›µ",
                    "anchor": "âš“",
                    "rocketship": "ğŸš€",
                    "flying_saucer": "ğŸ›¸",
                    "helicopter": "ğŸš",
                    "steam_locomotive": "ğŸš‚",
                    "car": "ğŸš—",
                    "taxi": "ğŸš•",
                    "busstop": "ğŸš",
                    "fuelpump": "â›½",
                    "rotating_light": "ğŸš¨",
                    "triangular_flag_on_post": "ğŸš©",
                    "crossed_flags": "ğŸŒ",
                    "waving_black_flag": "ğŸ´",
                    "waving_white_flag": "ğŸ³ï¸",
                    "rainbow-flag": "ğŸ³ï¸â€ğŸŒˆ",
                    "pirate_flag": "ğŸ´â€â˜ ï¸"
                }
            },
            // æ·»åŠ åˆå§‹åŒ–å®Œæˆå›è°ƒ - ç›´æ¥æ”¾åœ¨é¡¶å±‚é…ç½®ä¸­è€Œä¸æ˜¯åµŒå¥—å¯¹è±¡ä¸­
            after() {
                console.log('Vditoråˆå§‹åŒ–å®Œæˆï¼Œè®¾ç½®isVditorReadyä¸ºtrue');
                isVditorReady = true;
                loadPostContent();
            },
            // åˆå§‹åŒ–æ—¶ç›´æ¥è®¾ç½®é»˜è®¤å†…å®¹
            value: defaultContent
        });
        } catch (error) {
            console.error('Vditoråˆå§‹åŒ–å¤±è´¥:', error);
            // å³ä½¿åˆå§‹åŒ–å¤±è´¥ä¹Ÿå°è¯•è®¾ç½®isVditorReadyä¸ºtrueï¼Œä»¥ä¾¿ç»§ç»­æµç¨‹
            setTimeout(() => {
                isVditorReady = true;
                loadPostContent();
            }, 1000);
        }

        // æ–°å»ºæ–‡ç« æ—¶ï¼Œè®¾ç½®æ ‡é¢˜ä¸º"æœªå‘½å+æ—¶é—´æˆ³çŸ­å“ˆå¸Œ"
        if (!postId) {
            // ç”Ÿæˆæ—¶é—´æˆ³çŸ­å“ˆå¸Œï¼ˆåŸºäºå½“å‰æ—¶é—´æˆ³çš„ç®€å•å“ˆå¸Œï¼‰
            const timestamp = Date.now();
            // ç®€å•å“ˆå¸Œå‡½æ•°ï¼šå°†æ—¶é—´æˆ³è½¬ä¸º16è¿›åˆ¶å¹¶å–å6ä½
            const shortHash = timestamp.toString(16).slice(-6);
            postTitle.value = `æœªå‘½å${shortHash}`;
            pageTitle.textContent = 'æ–°å»ºæ–‡ç« ';
            // ç¡®ä¿æ–°å»ºæ–‡ç« æ—¶æ˜¾ç¤ºé¢„ç½®å†…å®¹
            if (vditor && typeof vditor.setValue === 'function') {
                // ä½¿ç”¨setTimeoutç¡®ä¿åœ¨Vditorå®Œå…¨åˆå§‹åŒ–åå†è®¾ç½®å†…å®¹
                setTimeout(() => {
                    vditor.setValue(defaultContent);
                }, 100);
            }
        } else {
            // å¤‡é€‰æ–¹æ¡ˆï¼šç¡®ä¿æ–‡ç« å†…å®¹è¢«åŠ è½½ï¼Œä¸ç®¡æ˜¯é€šè¿‡ä¸»å›è°ƒè¿˜æ˜¯æ‰‹åŠ¨è°ƒç”¨
            // æ·»åŠ é˜²æŠ–æ£€æŸ¥ï¼Œé¿å…é‡å¤åŠ è½½
            setTimeout(() => {
                console.log('å¤‡é€‰æ–¹æ¡ˆï¼šå°è¯•ç¡®ä¿å†…å®¹åŠ è½½ï¼ŒpostId:', postId, 'isVditorReady:', isVditorReady, 'isContentLoaded:', isContentLoaded);
                // åªæ£€æŸ¥å†…å®¹æ˜¯å¦å·²åŠ è½½ï¼Œè€Œä¸ä¾èµ–isVditorReadyçš„çŠ¶æ€
                if (!isContentLoaded) {
                    // å¦‚æœVditorå®ä¾‹å·²å­˜åœ¨ä½†isVditorReadyä¸ºfalseï¼Œå°è¯•å¼ºåˆ¶è®¾ç½®
                    if (vditor && !isVditorReady) {
                        console.log('å¤‡é€‰æ–¹æ¡ˆï¼šVditorå®ä¾‹å·²å­˜åœ¨ä½†isVditorReadyä¸ºfalseï¼Œå°è¯•å¼ºåˆ¶è®¾ç½®å¹¶è°ƒç”¨loadPostContent');
                        isVditorReady = true;
                    }
                    // æ— è®ºå¦‚ä½•éƒ½å°è¯•è°ƒç”¨loadPostContentï¼Œå®ƒå†…éƒ¨ä¼šè¿›è¡Œé˜²æŠ–æ£€æŸ¥
                    loadPostContent();
                } else {
                    console.log('å¤‡é€‰æ–¹æ¡ˆï¼šå†…å®¹å·²åŠ è½½ï¼Œæ— éœ€é‡å¤è°ƒç”¨loadPostContent');
                }
            }, 1000); // å»¶è¿Ÿ1ç§’åæ‰§è¡Œ
        }

        // åŠ è½½æ–‡ç« å†…å®¹å‡½æ•° - æ·»åŠ é˜²æŠ–æœºåˆ¶
        function loadPostContent() {
            console.log('å¼€å§‹åŠ è½½æ–‡ç« å†…å®¹ï¼ŒpostId:', postId, 'isVditorReady:', isVditorReady, 'isContentLoaded:', isContentLoaded);
            // é˜²æŠ–æ£€æŸ¥ï¼šå¦‚æœå†…å®¹å·²åŠ è½½ï¼Œåˆ™ä¸å†é‡å¤åŠ è½½
            if (isContentLoaded) {
                console.log('å†…å®¹å·²åŠ è½½ï¼Œè·³è¿‡é‡å¤åŠ è½½');
                return;
            }
            
            if (postId && isVditorReady) {
                // ç¼–è¾‘æ¨¡å¼ï¼Œä»APIè·å–æ–‡ç« å†…å®¹ - ä¿®æ­£URLä»¥åŒ¹é…è·¯ç”±é…ç½®
                const apiUrl = `/api/v1/post/${postId}`;
                console.log('å‡†å¤‡å‘é€APIè¯·æ±‚ï¼ŒURL:', apiUrl);
                // æ·»åŠ é‡è¯•è®¡æ•°å’Œæœ€å¤§é‡è¯•æ¬¡æ•°
                let retryCount = 0;
                const maxRetries = 2;
                
                function fetchWithRetry() {
                    fetch(apiUrl)
                        .then(response => {
                            console.log('APIå“åº”çŠ¶æ€:', response.status, response.ok);
                            if (!response.ok) {
                                throw new Error(`HTTPé”™è¯¯! çŠ¶æ€ç : ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('APIè¿”å›æ•°æ®:', data);
                            console.log('æ•°æ®ç»“æ„æ£€æŸ¥:', 'code=' + data.code, 'data=' + (data.data ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'));
                            console.log('æ ‡é¢˜å­—æ®µæ£€æŸ¥:', 'data.data.title=' + (data.data && data.data.title ? data.data.title : 'ä¸å­˜åœ¨æˆ–ä¸ºç©º'));
                            
                            if (data.code === 200 && data.data) {
                            // æ ‡è®°å†…å®¹å·²åŠ è½½ï¼Œé˜²æ­¢é‡å¤åŠ è½½
                            isContentLoaded = true;
                            console.log('APIæ•°æ®åŠ è½½æˆåŠŸï¼Œè®¾ç½®isContentLoadedä¸ºtrue');
                            
                            // ç¡®ä¿ç›´æ¥è·å–DOMå…ƒç´ è€Œä¸æ˜¯ä¾èµ–å˜é‡å¼•ç”¨
                            const titleInput = document.getElementById('post-title') || { value: '' };
                            const statusSelect = document.getElementById('post-status') || { value: 'draft' };
                            const pageTitleElem = document.getElementById('page-title') || { textContent: 'æ–‡ç« ç¼–è¾‘' };
                            
                            if (titleInput && typeof titleInput.value !== 'undefined') {
                                // ç¡®ä¿æ ‡é¢˜å€¼è¢«æ­£ç¡®è®¾ç½®
                                console.log('å°è¯•è®¾ç½®æ ‡é¢˜ï¼Œdata.data.titleå€¼:', data.data.title);
                                titleInput.value = data.data.title || '';
                                console.log('æ ‡é¢˜å·²è®¾ç½®:', titleInput.value);
                            } else {
                                console.error('æ— æ³•æ‰¾åˆ°æˆ–æ“ä½œpost-titleå…ƒç´ ');
                            }
                            
                            if (statusSelect && typeof statusSelect.value !== 'undefined') {
                                // è®¾ç½®æ–‡ç« çŠ¶æ€
                                statusSelect.value = data.data.status || 'draft';
                            }
                            
                            if (pageTitleElem && typeof pageTitleElem.textContent !== 'undefined') {
                                // è®¾ç½®é¡µé¢æ ‡é¢˜
                                pageTitleElem.textContent = `ç¼–è¾‘æ–‡ç« : ${data.data.title || 'æœªå‘½å'}`;
                            }
                            
                            // ç¡®ä¿vditorå·²åˆå§‹åŒ–å®Œæˆå†è®¾ç½®å€¼
                            if (vditor && typeof vditor.setValue === 'function') {
                                try {
                                    // åªåœ¨æœ‰å®é™…å†…å®¹æ—¶è®¾ç½®å€¼ï¼Œç¡®ä¿æ ‡é¢˜èƒ½å¤Ÿæ­£ç¡®åŠ è½½
                                    if (data.data.content && data.data.content.trim()) {
                                        vditor.setValue(data.data.content);
                                    } else {
                                        vditor.setValue(defaultContent);
                                    }
                                } catch (error) {
                                    console.error('è®¾ç½®Vditorå†…å®¹å¤±è´¥:', error);
                                }
                            } else {
                                console.warn('Vditoræœªå®Œå…¨åˆå§‹åŒ–æˆ–setValueæ–¹æ³•ä¸å¯ç”¨');
                                // å¦‚æœVditorä¸å¯ç”¨ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆï¼ˆå¦‚æœæœ‰ï¼‰
                            }
                        } else {
                            console.error('APIé€»è¾‘é”™è¯¯:', data.message || 'æœªçŸ¥é”™è¯¯');
                            showUserNotification('åŠ è½½æ–‡ç« å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                            if (vditor && typeof vditor.setValue === 'function') {
                                vditor.setValue(defaultContent);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('APIè¯·æ±‚å¤±è´¥:', error);
                        console.error('é”™è¯¯è¯¦æƒ…:', error.message);
                        
                        // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡è¯•
                        if (retryCount < maxRetries && (error.message.includes('NetworkError') || error.message.includes('Failed to fetch'))) {
                            retryCount++;
                            console.log(`å°è¯•é‡è¯•APIè¯·æ±‚ (${retryCount}/${maxRetries})...`);
                            // æŒ‡æ•°é€€é¿ç­–ç•¥ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
                            setTimeout(fetchWithRetry, 1000 * Math.pow(2, retryCount - 1));
                        } else {
                            showUserNotification('åŠ è½½æ–‡ç« å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                            if (vditor && typeof vditor.setValue === 'function') {
                                vditor.setValue(defaultContent);
                            }
                        }
                    });
                }
                
                // å¼€å§‹é¦–æ¬¡è¯·æ±‚
                fetchWithRetry();
            } else if (isVditorReady && !postId) {
                // åˆ›å»ºæ¨¡å¼ï¼Œç¡®ä¿æ˜¾ç¤ºé¢„ç½®æç¤ºæ–‡æœ¬
                if (vditor && typeof vditor.setValue === 'function') {
                    vditor.setValue(defaultContent);
                }
            }
        }

        // æ˜¾ç¤ºç”¨æˆ·é€šçŸ¥çš„è¾…åŠ©å‡½æ•°
        function showUserNotification(message, type = 'info') {
            try {
                // å°è¯•ä½¿ç”¨æ›´å¥½çš„é€šçŸ¥æ–¹å¼è€Œä¸æ˜¯alert
                if (typeof window.Toast !== 'undefined') {
                    window.Toast[type === 'error' ? 'error' : 'info'](message);
                } else if (typeof window.notification !== 'undefined') {
                    window.notification.show(message, type);
                } else {
                    // å›é€€åˆ°æ ‡å‡†alert
                    alert(message);
                }
            } catch (e) {
                // ç¡®ä¿é€šçŸ¥å‡½æ•°æœ¬èº«ä¸ä¼šæŠ›å‡ºå¼‚å¸¸
                console.error('æ˜¾ç¤ºé€šçŸ¥å¤±è´¥:', e);
                alert(message);
            }
        }
        
        // é¢„è§ˆæŒ‰é’®äº‹ä»¶
        document.getElementById('preview-btn').addEventListener('click', function () {
            if (vditor && typeof vditor.preview === 'function') {
                vditor.preview();
            }
        });

        // ä¿å­˜æŒ‰é’®äº‹ä»¶
        document.getElementById('save-btn').addEventListener('click', function () {
            if (vditor) {
                // éªŒè¯æ•°æ®
                if (!postTitle.value.trim()) {
                    alert('è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜');
                    postTitle.focus();
                    return;
                }
                
                if (!vditor.getValue().trim()) {
                    alert('è¯·è¾“å…¥æ–‡ç« å†…å®¹');
                    return;
                }
                
                // å‘é€åˆ°æœåŠ¡å™¨ä¿å­˜
                    fetch('/app/admin/editor/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                    },
                    body: JSON.stringify({
                        post_id: postId,
                        title: postTitle.value.trim(),
                        content: vditor.getValue(),
                        status: postStatus.value
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        // æ ¹æ®åç«¯è¿”å›çš„codeæ¥åˆ¤æ–­ä¿å­˜æ˜¯å¦æˆåŠŸ
                        // code=0è¡¨ç¤ºæˆåŠŸï¼Œcode=1è¡¨ç¤ºå¤±è´¥
                        if (data.code === 0) {
                            alert('ä¿å­˜æˆåŠŸ');
                            // å¦‚æœæ˜¯æ–°å»ºæ–‡ç« ï¼Œè·å–è¿”å›çš„ID
                            if (!postId) {
                                postId = data.data.id;
                                pageTitle.textContent = `ç¼–è¾‘æ–‡ç« : ${postTitle.value}`;
                                // å¯ä»¥é€‰æ‹©è·³è½¬åˆ°ç¼–è¾‘é¡µé¢æˆ–ç»§ç»­ç¼–è¾‘
                                // window.location.href = `/app/admin/posts/editor/${postId}`;
                            }
                        } else {
                            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                            alert('ä¿å­˜å¤±è´¥: ' + (data.msg || 'æœªçŸ¥é”™è¯¯'));
                        }
                    })
                    .catch(error => {
                        alert('ä¿å­˜å¤±è´¥: ' + error.message);
                    });
            }
        });

        // æ¸…é™¤ç¼“å­˜æŒ‰é’®äº‹ä»¶
        document.getElementById('clear-btn').addEventListener('click', function () {
            if (confirm('ç¡®å®šè¦æ¸…é™¤è‡ªåŠ¨ä¿å­˜çš„å†…å®¹å—ï¼Ÿ')) {
                try {
                    // 1. ä½¿ç”¨Vditorå†…ç½®çš„æ¸…é™¤ç¼“å­˜æ–¹æ³•
                    if (vditor && typeof vditor.clearCache === 'function') {
                        vditor.clearCache();
                    }
                    
                    // 2. æ‰‹åŠ¨æ¸…ç†localStorageä¸­ä¸å½“å‰ç¼–è¾‘å™¨ç›¸å…³çš„ç¼“å­˜
                    clearLocalCache();
                    
                    alert('å·²æ¸…é™¤è‡ªåŠ¨ä¿å­˜çš„å†…å®¹');
                } catch (error) {
                    console.error('æ¸…é™¤ç¼“å­˜æ—¶å‡ºé”™:', error);
                    alert('æ¸…é™¤ç¼“å­˜å¤±è´¥: ' + error.message);
                }
            }
        });
        
        // æ¸…é™¤localStorageä¸­ä¸å½“å‰ç¼–è¾‘å™¨ç›¸å…³çš„ç¼“å­˜
        function clearLocalCache() {
            try {
                // è·å–å½“å‰ç¼–è¾‘å™¨çš„ç¼“å­˜é”®å‰ç¼€
                const cacheKey = 'vditor_cache_' + (postId || 'new_post_' + Date.now());
                
                // æ¸…é™¤æ‰€æœ‰åŒ¹é…çš„ç¼“å­˜é¡¹
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('vditor_cache_')) {
                        // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰ç¼–è¾‘å™¨çš„ç¼“å­˜ï¼Œæˆ–è€…æ˜¯è¿‡æœŸçš„ç¼“å­˜
                        try {
                            const value = localStorage.getItem(key);
                            const parsed = JSON.parse(value);
                            
                            // å¦‚æœæ˜¯å½“å‰ç¼–è¾‘å™¨çš„ç¼“å­˜ï¼Œæˆ–è€…ç¼“å­˜æ—¶é—´è¶…è¿‡7å¤©ï¼Œåˆ™åˆ é™¤
                            if (key.includes(cacheKey) || 
                                (parsed.time && (Date.now() - parsed.time > 7 * 24 * 60 * 60 * 1000))) {
                                localStorage.removeItem(key);
                            }
                        } catch (e) {
                            // æ— æ•ˆçš„ç¼“å­˜æ¡ç›®ï¼Œåˆ é™¤å®ƒ
                            localStorage.removeItem(key);
                        }
                    }
                }
                
                console.log('å·²æ¸…ç†ç›¸å…³ç¼“å­˜');
            } catch (error) {
                console.error('æ¸…ç†localStorageç¼“å­˜æ—¶å‡ºé”™:', error);
            }
        }
        
        // å…¨å±€å‡½æ•°ï¼Œç¡®ä¿åª’ä½“é€‰æ‹©å™¨èƒ½è®¿é—®åˆ°
        window.selectMedia = function(media) {
            if (!media) return;
            insertMediaToEditor(media);
        };
        
        window.closeMediaSelector = function() {
            // æ­¤å‡½æ•°ä¸»è¦ç”¨äºiframeæ–¹å¼åµŒå…¥æ—¶çš„å…³é—­é€»è¾‘
        };
        
        // æ‰“å¼€åª’ä½“é€‰æ‹©å™¨å¼¹çª—
        function openMediaSelector() {
            // åˆ›å»ºä¸€ä¸ªå¼¹çª—
            const width = 900;
            const height = 600;
            const left = (window.innerWidth - width) / 2;
            const top = (window.innerHeight - height) / 2;
            
            // æ‰“å¼€åª’ä½“é€‰æ‹©å™¨çª—å£ï¼Œæ·»åŠ targetå‚æ•°æŒ‡æ˜æ¥æº
            const mediaWindow = window.open('/app/admin/editor/media-selector?target=window&origin=' + encodeURIComponent(window.location.href), 'media_selector', 
                `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`);
            
            if (!mediaWindow) {
                alert('æ— æ³•æ‰“å¼€åª’ä½“é€‰æ‹©å™¨ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å¼¹çª—è®¾ç½®');
                return;
            }
            
            // å®šæœŸæ£€æŸ¥çª—å£æ˜¯å¦è¢«å…³é—­
            const checkInterval = setInterval(function() {
                if (mediaWindow.closed) {
                    clearInterval(checkInterval);
                }
            }, 500);
        }
        
        // å°†é€‰æ‹©çš„åª’ä½“æ’å…¥åˆ°ç¼–è¾‘å™¨ä¸­
        function insertMediaToEditor(media) {
            if (!vditor) {
                console.error('ç¼–è¾‘å™¨æœªåˆå§‹åŒ–');
                return;
            }
            
            if (!media) {
                console.error('åª’ä½“æ•°æ®ä¸ºç©º');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å¤šé€‰æ¨¡å¼ï¼ˆmediaæ˜¯æ•°ç»„ï¼‰
            if (Array.isArray(media)) {
                // å¤šé€‰æ¨¡å¼ï¼Œéå†æ‰€æœ‰é€‰ä¸­çš„åª’ä½“
                media.forEach(item => {
                    insertSingleMedia(item);
                });
                return;
            }
            
            // å•é€‰æ¨¡å¼ï¼Œç›´æ¥æ’å…¥å•ä¸ªåª’ä½“
            insertSingleMedia(media);
        }
        
        // æ’å…¥å•ä¸ªåª’ä½“çš„è¾…åŠ©å‡½æ•°
        function insertSingleMedia(media) {
            // è·å–åª’ä½“URLï¼Œæ”¯æŒå¤šç§å¯èƒ½çš„å±æ€§å
            let mediaUrl = '';
            if (media.url) {
                mediaUrl = media.url;
            } else if (media.file_url) {
                mediaUrl = media.file_url;
            } else if (media.path) {
                mediaUrl = media.path;
            } else if (media.src) {
                mediaUrl = media.src;
            } else if (media.file_path) {
                // å…³é”®ä¿®å¤ï¼šå¦‚æœåªæœ‰file_pathï¼Œæ„å»ºå®Œæ•´çš„URL
                // æ£€æŸ¥file_pathæ˜¯å¦å·²ç»æ˜¯å®Œæ•´URL
                if (media.file_path.startsWith('http://') || media.file_path.startsWith('https://')) {
                    mediaUrl = media.file_path;
                } else {
                    // æ„å»ºå®Œæ•´URLï¼Œç¡®ä¿è·¯å¾„æ­£ç¡®
                    const basePath = media.file_path.startsWith('/') ? '' : '/';
                    mediaUrl = '/uploads' + basePath + media.file_path;
                }
            }
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„URLï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            if (!mediaUrl) {
                console.error('æ— æ³•è·å–åª’ä½“URL', media);
                alert('æ— æ³•è·å–åª’ä½“URLï¼Œè¯·æ£€æŸ¥åª’ä½“æ–‡ä»¶æ˜¯å¦å­˜åœ¨');
                return;
            }
            
            // æ ¹æ®åª’ä½“ç±»å‹ç”Ÿæˆä¸åŒçš„Markdownæ ¼å¼
            let markdown = '';
            
            if (media.mime_type && media.mime_type.startsWith('image/')) {
                // å›¾ç‰‡ç±»å‹ï¼šä½¿ç”¨Markdownå›¾ç‰‡è¯­æ³•
                const altText = media.alt_text || media.original_name || 'å›¾ç‰‡';
                markdown = `![${altText}](${mediaUrl})`;
            } else if (media.mime_type && media.mime_type.startsWith('video/')) {
                // è§†é¢‘ç±»å‹ï¼šä½¿ç”¨HTMLè§†é¢‘æ ‡ç­¾
                markdown = `<video src="${mediaUrl}" controls></video>`;
            } else if (media.mime_type && media.mime_type.startsWith('audio/')) {
                // éŸ³é¢‘ç±»å‹ï¼šä½¿ç”¨HTMLéŸ³é¢‘æ ‡ç­¾
                markdown = `<audio src="${mediaUrl}" controls></audio>`;
            } else {
                // å…¶ä»–ç±»å‹ï¼šä½¿ç”¨Markdowné“¾æ¥è¯­æ³•
                const fileName = media.original_name || 'æ–‡ä»¶';
                markdown = `[${fileName}](${mediaUrl})`;
            }
            
            // æ’å…¥åˆ°ç¼–è¾‘å™¨
            try {
                vditor.insertValue(markdown);
            } catch (error) {
                console.error('æ’å…¥åª’ä½“å¤±è´¥:', error);
                alert('æ’å…¥åª’ä½“å¤±è´¥: ' + error.message);
            }
        }
        
        // ä¸ºåª’ä½“é€‰æ‹©å™¨æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶
        document.getElementById('media-selector-btn').addEventListener('click', function() {
            openMediaSelector();
        });
    });
</script>
</body>
</html>
