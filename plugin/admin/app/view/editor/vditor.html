<!DOCTYPE html>
<html style="overflow: hidden; height: 100%;">
<head>
    <meta charset="utf-8">
    <title>æ•°æ®åˆ†æ</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href="/app/admin/component/pear/css/pear.css" rel="stylesheet"/>
    <link href="/app/admin/demos/css/console2.css" rel="stylesheet"/>
    <link href="/app/admin/component/layui/css/layui.css" rel="stylesheet"/>
</head>
<body class="pear-container" style="overflow: hidden; height: 100%; margin: 0; padding: 0;">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.11.0/axios.min.js"
        integrity="sha512-h9644v03pHqrIHThkvXhB2PJ8zf5E9IyVnrSfZg8Yj8k4RsO4zldcQc4Bi9iVLUCCsqNY0b4WXVV4UB+wbWENA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link href="/assets/css/font-awesome.css" rel="stylesheet">
<script src="/assets/js/highlight.min.js"></script>
<link rel="stylesheet" href="/assets/css/github-dark.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vditor/3.11.1/index.min.css"
      integrity="sha512-Tj6qPPqMhdET85Eu0Hy663goieFRcOde8i0J3DT8L+wb0sSDfgzPwoAYW63yijDXFzrzxOSvPuXfjHqL07hVcg=="
      crossorigin="anonymous" referrerpolicy="no-referrer"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vditor/3.11.1/index.min.js"
        integrity="sha512-oWE+EVJHubnxaqkZy5k5ZBs/TSNarmZyNhHevcfDIqhTza3rlwj1r5Vn8E+KiUPJMmCke08/W7HpN4qj/uHwmQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vditor/3.11.1/css/content-theme/light.min.css"
      integrity="sha512-o50pASvlcfHhtl2lTNfVkSBCgBSO2YeMZmRs1F7P6dD8m6XWWRr7nx9wbum75mBfMTeU8S+OQuIfkzLbLkk/Jw=="
      crossorigin="anonymous" referrerpolicy="no-referrer"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"
        integrity="sha512-LQNxIMR5rXv7o+b1l8+N1EZMfhG7iFZ9HhnbJkTp4zjNr5Wvst75AqUeFDxeRUa7l5vEDyUiAip//r+EFLLCyA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css"
      integrity="sha512-fHwaWebuwA7NSF5Qg/af4UeDx9XqUpYpOGgubo3yWu+b2IQR4UeQwbb42Ti7gVAjNtVoI/I9TEoYeu9omwcC6g=="
      crossorigin="anonymous" referrerpolicy="no-referrer"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.9.0/mermaid.min.js"
        integrity="sha512-OAr6bl1pt/FD0oVcuPzJ9VIMso+HQhHoodVI7mnDst19p8rNkNiraPLsDCYVhit3Mjd6B7AUHFsoDhq3dDeI7g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="/app/admin/component/layui/layui.js"></script>

<div style="width: 100%; height: 100vh; display: flex; flex-direction: column; overflow: hidden;">
    <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
    <header style="background: white; border-bottom: 1px solid #e5e7eb; padding: 12px 16px; flex-shrink: 0;">
        <div class="flex items-center justify-between">
            <h1 class="text-lg font-bold text-gray-800" id="page-title">æ–‡ç« ç¼–è¾‘</h1>
            <!-- é¡¶éƒ¨æ“ä½œæŒ‰é’® -->
            <div class="flex items-center gap-2">
                <button class="px-3 py-1.5 bg-purple-500 text-white text-sm rounded hover:bg-purple-600 transition-colors"
                        id="media-selector-btn">
                    <i class="fas fa-image mr-1"></i>æ’å…¥åª’ä½“
                </button>
                <button class="px-3 py-1.5 bg-gray-600 text-white text-sm rounded hover:bg-gray-700 transition-colors"
                        id="save-draft-btn">
                    <i class="fas fa-save mr-1"></i>ä¿å­˜è‰ç¨¿
                </button>
                <button class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors"
                        id="publish-btn">
                    <i class="fas fa-paper-plane mr-1"></i>å‘å¸ƒ
                </button>
            </div>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <div style="display: flex; flex: 1; overflow: hidden; min-height: 0;">
        <!-- ä¸»ç¼–è¾‘åŒº -->
        <main style="flex: 1; overflow-y: auto; background: #f9fafb; min-width: 0;">
            <div style="max-width: 100%; padding: 12px 16px;">
                <!-- æ ‡é¢˜è¾“å…¥ -->
                <div style="margin-bottom: 12px;">
                    <input type="text" id="post-title"
                           style="width: 100%; padding: 8px 12px; font-size: 18px; border: 1px solid #d1d5db; border-radius: 4px; background: white;"
                           placeholder="è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜">
                </div>
                <!-- ç¼–è¾‘å™¨åŒºåŸŸ -->
                <div id="vditor"
                     style="background: white; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"></div>
            </div>
        </main>

        <!-- å³ä¾§è¾¹æ  -->
        <aside style="width: 320px; flex-shrink: 0; background: white; border-left: 1px solid #e5e7eb; overflow-y: auto;">
            <div style="padding: 12px; display: flex; flex-direction: column; gap: 12px;">
                <!-- ç»Ÿè®¡ä¿¡æ¯å¡ç‰‡ -->
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded p-3 border border-blue-100">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-chart-line mr-2 text-blue-500"></i>å†…å®¹ç»Ÿè®¡
                    </h3>
                    <div class="space-y-2">
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-600">å­—æ•°</span>
                            <span class="font-semibold text-gray-800" id="stats-words">0</span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-600">å­—ç¬¦</span>
                            <span class="font-semibold text-gray-800" id="stats-chars">0</span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-600">é¢„è®¡é˜…è¯»</span>
                            <span class="font-semibold text-gray-800" id="stats-readtime">0åˆ†é’Ÿ</span>
                        </div>
                        <div class="flex items-center justify-between text-xs pt-2 border-t border-blue-200">
                            <span class="text-gray-500">ä¸Šæ¬¡ä¿å­˜</span>
                            <span class="text-gray-500" id="stats-last-saved">â€”</span>
                        </div>
                    </div>
                </div>

                <!-- å‘å¸ƒè®¾ç½® -->
                <div class="bg-white rounded border border-gray-200">
                    <div class="p-3 border-b border-gray-200">
                        <h3 class="text-sm font-semibold text-gray-700 flex items-center">
                            <i class="fas fa-cog mr-2 text-gray-500"></i>å‘å¸ƒè®¾ç½®
                        </h3>
                    </div>
                    <div class="p-3 space-y-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1.5" for="post-status">çŠ¶æ€</label>
                            <select class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    id="post-status">
                                <option value="draft">è‰ç¨¿</option>
                                <option value="published">å·²å‘å¸ƒ</option>
                                <option value="archived">å·²å½’æ¡£</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1.5"
                                   for="post-visibility">å¯è§æ€§</label>
                            <select class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    id="post-visibility">
                                <option value="public">ğŸŒ å…¬å¼€</option>
                                <option value="private">ğŸ”’ ç§å¯†</option>
                                <option value="password">ğŸ”‘ å¯†ç ä¿æŠ¤</option>
                            </select>
                        </div>
                        <div class="hidden" id="password-field">
                            <label class="block text-xs font-medium text-gray-600 mb-1.5"
                                   for="post-password">å¯†ç </label>
                            <input class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" id="post-password"
                                   placeholder="ç•™ç©ºä¸ä¿®æ”¹"
                                   type="text">
                        </div>
                    </div>
                </div>

                <!-- æ–‡ç« é€‰é¡¹ -->
                <div class="bg-white rounded border border-gray-200 p-3 space-y-3">
                    <h3 class="text-sm font-semibold text-gray-700 flex items-center mb-2">
                        <i class="fas fa-sliders-h mr-2 text-gray-500"></i>æ–‡ç« é€‰é¡¹
                    </h3>
                    <label class="flex items-center justify-between cursor-pointer group">
                        <span class="text-sm text-gray-700 group-hover:text-gray-900 flex items-center">
                            <i class="fas fa-comments mr-2 text-gray-400"></i>å…è®¸è¯„è®º
                        </span>
                        <div class="relative">
                            <input checked class="sr-only peer" id="allow-comments" type="checkbox">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-400 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </div>
                    </label>
                    <label class="flex items-center justify-between cursor-pointer group">
                        <span class="text-sm text-gray-700 group-hover:text-gray-900 flex items-center">
                            <i class="fas fa-star mr-2 text-gray-400"></i>ç²¾é€‰æ–‡ç« 
                        </span>
                        <div class="relative">
                            <input class="sr-only peer" id="post-featured" type="checkbox">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-yellow-400 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-500"></div>
                        </div>
                    </label>
                </div>

                <!-- AI æ‘˜è¦è®¾ç½® -->
                <div class="bg-gradient-to-br from-amber-50 to-yellow-50 rounded border border-amber-200">
                    <div class="p-3 border-b border-amber-200">
                        <div class="flex items-center justify-between">
                            <h3 class="text-sm font-semibold text-gray-700 flex items-center">
                                <i class="fas fa-brain mr-2 text-amber-500"></i>AI æ‘˜è¦
                            </h3>
                            <label class="relative cursor-pointer">
                                <input type="checkbox" id="ai-enabled" class="sr-only peer">
                                <div class="w-9 h-5 bg-gray-300 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-amber-400 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-amber-500"></div>
                            </label>
                        </div>
                    </div>
                    <div class="p-3 space-y-3">
                        <!-- å½“å‰çŠ¶æ€ï¼ˆåªè¯»ï¼‰ -->
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1.5">å½“å‰çŠ¶æ€</label>
                            <div class="px-3 py-2 text-sm bg-gray-50 border border-gray-200 rounded-md text-gray-700"
                                 id="ai-status-display">
                                <span id="ai-status-text">âšª æœªç”Ÿæˆ</span>
                            </div>
                        </div>

                        <!-- æŒä¹…åŒ–å¼€å…³ -->
                        <label class="flex items-center justify-between cursor-pointer group">
                            <span class="text-sm text-gray-700 group-hover:text-gray-900 flex items-center">
                                <i class="fas fa-lock mr-2 text-gray-400"></i>æŒä¹…åŒ–æ‘˜è¦
                                <span class="ml-2 text-xs text-gray-500">(ä¸è‡ªåŠ¨æ›´æ–°)</span>
                            </span>
                            <div class="relative">
                                <input class="sr-only peer" id="ai-persisted" type="checkbox">
                                <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-amber-400 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-amber-500"></div>
                            </div>
                        </label>

                        <!-- æ‘˜è¦å†…å®¹ -->
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1.5"
                                   for="ai-summary">æ‘˜è¦å†…å®¹</label>
                            <textarea class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-400" id="ai-summary"
                                      placeholder="å¯æ‰‹åŠ¨ç¼–è¾‘æˆ–ç”±AIç”Ÿæˆ"
                                      rows="5"></textarea>
                        </div>

                        <!-- æ“ä½œæŒ‰é’® -->
                        <div class="flex gap-2">
                            <button class="flex-1 px-3 py-2 bg-amber-500 hover:bg-amber-600 text-white text-sm rounded-md transition-colors flex items-center justify-center"
                                    id="ai-generate" type="button">
                                <i class="fas fa-magic mr-1"></i>ç”Ÿæˆæ‘˜è¦
                            </button>
                            <button class="flex-1 px-3 py-2 bg-green-500 hover:bg-green-600 text-white text-sm rounded-md transition-colors flex items-center justify-center"
                                    id="ai-save" type="button">
                                <i class="fas fa-save mr-1"></i>ä¿å­˜æ‘˜è¦
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ä½œè€…é€‰æ‹© -->
                <div class="bg-white rounded border border-gray-200">
                    <div class="p-3 border-b border-gray-200">
                        <h3 class="text-sm font-semibold text-gray-700 flex items-center">
                            <i class="fas fa-user-edit mr-2 text-gray-500"></i>ä½œè€…
                        </h3>
                    </div>
                    <div class="p-3 relative">
                        <input type="text" id="authors-select"
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white cursor-pointer"
                               placeholder="ç‚¹å‡»é€‰æ‹©ä½œè€…" readonly>
                        <div id="authors-dropdown"
                             class="absolute z-50 hidden w-full left-0 mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-64 overflow-hidden">
                            <div class="p-2 border-b border-gray-200 bg-gray-50">
                                <input type="text" id="authors-search"
                                       class="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       placeholder="æœç´¢ä½œè€…...">
                            </div>
                            <div class="p-2 overflow-y-auto max-h-52" id="authors-list"></div>
                        </div>
                    </div>
                </div>

                <!-- å¿«æ·æ“ä½œ -->
                <div class="space-y-2">
                    <button class="w-full px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm rounded transition-colors flex items-center justify-center border border-gray-300"
                            id="clear-btn">
                        <i class="fas fa-trash-alt mr-2"></i>æ¸…é™¤ç¼“å­˜
                    </button>
                </div>
            </div>
        </aside>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // çŠ¶æ€å˜é‡
        let vditor = null;
        let isVditorReady = false;
        let isContentLoaded = false; // æ ‡è®°å†…å®¹æ˜¯å¦å·²åŠ è½½

        // è·å–æ–‡ç« IDçš„é€»è¾‘
        // ä»URLè·¯å¾„ä¸­æå–IDï¼Œå…¼å®¹å¤šç§URLæ ¼å¼
        let pathSegments = window.location.pathname.split('/').filter(Boolean); // è¿‡æ»¤æ‰ç©ºå­—ç¬¦ä¸²
        let postId = 0;

        // æŸ¥æ‰¾ç¬¦åˆæ¡ä»¶çš„IDï¼ˆåœ¨vditoråé¢çš„æ•°å­—ï¼Œæ”¯æŒæ–°çš„è·¯ç”±ç»“æ„ï¼‰
        for (let i = 0; i < pathSegments.length; i++) {
            if (pathSegments[i] === 'vditor' && i + 1 < pathSegments.length) {
                const potentialId = pathSegments[i + 1];
                if (!isNaN(parseInt(potentialId))) {
                    postId = parseInt(potentialId);
                    break;
                }
            }
        }

        // å…¼å®¹æ€§å¤„ç†ï¼šå¦‚æœåœ¨vditoråé¢æ²¡æ‰¾åˆ°IDï¼Œä¹Ÿæ£€æŸ¥editoråé¢ï¼ˆä¸ºäº†å…¼å®¹æ—§çš„URLç»“æ„ï¼‰
        if (postId === 0) {
            for (let i = 0; i < pathSegments.length; i++) {
                if (pathSegments[i] === 'editor' && i + 1 < pathSegments.length) {
                    const potentialId = pathSegments[i + 1];
                    if (!isNaN(parseInt(potentialId))) {
                        postId = parseInt(potentialId);
                        break;
                    }
                }
            }
        }

        // å®‰å…¨æ€§æ£€æŸ¥ï¼šç¡®ä¿IDæ˜¯æœ‰æ•ˆçš„æ­£æ•´æ•°
        postId = postId > 0 ? postId : 0;

        // è·å–DOMå…ƒç´ 
        const postTitle = document.getElementById('post-title') || {value: ''};
        const postStatus = document.getElementById('post-status') || {value: 'draft'};
        const postVisibility = document.getElementById('post-visibility') || {value: 'public'};
        // const postPassword = document.getElementById('post-password') || {value: ''};
        const passwordField = document.getElementById('password-field');
        const allowComments = document.getElementById('allow-comments') || {checked: true};
        const postFeatured = document.getElementById('post-featured') || {checked: false};
        const pageTitle = document.getElementById('page-title') || {textContent: 'æ–‡ç« ç¼–è¾‘'};
        let defaultContent = ``;

        // åˆå§‹åŒ– Vditor
        console.log('åˆå§‹åŒ–ç¼–è¾‘å™¨ï¼Œå½“å‰URL:', window.location.href);
        console.log('æå–çš„æ–‡ç« ID:', postId);

        try {
            vditor = new Vditor('vditor', {
                height: 'calc(100vh - 140px)',
                minHeight: 600,
                // cdn: 'https://cdnjs.cloudflare.com/ajax/libs/vditor/3.11.1', // æ— æ³•ä½¿ç”¨cfå…¬å…±cdnï¼Œæ²¡æœ‰distç›®å½•
                mode: 'sv', // åˆ†å±
                input(value) {
                    updateStats(value);
                },
                toolbarConfig: {
                    pin: true,
                },
                comment: {
                    enable: false, // ä¸å¥½ç”¨
                },
                cache: {
                    enable: true, // å¯ç”¨localStorageç¼“å­˜
                    id: postId || 'new_post_' + Date.now(), // ä½¿ç”¨æ–‡ç« IDæˆ–ä¸´æ—¶IDä½œä¸ºç¼“å­˜é”®
                    after: function (html) {
                        // ç¼“å­˜åçš„å›è°ƒå‡½æ•°ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ç¼“å­˜å¤„ç†é€»è¾‘
                        return html;
                    }
                },
                preview: {
                    markdown: {
                        sanitize: true,
                    },
                    hljs: {
                        enable: true,
                        defaultLang: 'bash',
                        style: 'github-dark',
                        lineNumber: true,
                    }
                },
                upload: {
                    accept: 'image/*',
                    url: '/app/admin/editor/upload-image',
                    fieldName: 'image',
                    max: 50 * 1024 * 1024,
                    filename(name) {
                        return name.replace(/\?|\\|\/|:|\||<|>|\*|\[|\]|\s+/g, '-')
                    },
                    linkToImgUrl: '/app/admin/editor/upload-image',
                    handler(files) {
                        const data = new FormData()
                        data.append('image', files[0])

                        fetch('/app/admin/editor/upload-image', {
                            method: 'POST',
                            body: data,
                        }).then(response => response.json()).then(data => {
                            if (data.success === 1) {
                                vditor.insertValue(`![](${data.file.url})`)
                            } else {
                                alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ' + data.message)
                            }
                        }).catch(err => {
                            alert('ç½‘ç»œé”™è¯¯: ' + err)
                        })
                    }
                },
                hint: {
                    // emojiPath: 'https://cdn.jsdelivr.net/npm/vditor/dist/images/emoji',
                    emoji: {
                        "+1": "ğŸ‘",
                        "-1": "ğŸ‘",
                        "heart": "â¤ï¸",
                        "smile": "ğŸ˜„",
                        "laughing": "ğŸ˜†",
                        "smirk": "ğŸ˜",
                        "expressionless": "ğŸ˜‘",
                        "tired_face": "ğŸ˜«",
                        "sleeping": "ğŸ˜´",
                        "flushed": "ğŸ˜³",
                        "scream": "ğŸ˜±",
                        "rage": "ğŸ˜¡",
                        "smiling_imp": "ğŸ˜ˆ",
                        "sunglasses": "ğŸ˜",
                        "thumbsup": "ğŸ‘",
                        "thumbsdown": "ğŸ‘",
                        "ok_hand": "ğŸ‘Œ",
                        "punch": "ğŸ‘Š",
                        "wave": "ğŸ‘‹",
                        "clap": "ğŸ‘",
                        "open_hands": "ğŸ‘",
                        "pray": "ğŸ™",
                        "eyes": "ğŸ‘€",
                        "zzz": "ğŸ’¤",
                        "poop": "ğŸ’©",
                        "muscle": "ğŸ’ª",
                        "trumpet": "ğŸº",
                        "cake": "ğŸ°",
                        "coffee": "â˜•",
                        "bomb": "ğŸ’£",
                        "gem": "ğŸ’",
                        "ring": "ğŸ’",
                        "rocket": "ğŸš€",
                        "train": "ğŸš‹",
                        "bike": "ğŸš²",
                        "bus": "ğŸšŒ",
                        "airplane": "âœˆï¸",
                        "rocket2": "ğŸš€",
                        "moon": "ğŸŒ™",
                        "star2": "ğŸŒŸ",
                        "sunny": "â˜€ï¸",
                        "rainbow": "ğŸŒˆ",
                        "snowman": "â›„",
                        "zap": "âš¡",
                        "fire": "ğŸ”¥",
                        "ghost": "ğŸ‘»",
                        "alien": "ğŸ‘½",
                        "robot": "ğŸ¤–",
                        "skull": "ğŸ’€",
                        "heart_eyes": "ğŸ˜",
                        "kiss": "ğŸ˜˜",
                        "sweat": "ğŸ˜“",
                        "sob": "ğŸ˜­",
                        "joy": "ğŸ˜‚",
                        "tongue": "ğŸ˜›",
                        "v": "âœŒï¸",
                        "santa": "ğŸ…",
                        "christmas_tree": "ğŸ„",
                        "gift": "ğŸ",
                        "jack_o_lantern": "ğŸƒ",
                        "bamboo": "ğŸ",
                        "grapes": "ğŸ‡",
                        "watermelon": "ğŸ‰",
                        "ramen": "ğŸœ",
                        "soccer": "âš½",
                        "football": "ğŸˆ",
                        "basketball": "ğŸ€",
                        "dart": "ğŸ¯",
                        "slot_machine": "ğŸ°",
                        "8ball": "ğŸ±",
                        "game_die": "ğŸ²",
                        "spades": "â™ ï¸",
                        "clubs": "â™£ï¸",
                        "hearts": "â™¥ï¸",
                        "diamonds": "â™¦ï¸",
                        "clubhouse": "ğŸ›–",
                        "house": "ğŸ ",
                        "city_sunrise": "ğŸŒ‡",
                        "bridge_at_night": "ğŸŒ‰",
                        "ferris_wheel": "ğŸ¡",
                        "roller_coaster": "ğŸ¢",
                        "ship": "ğŸš¢",
                        "speedboat": "ğŸš¤",
                        "sailboat": "â›µ",
                        "anchor": "âš“",
                        "rocketship": "ğŸš€",
                        "flying_saucer": "ğŸ›¸",
                        "helicopter": "ğŸš",
                        "steam_locomotive": "ğŸš‚",
                        "car": "ğŸš—",
                        "taxi": "ğŸš•",
                        "busstop": "ğŸš",
                        "fuelpump": "â›½",
                        "rotating_light": "ğŸš¨",
                        "triangular_flag_on_post": "ğŸš©",
                        "crossed_flags": "ğŸŒ",
                        "waving_black_flag": "ğŸ´",
                        "waving_white_flag": "ğŸ³ï¸",
                        "rainbow-flag": "ğŸ³ï¸â€ğŸŒˆ",
                        "pirate_flag": "ğŸ´â€â˜ ï¸"
                    }
                },
                // æ·»åŠ åˆå§‹åŒ–å®Œæˆå›è°ƒ - ç›´æ¥æ”¾åœ¨é¡¶å±‚é…ç½®ä¸­è€Œä¸æ˜¯åµŒå¥—å¯¹è±¡ä¸­
                after() {
                    console.log('Vditoråˆå§‹åŒ–å®Œæˆï¼Œè®¾ç½®isVditorReadyä¸ºtrue');
                    isVditorReady = true;
                    loadPostContent();
                },
                // åˆå§‹åŒ–æ—¶ç›´æ¥è®¾ç½®é»˜è®¤å†…å®¹
                value: defaultContent
            });
        } catch (error) {
            console.error('Vditoråˆå§‹åŒ–å¤±è´¥:', error);
            // å³ä½¿åˆå§‹åŒ–å¤±è´¥ä¹Ÿå°è¯•è®¾ç½®isVditorReadyä¸ºtrueï¼Œä»¥ä¾¿ç»§ç»­æµç¨‹
            setTimeout(() => {
                isVditorReady = true;
                loadPostContent();
            }, 1000);
        }

        // æ–°å»ºæ–‡ç« æ—¶ï¼Œè®¾ç½®æ ‡é¢˜ä¸º"æœªå‘½å+æ—¶é—´æˆ³çŸ­å“ˆå¸Œ"
        if (!postId) {
            // ç”Ÿæˆæ—¶é—´æˆ³çŸ­å“ˆå¸Œï¼ˆåŸºäºå½“å‰æ—¶é—´æˆ³çš„ç®€å•å“ˆå¸Œï¼‰
            const timestamp = Date.now();
            // ç®€å•å“ˆå¸Œå‡½æ•°ï¼šå°†æ—¶é—´æˆ³è½¬ä¸º16è¿›åˆ¶å¹¶å–å6ä½
            const shortHash = timestamp.toString(16).slice(-6);
            postTitle.value = `æœªå‘½å${shortHash}`;
            pageTitle.textContent = 'æ–°å»ºæ–‡ç« ';
            // ç¡®ä¿æ–°å»ºæ–‡ç« æ—¶æ˜¾ç¤ºé¢„ç½®å†…å®¹
            if (vditor && typeof vditor.setValue === 'function') {
                // ä½¿ç”¨setTimeoutç¡®ä¿åœ¨Vditorå®Œå…¨åˆå§‹åŒ–åå†è®¾ç½®å†…å®¹
                setTimeout(() => {
                    vditor.setValue(defaultContent);
                }, 100);
            }
        } else {
            // å¤‡é€‰æ–¹æ¡ˆï¼šç¡®ä¿æ–‡ç« å†…å®¹è¢«åŠ è½½ï¼Œä¸ç®¡æ˜¯é€šè¿‡ä¸»å›è°ƒè¿˜æ˜¯æ‰‹åŠ¨è°ƒç”¨
            // æ·»åŠ é˜²æŠ–æ£€æŸ¥ï¼Œé¿å…é‡å¤åŠ è½½
            setTimeout(() => {
                console.log('å¤‡é€‰æ–¹æ¡ˆï¼šå°è¯•ç¡®ä¿å†…å®¹åŠ è½½ï¼ŒpostId:', postId, 'isVditorReady:', isVditorReady, 'isContentLoaded:', isContentLoaded);
                // åªæ£€æŸ¥å†…å®¹æ˜¯å¦å·²åŠ è½½ï¼Œè€Œä¸ä¾èµ–isVditorReadyçš„çŠ¶æ€
                if (!isContentLoaded) {
                    // å¦‚æœVditorå®ä¾‹å·²å­˜åœ¨ä½†isVditorReadyä¸ºfalseï¼Œå°è¯•å¼ºåˆ¶è®¾ç½®
                    if (vditor && !isVditorReady) {
                        console.log('å¤‡é€‰æ–¹æ¡ˆï¼šVditorå®ä¾‹å·²å­˜åœ¨ä½†isVditorReadyä¸ºfalseï¼Œå°è¯•å¼ºåˆ¶è®¾ç½®å¹¶è°ƒç”¨loadPostContent');
                        isVditorReady = true;
                    }
                    // æ— è®ºå¦‚ä½•éƒ½å°è¯•è°ƒç”¨loadPostContentï¼Œå®ƒå†…éƒ¨ä¼šè¿›è¡Œé˜²æŠ–æ£€æŸ¥
                    loadPostContent();
                } else {
                    console.log('å¤‡é€‰æ–¹æ¡ˆï¼šå†…å®¹å·²åŠ è½½ï¼Œæ— éœ€é‡å¤è°ƒç”¨loadPostContent');
                }
            }, 1000); // å»¶è¿Ÿ1ç§’åæ‰§è¡Œ
        }

        // åŠ è½½æ–‡ç« å†…å®¹å‡½æ•° - æ·»åŠ é˜²æŠ–æœºåˆ¶
        function loadPostContent() {
            console.log('å¼€å§‹åŠ è½½æ–‡ç« å†…å®¹ï¼ŒpostId:', postId, 'isVditorReady:', isVditorReady, 'isContentLoaded:', isContentLoaded);
            // é˜²æŠ–æ£€æŸ¥ï¼šå¦‚æœå†…å®¹å·²åŠ è½½ï¼Œåˆ™ä¸å†é‡å¤åŠ è½½
            if (isContentLoaded) {
                console.log('å†…å®¹å·²åŠ è½½ï¼Œè·³è¿‡é‡å¤åŠ è½½');
                return;
            }

            if (postId && isVditorReady) {
                // ç¼–è¾‘æ¨¡å¼ï¼Œä»APIè·å–æ–‡ç« å†…å®¹ - ä¿®æ­£URLä»¥åŒ¹é…è·¯ç”±é…ç½®
                const apiUrl = `/app/admin/editor/post/${postId}`;
                console.log('å‡†å¤‡å‘é€APIè¯·æ±‚ï¼ŒURL:', apiUrl);
                // æ·»åŠ é‡è¯•è®¡æ•°å’Œæœ€å¤§é‡è¯•æ¬¡æ•°
                let retryCount = 0;
                const maxRetries = 2;

                function fetchWithRetry() {
                    fetch(apiUrl)
                        .then(response => {
                            console.log('APIå“åº”çŠ¶æ€:', response.status, response.ok);
                            if (!response.ok) {
                                throw new Error(`HTTPé”™è¯¯! çŠ¶æ€ç : ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('APIè¿”å›æ•°æ®:', data);
                            console.log('æ•°æ®ç»“æ„æ£€æŸ¥:', 'code=' + data.code, 'data=' + (data.data ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'));
                            console.log('æ ‡é¢˜å­—æ®µæ£€æŸ¥:', 'data.data.title=' + (data.data && data.data.title ? data.data.title : 'ä¸å­˜åœ¨æˆ–ä¸ºç©º'));

                            if (data.code === 200 && data.data) {
                                // æ ‡è®°å†…å®¹å·²åŠ è½½ï¼Œé˜²æ­¢é‡å¤åŠ è½½
                                isContentLoaded = true;
                                console.log('APIæ•°æ®åŠ è½½æˆåŠŸï¼Œè®¾ç½®isContentLoadedä¸ºtrue');

                                // ç¡®ä¿ç›´æ¥è·å–DOMå…ƒç´ è€Œä¸æ˜¯ä¾èµ–å˜é‡å¼•ç”¨
                                const titleInput = document.getElementById('post-title') || {value: ''};
                                const statusSelect = document.getElementById('post-status') || {value: 'draft'};
                                const pageTitleElem = document.getElementById('page-title') || {textContent: 'æ–‡ç« ç¼–è¾‘'};

                                if (titleInput && typeof titleInput.value !== 'undefined') {
                                    // ç¡®ä¿æ ‡é¢˜å€¼è¢«æ­£ç¡®è®¾ç½®
                                    console.log('å°è¯•è®¾ç½®æ ‡é¢˜ï¼Œdata.data.titleå€¼:', data.data.title);
                                    titleInput.value = data.data.title || '';
                                    console.log('æ ‡é¢˜å·²è®¾ç½®:', titleInput.value);
                                } else {
                                    console.error('æ— æ³•æ‰¾åˆ°æˆ–æ“ä½œpost-titleå…ƒç´ ');
                                }

                                if (statusSelect && typeof statusSelect.value !== 'undefined') {
                                    // è®¾ç½®æ–‡ç« çŠ¶æ€
                                    statusSelect.value = data.data.status || 'draft';
                                }

                                // è®¾ç½®å¯è§æ€§
                                const visibilitySelect = document.getElementById('post-visibility');
                                if (visibilitySelect) {
                                    visibilitySelect.value = data.data.visibility || 'public';
                                    // è§¦å‘changeäº‹ä»¶ä»¥æ˜¾ç¤º/éšè—å¯†ç å­—æ®µ
                                    visibilitySelect.dispatchEvent(new Event('change'));
                                }

                                // è®¾ç½®å¯†ç 
                                /*const passwordInput = document.getElementById('post-password');
                                if (passwordInput && data.data.password) {
                                    passwordInput.value = data.data.password;
                                }*/

                                // è®¾ç½®è¯„è®ºå…è®¸
                                const allowCommentsCheckbox = document.getElementById('allow-comments');
                                if (allowCommentsCheckbox) {
                                    allowCommentsCheckbox.checked = data.data.allow_comments !== false;
                                }

                                // è®¾ç½®ç²¾é€‰æ–‡ç« 
                                const featuredCheckbox = document.getElementById('post-featured');
                                if (featuredCheckbox) {
                                    featuredCheckbox.checked = data.data.featured === true || data.data.featured === 1;
                                }

                                if (pageTitleElem && typeof pageTitleElem.textContent !== 'undefined') {
                                    // è®¾ç½®é¡µé¢æ ‡é¢˜
                                    pageTitleElem.textContent = `ç¼–è¾‘æ–‡ç« : ${data.data.title || 'æœªå‘½å'}`;
                                }

                                // ç¡®ä¿vditorå·²åˆå§‹åŒ–å®Œæˆå†è®¾ç½®å€¼
                                if (vditor && typeof vditor.setValue === 'function') {
                                    try {
                                        // åªåœ¨æœ‰å®é™…å†…å®¹æ—¶è®¾ç½®å€¼ï¼Œç¡®ä¿æ ‡é¢˜èƒ½å¤Ÿæ­£ç¡®åŠ è½½
                                        if (data.data.content && data.data.content.trim()) {
                                            vditor.setValue(data.data.content);
                                        } else {
                                            vditor.setValue(defaultContent);
                                        }
                                    } catch (error) {
                                        console.error('è®¾ç½®Vditorå†…å®¹å¤±è´¥:', error);
                                    }
                                } else {
                                    console.warn('Vditoræœªå®Œå…¨åˆå§‹åŒ–æˆ–setValueæ–¹æ³•ä¸å¯ç”¨');
                                    // å¦‚æœVditorä¸å¯ç”¨ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆï¼ˆå¦‚æœæœ‰ï¼‰
                                }
                            } else {
                                console.error('APIé€»è¾‘é”™è¯¯:', data.message || 'æœªçŸ¥é”™è¯¯');
                                showUserNotification('åŠ è½½æ–‡ç« å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                                if (vditor && typeof vditor.setValue === 'function') {
                                    vditor.setValue(defaultContent);
                                }
                            }
                        })
                        .catch(error => {
                            console.error('APIè¯·æ±‚å¤±è´¥:', error);
                            console.error('é”™è¯¯è¯¦æƒ…:', error.message);

                            // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡è¯•
                            if (retryCount < maxRetries && (error.message.includes('NetworkError') || error.message.includes('Failed to fetch'))) {
                                retryCount++;
                                console.log(`å°è¯•é‡è¯•APIè¯·æ±‚ (${retryCount}/${maxRetries})...`);
                                // æŒ‡æ•°é€€é¿ç­–ç•¥ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
                                setTimeout(fetchWithRetry, 1000 * Math.pow(2, retryCount - 1));
                            } else {
                                showUserNotification('åŠ è½½æ–‡ç« å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                                if (vditor && typeof vditor.setValue === 'function') {
                                    vditor.setValue(defaultContent);
                                }
                            }
                        });
                }

                // å¼€å§‹é¦–æ¬¡è¯·æ±‚
                fetchWithRetry();
            } else if (isVditorReady && !postId) {
                // åˆ›å»ºæ¨¡å¼ï¼Œç¡®ä¿æ˜¾ç¤ºé¢„ç½®æç¤ºæ–‡æœ¬
                if (vditor && typeof vditor.setValue === 'function') {
                    vditor.setValue(defaultContent);
                }
            }
        }

        // æ˜¾ç¤ºç”¨æˆ·é€šçŸ¥çš„è¾…åŠ©å‡½æ•°
        function showUserNotification(message, type = 'info') {
            try {
                // å°è¯•ä½¿ç”¨æ›´å¥½çš„é€šçŸ¥æ–¹å¼è€Œä¸æ˜¯alert
                if (typeof window.Toast !== 'undefined') {
                    window.Toast[type === 'error' ? 'error' : 'info'](message);
                } else if (typeof window.notification !== 'undefined') {
                    window.notification.show(message, type);
                } else {
                    // å›é€€åˆ°æ ‡å‡†alert
                    alert(message);
                }
            } catch (e) {
                // ç¡®ä¿é€šçŸ¥å‡½æ•°æœ¬èº«ä¸ä¼šæŠ›å‡ºå¼‚å¸¸
                console.error('æ˜¾ç¤ºé€šçŸ¥å¤±è´¥:', e);
                alert(message);
            }
        }

        // ç»Ÿè®¡ä¿¡æ¯è®¡ç®—ä¸æ›´æ–°
        function updateStats(value) {
            try {
                const text = (value || '').toString();
                const chars = text.length;
                const words = text.trim() ? text.trim().split(/\s+/).length : 0;
                // ç®€æ˜“é˜…è¯»æ—¶é•¿ï¼šæŒ‰æ¯åˆ†é’Ÿ500å­—ç¬¦ä¼°ç®—
                const minutes = Math.max(1, Math.ceil(chars / 500));

                const wEl = document.getElementById('stats-words');
                const cEl = document.getElementById('stats-chars');
                const rEl = document.getElementById('stats-readtime');

                if (wEl) wEl.textContent = String(words);
                if (cEl) cEl.textContent = String(chars);
                if (rEl) rEl.textContent = minutes + 'åˆ†é’Ÿ';
            } catch (e) {
                console.warn('æ›´æ–°ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', e);
            }
        }

        function updateLastSaved(date) {
            const el = document.getElementById('stats-last-saved');
            if (el) {
                const d = date instanceof Date ? date : new Date();
                el.textContent = d.toLocaleString();
            }
        }

        // ä¿å­˜è‰ç¨¿æŒ‰é’®äº‹ä»¶
        document.getElementById('save-draft-btn').addEventListener('click', function () {
            savePost('draft');
        });

        // å‘å¸ƒæŒ‰é’®äº‹ä»¶
        document.getElementById('publish-btn').addEventListener('click', function () {
            savePost('published');
        });

        // ä¿å­˜æ–‡ç« çš„é€šç”¨å‡½æ•°
        function savePost(targetStatus) {
            if (vditor) {
                // éªŒè¯æ•°æ®
                if (!postTitle.value.trim()) {
                    layer.msg('è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜', {icon: 5});
                    postTitle.focus();
                    return;
                }

                if (!vditor.getValue().trim()) {
                    layer.msg('è¯·è¾“å…¥æ–‡ç« å†…å®¹', {icon: 5});
                    return;
                }

                // å‡†å¤‡ä½œè€…æ•°æ®
                const authorIds = selectedAuthors.map(a => a.id);

                // å‡†å¤‡ä¿å­˜æ•°æ®
                const saveData = {
                    post_id: postId,
                    title: postTitle.value.trim(),
                    content: vditor.getValue(),
                    status: targetStatus,
                    visibility: postVisibility.value,
                    allow_comments: allowComments.checked ? 1 : 0,
                    featured: postFeatured.checked ? 1 : 0,
                    authors: authorIds
                    // AIæ‘˜è¦ç›¸å…³å­—æ®µé€šè¿‡å•ç‹¬çš„â€œä¿å­˜æ‘˜è¦â€æŒ‰é’®å¤„ç†
                };

                const loadingIndex = layer.msg('ä¿å­˜ä¸­...', {icon: 16, shade: 0.3, time: 0});

                // å‘é€åˆ°æœåŠ¡å™¨ä¿å­˜
                fetch('/app/admin/editor/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                    },
                    body: JSON.stringify(saveData)
                })
                    .then(response => response.json())
                    .then(data => {
                        layer.close(loadingIndex);
                        if (data.code === 0) {
                            const statusText = targetStatus === 'published' ? 'å‘å¸ƒ' : 'ä¿å­˜';
                            layer.msg(statusText + 'æˆåŠŸ', {icon: 1});
                            updateLastSaved(new Date());
                            if (!postId) {
                                postId = data.data.id;
                                pageTitle.textContent = `ç¼–è¾‘æ–‡ç« : ${postTitle.value}`;
                            }
                            // æ›´æ–°çŠ¶æ€é€‰æ‹©å™¨
                            postStatus.value = targetStatus;
                        } else {
                            layer.msg('ä¿å­˜å¤±è´¥: ' + (data.msg || 'æœªçŸ¥é”™è¯¯'), {icon: 5});
                        }
                    })
                    .catch(error => {
                        layer.close(loadingIndex);
                        layer.msg('ä¿å­˜å¤±è´¥: ' + error.message, {icon: 5});
                    });
            }
        }

        // æ¸…é™¤ç¼“å­˜æŒ‰é’®äº‹ä»¶
        document.getElementById('clear-btn').addEventListener('click', function () {
            if (confirm('ç¡®å®šè¦æ¸…é™¤è‡ªåŠ¨ä¿å­˜çš„å†…å®¹å—ï¼Ÿ')) {
                try {
                    // 1. ä½¿ç”¨Vditorå†…ç½®çš„æ¸…é™¤ç¼“å­˜æ–¹æ³•
                    if (vditor && typeof vditor.clearCache === 'function') {
                        vditor.clearCache();
                    }

                    // 2. æ‰‹åŠ¨æ¸…ç†localStorageä¸­ä¸å½“å‰ç¼–è¾‘å™¨ç›¸å…³çš„ç¼“å­˜
                    clearLocalCache();

                    alert('å·²æ¸…é™¤è‡ªåŠ¨ä¿å­˜çš„å†…å®¹');
                } catch (error) {
                    console.error('æ¸…é™¤ç¼“å­˜æ—¶å‡ºé”™:', error);
                    alert('æ¸…é™¤ç¼“å­˜å¤±è´¥: ' + error.message);
                }
            }
        });

        // å¤šä½œè€…é€‰æ‹©åŠŸèƒ½
        let selectedAuthors = [];
        let allAuthors = [];

        // åˆå§‹åŒ–ä½œè€…é€‰æ‹©å™¨
        function initAuthorsSelector() {
            const authorsSelect = document.getElementById('authors-select');
            const authorsDropdown = document.getElementById('authors-dropdown');
            const authorsSearch = document.getElementById('authors-search');
            const authorsList = document.getElementById('authors-list');

            if (!authorsSelect || !authorsDropdown) return;

            // ç‚¹å‡»è¾“å…¥æ¡†æ˜¾ç¤º/éšè—ä¸‹æ‹‰æ¡†
            authorsSelect.addEventListener('click', function (e) {
                e.stopPropagation();
                authorsDropdown.classList.toggle('hidden');
                if (!authorsDropdown.classList.contains('hidden')) {
                    authorsSearch.focus();
                    loadAuthorsList();
                }
            });

            // æœç´¢åŠŸèƒ½
            let debounceTimer = null;

            authorsSearch.addEventListener('input', function () {
                // æ¯æ¬¡è¾“å…¥æ—¶å…ˆæ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                clearTimeout(debounceTimer);

                // è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼Œå»¶è¿Ÿæ‰§è¡Œè¯·æ±‚ï¼ˆè¿™é‡Œè®¾ç½®ä¸º500æ¯«ç§’ï¼Œå¯æ ¹æ®éœ€æ±‚è°ƒæ•´ï¼‰
                debounceTimer = setTimeout(() => {
                    loadAuthorsList(this.value);
                }, 500); // 500msæ˜¯ç­‰å¾…æ—¶é—´ï¼Œç”¨æˆ·åœæ­¢è¾“å…¥500msåæ‰ä¼šæ‰§è¡Œè¯·æ±‚
            });

            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰æ¡†
            document.addEventListener('click', function () {
                authorsDropdown.classList.add('hidden');
            });

            // é˜»æ­¢ä¸‹æ‹‰æ¡†å†…éƒ¨ç‚¹å‡»äº‹ä»¶å†’æ³¡
            authorsDropdown.addEventListener('click', function (e) {
                e.stopPropagation();
            });

            // åŠ è½½æ–‡ç« æ—¶è®¾ç½®å·²é€‰ä½œè€…
            if (postId > 0) {
                loadPostAuthors();
            }
        }

        // åŠ è½½ä½œè€…åˆ—è¡¨
        function loadAuthorsList(search = '') {
            const authorsList = document.getElementById('authors-list');
            if (!authorsList) return;

            authorsList.innerHTML = '<div class="p-2 text-gray-500 text-center">åŠ è½½ä¸­...</div>';

            fetch(`/app/admin/editor/authors?search=${encodeURIComponent(search)}&limit=20`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 0) {
                        allAuthors = data.data.list;
                        renderAuthorsList(allAuthors);
                    } else {
                        authorsList.innerHTML = '<div class="p-2 text-red-500 text-center">åŠ è½½å¤±è´¥</div>';
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½ä½œè€…åˆ—è¡¨å¤±è´¥:', error);
                    authorsList.innerHTML = '<div class="p-2 text-red-500 text-center">åŠ è½½å¤±è´¥</div>';
                });
        }

        // æ¸²æŸ“ä½œè€…åˆ—è¡¨
        function renderAuthorsList(authors) {
            const authorsList = document.getElementById('authors-list');
            if (!authorsList) return;

            if (authors.length === 0) {
                authorsList.innerHTML = '<div class="p-2 text-gray-500 text-center">æš‚æ— ä½œè€…</div>';
                return;
            }

            authorsList.innerHTML = '';
            authors.forEach(author => {
                const isSelected = selectedAuthors.some(a => a.id === author.id);
                const authorItem = document.createElement('div');
                if (!author.email) {
                    author.email = 'æ— é‚®ä»¶åœ°å€';
                }
                authorItem.className = `p-2 cursor-pointer hover:bg-gray-100 rounded ${isSelected ? 'bg-blue-50 text-blue-600' : ''}`;
                authorItem.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="font-medium">${author.nickname || author.username}</span>
                            <span class="text-gray-500 text-sm ml-2">${author.email}</span>
                        </div>
                        ${isSelected ? '<span class="text-blue-600">âœ“</span>' : ''}
                    </div>
                `;
                authorItem.addEventListener('click', function () {
                    toggleAuthorSelection(author);
                });
                authorsList.appendChild(authorItem);
            });
        }

        // åˆ‡æ¢ä½œè€…é€‰æ‹©çŠ¶æ€
        function toggleAuthorSelection(author) {
            const index = selectedAuthors.findIndex(a => a.id === author.id);
            if (index > -1) {
                selectedAuthors.splice(index, 1);
            } else {
                selectedAuthors.push(author);
            }
            updateAuthorsDisplay();
            renderAuthorsList(allAuthors);
        }

        // æ›´æ–°ä½œè€…æ˜¾ç¤º
        function updateAuthorsDisplay() {
            const authorsSelect = document.getElementById('authors-select');
            if (!authorsSelect) return;

            if (selectedAuthors.length === 0) {
                authorsSelect.value = '';
                authorsSelect.placeholder = 'é€‰æ‹©ä½œè€…';
            } else {
                const names = selectedAuthors.map(a => a.nickname || a.username).join(', ');
                authorsSelect.value = names;
            }
        }

        // åŠ è½½æ–‡ç« çš„ä½œè€…ä¿¡æ¯
        function loadPostAuthors() {
            if (!postId) return;

            fetch(`/app/admin/editor/post/${postId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200 && data.data && data.data.authors) {
                        selectedAuthors = data.data.authors.map(author => ({
                            id: author.id,
                            username: author.username,
                            nickname: author.nickname,
                            email: author.email
                        }));
                        updateAuthorsDisplay();
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½æ–‡ç« ä½œè€…ä¿¡æ¯å¤±è´¥:', error);
                });
        }


        // åˆå§‹åŒ–ä½œè€…é€‰æ‹©å™¨
        initAuthorsSelector();

        // AI æ‘˜è¦çŠ¶æ€æ˜¾ç¤ºæ˜ å°„
        const statusTextMap = {
            'none': 'âšª æœªç”Ÿæˆ',
            'done': 'âœ… å·²ç”Ÿæˆ',
            'failed': 'âŒ å¤±è´¥',
            'refreshing': 'ğŸ”„ åˆ·æ–°ä¸­',
            'persisted': 'ğŸ’¾ æŒä¹…åŒ–'
        };

        // AI æ‘˜è¦åˆ·æ–°åŠŸèƒ½
        let aiRefreshInterval = null;
        let aiPollCount = 0; // è½®è¯¢æ¬¡æ•°è®¡æ•°å™¨
        const MAX_POLL_COUNT = 60; // æœ€å¤šè½®è¯¢60æ¬¡ï¼ˆ3åˆ†é’Ÿï¼‰

        function updateAiStatusDisplay(status) {
            const statusText = document.getElementById('ai-status-text');
            if (statusText) {
                statusText.textContent = statusTextMap[status] || statusTextMap['none'];
            }
        }

        function checkAiSummaryStatus() {
            if (!postId) return;

            fetch('/app/admin/ai/summary/status?post_id=' + postId)
                .then(r => r.json())
                .then(res => {
                    if (res && res.code === 0 && res.data) {
                        const data = res.data;
                        const summaryTextarea = document.getElementById('ai-summary');
                        const aiBtn = document.getElementById('ai-generate');
                        const aiEnabledCheckbox = document.getElementById('ai-enabled');
                        const aiPersistedCheckbox = document.getElementById('ai-persisted');

                        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                        updateAiStatusDisplay(data.status);

                        // æ›´æ–°å¯ç”¨çŠ¶æ€
                        if (aiEnabledCheckbox) {
                            aiEnabledCheckbox.checked = data.enabled || false;
                        }

                        // æ›´æ–°æŒä¹…åŒ–çŠ¶æ€
                        if (aiPersistedCheckbox) {
                            aiPersistedCheckbox.checked = (data.status === 'persisted');
                        }

                        // æ›´æ–°æ‘˜è¦å†…å®¹
                        if (summaryTextarea && data.summary) {
                            summaryTextarea.value = data.summary;
                        }

                        // æ ¹æ®çŠ¶æ€æ›´æ–°æŒ‰é’®æ–‡æœ¬
                        if (aiBtn) {
                            if (data.status === 'refreshing') {
                                aiPollCount++;

                                // æ£€æŸ¥æ˜¯å¦è¶…è¿‡æœ€å¤§è½®è¯¢æ¬¡æ•°
                                if (aiPollCount >= MAX_POLL_COUNT) {
                                    // è¶…æ—¶ï¼Œåœæ­¢è½®è¯¢å¹¶æ˜¾ç¤ºè­¦å‘Š
                                    if (aiRefreshInterval) {
                                        clearInterval(aiRefreshInterval);
                                        aiRefreshInterval = null;
                                    }
                                    aiBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i>ä»»åŠ¡è¶…æ—¶';
                                    aiBtn.disabled = false;
                                    layer.msg('ä»»åŠ¡è¶…æ—¶ï¼Œè¯·é‡è¯•æˆ–æ£€æŸ¥Workerè¿›ç¨‹', {icon: 5});
                                    aiPollCount = 0;
                                    return;
                                }

                                const elapsed = Math.floor((aiPollCount * 3) / 60);
                                const remaining = Math.max(0, 3 - elapsed);
                                aiBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>ç”Ÿæˆä¸­ (' + remaining + 'm)';
                                aiBtn.disabled = true;

                                // å¦‚æœæ­£åœ¨ç”Ÿæˆï¼Œå¯åŠ¨è½®è¯¢
                                if (!aiRefreshInterval) {
                                    aiRefreshInterval = setInterval(checkAiSummaryStatus, 3000);
                                }
                            } else {
                                aiBtn.innerHTML = '<i class="fas fa-magic mr-1"></i>ç”Ÿæˆæ‘˜è¦';
                                aiBtn.disabled = false;
                                aiPollCount = 0;
                                // åœæ­¢è½®è¯¢
                                if (aiRefreshInterval) {
                                    clearInterval(aiRefreshInterval);
                                    aiRefreshInterval = null;
                                }
                            }
                        }

                        // å¦‚æœå¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                        if (data.status === 'failed' && data.error) {
                            layer.msg('AIæ‘˜è¦ç”Ÿæˆå¤±è´¥: ' + data.error, {icon: 5, time: 5000});
                        }

                        // å¦‚æœæˆåŠŸï¼Œæ˜¾ç¤ºæç¤º
                        if (data.status === 'done' && aiPollCount > 0) {
                            layer.msg('æ‘˜è¦ç”ŸæˆæˆåŠŸ', {icon: 1});
                            aiPollCount = 0;
                        }
                    }
                })
                .catch(e => {
                    console.error('æ£€æŸ¥AIæ‘˜è¦çŠ¶æ€å¤±è´¥:', e);
                    // ç½‘ç»œé”™è¯¯ï¼Œåœæ­¢è½®è¯¢
                    if (aiRefreshInterval) {
                        clearInterval(aiRefreshInterval);
                        aiRefreshInterval = null;
                    }
                });
        }

        // AI ç”ŸæˆæŒ‰é’®
        const aiBtn = document.getElementById('ai-generate');
        if (aiBtn) {
            aiBtn.addEventListener('click', function () {
                if (!postId) {
                    layer.msg('è¯·å…ˆä¿å­˜æ–‡ç« åå†ç”ŸæˆAIæ‘˜è¦', {icon: 5});
                    return;
                }

                updateAiStatusDisplay('refreshing');

                aiBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>ç”Ÿæˆä¸­...';
                aiBtn.disabled = true;

                fetch('/app/admin/ai/summary/enqueue', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({post_id: postId, force: true})
                })
                    .then(r => r.json()).then(res => {
                    if (res.code === 0) {
                        layer.msg('å·²æäº¤ç”Ÿæˆä»»åŠ¡ï¼Œè¯·ç¨å€™...', {icon: 1});
                        // å¯åŠ¨è½®è¯¢æ£€æŸ¥çŠ¶æ€
                        if (!aiRefreshInterval) {
                            aiRefreshInterval = setInterval(checkAiSummaryStatus, 3000);
                        }
                    } else {
                        layer.msg(res.msg || 'æäº¤å¤±è´¥', {icon: 2});
                        aiBtn.innerHTML = '<i class="fas fa-magic mr-1"></i>ç”Ÿæˆæ‘˜è¦';
                        aiBtn.disabled = false;
                    }
                }).catch(e => {
                    layer.msg('è¯·æ±‚å¤±è´¥: ' + e.message, {icon: 2});
                    aiBtn.innerHTML = '<i class="fas fa-magic mr-1"></i>ç”Ÿæˆæ‘˜è¦';
                    aiBtn.disabled = false;
                });
            });
        }

        // AI ä¿å­˜æŒ‰é’®
        const aiSaveBtn = document.getElementById('ai-save');
        if (aiSaveBtn) {
            aiSaveBtn.addEventListener('click', function () {
                if (!postId) {
                    layer.msg('è¯·å…ˆä¿å­˜æ–‡ç« ', {icon: 5});
                    return;
                }

                const aiEnabled = document.getElementById('ai-enabled')?.checked || false;
                const aiPersisted = document.getElementById('ai-persisted')?.checked || false;
                const aiSummary = document.getElementById('ai-summary')?.value || '';

                // æ ¹æ®æŒä¹…åŒ–çŠ¶æ€å†³å®šçŠ¶æ€
                const status = aiPersisted ? 'persisted' : (aiSummary ? 'done' : 'none');

                const loadingIdx = layer.msg('ä¿å­˜ä¸­...', {icon: 16, shade: 0.1, time: 0});

                fetch('/app/admin/ai/summary/set-meta', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        post_id: postId,
                        enabled: aiEnabled ? 1 : 0,
                        status: status
                    })
                })
                    .then(r => r.json())
                    .then(res => {
                        layer.close(loadingIdx);
                        if (res.code === 0) {
                            layer.msg('ä¿å­˜æˆåŠŸ', {icon: 1});
                            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                            updateAiStatusDisplay(status);
                        } else {
                            layer.msg(res.msg || 'ä¿å­˜å¤±è´¥', {icon: 2});
                        }
                    })
                    .catch(e => {
                        layer.close(loadingIdx);
                        layer.msg('è¯·æ±‚å¤±è´¥: ' + e.message, {icon: 2});
                    });
            });
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ä¸€æ¬¡çŠ¶æ€
        if (postId > 0) {
            setTimeout(checkAiSummaryStatus, 1000);
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†è½®è¯¢
        window.addEventListener('beforeunload', function () {
            if (aiRefreshInterval) {
                clearInterval(aiRefreshInterval);
                aiRefreshInterval = null;
            }
        });

        // å¯è§æ€§å­—æ®µå˜åŒ–ç›‘å¬ï¼Œæ˜¾ç¤º/éšè—å¯†ç è¾“å…¥æ¡†
        if (postVisibility && passwordField) {
            postVisibility.addEventListener('change', function () {
                if (this.value === 'password') {
                    passwordField.classList.remove('hidden');
                } else {
                    passwordField.classList.add('hidden');
                }
            });
        }

        // æ¸…é™¤localStorageä¸­ä¸å½“å‰ç¼–è¾‘å™¨ç›¸å…³çš„ç¼“å­˜
        function clearLocalCache() {
            try {
                // è·å–å½“å‰ç¼–è¾‘å™¨çš„ç¼“å­˜é”®å‰ç¼€
                const cacheKey = 'vditor_cache_' + (postId || 'new_post_' + Date.now());

                // æ¸…é™¤æ‰€æœ‰åŒ¹é…çš„ç¼“å­˜é¡¹
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('vditor_cache_')) {
                        // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰ç¼–è¾‘å™¨çš„ç¼“å­˜ï¼Œæˆ–è€…æ˜¯è¿‡æœŸçš„ç¼“å­˜
                        try {
                            const value = localStorage.getItem(key);
                            const parsed = JSON.parse(value);

                            // å¦‚æœæ˜¯å½“å‰ç¼–è¾‘å™¨çš„ç¼“å­˜ï¼Œæˆ–è€…ç¼“å­˜æ—¶é—´è¶…è¿‡7å¤©ï¼Œåˆ™åˆ é™¤
                            if (key.includes(cacheKey) ||
                                (parsed.time && (Date.now() - parsed.time > 7 * 24 * 60 * 60 * 1000))) {
                                localStorage.removeItem(key);
                            }
                        } catch (e) {
                            // æ— æ•ˆçš„ç¼“å­˜æ¡ç›®ï¼Œåˆ é™¤å®ƒ
                            localStorage.removeItem(key);
                        }
                    }
                }

                console.log('å·²æ¸…ç†ç›¸å…³ç¼“å­˜');
            } catch (error) {
                console.error('æ¸…ç†localStorageç¼“å­˜æ—¶å‡ºé”™:', error);
            }
        }

        // å…¨å±€å‡½æ•°ï¼Œç¡®ä¿åª’ä½“é€‰æ‹©å™¨èƒ½è®¿é—®åˆ°
        window.selectMedia = function (media) {
            if (!media) return;
            insertMediaToEditor(media);
        };

        window.closeMediaSelector = function () {
            // æ­¤å‡½æ•°ä¸»è¦ç”¨äºiframeæ–¹å¼åµŒå…¥æ—¶çš„å…³é—­é€»è¾‘
        };

        // æ‰“å¼€åª’ä½“é€‰æ‹©å™¨å¼¹çª—
        function openMediaSelector() {
            // åˆ›å»ºä¸€ä¸ªå¼¹çª—
            const width = 900;
            const height = 600;
            const left = (window.innerWidth - width) / 2;
            const top = (window.innerHeight - height) / 2;

            // æ‰“å¼€åª’ä½“é€‰æ‹©å™¨çª—å£ï¼Œæ·»åŠ targetå‚æ•°æŒ‡æ˜æ¥æº
            const mediaWindow = window.open('/app/admin/editor/media-selector?target=window&origin=' + encodeURIComponent(window.location.href), 'media_selector',
                `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`);

            if (!mediaWindow) {
                alert('æ— æ³•æ‰“å¼€åª’ä½“é€‰æ‹©å™¨ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å¼¹çª—è®¾ç½®');
                return;
            }

            // å®šæœŸæ£€æŸ¥çª—å£æ˜¯å¦è¢«å…³é—­
            const checkInterval = setInterval(function () {
                if (mediaWindow.closed) {
                    clearInterval(checkInterval);
                }
            }, 500);
        }

        // å°†é€‰æ‹©çš„åª’ä½“æ’å…¥åˆ°ç¼–è¾‘å™¨ä¸­
        function insertMediaToEditor(media) {
            if (!vditor) {
                console.error('ç¼–è¾‘å™¨æœªåˆå§‹åŒ–');
                return;
            }

            if (!media) {
                console.error('åª’ä½“æ•°æ®ä¸ºç©º');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æ˜¯å¤šé€‰æ¨¡å¼ï¼ˆmediaæ˜¯æ•°ç»„ï¼‰
            if (Array.isArray(media)) {
                // å¤šé€‰æ¨¡å¼ï¼Œéå†æ‰€æœ‰é€‰ä¸­çš„åª’ä½“
                media.forEach(item => {
                    insertSingleMedia(item);
                });
                return;
            }

            // å•é€‰æ¨¡å¼ï¼Œç›´æ¥æ’å…¥å•ä¸ªåª’ä½“
            insertSingleMedia(media);
        }

        // æ’å…¥å•ä¸ªåª’ä½“çš„è¾…åŠ©å‡½æ•°
        function insertSingleMedia(media) {
            // è·å–åª’ä½“URLï¼Œæ”¯æŒå¤šç§å¯èƒ½çš„å±æ€§å
            let mediaUrl = '';
            if (media.url) {
                mediaUrl = media.url;
            } else if (media.file_url) {
                mediaUrl = media.file_url;
            } else if (media.path) {
                mediaUrl = media.path;
            } else if (media.src) {
                mediaUrl = media.src;
            } else if (media.file_path) {
                // å…³é”®ä¿®å¤ï¼šå¦‚æœåªæœ‰file_pathï¼Œæ„å»ºå®Œæ•´çš„URL
                // æ£€æŸ¥file_pathæ˜¯å¦å·²ç»æ˜¯å®Œæ•´URL
                if (media.file_path.startsWith('http://') || media.file_path.startsWith('https://')) {
                    mediaUrl = media.file_path;
                } else {
                    // æ„å»ºå®Œæ•´URLï¼Œç¡®ä¿è·¯å¾„æ­£ç¡®
                    const basePath = media.file_path.startsWith('/') ? '' : '/';
                    mediaUrl = '/uploads' + basePath + media.file_path;
                }
            }

            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„URLï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            if (!mediaUrl) {
                console.error('æ— æ³•è·å–åª’ä½“URL', media);
                alert('æ— æ³•è·å–åª’ä½“URLï¼Œè¯·æ£€æŸ¥åª’ä½“æ–‡ä»¶æ˜¯å¦å­˜åœ¨');
                return;
            }

            // æ ¹æ®åª’ä½“ç±»å‹ç”Ÿæˆä¸åŒçš„Markdownæ ¼å¼
            let markdown = '';

            if (media.mime_type && media.mime_type.startsWith('image/')) {
                // å›¾ç‰‡ç±»å‹ï¼šä½¿ç”¨Markdownå›¾ç‰‡è¯­æ³•
                const altText = media.alt_text || media.original_name || 'å›¾ç‰‡';
                markdown = `![${altText}](${mediaUrl})`;
            } else if (media.mime_type && media.mime_type.startsWith('video/')) {
                // è§†é¢‘ç±»å‹ï¼šä½¿ç”¨HTMLè§†é¢‘æ ‡ç­¾
                markdown = `<video src="${mediaUrl}" controls></video>`;
            } else if (media.mime_type && media.mime_type.startsWith('audio/')) {
                // éŸ³é¢‘ç±»å‹ï¼šä½¿ç”¨HTMLéŸ³é¢‘æ ‡ç­¾
                markdown = `<audio src="${mediaUrl}" controls></audio>`;
            } else {
                // å…¶ä»–ç±»å‹ï¼šä½¿ç”¨Markdowné“¾æ¥è¯­æ³•
                const fileName = media.original_name || 'æ–‡ä»¶';
                markdown = `[${fileName}](${mediaUrl})`;
            }

            // æ’å…¥åˆ°ç¼–è¾‘å™¨
            try {
                vditor.insertValue(markdown);
            } catch (error) {
                console.error('æ’å…¥åª’ä½“å¤±è´¥:', error);
                alert('æ’å…¥åª’ä½“å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½layui
        layui.use(['layer'], function () {
            const layer = layui.layer;

            // ä¸ºåª’ä½“é€‰æ‹©å™¨æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼ˆä½¿ç”¨layerå¼¹çª—ï¼‰
            document.getElementById('media-selector-btn').addEventListener('click', function () {
                layer.open({
                    type: 2,
                    title: 'é€‰æ‹©åª’ä½“',
                    shadeClose: true,
                    shade: 0.3,
                    maxmin: true,
                    area: ['900px', '600px'],
                    content: '/app/admin/editor/media-selector?target=layer&origin=' + encodeURIComponent(window.location.href)
                });
            });
        });
    });
</script>
</body>
</html>
