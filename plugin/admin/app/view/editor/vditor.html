<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>数据分析</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../component/pear/css/pear.css"/>
    <link rel="stylesheet" href="../../demos/css/console2.css"/>
</head>
<body class="pear-container">
    <script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.11.0/axios.min.js"
        integrity="sha512-h9644v03pHqrIHThkvXhB2PJ8zf5E9IyVnrSfZg8Yj8k4RsO4zldcQc4Bi9iVLUCCsqNY0b4WXVV4UB+wbWENA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="/assets/css/all.min.css">
<script src="/assets/js/highlight.min.js"></script>
<link rel="stylesheet" href="/assets/css/github-dark.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vditor/3.11.1/index.min.css"
      integrity="sha512-Tj6qPPqMhdET85Eu0Hy663goieFRcOde8i0J3DT8L+wb0sSDfgzPwoAYW63yijDXFzrzxOSvPuXfjHqL07hVcg=="
      crossorigin="anonymous" referrerpolicy="no-referrer"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vditor/3.11.1/index.min.js"
        integrity="sha512-oWE+EVJHubnxaqkZy5k5ZBs/TSNarmZyNhHevcfDIqhTza3rlwj1r5Vn8E+KiUPJMmCke08/W7HpN4qj/uHwmQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vditor/3.11.1/css/content-theme/light.min.css"
      integrity="sha512-o50pASvlcfHhtl2lTNfVkSBCgBSO2YeMZmRs1F7P6dD8m6XWWRr7nx9wbum75mBfMTeU8S+OQuIfkzLbLkk/Jw=="
      crossorigin="anonymous" referrerpolicy="no-referrer"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"
        integrity="sha512-LQNxIMR5rXv7o+b1l8+N1EZMfhG7iFZ9HhnbJkTp4zjNr5Wvst75AqUeFDxeRUa7l5vEDyUiAip//r+EFLLCyA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css"
      integrity="sha512-fHwaWebuwA7NSF5Qg/af4UeDx9XqUpYpOGgubo3yWu+b2IQR4UeQwbb42Ti7gVAjNtVoI/I9TEoYeu9omwcC6g=="
      crossorigin="anonymous" referrerpolicy="no-referrer"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.9.0/mermaid.min.js"
        integrity="sha512-OAr6bl1pt/FD0oVcuPzJ9VIMso+HQhHoodVI7mnDst19p8rNkNiraPLsDCYVhit3Mjd6B7AUHFsoDhq3dDeI7g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<div class="max-w-6xl mx-auto px-4 py-8 h-full">
    <!-- 编辑器容器 -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        <!-- 标题 -->
        <h1 id="page-title" class="text-2xl font-bold text-gray-800 mb-6">文章编辑</h1>

        <!-- 操作按钮 -->
        <div class="flex flex-wrap gap-4 mb-6">
            <div class="flex-1">
                <input type="text" id="post-title" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="请输入文章标题">
            </div>
            <select id="post-status" class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="draft">草稿</option>
                <option value="published">已发布</option>
                <option value="archived">已归档</option>
            </select>
            <button id="media-selector-btn"
                    class="px-4 py-2 bg-purple-500 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50">
                选择媒体
            </button>
            <button id="preview-btn"
                    class="px-4 py-2 bg-blue-500 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                预览
            </button>
            <button id="save-btn"
                    class="px-4 py-2 bg-green-500 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50">
                保存
            </button>
            <button id="clear-btn"
                    class="px-4 py-2 bg-red-500 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">
                清除缓存
            </button>
        </div>

        <!-- 编辑器区域 -->
        <div id="vditor"></div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 状态变量
        let vditor = null;
        let isVditorReady = false;
        let isContentLoaded = false; // 标记内容是否已加载
        
        // 获取文章ID的逻辑
        // 从URL路径中提取ID，兼容多种URL格式
        let pathSegments = window.location.pathname.split('/').filter(Boolean); // 过滤掉空字符串
        let postId = 0;
        
        // 查找符合条件的ID（在vditor后面的数字，支持新的路由结构）
        for (let i = 0; i < pathSegments.length; i++) {
            if (pathSegments[i] === 'vditor' && i + 1 < pathSegments.length) {
                const potentialId = pathSegments[i + 1];
                if (!isNaN(parseInt(potentialId))) {
                    postId = parseInt(potentialId);
                    break;
                }
            }
        }
        
        // 兼容性处理：如果在vditor后面没找到ID，也检查editor后面（为了兼容旧的URL结构）
        if (postId === 0) {
            for (let i = 0; i < pathSegments.length; i++) {
                if (pathSegments[i] === 'editor' && i + 1 < pathSegments.length) {
                    const potentialId = pathSegments[i + 1];
                    if (!isNaN(parseInt(potentialId))) {
                        postId = parseInt(potentialId);
                        break;
                    }
                }
            }
        }
        
        // 安全性检查：确保ID是有效的正整数
        postId = postId > 0 ? postId : 0;
        
        // 获取DOM元素 - 使用防御性编程
        const postTitle = document.getElementById('post-title') || { value: '' };
        const postStatus = document.getElementById('post-status') || { value: 'draft' };
        const pageTitle = document.getElementById('page-title') || { textContent: '文章编辑' };
        let defaultContent = `# 请输入文章标题

## 章节标题

请在这里输入文章内容...

支持 Markdown 语法：

- 列表项
- 列表项
- 列表项

**粗体文本** *斜体文本* [链接文本](https://example.com)

![图片描述](https://example.com/image.jpg)

\`\`\`php
// 代码示例
function example() {
    return '代码块';
}
\`\`\``;

        // 初始化 Vditor
        console.log('初始化编辑器，当前URL:', window.location.href);
        console.log('提取的文章ID:', postId);
        
        try {
            vditor = new Vditor('vditor', {
            height: 'auto',
            minHeight: 500,
            counter: {
                enable: true,
            },
            // cdn: 'https://cdnjs.cloudflare.com/ajax/libs/vditor/3.11.1', // 无法使用cf公共cdn，没有dist目录
            mode: 'sv', // 分屏
            toolbarConfig: {
                pin: true,
            },
            comment: {
                enable: false, // 不好用
            },
            cache: {
                enable: true, // 启用localStorage缓存
                id: postId || 'new_post_' + Date.now(), // 使用文章ID或临时ID作为缓存键
                after: function(html) {
                    // 缓存后的回调函数，可以在这里添加缓存处理逻辑
                    return html;
                }
            },
            preview: {
                markdown: {
                    sanitize: true,
                },
                hljs: {
                    enable: true,
                    defaultLang: 'bash',
                    style: 'github-dark',
                    lineNumber: true,
                }
            },
            upload: {
                accept: 'image/*',
                url: '/app/admin/editor/upload-image',
                fieldName: 'image',
                max: 50 * 1024 * 1024,
                filename(name) {
                    return name.replace(/\?|\\|\/|:|\||<|>|\*|\[|\]|\s+/g, '-')
                },
                linkToImgUrl: '/app/admin/editor/upload-image',
                handler(files) {
                    const data = new FormData()
                    data.append('image', files[0])

                    fetch('/app/admin/editor/upload-image', {
                        method: 'POST',
                        body: data,
                    }).then(response => response.json()).then(data => {
                        if (data.success === 1) {
                            vditor.insertValue(`![](${data.file.url})`)
                        } else {
                            alert('图片上传失败: ' + data.message)
                        }
                    }).catch(err => {
                        alert('网络错误: ' + err)
                    })
                }
            },
            hint: {
                // emojiPath: 'https://cdn.jsdelivr.net/npm/vditor/dist/images/emoji',
                emoji: {
                    "+1": "👍",
                    "-1": "👎",
                    "heart": "❤️",
                    "smile": "😄",
                    "laughing": "😆",
                    "smirk": "😏",
                    "expressionless": "😑",
                    "tired_face": "😫",
                    "sleeping": "😴",
                    "flushed": "😳",
                    "scream": "😱",
                    "rage": "😡",
                    "smiling_imp": "😈",
                    "sunglasses": "😎",
                    "thumbsup": "👍",
                    "thumbsdown": "👎",
                    "ok_hand": "👌",
                    "punch": "👊",
                    "wave": "👋",
                    "clap": "👏",
                    "open_hands": "👐",
                    "pray": "🙏",
                    "eyes": "👀",
                    "zzz": "💤",
                    "poop": "💩",
                    "muscle": "💪",
                    "trumpet": "🎺",
                    "cake": "🍰",
                    "coffee": "☕",
                    "bomb": "💣",
                    "gem": "💎",
                    "ring": "💍",
                    "rocket": "🚀",
                    "train": "🚋",
                    "bike": "🚲",
                    "bus": "🚌",
                    "airplane": "✈️",
                    "rocket2": "🚀",
                    "moon": "🌙",
                    "star2": "🌟",
                    "sunny": "☀️",
                    "rainbow": "🌈",
                    "snowman": "⛄",
                    "zap": "⚡",
                    "fire": "🔥",
                    "ghost": "👻",
                    "alien": "👽",
                    "robot": "🤖",
                    "skull": "💀",
                    "heart_eyes": "😍",
                    "kiss": "😘",
                    "sweat": "😓",
                    "sob": "😭",
                    "joy": "😂",
                    "tongue": "😛",
                    "v": "✌️",
                    "santa": "🎅",
                    "christmas_tree": "🎄",
                    "gift": "🎁",
                    "jack_o_lantern": "🎃",
                    "bamboo": "🎍",
                    "grapes": "🍇",
                    "watermelon": "🍉",
                    "ramen": "🍜",
                    "soccer": "⚽",
                    "football": "🏈",
                    "basketball": "🏀",
                    "dart": "🎯",
                    "slot_machine": "🎰",
                    "8ball": "🎱",
                    "game_die": "🎲",
                    "spades": "♠️",
                    "clubs": "♣️",
                    "hearts": "♥️",
                    "diamonds": "♦️",
                    "clubhouse": "🛖",
                    "house": "🏠",
                    "city_sunrise": "🌇",
                    "bridge_at_night": "🌉",
                    "ferris_wheel": "🎡",
                    "roller_coaster": "🎢",
                    "ship": "🚢",
                    "speedboat": "🚤",
                    "sailboat": "⛵",
                    "anchor": "⚓",
                    "rocketship": "🚀",
                    "flying_saucer": "🛸",
                    "helicopter": "🚁",
                    "steam_locomotive": "🚂",
                    "car": "🚗",
                    "taxi": "🚕",
                    "busstop": "🚏",
                    "fuelpump": "⛽",
                    "rotating_light": "🚨",
                    "triangular_flag_on_post": "🚩",
                    "crossed_flags": "🎌",
                    "waving_black_flag": "🏴",
                    "waving_white_flag": "🏳️",
                    "rainbow-flag": "🏳️‍🌈",
                    "pirate_flag": "🏴‍☠️"
                }
            },
            // 添加初始化完成回调 - 直接放在顶层配置中而不是嵌套对象中
            after() {
                console.log('Vditor初始化完成，设置isVditorReady为true');
                isVditorReady = true;
                loadPostContent();
            },
            // 初始化时直接设置默认内容
            value: defaultContent
        });
        } catch (error) {
            console.error('Vditor初始化失败:', error);
            // 即使初始化失败也尝试设置isVditorReady为true，以便继续流程
            setTimeout(() => {
                isVditorReady = true;
                loadPostContent();
            }, 1000);
        }

        // 新建文章时，设置标题为"未命名+时间戳短哈希"
        if (!postId) {
            // 生成时间戳短哈希（基于当前时间戳的简单哈希）
            const timestamp = Date.now();
            // 简单哈希函数：将时间戳转为16进制并取后6位
            const shortHash = timestamp.toString(16).slice(-6);
            postTitle.value = `未命名${shortHash}`;
            pageTitle.textContent = '新建文章';
            // 确保新建文章时显示预置内容
            if (vditor && typeof vditor.setValue === 'function') {
                // 使用setTimeout确保在Vditor完全初始化后再设置内容
                setTimeout(() => {
                    vditor.setValue(defaultContent);
                }, 100);
            }
        } else {
            // 备选方案：确保文章内容被加载，不管是通过主回调还是手动调用
            // 添加防抖检查，避免重复加载
            setTimeout(() => {
                console.log('备选方案：尝试确保内容加载，postId:', postId, 'isVditorReady:', isVditorReady, 'isContentLoaded:', isContentLoaded);
                // 只检查内容是否已加载，而不依赖isVditorReady的状态
                if (!isContentLoaded) {
                    // 如果Vditor实例已存在但isVditorReady为false，尝试强制设置
                    if (vditor && !isVditorReady) {
                        console.log('备选方案：Vditor实例已存在但isVditorReady为false，尝试强制设置并调用loadPostContent');
                        isVditorReady = true;
                    }
                    // 无论如何都尝试调用loadPostContent，它内部会进行防抖检查
                    loadPostContent();
                } else {
                    console.log('备选方案：内容已加载，无需重复调用loadPostContent');
                }
            }, 1000); // 延迟1秒后执行
        }

        // 加载文章内容函数 - 添加防抖机制
        function loadPostContent() {
            console.log('开始加载文章内容，postId:', postId, 'isVditorReady:', isVditorReady, 'isContentLoaded:', isContentLoaded);
            // 防抖检查：如果内容已加载，则不再重复加载
            if (isContentLoaded) {
                console.log('内容已加载，跳过重复加载');
                return;
            }
            
            if (postId && isVditorReady) {
                // 编辑模式，从API获取文章内容 - 修正URL以匹配路由配置
                const apiUrl = `/api/v1/post/${postId}`;
                console.log('准备发送API请求，URL:', apiUrl);
                // 添加重试计数和最大重试次数
                let retryCount = 0;
                const maxRetries = 2;
                
                function fetchWithRetry() {
                    fetch(apiUrl)
                        .then(response => {
                            console.log('API响应状态:', response.status, response.ok);
                            if (!response.ok) {
                                throw new Error(`HTTP错误! 状态码: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('API返回数据:', data);
                            console.log('数据结构检查:', 'code=' + data.code, 'data=' + (data.data ? '存在' : '不存在'));
                            console.log('标题字段检查:', 'data.data.title=' + (data.data && data.data.title ? data.data.title : '不存在或为空'));
                            
                            if (data.code === 200 && data.data) {
                            // 标记内容已加载，防止重复加载
                            isContentLoaded = true;
                            console.log('API数据加载成功，设置isContentLoaded为true');
                            
                            // 确保直接获取DOM元素而不是依赖变量引用
                            const titleInput = document.getElementById('post-title') || { value: '' };
                            const statusSelect = document.getElementById('post-status') || { value: 'draft' };
                            const pageTitleElem = document.getElementById('page-title') || { textContent: '文章编辑' };
                            
                            if (titleInput && typeof titleInput.value !== 'undefined') {
                                // 确保标题值被正确设置
                                console.log('尝试设置标题，data.data.title值:', data.data.title);
                                titleInput.value = data.data.title || '';
                                console.log('标题已设置:', titleInput.value);
                            } else {
                                console.error('无法找到或操作post-title元素');
                            }
                            
                            if (statusSelect && typeof statusSelect.value !== 'undefined') {
                                // 设置文章状态
                                statusSelect.value = data.data.status || 'draft';
                            }
                            
                            if (pageTitleElem && typeof pageTitleElem.textContent !== 'undefined') {
                                // 设置页面标题
                                pageTitleElem.textContent = `编辑文章: ${data.data.title || '未命名'}`;
                            }
                            
                            // 确保vditor已初始化完成再设置值
                            if (vditor && typeof vditor.setValue === 'function') {
                                try {
                                    // 只在有实际内容时设置值，确保标题能够正确加载
                                    if (data.data.content && data.data.content.trim()) {
                                        vditor.setValue(data.data.content);
                                    } else {
                                        vditor.setValue(defaultContent);
                                    }
                                } catch (error) {
                                    console.error('设置Vditor内容失败:', error);
                                }
                            } else {
                                console.warn('Vditor未完全初始化或setValue方法不可用');
                                // 如果Vditor不可用，尝试备用方案（如果有）
                            }
                        } else {
                            console.error('API逻辑错误:', data.message || '未知错误');
                            showUserNotification('加载文章失败: ' + (data.message || '未知错误'), 'error');
                            if (vditor && typeof vditor.setValue === 'function') {
                                vditor.setValue(defaultContent);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('API请求失败:', error);
                        console.error('错误详情:', error.message);
                        
                        // 检查是否需要重试
                        if (retryCount < maxRetries && (error.message.includes('NetworkError') || error.message.includes('Failed to fetch'))) {
                            retryCount++;
                            console.log(`尝试重试API请求 (${retryCount}/${maxRetries})...`);
                            // 指数退避策略，等待一段时间后重试
                            setTimeout(fetchWithRetry, 1000 * Math.pow(2, retryCount - 1));
                        } else {
                            showUserNotification('加载文章失败，请检查网络连接', 'error');
                            if (vditor && typeof vditor.setValue === 'function') {
                                vditor.setValue(defaultContent);
                            }
                        }
                    });
                }
                
                // 开始首次请求
                fetchWithRetry();
            } else if (isVditorReady && !postId) {
                // 创建模式，确保显示预置提示文本
                if (vditor && typeof vditor.setValue === 'function') {
                    vditor.setValue(defaultContent);
                }
            }
        }

        // 显示用户通知的辅助函数
        function showUserNotification(message, type = 'info') {
            try {
                // 尝试使用更好的通知方式而不是alert
                if (typeof window.Toast !== 'undefined') {
                    window.Toast[type === 'error' ? 'error' : 'info'](message);
                } else if (typeof window.notification !== 'undefined') {
                    window.notification.show(message, type);
                } else {
                    // 回退到标准alert
                    alert(message);
                }
            } catch (e) {
                // 确保通知函数本身不会抛出异常
                console.error('显示通知失败:', e);
                alert(message);
            }
        }
        
        // 预览按钮事件
        document.getElementById('preview-btn').addEventListener('click', function () {
            if (vditor && typeof vditor.preview === 'function') {
                vditor.preview();
            }
        });

        // 保存按钮事件
        document.getElementById('save-btn').addEventListener('click', function () {
            if (vditor) {
                // 验证数据
                if (!postTitle.value.trim()) {
                    alert('请输入文章标题');
                    postTitle.focus();
                    return;
                }
                
                if (!vditor.getValue().trim()) {
                    alert('请输入文章内容');
                    return;
                }
                
                // 发送到服务器保存
                    fetch('/app/admin/editor/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                    },
                    body: JSON.stringify({
                        post_id: postId,
                        title: postTitle.value.trim(),
                        content: vditor.getValue(),
                        status: postStatus.value
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        // 根据后端返回的code来判断保存是否成功
                        // code=0表示成功，code=1表示失败
                        if (data.code === 0) {
                            alert('保存成功');
                            // 如果是新建文章，获取返回的ID
                            if (!postId) {
                                postId = data.data.id;
                                pageTitle.textContent = `编辑文章: ${postTitle.value}`;
                                // 可以选择跳转到编辑页面或继续编辑
                                // window.location.href = `/app/admin/posts/editor/${postId}`;
                            }
                        } else {
                            // 显示错误信息
                            alert('保存失败: ' + (data.msg || '未知错误'));
                        }
                    })
                    .catch(error => {
                        alert('保存失败: ' + error.message);
                    });
            }
        });

        // 清除缓存按钮事件
        document.getElementById('clear-btn').addEventListener('click', function () {
            if (confirm('确定要清除自动保存的内容吗？')) {
                try {
                    // 1. 使用Vditor内置的清除缓存方法
                    if (vditor && typeof vditor.clearCache === 'function') {
                        vditor.clearCache();
                    }
                    
                    // 2. 手动清理localStorage中与当前编辑器相关的缓存
                    clearLocalCache();
                    
                    alert('已清除自动保存的内容');
                } catch (error) {
                    console.error('清除缓存时出错:', error);
                    alert('清除缓存失败: ' + error.message);
                }
            }
        });
        
        // 清除localStorage中与当前编辑器相关的缓存
        function clearLocalCache() {
            try {
                // 获取当前编辑器的缓存键前缀
                const cacheKey = 'vditor_cache_' + (postId || 'new_post_' + Date.now());
                
                // 清除所有匹配的缓存项
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('vditor_cache_')) {
                        // 检查是否是当前编辑器的缓存，或者是过期的缓存
                        try {
                            const value = localStorage.getItem(key);
                            const parsed = JSON.parse(value);
                            
                            // 如果是当前编辑器的缓存，或者缓存时间超过7天，则删除
                            if (key.includes(cacheKey) || 
                                (parsed.time && (Date.now() - parsed.time > 7 * 24 * 60 * 60 * 1000))) {
                                localStorage.removeItem(key);
                            }
                        } catch (e) {
                            // 无效的缓存条目，删除它
                            localStorage.removeItem(key);
                        }
                    }
                }
                
                console.log('已清理相关缓存');
            } catch (error) {
                console.error('清理localStorage缓存时出错:', error);
            }
        }
        
        // 全局函数，确保媒体选择器能访问到
        window.selectMedia = function(media) {
            if (!media) return;
            insertMediaToEditor(media);
        };
        
        window.closeMediaSelector = function() {
            // 此函数主要用于iframe方式嵌入时的关闭逻辑
        };
        
        // 打开媒体选择器弹窗
        function openMediaSelector() {
            // 创建一个弹窗
            const width = 900;
            const height = 600;
            const left = (window.innerWidth - width) / 2;
            const top = (window.innerHeight - height) / 2;
            
            // 打开媒体选择器窗口，添加target参数指明来源
            const mediaWindow = window.open('/app/admin/editor/media-selector?target=window&origin=' + encodeURIComponent(window.location.href), 'media_selector', 
                `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`);
            
            if (!mediaWindow) {
                alert('无法打开媒体选择器，请检查浏览器弹窗设置');
                return;
            }
            
            // 定期检查窗口是否被关闭
            const checkInterval = setInterval(function() {
                if (mediaWindow.closed) {
                    clearInterval(checkInterval);
                }
            }, 500);
        }
        
        // 将选择的媒体插入到编辑器中
        function insertMediaToEditor(media) {
            if (!vditor) {
                console.error('编辑器未初始化');
                return;
            }
            
            if (!media) {
                console.error('媒体数据为空');
                return;
            }
            
            // 检查是否是多选模式（media是数组）
            if (Array.isArray(media)) {
                // 多选模式，遍历所有选中的媒体
                media.forEach(item => {
                    insertSingleMedia(item);
                });
                return;
            }
            
            // 单选模式，直接插入单个媒体
            insertSingleMedia(media);
        }
        
        // 插入单个媒体的辅助函数
        function insertSingleMedia(media) {
            // 获取媒体URL，支持多种可能的属性名
            let mediaUrl = '';
            if (media.url) {
                mediaUrl = media.url;
            } else if (media.file_url) {
                mediaUrl = media.file_url;
            } else if (media.path) {
                mediaUrl = media.path;
            } else if (media.src) {
                mediaUrl = media.src;
            } else if (media.file_path) {
                // 关键修复：如果只有file_path，构建完整的URL
                // 检查file_path是否已经是完整URL
                if (media.file_path.startsWith('http://') || media.file_path.startsWith('https://')) {
                    mediaUrl = media.file_path;
                } else {
                    // 构建完整URL，确保路径正确
                    const basePath = media.file_path.startsWith('/') ? '' : '/';
                    mediaUrl = '/uploads' + basePath + media.file_path;
                }
            }
            
            // 如果没有找到有效的URL，显示错误信息
            if (!mediaUrl) {
                console.error('无法获取媒体URL', media);
                alert('无法获取媒体URL，请检查媒体文件是否存在');
                return;
            }
            
            // 根据媒体类型生成不同的Markdown格式
            let markdown = '';
            
            if (media.mime_type && media.mime_type.startsWith('image/')) {
                // 图片类型：使用Markdown图片语法
                const altText = media.alt_text || media.original_name || '图片';
                markdown = `![${altText}](${mediaUrl})`;
            } else if (media.mime_type && media.mime_type.startsWith('video/')) {
                // 视频类型：使用HTML视频标签
                markdown = `<video src="${mediaUrl}" controls></video>`;
            } else if (media.mime_type && media.mime_type.startsWith('audio/')) {
                // 音频类型：使用HTML音频标签
                markdown = `<audio src="${mediaUrl}" controls></audio>`;
            } else {
                // 其他类型：使用Markdown链接语法
                const fileName = media.original_name || '文件';
                markdown = `[${fileName}](${mediaUrl})`;
            }
            
            // 插入到编辑器
            try {
                vditor.insertValue(markdown);
            } catch (error) {
                console.error('插入媒体失败:', error);
                alert('插入媒体失败: ' + error.message);
            }
        }
        
        // 为媒体选择器按钮绑定点击事件
        document.getElementById('media-selector-btn').addEventListener('click', function() {
            openMediaSelector();
        });
    });
</script>
</body>
</html>
