<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <title>侧边栏管理</title>
    <link rel="stylesheet" href="/app/admin/component/pear/css/pear.css" />
    <link rel="stylesheet" href="/app/admin/admin/css/reset.css" />
    <link rel="stylesheet" href="/app/admin/component/layui/css/layui.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/themes/base/jquery-ui.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>
    <style>
        /* 侧边栏管理样式 */
        .sidebar-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .widget-area {
            flex: 1;
            min-height: 500px;
            border: 1px dashed #dcdcdc;
            border-radius: 4px;
            padding: 10px;
            background-color: #f8f8f8;
        }
        .available-widgets {
            width: 280px;
            border: 1px solid #dcdcdc;
            border-radius: 4px;
            background-color: #ffffff;
        }
        .widget {
            margin-bottom: 15px;
            border: 1px solid #e6e6e6;
            border-radius: 4px;
            background-color: #ffffff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .widget-header {
            padding: 10px 15px;
            background-color: #f2f2f2;
            border-bottom: 1px solid #e6e6e6;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .widget-content {
            padding: 15px;
        }
        .available-widget-item {
            padding: 10px 15px;
            border-bottom: 1px solid #f2f2f2;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .available-widget-item:hover {
            background-color: #f2f2f2;
        }
        .available-widget-item:last-child {
            border-bottom: none;
        }
        .widget-tools {
            display: flex;
            gap: 5px;
        }
        .widget-tool-btn {
            color: #999;
            cursor: pointer;
        }
        .widget-tool-btn:hover {
            color: #666;
        }
        .page-selector {
            margin-bottom: 20px;
        }
        .widget-edit-form {
            display: none;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 1px solid #f2f2f2;
        }
        .save-section {
            margin-top: 20px;
            text-align: right;
        }
        .widget-active {
            border-left: 3px solid #1aa094;
        }
        .widget-disabled {
            opacity: 0.6;
        }
        .widget-title-input {
            width: 100%;
            padding: 5px 10px;
            border: 1px solid #dcdcdc;
            border-radius: 4px;
        }
        .available-widgets-header {
            padding: 10px 15px;
            background-color: #f2f2f2;
            border-bottom: 1px solid #e6e6e6;
            font-weight: bold;
        }
        .available-widgets-content {
            max-height: 600px;
            overflow-y: auto;
        }
        .sortable-placeholder {
            background-color: #f0f9ff;
            border: 2px dashed #409eff;
            height: 80px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
    </style>
</head>
<body class="pear-container">
    <div class="layui-card">
        <div class="layui-card-header">
            <h3>侧边栏管理</h3>
        </div>
        <div class="layui-card-body">
            <!-- 页面选择器 -->
            <div class="page-selector">
                <div class="layui-form">
                    <div class="layui-form-item">
                        <label class="layui-form-label">选择页面：</label>
                        <div class="layui-input-block">
                            <select id="page-select" lay-filter="page-select" class="layui-select">
                                <!-- 页面列表将通过JavaScript动态加载 -->
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 侧边栏容器 -->
            <div class="sidebar-container">
                <!-- 侧边栏小工具区域 -->
                <div class="widget-area" id="sidebar-widgets">
                    <!-- 小工具将通过JavaScript动态加载 -->
                </div>

                <!-- 可用小工具区域 -->
                <div class="available-widgets">
                    <div class="available-widgets-header">
                        可用小工具
                    </div>
                    <div class="available-widgets-content" id="available-widgets">
                        <!-- 可用小工具将通过JavaScript动态加载 -->
                    </div>
                </div>
            </div>

            <!-- 保存按钮 -->
            <div class="save-section">
                <button class="pear-btn pear-btn-primary" id="save-sidebar">保存配置</button>
            </div>
        </div>
    </div>

    <script src="/app/admin/component/layui/layui.js?v=2.8.12"></script>
    <script src="/app/admin/component/pear/pear.js"></script>
    <script src="/app/admin/admin/js/permission.js"></script>
    <script src="/app/admin/admin/js/common.js"></script>

    <script>
layui.use(['jquery', 'layer', 'form'], function() {
    var $ = layui.jquery;
    var layer = layui.layer;
    var form = layui.form;
    
    // 当前选中的页面
    var currentPageKey = 'default';
    // 当前侧边栏配置
    var currentSidebarConfig = { widgets: [] };
    // 可用小工具列表
    var availableWidgets = [];
    // 当前编辑的小工具ID
    var currentEditWidgetId = null;
    
    // 初始化页面
    $(document).ready(function() {
        initPage();
        bindEvents();
    });
    
    // 初始化页面
    function initPage() {
        loadPages();
        loadAvailableWidgets();
    }
    
    // 绑定事件
    function bindEvents() {
        // 页面选择事件
        form.on('select(page-select)', function(data) {
            currentPageKey = data.value;
            loadSidebarConfig(currentPageKey);
        });
        
        // 保存配置事件
        $('#save-sidebar').on('click', saveSidebarConfig);
        
        // 可用小工具点击事件
        $(document).on('click', '.available-widget-item', function() {
            var widgetType = $(this).data('type');
            addWidgetToSidebar(widgetType);
        });
        
        // 小工具操作事件
        $(document).on('click', '.widget-edit-btn', function() {
            var widgetId = $(this).closest('.widget').data('id');
            editWidget(widgetId);
        });
        
        $(document).on('click', '.widget-delete-btn', function() {
            var widgetId = $(this).closest('.widget').data('id');
            deleteWidget(widgetId);
        });
        
        $(document).on('click', '.widget-toggle-btn', function() {
            var widgetId = $(this).closest('.widget').data('id');
            toggleWidget(widgetId);
        });
        
        // 表单提交事件
        $(document).on('submit', '.widget-edit-form', function(e) {
            e.preventDefault();
            saveWidgetConfig();
        });
        
        // 初始化拖拽功能
        initDragAndDrop();
    }
    
    // 加载页面列表
    function loadPages() {
        $.ajax({
            url: '/app/admin/sidebar/getPages',
            type: 'GET',
            success: function(res) {
                if (res.code === 0) {
                    var selectHtml = '';
                    $.each(res.data, function(index, page) {
                        selectHtml += '<option value="' + page.key + '">' + page.name + '</option>';
                    });
                    $('#page-select').html(selectHtml);
                    form.render('select');
                    
                    // 默认加载第一个页面的配置
                    if (res.data.length > 0) {
                        currentPageKey = res.data[0].key;
                        loadSidebarConfig(currentPageKey);
                    }
                }
            }
        });
    }
    
    // 加载可用小工具列表
    function loadAvailableWidgets() {
        $.ajax({
            url: '/app/admin/sidebar/getAvailableWidgets',
            type: 'GET',
            success: function(res) {
                if (res.code === 0) {
                    availableWidgets = res.data;
                    renderAvailableWidgets();
                }
            }
        });
    }
    
    // 渲染可用小工具列表
    function renderAvailableWidgets() {
        var html = '';
        $.each(availableWidgets, function(index, widget) {
            html += '<div class="available-widget-item" data-type="' + widget.type + '">';
            html += '<strong>' + widget.name + '</strong>';
            html += '<div class="text-muted" style="font-size: 12px; color: #666;">' + (widget.description || '') + '</div>';
            html += '</div>';
        });
        $('#available-widgets').html(html);
    }
    
    // 加载侧边栏配置
    function loadSidebarConfig(pageKey) {
        $.ajax({
            url: '/app/admin/sidebar/getSidebar',
            type: 'GET',
            data: { page_key: pageKey },
            success: function(res) {
                if (res.code === 0) {
                    currentSidebarConfig = res.data;
                    renderSidebarWidgets();
                }
            }
        });
    }
    
    // 渲染侧边栏小工具
    function renderSidebarWidgets() {
        var html = '';
        if (currentSidebarConfig.widgets && currentSidebarConfig.widgets.length > 0) {
            $.each(currentSidebarConfig.widgets, function(index, widget) {
                html += renderWidgetHtml(widget);
            });
        } else {
            html = '<div class="text-center text-muted" style="padding: 40px;">';
            html += '<i class="layui-icon layui-icon-face-smile" style="font-size: 48px;"></i>';
            html += '<p>暂无小工具，请从右侧添加</p>';
            html += '</div>';
        }
        $('#sidebar-widgets').html(html);
        
        // 重新初始化拖拽
        initDragAndDrop();
    }
    
    // 渲染单个小工具HTML
    function renderWidgetHtml(widget) {
        var isEnabled = widget.enabled !== false;
        var widgetClass = 'widget';
        if (!isEnabled) widgetClass += ' widget-disabled';
        if (currentEditWidgetId === widget.id) widgetClass += ' widget-active';
        
        var html = '<div class="' + widgetClass + '" data-id="' + widget.id + '">';
        html += '<div class="widget-header">';
        html += '<span class="widget-title">' + (widget.title || '未命名小工具') + '</span>';
        html += '<div class="widget-tools">';
        html += '<span class="widget-tool-btn widget-toggle-btn" title="' + (isEnabled ? '禁用' : '启用') + '">';
        html += '<i class="layui-icon ' + (isEnabled ? 'layui-icon-ok' : 'layui-icon-close') + '"></i>';
        html += '</span>';
        html += '<span class="widget-tool-btn widget-edit-btn" title="编辑">';
        html += '<i class="layui-icon layui-icon-edit"></i>';
        html += '</span>';
        html += '<span class="widget-tool-btn widget-delete-btn" title="删除">';
        html += '<i class="layui-icon layui-icon-delete"></i>';
        html += '</span>';
        html += '</div>';
        html += '</div>';
        html += '<div class="widget-content">';
        html += '<p class="text-muted">类型: ' + (availableWidgets.find(w => w.type === widget.type)?.name || widget.type) + '</p>';
        if (widget.content) {
            html += '<div class="widget-preview">' + (widget.content.length > 100 ? widget.content.substring(0, 100) + '...' : widget.content) + '</div>';
        }
        html += '</div>';
        
        // 编辑表单
        html += '<div class="widget-edit-form" id="edit-form-' + widget.id + '">';
        html += renderWidgetEditForm(widget);
        html += '</div>';
        
        html += '</div>';
        
        return html;
    }
    
    // 渲染小工具编辑表单
    function renderWidgetEditForm(widget) {
        var html = '<form class="layui-form">';
        html += '<div class="layui-form-item">';
        html += '<label class="layui-form-label">标题</label>';
        html += '<div class="layui-input-block">';
        html += '<input type="text" name="title" value="' + (widget.title || '') + '" class="layui-input" placeholder="请输入小工具标题">';
        html += '</div>';
        html += '</div>';
        
        html += '<div class="layui-form-item">';
        html += '<label class="layui-form-label">启用</label>';
        html += '<div class="layui-input-block">';
        html += '<input type="checkbox" name="enabled" lay-skin="switch" lay-text="启用|禁用" ' + (widget.enabled !== false ? 'checked' : '') + '>';
        html += '</div>';
        html += '</div>';
        
        // 根据小工具类型显示不同的配置项
        if (widget.type === 'about' || widget.type === 'html') {
            html += '<div class="layui-form-item">';
            html += '<label class="layui-form-label">内容</label>';
            html += '<div class="layui-input-block">';
            html += '<textarea name="content" class="layui-textarea" placeholder="请输入内容" rows="5">' + (widget.content || '') + '</textarea>';
            html += '</div>';
            html += '</div>';
        }
        
        if (widget.type === 'recent_posts' || widget.type === 'popular_posts' || widget.type === 'random_posts') {
            html += '<div class="layui-form-item">';
            html += '<label class="layui-form-label">显示数量</label>';
            html += '<div class="layui-input-block">';
            html += '<input type="number" name="limit" value="' + (widget.limit || 5) + '" class="layui-input" min="1" max="20">';
            html += '</div>';
            html += '</div>';
        }
        
        // 高级设置 - 自定义样式
        html += '<div class="layui-form-item">';
        html += '<label class="layui-form-label">自定义样式</label>';
        html += '<div class="layui-input-block">';
        html += '<textarea name="custom_style" class="layui-textarea" placeholder="请输入自定义CSS样式" rows="3">' + (widget.custom_style || '') + '</textarea>';
        html += '</div>';
        html += '</div>';
        
        // 高级设置 - 自定义Class
        html += '<div class="layui-form-item">';
        html += '<label class="layui-form-label">自定义Class</label>';
        html += '<div class="layui-input-block">';
        html += '<input type="text" name="custom_class" value="' + (widget.custom_class || '') + '" class="layui-input" placeholder="请输入自定义CSS类名，多个用空格分隔">';
        html += '</div>';
        html += '</div>';
        
        // 高级设置 - 显示条件
        html += '<div class="layui-form-item">';
        html += '<label class="layui-form-label">显示条件</label>';
        html += '<div class="layui-input-block">';
        html += '<select name="visibility" lay-filter="visibility">';
        html += '<option value="always" ' + ((widget.visibility || 'always') === 'always' ? 'selected' : '') + '>始终显示</option>';
        html += '<option value="logged_in" ' + (widget.visibility === 'logged_in' ? 'selected' : '') + '>仅登录用户</option>';
        html += '<option value="guest" ' + (widget.visibility === 'guest' ? 'selected' : '') + '>仅访客</option>';
        html += '</select>';
        html += '</div>';
        html += '</div>';
        
        html += '<div class="layui-form-item">';
        html += '<div class="layui-input-block">';
        html += '<button class="layui-btn layui-btn-primary" type="button" onclick="hideEditForm(\'' + widget.id + '\')">取消</button>';
        html += '<button class="layui-btn" lay-submit lay-filter="widget-form">保存</button>';
        html += '</div>';
        html += '</div>';
        
        html += '</form>';
        return html;
    }
    
    // 初始化拖拽功能
    function initDragAndDrop() {
        // 使用jQuery UI的sortable实现拖拽排序
        if ($.fn.sortable) {
            $('#sidebar-widgets').sortable({
                handle: '.widget-header',
                placeholder: 'sortable-placeholder',
                tolerance: 'pointer',
                opacity: 0.7,
                revert: 150,
                update: function(event, ui) {
                    // 拖拽完成后更新小工具顺序
                    updateWidgetsOrder();
                }
            }).disableSelection();
        }
        
        // 初始化可用小工具的拖拽
        $('.available-widget-item').draggable({
            connectToSortable: '#sidebar-widgets',
            helper: 'clone',
            revert: 'invalid',
            cursor: 'move',
            start: function(event, ui) {
                $(this).addClass('dragging');
            },
            stop: function(event, ui) {
                $(this).removeClass('dragging');
                // 检查是否成功拖拽到侧边栏区域
                if (ui.helper.closest('#sidebar-widgets').length > 0) {
                    var widgetType = $(this).data('type');
                    addWidgetToSidebar(widgetType);
                }
            }
        });
    }
    
    // 更新小工具顺序
    function updateWidgetsOrder() {
        var newOrder = [];
        $('#sidebar-widgets .widget').each(function(index) {
            var widgetId = $(this).data('id');
            var widget = currentSidebarConfig.widgets.find(w => w.id === widgetId);
            if (widget) {
                newOrder.push(widget);
            }
        });
        
        currentSidebarConfig.widgets = newOrder;
    }
    
    // 添加小工具到侧边栏
    function addWidgetToSidebar(widgetType) {
        $.ajax({
            url: '/app/admin/sidebar/addWidget',
            type: 'POST',
            data: {
                page_key: currentPageKey,
                widget_type: widgetType
            },
            success: function(res) {
                if (res.code === 0) {
                    // 将新小工具添加到配置中
                    currentSidebarConfig.widgets.push(res.data);
                    renderSidebarWidgets();
                    layer.msg('添加成功');
                } else {
                    layer.msg(res.msg || '添加失败');
                }
            }
        });
    }
    
    // 编辑小工具
    function editWidget(widgetId) {
        // 隐藏其他编辑表单
        $('.widget-edit-form').hide();
        $('.widget').removeClass('widget-active');
        
        // 显示当前编辑表单
        $('#edit-form-' + widgetId).show();
        $('.widget[data-id="' + widgetId + '"]').addClass('widget-active');
        
        currentEditWidgetId = widgetId;
        
        // 重新渲染表单
        form.render();
    }
    
    // 隐藏编辑表单
    window.hideEditForm = function(widgetId) {
        $('#edit-form-' + widgetId).hide();
        $('.widget[data-id="' + widgetId + '"]').removeClass('widget-active');
        currentEditWidgetId = null;
    }
    
    // 保存小工具配置
    function saveWidgetConfig() {
        if (!currentEditWidgetId) return;
        
        var formData = $('#edit-form-' + currentEditWidgetId + ' form').serializeArray();
        var config = {};
        
        $.each(formData, function(index, field) {
            if (field.name === 'enabled') {
                config[field.name] = field.value === 'on';
            } else {
                config[field.name] = field.value;
            }
        });
        
        $.ajax({
            url: '/app/admin/sidebar/updateWidget',
            type: 'POST',
            data: {
                page_key: currentPageKey,
                widget_id: currentEditWidgetId,
                widget_config: config
            },
            success: function(res) {
                if (res.code === 0) {
                    // 更新本地配置
                    var widgetIndex = currentSidebarConfig.widgets.findIndex(w => w.id === currentEditWidgetId);
                    if (widgetIndex !== -1) {
                        currentSidebarConfig.widgets[widgetIndex] = {
                            ...currentSidebarConfig.widgets[widgetIndex],
                            ...config
                        };
                    }
                    
                    hideEditForm(currentEditWidgetId);
                    renderSidebarWidgets();
                    layer.msg('保存成功');
                } else {
                    layer.msg(res.msg || '保存失败');
                }
            }
        });
    }
    
    // 删除小工具
    function deleteWidget(widgetId) {
        layer.confirm('确定要删除这个小工具吗？', function(index) {
            $.ajax({
                url: '/app/admin/sidebar/removeWidget',
                type: 'POST',
                data: {
                    page_key: currentPageKey,
                    widget_id: widgetId
                },
                success: function(res) {
                    if (res.code === 0) {
                        // 从本地配置中移除
                        currentSidebarConfig.widgets = currentSidebarConfig.widgets.filter(w => w.id !== widgetId);
                        renderSidebarWidgets();
                        layer.msg('删除成功');
                    } else {
                        layer.msg(res.msg || '删除失败');
                    }
                }
            });
            layer.close(index);
        });
    }
    
    // 切换小工具启用状态
    function toggleWidget(widgetId) {
        var widget = currentSidebarConfig.widgets.find(w => w.id === widgetId);
        if (widget) {
            var newEnabled = !(widget.enabled !== false);
            
            $.ajax({
                url: '/app/admin/sidebar/updateWidget',
                type: 'POST',
                data: {
                    page_key: currentPageKey,
                    widget_id: widgetId,
                    widget_config: { enabled: newEnabled }
                },
                success: function(res) {
                    if (res.code === 0) {
                        widget.enabled = newEnabled;
                        renderSidebarWidgets();
                        layer.msg(newEnabled ? '已启用' : '已禁用');
                    } else {
                        layer.msg(res.msg || '操作失败');
                    }
                }
            });
        }
    }
    
    // 保存侧边栏配置
    function saveSidebarConfig() {
        // 确保顺序是最新的
        updateWidgetsOrder();
        
        $.ajax({
            url: '/app/admin/sidebar/saveSidebar',
            type: 'POST',
            data: {
                page_key: currentPageKey,
                sidebar_config: JSON.stringify(currentSidebarConfig)
            },
            success: function(res) {
                if (res.code === 0) {
                    layer.msg('保存成功');
                } else {
                    layer.msg(res.msg || '保存失败');
                }
            }
        });
    }
});
    </script>
</body>
</html>