<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <title>admin管理</title>
    <link href="/app/admin/component/layui/css/layui.css?v=2.8.12" rel="stylesheet"/>
    <link href="/app/admin/component/pear/css/pear.css" rel="stylesheet"/>
    <link href="/app/admin/admin/css/reset.css" rel="stylesheet"/>
</head>
<body class="pear-container">

<!-- 顶部查询表单 -->
<div class="layui-card">
    <div class="layui-card-body">
        <form class="layui-form top-search-from">
            <div class="layui-form-item layui-inline">
                <label class="layui-form-label"></label>
                <button class="pear-btn pear-btn-md pear-btn-primary" lay-filter="table-query" lay-submit>
                    <i class="layui-icon layui-icon-search"></i>查询
                </button>
                <button class="pear-btn pear-btn-md" lay-filter="table-reset" lay-submit type="reset">
                    <i class="layui-icon layui-icon-refresh"></i>重置
                </button>
            </div>
        </form>
    </div>
</div>

<div class="layui-card">
    <div class="layui-card-body">
        <table id="failed-media-table" lay-filter="failed-media-table"></table>
    </div>
</div>

<script id="table-toolbar" type="text/html">
    <button class="pear-btn pear-btn-primary pear-btn-md" lay-event="retryAll" permission="app.admin.table.create">
        <i class="layui-icon layui-icon-refresh"></i>重试所有失败媒体
    </button>
</script>

<script src="/app/admin/component/layui/layui.js?v=2.8.12"></script>
<script src="/app/admin/component/pear/pear.js"></script>
<script src="/app/admin/admin/js/permission.js"></script>
<script src="/app/admin/admin/js/common.js"></script>

<script id="retry-cell" type="text/html">
    <button class="pear-btn pear-btn-primary pear-btn-xs" lay-event="retry">
        <i class="layui-icon layui-icon-refresh"></i>重试
    </button>
</script>

<script id="url-cell" type="text/html">
    <a href="{{d.custom_fields.reference_info.failed_external_urls[0].url}}" target="_blank"
       class="layui-text layui-underline">{{d.custom_fields.reference_info.failed_external_urls[0].url}}</a>
</script>

<script id="error-cell" type="text/html">
    <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
         title="{{d.custom_fields.reference_info.failed_external_urls[0].error}}">
        {{d.custom_fields.reference_info.failed_external_urls[0].error}}
    </div>
</script>

<script id="retry-count-cell" type="text/html">
    {{d.custom_fields.reference_info.failed_external_urls[0].retry_count || 0}}
</script>

<script>

    // 相关接口
    const LIST_API = "/app/admin/tools/wp-import/failed-media-list";
    const RETRY_API = (id) => `/app/admin/tools/wp-import/retry-failed-media/${id}`;

    layui.use(["table", "form", "common", "popup"], function () {
        let table = layui.table;
        let form = layui.form;
        let $ = layui.$;
        let common = layui.common;

        let cols = [
            {type: "checkbox", width: 50},
            {title: "ID", field: "id", width: 80},
            {title: "原始文件名", field: "original_name"},
            {title: "失败URL", field: "custom_fields", width: 300, templet: "#url-cell"},
            {title: "错误信息", field: "custom_fields", width: 200, templet: "#error-cell"},
            {title: "重试次数", field: "custom_fields", width: 100, templet: "#retry-count-cell"},
            {title: "创建时间", field: "created_at", width: 180},
            {
                title: "操作",
                align: "center",
                width: 120,
                templet: "#retry-cell"
            }
        ];

        table.render({
            elem: "#failed-media-table",
            url: LIST_API,
            page: true,
            cols: [cols],
            skin: "line",
            size: "lg",
            toolbar: "#table-toolbar",
            defaultToolbar: [{
                title: "刷新",
                layEvent: "refresh",
                icon: "layui-icon-refresh",
            }, "filter", "print", "exports"]
        });

        table.on("tool(failed-media-table)", function (obj) {
            if (obj.event === "retry") {
                retry(obj.data.id);
            }
        });

        table.on("toolbar(failed-media-table)", function (obj) {
            if (obj.event === "retryAll") {
                retryAll();
            } else if (obj.event === "refresh") {
                refreshTable();
            }
        });

        form.on("submit(table-query)", function (data) {
            table.reload("failed-media-table", {
                page: {
                    curr: 1
                },
                where: data.field
            })
            return false;
        });

        // 查询重置：清空并刷新
        form.on("submit(table-reset)", function () {
            table.reload("failed-media-table", {
                page: {curr: 1},
                where: {}
            });
            return false;
        });

        let retry = function (id) {
            layer.confirm("确定重试该媒体?", {
                icon: 3,
                title: "提示"
            }, function (index) {
                layer.close(index);
                let loading = layer.load();
                $.ajax({
                    url: RETRY_API(id),
                    type: "post",
                    dataType: "json",
                    success: function (res) {
                        layer.close(loading);
                        if (res.code === 200 || res.code === 0) {
                            layui.popup.success("重试成功", refreshTable);
                        } else {
                            layui.popup.failure(res.msg || '重试失败');
                        }
                    },
                    error: function () {
                        layer.close(loading);
                        layui.popup.failure("请求失败");
                    }
                });
            });
        }

        let retryAll = function () {
            layer.confirm("确定重试所有失败媒体?", {
                icon: 3,
                title: "提示"
            }, function (index) {
                layer.close(index);
                // 这里可以添加重试所有的逻辑
                layui.popup.success("已开始重试所有失败媒体", refreshTable);
            });
        }

        window.refreshTable = function () {
            table.reloadData("failed-media-table", {
                scrollPos: "fixed",
                done: function (res, curr) {
                    if (curr > 1 && res.data && !res.data.length) {
                        curr = curr - 1;
                        table.reloadData("failed-media-table", {
                            page: {
                                curr: curr
                            },
                        })
                    }
                }
            });
        }
    })

</script>
</body>
</html>
