<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <title>admin管理</title>
    <link rel="stylesheet" href="/app/admin/component/layui/css/layui.css?v=2.8.12" />
    <link rel="stylesheet" href="/app/admin/component/pear/css/pear.css" />
    <link rel="stylesheet" href="/app/admin/admin/css/reset.css" />
    <style>
        /* 状态行高亮 */
        .row-status-pending { background-color: #fff7e6; }     /* 橙色浅底 */
        .row-status-processing { background-color: #e6f7ff; }  /* 蓝色浅底 */
        .row-status-completed { background-color: #f6ffed; }   /* 绿色浅底 */
        .row-status-failed { background-color: #fff1f0; }      /* 红色浅底 */
    </style>
</head>
<body class="pear-container">

<!-- 导入任务列表 -->
<div class="layui-card">
    <div class="layui-card-body">
        <!-- 顶部查询表单 -->
        <div class="layui-card">
            <div class="layui-card-body">
                <form class="layui-form top-search-from">

                    <div class="layui-form-item">
                        <label class="layui-form-label">任务名</label>
                        <div class="layui-input-block">
                            <input class="layui-input" id="name" name="name" placeholder="请输入任务名" type="text">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">状态</label>
                        <div class="layui-input-block">
                            <select id="status" name="status">
                                <option value="">全部</option>
                                <option value="pending">等待中</option>
                                <option value="processing">导入中</option>
                                <option value="completed">已完成</option>
                                <option value="failed">已失败</option>
                            </select>
                        </div>
                    </div>

                    <div class="layui-form-item layui-inline">
                        <label class="layui-form-label"></label>
                        <button class="pear-btn pear-btn-md pear-btn-primary" lay-filter="table-query" lay-submit>
                            <i class="layui-icon layui-icon-search"></i>查询
                        </button>
                        <button class="pear-btn pear-btn-md" lay-filter="table-reset" lay-submit type="reset">
                            <i class="layui-icon layui-icon-refresh"></i>重置
                        </button>
                    </div>
                    <div class="toggle-btn">
                        <a class="layui-hide">展开<i class="layui-icon layui-icon-down"></i></a>
                        <a class="layui-hide">收起<i class="layui-icon layui-icon-up"></i></a>
                    </div>

                </form>
            </div>
        </div>

        <div class="layui-card">
            <div class="layui-card-body">
                <table id="job-table" lay-filter="job-table"></table>
            </div>
        </div>
    </div>
</div>

<script type="text/html" id="table-toolbar">
    <button class="pear-btn pear-btn-primary pear-btn-md" lay-event="add" permission="app.admin.table.create">
        <i class="layui-icon layui-icon-add-1"></i>创建导入任务
    </button>
    <button class="pear-btn pear-btn-danger pear-btn-md" lay-event="batchRemove" permission="app.admin.table.drop">
        <i class="layui-icon layui-icon-delete"></i>删除导入任务
    </button>
</script>

<!-- 移除无效的操作栏 -->

<script src="/app/admin/component/layui/layui.js?v=2.8.12"></script>
<script src="/app/admin/component/pear/pear.js"></script>
<script src="/app/admin/admin/js/permission.js"></script>
<script src="/app/admin/admin/js/common.js"></script>

<script type="text/html" id="progress-cell">
    <div class="layui-progress" lay-showPercent="true" style="margin:8px 0;">
        <div class="layui-progress-bar" lay-percent="{{ d.progress || 0 }}%"></div>
    </div>
</script>

<script type="text/html" id="job-status">
    {{# if(d.status == 'pending'){ }}
    <span class="layui-badge layui-bg-orange">等待中</span>
    {{# }else if(d.status == 'processing'){ }}
    <span class="layui-badge layui-bg-blue">导入中</span>
    {{# }else if(d.status == 'completed'){ }}
    <span class="layui-badge layui-bg-green">已完成</span>
    {{# }else if(d.status == 'failed'){ }}
    <span class="layui-badge layui-bg-red">已失败</span>
    {{# }else{ }}
    <span class="layui-badge">未知</span>
    {{# } }}
</script>

<script>

    // 相关接口
    const LIST_API = "/app/admin/tools/wp-import/list";
    const CREATE_URL = "/app/admin/tools/wp-import/create";
    const DELETE_API = (id) => `/app/admin/tools/wp-import/delete/${id}`;
    const FAILED_MEDIA_LIST_API = (id) => `/app/admin/tools/wp-import/failed-media-list?id=${id}`;
    const RETRY_FAILED_MEDIA_API = (id) => `/app/admin/tools/wp-import/retry-failed-media/${id}`;

    layui.use(["table", "form", "common", "popup"], function() {
        let table = layui.table;
        let form = layui.form;
        let $ = layui.$;
        let common = layui.common;

        let cols = [
            { title: "ID", field: "id", width: 80 },
            { title: "任务名", field: "name" },
            { title: "状态", field: "status", width: 120, templet: "#job-status" },
            { title: "进度", field: "progress", width: 160, templet: "#progress-cell" },
            { title: "创建时间", field: "created_at", width: 180 },
            {
                title: "操作",
                align: "center",
                width: 180,
                templet: function(d){
                    return '<button class="pear-btn pear-btn-xs pear-btn-info tool-btn" lay-event="failed-media">失败媒体</button> ' +
                        '<button class="pear-btn pear-btn-xs tool-btn" lay-event="remove">删除</button>';
                }
            }
        ];

        table.render({
            elem: "#job-table",
            url: LIST_API,
            page: true,
            cols: [cols],
            skin: "line",
            size: "lg",
            toolbar: "#table-toolbar",
            defaultToolbar: [{
                title: "刷新",
                layEvent: "refresh",
                icon: "layui-icon-refresh",
            }, "filter", "print", "exports"],
            done: function (res) {
                var $ = layui.$;
                var trs = $('div[lay-id="job-table"] .layui-table-body tbody tr');
                trs.each(function (index) {
                    var d = res.data[index];
                    if (!d || !d.status) return;
                    var cls = '';
                    switch (d.status) {
                        case 'pending': cls = 'row-status-pending'; break;
                        case 'processing': cls = 'row-status-processing'; break;
                        case 'completed': cls = 'row-status-completed'; break;
                        case 'failed': cls = 'row-status-failed'; break;
                    }
                    if (cls) $(this).addClass(cls);
                });
            }
        });

        $(document).on("click", ".tab-link", function () {
            let obj = $(this);
            let table = obj.html();
            let url = obj.attr("src");
            parent.layui.admin.addTab(table , table + "表", url);
        })

        table.on("tool(job-table)", function(obj) {
            if (obj.event === "remove") {
                remove(obj);
            } else if (obj.event === "failed-media") {
                showFailedMedia(obj.data.id);
            }
        });

        table.on("toolbar(job-table)", function(obj) {
            if (obj.event === "add") {
                add();
            } else if (obj.event === "refresh") {
                refreshTable();
            }
        });

        form.on("submit(table-query)", function(data) {
            table.reload("job-table", {
                page: {
                    curr: 1
                },
                where: data.field
            })
            return false;
        });

        // 查询重置：清空 name/status 并刷新
        form.on("submit(table-reset)", function() {
            $('#name').val('');
            $('#status').val('');
            form.render('select');
            table.reload("job-table", {
                page: { curr: 1 },
                where: { name: '', status: '' }
            });
            return false;
        });

        let add = function() {
            layer.open({
                type: 2,
                title: "创建导入任务",
                shade: 0.1,
                maxmin: true,
                area: [common.isModile()?"100%":"98%", common.isModile()?"100%":"95%"],
                content: CREATE_URL
            });
        }

        // 移除 edit 功能

        // 移除 crud 功能

        let remove = function(obj) {
            const id = obj.data.id;
            layer.confirm("确定删除该任务?", {
                icon: 3,
                title: "提示"
            }, function(index) {
                layer.close(index);
                let loading = layer.load();
                $.ajax({
                    url: DELETE_API(id),
                    type: "post",
                    dataType: "json",
                    success: function (res) {
                        layer.close(loading);
                        if (res.code && res.code !== 200 && res.code !== 0) {
                            return layui.popup.failure(res.msg || '删除失败');
                        }
                        return layui.popup.success("操作成功", refreshTable);
                    },
                    error: function () {
                        layer.close(loading);
                        layui.popup.failure("请求失败");
                    }
                });
            });
        }

        // 失败媒体弹窗
        let failedMediaPopup = null;
        let currentJobId = null;
        let failedMediaTable = null;

        // 显示失败媒体弹窗
        let showFailedMedia = function (jobId) {
            currentJobId = jobId;

            // 创建弹窗
            failedMediaPopup = layer.open({
                type: 1,
                title: "失败媒体列表",
                shade: 0.1,
                maxmin: true,
                area: [common.isModile() ? "100%" : "90%", common.isModile() ? "100%" : "80%"],
                content: `
                <div class="layui-card" style="margin: 15px;">
                    <div class="layui-card-body">
                        <table id="failed-media-popup-table" lay-filter="failed-media-popup-table"></table>
                    </div>
                </div>
            `,
                success: function (layero, index) {
                    // 渲染失败媒体表格
                    renderFailedMediaTable();
                }
            });
        }

        // 渲染失败媒体表格
        let renderFailedMediaTable = function () {
            layui.use(["table"], function () {
                let table = layui.table;
                let $ = layui.$;

                failedMediaTable = table.render({
                    elem: "#failed-media-popup-table",
                    url: FAILED_MEDIA_LIST_API(currentJobId),
                    page: true,
                    cols: [[
                        {type: "checkbox", width: 50},
                        {title: "ID", field: "id", width: 80},
                        {title: "原始文件名", field: "original_name"},
                        {
                            title: "失败URL",
                            field: "custom_fields",
                            width: 300,
                            templet: function (d) {
                                let url = d.custom_fields?.reference_info?.failed_external_urls?.[0]?.url || '';
                                return `<a href="${url}" target="_blank" class="layui-text layui-underline">${url}</a>`;
                            }
                        },
                        {
                            title: "错误信息",
                            field: "custom_fields",
                            width: 200,
                            templet: function (d) {
                                let error = d.custom_fields?.reference_info?.failed_external_urls?.[0]?.error || '';
                                return `<div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${error}">${error}</div>`;
                            }
                        },
                        {
                            title: "重试次数",
                            field: "custom_fields",
                            width: 100,
                            templet: function (d) {
                                return d.custom_fields?.reference_info?.failed_external_urls?.[0]?.retry_count || 0;
                            }
                        },
                        {title: "创建时间", field: "created_at", width: 180},
                        {
                            title: "操作",
                            align: "center",
                            width: 120,
                            templet: function () {
                                return `<button class="pear-btn pear-btn-primary pear-btn-xs" lay-event="retry">
                                        <i class="layui-icon layui-icon-refresh"></i>重试
                                    </button>`;
                            }
                        }
                    ]],
                    skin: "line",
                    size: "lg",
                    toolbar: `
                    <div class="layui-btn-container">
                        <button class="pear-btn pear-btn-primary pear-btn-md" lay-event="retryAll">
                            <i class="layui-icon layui-icon-refresh"></i>重试所有失败媒体
                        </button>
                    </div>
                `,
                    defaultToolbar: [{
                        title: "刷新",
                        layEvent: "refresh",
                        icon: "layui-icon-refresh",
                    }, "filter", "print", "exports"]
                });

                // 监听表格工具事件
                table.on("tool(failed-media-popup-table)", function (obj) {
                    if (obj.event === "retry") {
                        retryFailedMedia(obj.data.id);
                    }
                });

                // 监听表格头部工具事件
                table.on("toolbar(failed-media-popup-table)", function (obj) {
                    if (obj.event === "retryAll") {
                        retryAllFailedMedia();
                    } else if (obj.event === "refresh") {
                        refreshFailedMediaTable();
                    }
                });
            });
        }

        // 重试单个失败媒体
        let retryFailedMedia = function (mediaId) {
            layer.confirm("确定重试该媒体?", {
                icon: 3,
                title: "提示"
            }, function (index) {
                layer.close(index);
                let loading = layer.load();

                $.ajax({
                    url: RETRY_FAILED_MEDIA_API(mediaId),
                    type: "post",
                    dataType: "json",
                    success: function (res) {
                        layer.close(loading);
                        if (res.code === 200 || res.code === 0) {
                            layui.popup.success("重试成功", refreshFailedMediaTable);
                        } else {
                            layui.popup.failure(res.msg || '重试失败');
                        }
                    },
                    error: function () {
                        layer.close(loading);
                        layui.popup.failure("请求失败");
                    }
                });
            });
        }

        // 重试所有失败媒体
        let retryAllFailedMedia = function () {
            layer.confirm("确定重试所有失败媒体?", {
                icon: 3,
                title: "提示"
            }, function (index) {
                layer.close(index);
                let loading = layer.load();

                // 这里可以添加重试所有的逻辑，目前先刷新表格
                setTimeout(function () {
                    layer.close(loading);
                    layui.popup.success("已开始重试所有失败媒体", refreshFailedMediaTable);
                }, 500);
            });
        }

        // 刷新失败媒体表格
        let refreshFailedMediaTable = function () {
            if (failedMediaTable) {
                failedMediaTable.reload({
                    page: {curr: 1}
                });
            }
        }

        // 移除批量删除功能

        // 移除旧的删除实现

        window.refreshTable = function () {
            table.reloadData("job-table", {
                scrollPos: "fixed",
                done: function (res, curr) {
                    if (curr > 1 && res.data && !res.data.length) {
                        curr = curr - 1;
                        table.reloadData("job-table", {
                            page: {
                                curr: curr
                            },
                        })
                    }
                }
            });
        }
    })

    // 获取选择组件配置项
    function getControlProps(control_args)
    {
        if (!control_args) {
            return {};
        }
        let props = {};
        let split = control_args.split(";");
        for (let item of split) {
            let pos = item.indexOf(":");
            if (pos === -1) continue;
            let name = item.substring(0, pos).trim();
            let values = item.substring(pos + 1).trim();

            // values = a:v,c:d
            pos = values.indexOf(":");
            if (pos !== -1) {
                let options = values.split(",");
                values = {};
                for (const option of options) {
                    let [value, name] = option.split(":");
                    values[value] = name;
                }
            }
            props[name] = values;
        }
        return props;
    }

</script>
</body>
</html>
