<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <title>admin管理</title>
    <link rel="stylesheet" href="/app/admin/component/layui/css/layui.css?v=2.8.12" />
    <link rel="stylesheet" href="/app/admin/component/pear/css/pear.css" />
    <link rel="stylesheet" href="/app/admin/admin/css/reset.css" />
    <style>
        /* 状态行高亮 */
        .row-status-pending { background-color: #fff7e6; }     /* 橙色浅底 */
        .row-status-processing { background-color: #e6f7ff; }  /* 蓝色浅底 */
        .row-status-completed { background-color: #f6ffed; }   /* 绿色浅底 */
        .row-status-failed { background-color: #fff1f0; }      /* 红色浅底 */
    </style>
</head>
<body class="pear-container">

<!-- 顶部查询表单 -->
<div class="layui-card">
    <div class="layui-card-body">
        <form class="layui-form top-search-from">

            <div class="layui-form-item">
                <label class="layui-form-label">任务名</label>
                <div class="layui-input-block">
                    <input type="text" name="name" id="name" placeholder="请输入任务名" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">状态</label>
                <div class="layui-input-block">
                    <select name="status" id="status">
                        <option value="">全部</option>
                        <option value="pending">等待中</option>
                        <option value="processing">导入中</option>
                        <option value="completed">已完成</option>
                        <option value="failed">已失败</option>
                    </select>
                </div>
            </div>

            <div class="layui-form-item layui-inline">
                <label class="layui-form-label"></label>
                <button class="pear-btn pear-btn-md pear-btn-primary" lay-submit lay-filter="table-query">
                    <i class="layui-icon layui-icon-search"></i>查询
                </button>
                <button type="reset" class="pear-btn pear-btn-md" lay-submit lay-filter="table-reset">
                    <i class="layui-icon layui-icon-refresh"></i>重置
                </button>
            </div>
            <div class="toggle-btn">
                <a class="layui-hide">展开<i class="layui-icon layui-icon-down"></i></a>
                <a class="layui-hide">收起<i class="layui-icon layui-icon-up"></i></a>
            </div>

        </form>
    </div>
</div>

<div class="layui-card">
    <div class="layui-card-body">
        <table id="job-table" lay-filter="job-table"></table>
    </div>
</div>

<script type="text/html" id="table-toolbar">
    <button class="pear-btn pear-btn-primary pear-btn-md" lay-event="add" permission="app.admin.table.create">
        <i class="layui-icon layui-icon-add-1"></i>创建导入任务
    </button>
    <button class="pear-btn pear-btn-danger pear-btn-md" lay-event="batchRemove" permission="app.admin.table.drop">
        <i class="layui-icon layui-icon-delete"></i>删除导入任务
    </button>
</script>

<!-- 移除无效的操作栏 -->

<script src="/app/admin/component/layui/layui.js?v=2.8.12"></script>
<script src="/app/admin/component/pear/pear.js"></script>
<script src="/app/admin/admin/js/permission.js"></script>
<script src="/app/admin/admin/js/common.js"></script>

<script type="text/html" id="progress-cell">
    <div class="layui-progress" lay-showPercent="true" style="margin:8px 0;">
        <div class="layui-progress-bar" lay-percent="{{ d.progress || 0 }}%"></div>
    </div>
</script>

<script type="text/html" id="job-status">
    {{# if(d.status == 'pending'){ }}
    <span class="layui-badge layui-bg-orange">等待中</span>
    {{# }else if(d.status == 'processing'){ }}
    <span class="layui-badge layui-bg-blue">导入中</span>
    {{# }else if(d.status == 'completed'){ }}
    <span class="layui-badge layui-bg-green">已完成</span>
    {{# }else if(d.status == 'failed'){ }}
    <span class="layui-badge layui-bg-red">已失败</span>
    {{# }else{ }}
    <span class="layui-badge">未知</span>
    {{# } }}
</script>

<script>

    // 相关接口
    const LIST_API = "/app/admin/tools/wp-import/list";
    const CREATE_URL = "/app/admin/tools/wp-import/create";
    const DELETE_API = (id) => `/app/admin/tools/wp-import/delete/${id}`;

    layui.use(["table", "form", "common", "popup"], function() {
        let table = layui.table;
        let form = layui.form;
        let $ = layui.$;
        let common = layui.common;

        let cols = [
            { title: "ID", field: "id", width: 80 },
            { title: "任务名", field: "name" },
            { title: "状态", field: "status", width: 120, templet: "#job-status" },
            { title: "进度", field: "progress", width: 160, templet: "#progress-cell" },
            { title: "创建时间", field: "created_at", width: 180 },
            {
                title: "操作",
                align: "center",
                width: 120,
                templet: function(d){
                    return '<button class="pear-btn pear-btn-xs tool-btn" lay-event="remove">删除</button>';
                }
            }
        ];

        table.render({
            elem: "#job-table",
            url: LIST_API,
            page: true,
            cols: [cols],
            skin: "line",
            size: "lg",
            toolbar: "#table-toolbar",
            defaultToolbar: [{
                title: "刷新",
                layEvent: "refresh",
                icon: "layui-icon-refresh",
            }, "filter", "print", "exports"],
            done: function (res) {
                var $ = layui.$;
                var trs = $('div[lay-id="job-table"] .layui-table-body tbody tr');
                trs.each(function (index) {
                    var d = res.data[index];
                    if (!d || !d.status) return;
                    var cls = '';
                    switch (d.status) {
                        case 'pending': cls = 'row-status-pending'; break;
                        case 'processing': cls = 'row-status-processing'; break;
                        case 'completed': cls = 'row-status-completed'; break;
                        case 'failed': cls = 'row-status-failed'; break;
                    }
                    if (cls) $(this).addClass(cls);
                });
            }
        });

        $(document).on("click", ".tab-link", function () {
            let obj = $(this);
            let table = obj.html();
            let url = obj.attr("src");
            parent.layui.admin.addTab(table , table + "表", url);
        })

        table.on("tool(job-table)", function(obj) {
            if (obj.event === "remove") {
                remove(obj);
            }
        });

        table.on("toolbar(job-table)", function(obj) {
            if (obj.event === "add") {
                add();
            } else if (obj.event === "refresh") {
                refreshTable();
            }
        });

        form.on("submit(table-query)", function(data) {
            table.reload("job-table", {
                page: {
                    curr: 1
                },
                where: data.field
            })
            return false;
        });

        // 查询重置：清空 name/status 并刷新
        form.on("submit(table-reset)", function() {
            $('#name').val('');
            $('#status').val('');
            form.render('select');
            table.reload("job-table", {
                page: { curr: 1 },
                where: { name: '', status: '' }
            });
            return false;
        });

        let add = function() {
            layer.open({
                type: 2,
                title: "创建导入任务",
                shade: 0.1,
                maxmin: true,
                area: [common.isModile()?"100%":"98%", common.isModile()?"100%":"95%"],
                content: CREATE_URL
            });
        }

        // 移除 edit 功能

        // 移除 crud 功能

        let remove = function(obj) {
            const id = obj.data.id;
            layer.confirm("确定删除该任务?", {
                icon: 3,
                title: "提示"
            }, function(index) {
                layer.close(index);
                let loading = layer.load();
                $.ajax({
                    url: DELETE_API(id),
                    type: "post",
                    dataType: "json",
                    success: function (res) {
                        layer.close(loading);
                        if (res.code && res.code !== 200 && res.code !== 0) {
                            return layui.popup.failure(res.msg || '删除失败');
                        }
                        return layui.popup.success("操作成功", refreshTable);
                    },
                    error: function () {
                        layer.close(loading);
                        layui.popup.failure("请求失败");
                    }
                });
            });
        }

        // 移除批量删除功能

        // 移除旧的删除实现

        window.refreshTable = function() {
            table.reloadData("job-table", {
                scrollPos: "fixed",
                done: function (res, curr) {
                    if (curr > 1 && res.data && !res.data.length) {
                        curr = curr - 1;
                        table.reloadData("job-table", {
                            page: {
                                curr: curr
                            },
                        })
                    }
                }
            });
        }
    })

    // 获取选择组件配置项
    function getControlProps(control_args)
    {
        if (!control_args) {
            return {};
        }
        let props = {};
        let split = control_args.split(";");
        for (let item of split) {
            let pos = item.indexOf(":");
            if (pos === -1) continue;
            let name = item.substring(0, pos).trim();
            let values = item.substring(pos + 1).trim();

            // values = a:v,c:d
            pos = values.indexOf(":");
            if (pos !== -1) {
                let options = values.split(",");
                values = {};
                for (const option of options) {
                    let [value, name] = option.split(":");
                    values[value] = name;
                }
            }
            props[name] = values;
        }
        return props;
    }

</script>
</body>
</html>
