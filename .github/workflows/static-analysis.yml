name: Static Analysis

on:
  push:
    branches: ['**']  # ä»»ä½•åˆ†æ”¯æŽ¨é€éƒ½è§¦å‘
  pull_request:
    branches: ['**']  # ä»»ä½•åˆ†æ”¯çš„PRéƒ½è§¦å‘

jobs:
  phpstan:
    runs-on: ubuntu-latest
    name: PHPStan Static Analysis
    permissions:
      contents: read
      pull-requests: write
      checks: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, pdo_pgsql, pgsql, bcmath, intl, gd, exif, iconv
        tools: composer:v2

    - name: Get composer cache directory
      id: composer-cache
      run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

    - name: Cache composer dependencies
      uses: actions/cache@v4
      with:
        path: ${{ steps.composer-cache.outputs.dir }}
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-

    - name: Install dependencies
      run: composer install --prefer-dist --no-interaction --no-progress

    - name: Run PHPStan and generate report
      continue-on-error: true
      run: |
        vendor/bin/phpstan analyze --error-format=github --no-progress || true
        vendor/bin/phpstan analyze --error-format=json --no-progress > phpstan-report.json || true

    - name: Upload PHPStan Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: phpstan-report
        path: phpstan-report.json
        retention-days: 30

    - name: Comment PR with PHPStan summary
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          try {
            const reportData = fs.readFileSync('phpstan-report.json', 'utf8');
            const report = JSON.parse(reportData);

            const errorCount = report.totals?.errors || 0;
            const fileCount = report.totals?.file_errors || 0;

            if (errorCount > 0) {
              const comment = '## ðŸ” PHPStan é™æ€åˆ†æžæŠ¥å‘Š\n\n' +
                '**å‘çŽ° ' + errorCount + ' ä¸ªé—®é¢˜**ï¼Œæ¶‰åŠ ' + fileCount + ' ä¸ªæ–‡ä»¶\n\n' +
                '### ä¸»è¦é—®é¢˜ç±»åž‹\n' +
                '- ç¼ºå°‘ç±»åž‹å£°æ˜Ž\n' +
                '- ç±»åž‹ä¸åŒ¹é…\n' +
                '- é€»è¾‘é”™è¯¯\n\n' +
                '### å¦‚ä½•æŸ¥çœ‹è¯¦æƒ…\n' +
                'ðŸ“¥ å®Œæ•´æŠ¥å‘Šå·²ä¿å­˜ä¸º Artifactï¼Œå¯åœ¨ Actions é¡µé¢ä¸‹è½½æŸ¥çœ‹ã€‚\n\n' +
                '### å»ºè®®\n' +
                'å»ºè®®é€æ­¥ä¿®å¤è¿™äº›é—®é¢˜ä»¥æé«˜ä»£ç è´¨é‡ã€‚å¯ä»¥å…ˆä»Ž level 6 é™ä½Žåˆ° level 5 ä»¥å‡å°‘æ£€æŸ¥ä¸¥æ ¼åº¦ã€‚';

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
          } catch (error) {
            console.log('No PHPStan issues found or report file missing');
          }

  php-cs-fixer:
    runs-on: ubuntu-latest
    name: PHP CS Fixer
    permissions:
      contents: read
      pull-requests: write
      checks: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        tools: php-cs-fixer, composer:v2, cs2pr

    - name: Get composer cache directory
      id: composer-cache
      run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

    - name: Cache composer dependencies
      uses: actions/cache@v4
      with:
        path: ${{ steps.composer-cache.outputs.dir }}
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-

    - name: Install dependencies
      run: composer install --prefer-dist --no-interaction --no-progress

    - name: Run PHP CS Fixer and generate report
      continue-on-error: true
      run: |
        vendor/bin/php-cs-fixer fix --dry-run --diff --format=checkstyle > php-cs-fixer-report.xml || true

    - name: Show annotations in PR
      if: always()
      run: |
        cat php-cs-fixer-report.xml | cs2pr

    - name: Upload PHP CS Fixer Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: php-cs-fixer-report
        path: php-cs-fixer-report.xml
        retention-days: 30

    - name: Comment PR with summary
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const xml2js = require('xml2js');

          try {
            const xmlData = fs.readFileSync('php-cs-fixer-report.xml', 'utf8');
            const parser = new xml2js.Parser();
            const result = await parser.parseStringPromise(xmlData);

            let issueCount = 0;
            let fileCount = 0;
            if (result.checkstyle && result.checkstyle.file) {
              fileCount = result.checkstyle.file.length;
              result.checkstyle.file.forEach(file => {
                if (file.error) {
                  issueCount += file.error.length;
                }
              });
            }

            const comment = `## ðŸŽ¨ PHP CS Fixer Report

            **å‘çŽ°ä»£ç é£Žæ ¼é—®é¢˜**: ${issueCount} ä¸ªé—®é¢˜ï¼Œæ¶‰åŠ ${fileCount} ä¸ªæ–‡ä»¶

            ### å¦‚ä½•ä¿®å¤

            åœ¨æœ¬åœ°è¿è¡Œä»¥ä¸‹å‘½ä»¤è‡ªåŠ¨ä¿®å¤ï¼š
            \`\`\`bash
            vendor/bin/php-cs-fixer fix
            \`\`\`

            ðŸ“¥ è¯¦ç»†æŠ¥å‘Šå·²ä¿å­˜ä¸º Artifactï¼Œå¯åœ¨ Actions é¡µé¢ä¸‹è½½æŸ¥çœ‹ã€‚
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } catch (error) {
            console.log('No issues found or report file missing');
          }

  security:
    runs-on: ubuntu-latest
    name: Security Check

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        tools: composer:v2

    - name: Get composer cache directory
      id: composer-cache
      run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

    - name: Cache composer dependencies
      uses: actions/cache@v4
      with:
        path: ${{ steps.composer-cache.outputs.dir }}
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-

    - name: Install dependencies
      run: composer install --prefer-dist --no-interaction --no-progress

    - name: Security Check
      uses: symfonycorp/security-checker-action@v5
