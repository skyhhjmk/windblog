<title>{{ page_title|default('WindBlog') }}</title>

<!-- PJAX SEO Data -->
<div id="pjax-seo-data" style="display:none;">
    {% if seo is defined %}
        {% include 'components/seo-meta.html.twig' with {'seo': seo} %}
    {% endif %}
    {% if schema is defined %}
        {% include 'components/structured-data.html.twig' with {'schema': schema} %}
    {% endif %}
</div>

<div id="pjax-container">
    <div class="max-w-full mx-auto">
        <div class="tui-box mb-6" data-title="METADATA">
            <div class="mb-4">
                <h1 class="text-2xl font-bold mb-2">
                    <span class="text-green-500">âžœ</span> {{ post.title }}
                </h1>
                <div class="font-mono text-sm text-gray-500">
                    <div>File: ~/posts/{{ post.slug }}.md</div>
                    <div>Size: {{ post.content|length }} bytes</div>
                    <div>Permissions: -rw-r--r--</div>
                    <div>Author: {{ author }}</div>
                    <div>Date: {{ post.created_at|local_date('Y-m-d H:i:s') }}</div>
                </div>
            </div>

            <div class="flex flex-wrap gap-2 text-sm font-mono border-t border-gray-700 pt-2 mt-2">
                {% if post.categories|length > 0 %}
                    <span class="text-gray-500">Categories:</span>
                    {% for c in post.categories %}
                        <a href="/category/{{ c.slug }}.html" class="text-yellow-500 hover:underline">#{{ c.name }}</a>
                    {% endfor %}
                {% endif %}

                {% if post.tags|length > 0 %}
                    <span class="text-gray-500 ml-2">Tags:</span>
                    {% for t in post.tags %}
                        <a href="/tag/{{ t.slug }}.html" class="text-blue-500 hover:underline">#{{ t.name }}</a>
                    {% endfor %}
                {% endif %}
            </div>
        </div>

        <article class="tui-box relative" data-title="CONTENT">
            <!-- TOC FAB -->
            <div id="toc-fab-wrap" class="absolute right-4 top-4 z-10">
                <button id="toc-fab" class="bg-gray-700 text-white p-2 border border-gray-500 hover:bg-gray-600"
                        title="Table of Contents">
                    [TOC]
                </button>
                <div id="toc-drawer"
                     class="hidden absolute right-0 top-10 w-64 bg-gray-800 border border-gray-500 p-2 z-20 shadow-none">
                    <div class="flex justify-between items-center border-b border-gray-600 pb-2 mb-2">
                        <span class="font-bold">Table of Contents</span>
                        <button id="toc-close" class="text-red-500">[x]</button>
                    </div>
                    <div id="toc-list-desktop" class="max-h-64 overflow-y-auto font-mono text-sm"></div>
                </div>
            </div>

            {% if post.ai_summary %}
                <div class="mb-6 p-4 border border-purple-500 bg-gray-800">
                    <div class="font-bold text-purple-400 mb-2">[AI Summary]</div>
                    <p class="text-gray-300 font-mono text-sm leading-relaxed">
                        {{ post.ai_summary }}
                    </p>
                </div>
            {% endif %}

            <div class="prose max-w-none font-mono" id="post-container" data-post-id="{{ post.id }}"
                 data-post-slug="{{ post.slug }}">
                {{ post_html|default('')|raw }}
            </div>

            <div class="mt-8 pt-4 border-t border-gray-700 flex justify-between items-center font-mono text-sm">
                <a href="/" class="text-blue-500 hover:underline"><- cd ..</a>
                <span class="text-gray-500">EOF</span>
            </div>
        </article>

        <!-- Comments -->
        <div class="mt-8 tui-box" data-title="COMMENTS">
            <div id="comments-list" class="mb-8">
                <!-- Dynamic comments -->
            </div>

            {% if post.allow_comments %}
                <div class="border-t border-gray-700 pt-6">
                    <h3 class="font-bold mb-4">> Add Comment_</h3>
                    <form id="comment-form" class="space-y-4 font-mono">
                        <input type="hidden" name="_token" value="" data-csrf-placeholder="true">
                        <input type="hidden" id="post-id" name="post_id" value="{{ post.id }}">
                        <input type="hidden" id="parent-id" name="parent_id" value="0">

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-500 mb-1">Name*</label>
                                <input type="text" name="guest_name" required
                                       class="w-full bg-gray-800 border border-gray-600 p-2 text-white focus:border-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-gray-500 mb-1">Email*</label>
                                <input type="email" name="guest_email" required
                                       class="w-full bg-gray-800 border border-gray-600 p-2 text-white focus:border-blue-500 outline-none">
                            </div>
                        </div>

                        <div>
                            <label class="block text-gray-500 mb-1">Message*</label>
                            <textarea name="content" rows="4" required
                                      class="w-full bg-gray-800 border border-gray-600 p-2 text-white focus:border-blue-500 outline-none"></textarea>
                        </div>

                        <div id="comment-captcha-wrapper"></div>

                        <button type="submit"
                                class="bg-blue-600 text-white px-4 py-2 border border-blue-500 hover:bg-blue-700">
                            [Submit]
                        </button>
                        <div id="comment-status" class="mt-2 hidden"></div>
                    </form>
                </div>
            {% else %}
                <p class="text-gray-500 text-center py-4"># Comments are closed.</p>
            {% endif %}
        </div>
    </div>

    <!-- Scripts (reused from original, simplified for TUI) -->
    <script data-pjax-eval="true">
        window.__postContentCache = window.__postContentCache || {};
        window.__postLoadingState = window.__postLoadingState || {};
        window.__postRendered = window.__postRendered || false;

        function renderPost() {
            if (window.__postRendered) return;
            const container = document.getElementById('post-container');
            if (!container) return;
            renderContent(container);
            window.__postRendered = true;
        }

        function renderContent(container) {
            // Basic highlighting
            if (window.hljs) {
                container.querySelectorAll('pre > code').forEach(block => {
                    window.hljs.highlightElement(block);
                });
            }

            // TOC Logic
            buildInPageTOC();

            // Comments Init (assuming global function exists or will be loaded)
            if (typeof initComments === 'function') initComments();
        }

        function buildInPageTOC() {
            const root = document.getElementById('post-container');
            const list = document.getElementById('toc-list-desktop');
            if (!root || !list) return;

            const headers = root.querySelectorAll('h1, h2, h3, h4, h5, h6');
            if (headers.length === 0) {
                document.getElementById('toc-fab-wrap').style.display = 'none';
                return;
            }

            let html = '<ul class="space-y-1">';
            headers.forEach((header, index) => {
                const id = 'header-' + index;
                header.id = id;
                const level = parseInt(header.tagName.substring(1));
                const indent = (level - 1) * 10;
                html += `<li style="padding-left:${indent}px"><a href="#${id}" class="hover:text-blue-400 block truncate">${header.textContent}</a></li>`;
            });
            html += '</ul>';
            list.innerHTML = html;

            // Toggle logic
            const fab = document.getElementById('toc-fab');
            const drawer = document.getElementById('toc-drawer');
            const close = document.getElementById('toc-close');

            fab.onclick = () => drawer.classList.remove('hidden');
            close.onclick = () => drawer.classList.add('hidden');
        }

        // Init
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', renderPost);
        } else {
            renderPost();
        }
    </script>
</div>
