<title>{{ page_title|default('申请友链') }}</title>
<div id="pjax-container">
    <!-- PJAX 隐藏侧栏片段：完成后注入到布局右侧栏 -->
    <div id="pjax-sidebar-html" style="display:none">
        {% if sidebar is defined and sidebar.widgets is defined %}
            {% for widget in sidebar.widgets %}
                {% if widget.enabled and widget.html is defined %}
                    <div class="sidebar-widget"
                         data-widget-key="{{ widget.key ?? widget.id ?? widget.slug ?? widget.name ?? loop.index }}"
                         data-widget-type="{{ widget.type ?? '' }}">
                        {{ widget.html|raw }}
                    </div>
                {% endif %}
            {% endfor %}
        {% endif %}
    </div>
    <div class="max-w-4xl mx-auto px-3 sm:px-4">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden no-animation">
            <div class="p-4 sm:p-6 md:p-8">
                <div class="text-center mb-6 sm:mb-8">
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">申请友链</h1>
                    <p class="text-sm sm:text-base text-gray-600">填写以下信息申请友情链接，我们会尽快审核</p>
                </div>

                <!-- 友链申请规则卡片 -->
                <div id="link-rules"
                     class="tui-box border border-gray-600 rounded-lg p-4 sm:p-6 mb-6 sm:mb-8 transition-all duration-300">
                    <div class="flex items-start">
                        <span class="tui-prompt text-blue-400 text-xl mr-3 mt-1">[INFO]</span>
                        <div>
                            <h2 class="text-lg font-semibold text-blue-400 mb-3">[LINK RULES] 友链申请规则</h2>
                            <ul class="text-gray-300 space-y-2">
                                <li class="flex items-start">
                                    <span class="text-green-400 mt-1 mr-2">[OK]</span>
                                    <div>
                                        <span>网站内容合法、健康，不包含任何违法不良信息</span>
                                        <div class="text-xs text-gray-400 mt-1">网站应遵守相关法律法规，不传播违法信息
                                        </div>
                                    </div>
                                </li>
                                <li class="flex items-start">
                                    <span class="text-green-400 mt-1 mr-2">[SEC]</span>
                                    <div>
                                        <span>网站有至少三篇原创内容</span>
                                        <div class="text-xs text-gray-400 mt-1">
                                            原创内容指由网站主体创作的非转载、非采集内容。
                                        </div>
                                    </div>
                                </li>
                                <li class="flex items-start">
                                    <span class="text-purple-400 mt-1 mr-2">[LINK]</span>
                                    <div>
                                        <span>已将本站添加至贵站友情链接中</span>
                                        <div class="text-xs text-gray-400 mt-1">支持风屿互联协议至少 CAT3
                                            运行级别可忽略此要求。
                                        </div>
                                    </div>
                                </li>
                                <li class="flex items-start">
                                    <span class="text-red-400 mt-1 mr-2">[BAN]</span>
                                    <div>
                                        <span>不接受广告站、采集站、AI 站、违法网站的申请</span>
                                        <div class="text-xs text-gray-400 mt-1">
                                            为保证友链质量，仅接受原创内容占比高且合法的网站。
                                        </div>
                                    </div>
                                </li>
                                <li class="flex items-start">
                                    <span class="text-blue-400 mt-1 mr-2">[SYNC]</span>
                                    <div>
                                        <span>申请提交后，会有爬虫前往贵站</span>
                                        <div class="text-xs text-gray-400 mt-1">
                                            用于定期检查友链站点可用性，支持风屿互联协议会优先走协议。
                                        </div>
                                    </div>
                                </li>
                                <li class="flex items-start">
                                    <span class="text-yellow-400 mt-1 mr-2">[TIME]</span>
                                    <div>
                                        <span>申请通过后，会不定期有爬虫光顾贵站</span>
                                        <div class="text-xs text-gray-400 mt-1">
                                            本功能为可选功能-采集内容用于获取友链站点内容摘要等供展示使用。
                                        </div>
                                    </div>
                                </li>
                            </ul>
                            <div class="mt-4 text-xs text-gray-400">
                                <p>[NOTE] 补充说明：</p>
                                <ul class="list-disc pl-5 space-y-1 mt-1">
                                    <li>原创内容：指由网站主体创作的非转载、非采集内容。</li>
                                    <li>风屿互联协议：基于 HTTP/WS/MQTT 的信息交换协议，CAT 后的数字即代表运行级别，运行级别的区别在于功能不同，例如
                                        CAT1 仅提供解析 peer 数据的功能。
                                    </li>
                                    <li>状态采集爬虫：用于定期检查友链站点可用性的自动化程序。</li>
                                    <li>信息采集爬虫：可选功能，用于获取友链站点 SSR/文章列表进行聚合显示。</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 本站信息卡片 -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 sm:p-6 mb-6 sm:mb-8">
                    <div class="flex items-start">
                        <i class="fas fa-home text-gray-500 text-xl mr-3 mt-1"></i>
                        <div class="flex-1">
                            <h2 class="text-lg font-semibold text-gray-800 mb-3">本站信息</h2>
                            <div class="space-y-2 text-gray-700 mb-4">
                                {% if cat_level_info is defined and cat_level_info.level is defined %}
                                    <div class="flex items-center mb-3">
                                        <span class="font-medium mr-2">风屿互联协议级别：</span>
                                        <span class="cat-level-badge"
                                              style="background: {% if cat_level_info.level starts with 'CAT5' %}#ff6b6b{% elseif cat_level_info.level starts with 'CAT4' %}#4ecdc4{% elseif cat_level_info.level starts with 'CAT3' %}#95e1d3{% elseif cat_level_info.level starts with 'CAT2' %}#feca57{% else %}#dfe6e9{% endif %}; color: white; padding: 4px 12px; border-radius: 4px; font-weight: bold; font-size: 14px; display: inline-block;">{{ cat_level_info.level }}</span>
                                        <button type="button" onclick="toggleCatInfo()"
                                                class="ml-2 text-blue-600 hover:text-blue-800 text-sm">
                                            <i class="fas fa-info-circle"></i> 详情
                                        </button>
                                    </div>
                                    <div id="cat-level-details"
                                         class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                                        <div
                                            class="text-sm text-blue-800 font-medium mb-2">{{ cat_level_info.description }}</div>
                                        <div class="text-xs text-gray-700 space-y-1">
                                            {% for capability in cat_level_info.capabilities %}
                                                <div>{{ capability }}</div>
                                            {% endfor %}
                                        </div>
                                        <div class="text-xs text-gray-500 mt-2">
                                            <i class="fas fa-clock mr-1"></i>检测时间：{{ cat_level_info.detected_at }}
                                            UTC
                                        </div>
                                    </div>
                                {% else %}
                                    <p><span class="font-medium">风屿互联协议级别：CAT3E</span></p>
                                {% endif %}
                                <p><span class="font-medium">网站名称：{{ blog_config('title', '') }}</span></p>
                                <p><span class="font-medium">网站描述：{{ blog_config('description', '') }}</span></p>
                                <p><span class="font-medium">Favicon：{{ blog_config('favicon', '') }}</span></p>
                            </div>
                            <button id="toggleConfig"
                                    class="flex items-center text-blue-600 hover:text-blue-800 font-medium">
                                <i class="fas fa-code mr-2"></i>
                                点击展开JSON配置
                                <i class="fas fa-chevron-down ml-2 transition-transform duration-300"></i>
                            </button>
                            <div id="configSection" class="hidden mt-4">
                                <div class="relative">
                                <pre class="bg-gray-800 text-gray-100 p-4 rounded-lg overflow-x-auto text-sm"
                                     style="max-width: 100%;"><code
                                        id="configCode">{{ site_info_json_config|default('{}') }}</code></pre>
                                    <button id="copyConfig"
                                            class="absolute top-2 right-2 bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm transition-colors duration-200 opacity-0 group-hover:opacity-100">
                                        <i class="fas fa-copy mr-1"></i>复制
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CAT3* 快速互联 -->
                <div class="tui-box border border-green-600 rounded-lg p-3 sm:p-4 mb-6 sm:mb-8">
                    <div class="flex items-start">
                        <span class="text-green-400 text-lg sm:text-xl mr-2 sm:mr-3 mt-1 flex-shrink-0">[PLUG]</span>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-base sm:text-lg font-semibold text-green-400 mb-2">
                                [QUICK CONNECT] 快速互联（CAT3*以上支持）</h3>
                            <p class="text-gray-300 text-xs sm:text-sm mb-3">
                                如果您的站点支持风屿互联协议，请填写其接收 API（peer_api），系统将自动在您的站点创建友链记录。
                            </p>
                            <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
                                <input type="url"
                                       id="peer_api"
                                       class="flex-1 min-w-0 px-3 sm:px-4 py-2 text-sm border border-gray-600 rounded focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors duration-200"
                                       placeholder="https://peer.example.com/..."
                                       pattern="https?://.+">
                                <button id="quickConnectBtn"
                                        class="px-4 py-2 bg-green-700 hover:bg-green-600 text-white text-sm font-medium border border-green-600 rounded transition-colors duration-200 relative overflow-hidden whitespace-nowrap flex-shrink-0">
                                    <span id="quickConnectBtnText">[CONNECT]</span>
                                    <span id="quickConnectBtnLoader"
                                          class="hidden absolute inset-0 flex items-center justify-center bg-green-600">
                                    <span class="text-green-300 mr-2">[...]</span>处理中...
                                </span>
                                </button>
                            </div>
                            <p class="text-xs text-gray-400 mt-2">
                                [TIP] 提示：将复用你在下方表单中已填写的基本信息一并发送给本站。</p>
                            <div id="quickConnectResult"
                                 class="hidden mt-3 p-3 border border-gray-600 rounded text-sm"></div>
                        </div>
                    </div>
                </div>

                <form id="linkRequestForm" class="space-y-6">
                    <input type="hidden" name="_link_request_token" value="{{ csrf }}">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-300 mb-1">[NAME] 网站名称 <span
                                class="text-red-400">*</span></label>
                        <input type="text"
                               id="name"
                               name="name"
                               required
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-600 text-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
                               placeholder="请输入网站名称">
                    </div>

                    <div>
                        <label for="url" class="block text-sm font-medium text-gray-300 mb-1">[URL] 网站地址 <span
                                class="text-red-400">*</span></label>
                        <input type="url"
                               id="url"
                               name="url"
                               required
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-600 text-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
                               placeholder="https://example.com">
                    </div>

                    <div>
                        <label for="icon"
                               class="block text-sm font-medium text-gray-300 mb-1">[ICON]
                            网站图标地址（不填则尝试自动获取）</label>
                        <input type="url"
                               id="icon"
                               name="icon"
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-600 text-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
                               placeholder="https://example.com/favicon.ico">
                    </div>

                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-300 mb-1">[DESC]
                            网站描述<span
                                class="text-red-400">*</span></label>
                        <textarea id="description"
                                  name="description"
                                  rows="3"
                                  required
                                  class="w-full px-4 py-2 bg-gray-800 border border-gray-600 text-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
                                  placeholder="请简单描述您的网站内容"></textarea>
                    </div>

                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-300 mb-1">[MAIL] 邮箱</label>
                        <input type="text"
                               id="email"
                               name="email"
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-600 text-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
                               placeholder="邮箱联系方式（可选，用于审核结果通知）">
                    </div>

                    <div>
                        <label for="full_description" class="block text-sm font-medium text-gray-300 mb-1">[INFO]
                            网站详细介绍（支持
                            Markdown 语法）</label>
                        <textarea id="full_description"
                                  name="full_description"
                                  rows="3"
                                  class="w-full px-4 py-2 bg-gray-800 border border-gray-600 text-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
                                  placeholder="当使用 info 方式跳转时，内容会被渲染在页面上"></textarea>
                    </div>

                    <div>
                        <label for="contact" class="block text-sm font-medium text-gray-300 mb-1">[CONTACT]
                            联系方式</label>
                        <input type="text"
                               id="contact"
                               name="contact"
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-600 text-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
                               placeholder="微信/QQ等联系方式（可选）">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">[POSITION] 友链放置位置 <span
                                class="text-red-400">*</span></label>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-2">
                            <label class="link-position-option">
                                <input type="radio"
                                       name="link_position"
                                       value="homepage"
                                       class="peer hidden"
                                       checked
                                       required>
                                <div
                                    class="cursor-pointer px-4 py-3 border-2 border-gray-600 rounded-lg text-center transition-all duration-200 peer-checked:border-blue-500 peer-checked:bg-gray-800 peer-checked:text-blue-400 hover:border-blue-400 hover:bg-gray-700">
                                    <span class="text-lg text-blue-400 mb-1">[HOME]</span>
                                    <div class="font-medium text-gray-300">首页</div>
                                </div>
                            </label>
                            <label class="link-position-option">
                                <input type="radio"
                                       name="link_position"
                                       value="link_page"
                                       class="peer hidden">
                                <div
                                    class="cursor-pointer px-4 py-3 border-2 border-gray-600 rounded-lg text-center transition-all duration-200 peer-checked:border-blue-500 peer-checked:bg-gray-800 peer-checked:text-blue-400 hover:border-blue-400 hover:bg-gray-700">
                                    <span class="text-lg text-blue-400 mb-1">[LINK]</span>
                                    <div class="font-medium text-gray-300">友链页</div>
                                </div>
                            </label>
                            <label class="link-position-option">
                                <input type="radio"
                                       name="link_position"
                                       value="other_page"
                                       class="peer hidden">
                                <div
                                    class="cursor-pointer px-4 py-3 border-2 border-gray-600 rounded-lg text-center transition-all duration-200 peer-checked:border-blue-500 peer-checked:bg-gray-800 peer-checked:text-blue-400 hover:border-blue-400 hover:bg-gray-700">
                                    <span class="text-lg text-blue-400 mb-1">[PAGE]</span>
                                    <div class="font-medium text-gray-300">其他页面</div>
                                </div>
                            </label>
                        </div>
                        <p class="text-xs text-gray-400 mb-3">[TIP] 您将本站的友链放置于您站点的哪个页面？</p>
                        <div id="page_link_container" class="hidden">
                            <input type="url"
                                   id="page_link"
                                   name="page_link"
                                   class="w-full px-4 py-2 bg-gray-800 border border-gray-600 text-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
                                   placeholder="为便于自动审核,请填写此内容">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">[REDIRECT] 跳转方式 <span
                                class="text-red-400">*</span></label>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-2">
                            <label class="redirect-type-option">
                                <input type="radio"
                                       name="redirect_type"
                                       value="direct"
                                       class="peer hidden"
                                       required>
                                <div
                                    class="cursor-pointer px-4 py-3 border-2 border-gray-600 rounded-lg text-center transition-all duration-200 peer-checked:border-blue-500 peer-checked:bg-gray-800 peer-checked:text-blue-400 hover:border-blue-400 hover:bg-gray-700">
                                    <span class="text-lg text-yellow-400 mb-1">[BOLT]</span>
                                    <div class="font-medium text-gray-300">直接跳转</div>
                                    <div class="text-xs text-gray-400 mt-1">(需人工审核)</div>
                                </div>
                            </label>
                            <label class="redirect-type-option">
                                <input type="radio"
                                       name="redirect_type"
                                       value="goto"
                                       class="peer hidden"
                                       checked>
                                <div
                                    class="cursor-pointer px-4 py-3 border-2 border-gray-600 rounded-lg text-center transition-all duration-200 peer-checked:border-blue-500 peer-checked:bg-gray-800 peer-checked:text-blue-400 hover:border-blue-400 hover:bg-gray-700">
                                    <span class="text-lg text-blue-400 mb-1">[GO]</span>
                                    <div class="font-medium text-gray-300">goto页面</div>
                                    <div class="text-xs text-gray-400 mt-1">&nbsp;</div>
                                </div>
                            </label>
                            <label class="redirect-type-option">
                                <input type="radio"
                                       name="redirect_type"
                                       value="info"
                                       class="peer hidden">
                                <div
                                    class="cursor-pointer px-4 py-3 border-2 border-gray-600 rounded-lg text-center transition-all duration-200 peer-checked:border-blue-500 peer-checked:bg-gray-800 peer-checked:text-blue-400 hover:border-blue-400 hover:bg-gray-700">
                                    <span class="text-lg text-green-400 mb-1">[INFO]</span>
                                    <div class="font-medium text-gray-300">info页面</div>
                                    <div class="text-xs text-gray-400 mt-1">(显示详细信息)</div>
                                </div>
                            </label>
                        </div>
                        <div id="redirect_type_hint"
                             class="text-xs text-gray-400 bg-gray-800 border border-gray-600 rounded-lg p-3">
                            <span class="text-blue-400 mr-1">[GO]</span>
                            使用goto中间页询问用户是否跳转
                        </div>
                    </div>

                    <div style="position:absolute; left:-9999px; top:-9999px;">
                        <label for="fullname" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input type="text"
                               id="fullname"
                               name="fullname"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
                               placeholder="Please input your fullname">
                    </div>

                    <div class="tui-box border border-gray-600 rounded-lg p-4">
                        <h3 class="text-lg font-medium text-gray-300 mb-3">[OPTIONS] 其他可选功能</h3>
                        <div class="space-y-4">
                            <div class="flex items-start">
                                <div class="flex items-center h-5">
                                    <input id="supports_wind_connect"
                                           name="supports_wind_connect"
                                           type="checkbox"
                                           class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-600 rounded bg-gray-800">
                                </div>
                                <div class="ml-3 text-sm">
                                    <label for="supports_wind_connect"
                                           class="font-medium text-gray-300">[WIND] 支持风屿互联协议</label>
                                    <p class="text-gray-400 mt-1">
                                        您的网站是否支持风屿互联协议，支持后可实现更高效的通信</p>
                                </div>
                            </div>

                            <div class="flex items-start">
                                <div class="flex items-center h-5">
                                    <input id="allows_crawling"
                                           name="allows_crawling"
                                           type="checkbox"
                                           class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-600 rounded bg-gray-800">
                                </div>
                                <div class="ml-3 text-sm">
                                    <label for="allows_crawling"
                                           class="font-medium text-gray-300">[CRAWL] 允许资源爬虫访问</label>
                                    <p class="text-gray-400 mt-1">
                                        是否允许我们的爬虫定期访问您的网站以获取内容摘要用于展示</p>
                                </div>
                            </div>

                            <div class="flex items-start">
                                <div class="flex items-center h-5">
                                    <input id="hide_url"
                                           name="hide_url"
                                           type="checkbox"
                                           class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-600 rounded bg-gray-800">
                                </div>
                                <div class="ml-3 text-sm">
                                    <label for="hide_url" class="font-medium text-gray-300">[HIDE] 隐藏链接</label>
                                    <p class="text-gray-400 mt-1">选中后将在前端友链页面中隐藏您的网站链接，使用 goto/301
                                        重定向方式跳转</p>
                                </div>
                            </div>

                        </div>
                    </div>

                    <div class="flex items-center">
                        <input id="agreement"
                               type="checkbox"
                               required
                               class="w-4 h-4 text-blue-600 bg-gray-800 border-gray-600 rounded focus:ring-blue-500">
                        <label for="agreement" class="ml-2 text-sm text-gray-300">
                            [AGREE] 我已阅读并同意 <a href="#link-rules"
                                                      class="text-blue-400 hover:underline">友链申请规则</a>
                        </label>
                    </div>

                    <div>
                        <button type="submit"
                                class="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900 relative overflow-hidden">
                            <span id="submitBtnText">[SEND] 提交申请</span>
                            <span id="submitBtnLoader"
                                  class="hidden absolute inset-0 flex items-center justify-center bg-blue-700">
                            <span class="text-blue-300 mr-2">[LOAD]</span>提交中...
                        </span>
                        </button>
                    </div>
                </form>

                <div id="resultMessage" class="hidden mt-6 p-4 rounded-lg"></div>
            </div>
        </div>
    </div>

    <script>
        // CAT 级别详情切换
        function toggleCatInfo() {
            const details = document.getElementById('cat-level-details');
            if (details) {
                details.classList.toggle('hidden');
            }
        }
    </script>

    <script>
        // 处理锚点跳转 + JSON 配置展开/复制（支持 PJAX）
        function setupConfigAndAnchors() {
            // 首屏带哈希时滚动并高亮
            if (window.location.hash) {
                const target = document.querySelector(window.location.hash);
                if (target) {
                    scrollToCenter(target);
                    triggerBlinkEffect(target);
                }
            }

            // 绑定站内锚点（避免重复绑定）
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                if (anchor.dataset.anchorBound === '1') return;
                anchor.dataset.anchorBound = '1';
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href');
                    const target = document.querySelector(targetId);
                    if (target) {
                        scrollToCenter(target);
                        triggerBlinkEffect(target);
                    }
                });
            });

            // 展开/收起 JSON 配置（使用克隆避免重复绑定）
            const toggleBtn = document.getElementById('toggleConfig');
            const configSection = document.getElementById('configSection');
            if (toggleBtn && configSection) {
                const newBtn = toggleBtn.cloneNode(true);
                toggleBtn.parentNode.replaceChild(newBtn, toggleBtn);
                const chevronIcon = newBtn.querySelector('i.fa-chevron-down');
                newBtn.addEventListener('click', function () {
                    const isHidden = configSection.classList.contains('hidden');
                    if (isHidden) {
                        configSection.classList.remove('hidden');
                        if (chevronIcon) chevronIcon.classList.add('rotate-180');
                    } else {
                        configSection.classList.add('hidden');
                        if (chevronIcon) chevronIcon.classList.remove('rotate-180');
                    }
                });
            }

            // 复制 JSON 配置（使用克隆避免重复绑定）
            const copyBtn = document.getElementById('copyConfig');
            const configCode = document.getElementById('configCode');
            if (copyBtn && configCode) {
                const newCopy = copyBtn.cloneNode(true);
                copyBtn.parentNode.replaceChild(newCopy, copyBtn);
                const codeContainer = newCopy.parentElement;
                codeContainer.classList.add('group');
                newCopy.addEventListener('click', function () {
                    const textArea = document.createElement('textarea');
                    textArea.value = configCode.textContent || '';
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    const originalText = newCopy.innerHTML;
                    newCopy.innerHTML = '<i class="fas fa-check mr-1"></i>已复制';
                    setTimeout(() => {
                        newCopy.innerHTML = originalText;
                    }, 2000);
                });
            }
        }

        // 初次加载或非 PJAX 情况
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupConfigAndAnchors);
        } else {
            setupConfigAndAnchors();
        }
        // PJAX 导航后
        document.addEventListener('page:ready', setupConfigAndAnchors);

        function scrollToCenter(element) {
            const elementRect = element.getBoundingClientRect();
            const absoluteElementTop = elementRect.top + window.pageYOffset;
            const middle = absoluteElementTop - (window.innerHeight / 2);
            window.scrollTo({top: middle, behavior: 'smooth'});
        }

        function triggerBlinkEffect(element) {
            element.classList.add('blink-border');
            setTimeout(() => {
                element.classList.remove('blink-border');
            }, 3000);
        }
    </script>

    <script>
        // CAT3* 快速互联：向本机 /link/connect/apply 发起 - 支持 PJAX
        function setupQuickConnect() {
            const btn = document.getElementById('quickConnectBtn');
            if (!btn) return;

            // 移除之前的事件监听器，避免重复绑定
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);

            newBtn.addEventListener('click', function (e) {
                e.preventDefault();
                const resBox = document.getElementById('quickConnectResult');
                const peerApi = (document.getElementById('peer_api') || {}).value || '';
                if (!peerApi || !/^https?:\/\//i.test(peerApi)) {
                    showQuickResult(resBox, false, '请输入有效的 peer_api 地址');
                    return;
                }
                const name = (document.getElementById('name') || {}).value || '';
                const url = (document.getElementById('url') || {}).value || '';
                const icon = (document.getElementById('icon') || {}).value || '';
                const description = (document.getElementById('description') || {}).value || '';
                const email = (document.getElementById('email') || {}).value || '';

                const payload = {
                    peer_api: peerApi,
                    name: name,
                    url: url,
                    icon: icon,
                    description: description,
                    email: email
                };

                // 禁用按钮并显示加载状态（加强版）
                newBtn.disabled = true;
                newBtn.classList.add('opacity-70', 'cursor-not-allowed');
                document.getElementById('quickConnectBtnText').classList.add('hidden');
                document.getElementById('quickConnectBtnLoader').classList.remove('hidden');

                // 添加临时样式增强视觉反馈
                const tempStyle = document.createElement('style');
                tempStyle.textContent = `
                #quickConnectBtn:disabled {
                    transform: scale(0.98);
                    transition: all 0.2s ease;
                }
            `;
                document.head.appendChild(tempStyle);

                fetch('/link/connect/apply', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(payload)
                })
                    .then(r => {
                        if (!r.ok) throw new Error(`HTTP错误: ${r.status}`);
                        return r.json();
                    })
                    .then(data => {
                        if (data && data.code === 0 && data.task_id) {
                            // 开始轮询任务状态
                            showQuickResult(resBox, true, '任务已提交，正在异步处理中...');
                            pollTaskStatus(data.task_id, resBox, newBtn, tempStyle);
                        } else if (data && data.code === 0) {
                            // 兼容旧版同步返回
                            showQuickResult(resBox, true, data.msg || '已发起互联申请', true);
                            restoreButton(newBtn, tempStyle);
                        } else {
                            showQuickResult(resBox, false, (data && data.msg) ? data.msg : '互联申请失败', true);
                            restoreButton(newBtn, tempStyle);
                        }
                    })
                    .catch(error => {
                        console.error('互联申请错误:', error);
                        showQuickResult(resBox, false, '互联申请请求失败，请稍后重试', true);
                        restoreButton(newBtn, tempStyle);
                    });

                // 恢复按钮状态的函数
                function restoreButton(btn, style) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-70', 'cursor-not-allowed');
                    document.getElementById('quickConnectBtnText').classList.remove('hidden');
                    document.getElementById('quickConnectBtnLoader').classList.add('hidden');
                    if (style && style.parentNode) {
                        document.head.removeChild(style);
                    }
                }

                // 轮询任务状态
                function pollTaskStatus(taskId, resBox, btn, style) {
                    let pollCount = 0;
                    const maxPolls = 10; // 最多轮询10次
                    const pollInterval = 6000; // 每6秒轮询一次

                    const poll = () => {
                        pollCount++;

                        if (pollCount > maxPolls) {
                            showQuickResult(resBox, false, '处理超时，请稍后查看结果', true);
                            restoreButton(btn, style);
                            return;
                        }

                        fetch(`/link/connect/check-status?task_id=${encodeURIComponent(taskId)}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        })
                            .then(r => r.json())
                            .then(data => {
                                if (data.code !== 0) {
                                    showQuickResult(resBox, false, data.msg || '查询任务状态失败', true);
                                    restoreButton(btn, style);
                                    return;
                                }

                                const status = data.status;
                                const message = data.message || '';

                                if (status === 'success') {
                                    // 任务成功
                                    showQuickResult(resBox, true, message || '友链互联申请成功！', true);
                                    restoreButton(btn, style);
                                } else if (status === 'failed') {
                                    // 任务失败
                                    showQuickResult(resBox, false, message || '友链互联申请失败', true);
                                    restoreButton(btn, style);
                                } else if (status === 'pending' || status === 'processing') {
                                    // 继续轮询
                                    showQuickResult(resBox, true, `处理中 (${pollCount}/${maxPolls})...`);
                                    setTimeout(poll, pollInterval);
                                } else {
                                    // 未知状态
                                    showQuickResult(resBox, false, '任务状态未知', true);
                                    restoreButton(btn, style);
                                }
                            })
                            .catch(error => {
                                console.error('轮询任务状态错误:', error);
                                showQuickResult(resBox, false, '查询任务状态失败，请稍后重试', true);
                                restoreButton(btn, style);
                            });
                    };

                    // 首次轮询延迟2秒
                    setTimeout(poll, 2000);
                }

                function showQuickResult(el, ok, text, autoHide = false) {
                    if (!el) return;
                    el.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700', 'bg-red-900', 'text-red-200', 'bg-green-900', 'text-green-200', 'bg-blue-900', 'text-blue-200');

                    // 根据状态设置颜色（深色模式适配）
                    if (text.includes('处理中')) {
                        el.classList.add('bg-blue-900', 'text-blue-200');
                        el.innerHTML = '<span class="text-blue-400 mr-2">[LOAD]</span>' + text;
                    } else {
                        el.classList.add(ok ? 'bg-green-900' : 'bg-red-900', ok ? 'text-green-200' : 'text-red-200');
                        el.innerHTML = (ok ? '<span class="text-green-400 mr-2">[OK]</span>' : '<span class="text-red-400 mr-2">[ERR]</span>') + text;
                    }

                    // 添加淡入动画
                    el.style.opacity = '0';
                    el.style.transition = 'opacity 0.3s ease';
                    setTimeout(() => {
                        el.style.opacity = '1';
                    }, 10);

                    // 只在需要时自动隐藏（最终状态）
                    if (autoHide) {
                        setTimeout(() => {
                            el.style.opacity = '0';
                            setTimeout(() => el.classList.add('hidden'), 300);
                        }, 5000);
                    }
                }
            });
        }

        // 初始加载时设置
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupQuickConnect);
        } else {
            setupQuickConnect();
        }

        // PJAX环境下重新设置
        document.addEventListener('page:ready', setupQuickConnect);
    </script>

    <script>
        // 友链放置位置选项交互逻辑
        (function () {
            const linkPositionRadios = document.querySelectorAll('input[name="link_position"]');
            const pageLinkContainer = document.getElementById('page_link_container');
            const pageLinkInput = document.getElementById('page_link');

            if (!linkPositionRadios.length || !pageLinkContainer || !pageLinkInput) return;

            // 监听单选按钮变化
            linkPositionRadios.forEach(radio => {
                radio.addEventListener('change', function () {
                    if (this.value === 'link_page' || this.value === 'other_page') {
                        // 显示页面链接输入框并设为必填
                        pageLinkContainer.classList.remove('hidden');
                        pageLinkInput.setAttribute('required', 'required');
                    } else {
                        // 隐藏页面链接输入框并取消必填
                        pageLinkContainer.classList.add('hidden');
                        pageLinkInput.removeAttribute('required');
                        pageLinkInput.value = '';
                    }
                });
            });
        })();
    </script>

    <script>
        // 跳转方式选项交互逻辑
        (function () {
            const redirectTypeRadios = document.querySelectorAll('input[name="redirect_type"]');
            const redirectTypeHint = document.getElementById('redirect_type_hint');

            if (!redirectTypeRadios.length || !redirectTypeHint) return;

            // 提示文本映射
            const hintMap = {
                'direct': '<span class="text-yellow-400 mr-1">[BOLT]</span>不询问用户直接跳转',
                'goto': '<span class="text-blue-400 mr-1">[GO]</span>使用goto中间页询问用户是否跳转',
                'info': '<span class="text-green-400 mr-1">[INFO]</span>显示友链的详细信息，用户选择是否跳转'
            };

            // 监听单选按钮变化
            redirectTypeRadios.forEach(radio => {
                radio.addEventListener('change', function () {
                    if (hintMap[this.value]) {
                        redirectTypeHint.innerHTML = hintMap[this.value];
                    }
                });
            });
        })();
    </script>

    <script>
        // 表单提交处理
        (function () {
            const form = document.getElementById('linkRequestForm');
            if (!form) return;

            form.addEventListener('submit', function (e) {
                e.preventDefault();

                const formData = new FormData(this);
                const submitBtn = form.querySelector('button[type="submit"]');

                // 禁用按钮并显示加载状态
                submitBtn.disabled = true;
                document.getElementById('submitBtnText').classList.add('hidden');
                document.getElementById('submitBtnLoader').classList.remove('hidden');

                fetch('/link/request', {method: 'POST', body: formData})
                    .then(response => response.json())
                    .then(data => {
                        const resultMessage = document.getElementById('resultMessage');
                        resultMessage.classList.remove('hidden');

                        if (data.code === 0) {
                            resultMessage.classList.add('bg-green-900', 'text-green-200');
                            resultMessage.innerHTML = '<span class="text-green-400 mr-2">[OK]</span>' + (data.msg || '申请成功');
                            form.reset();
                        } else {
                            resultMessage.classList.add('bg-red-900', 'text-red-200');
                            resultMessage.innerHTML = '<span class="text-red-400 mr-2">[ERR]</span>' + (data.msg || '申请失败');
                        }

                        setTimeout(() => {
                            resultMessage.classList.add('hidden');
                        }, 3000);
                    })
                    .catch(() => {
                        const resultMessage = document.getElementById('resultMessage');
                        resultMessage.classList.remove('hidden');
                        resultMessage.classList.add('bg-red-900', 'text-red-200');
                        resultMessage.innerHTML = '<span class="text-red-400 mr-2">[ERR]</span>提交失败，请稍后重试';
                        setTimeout(() => {
                            resultMessage.classList.add('hidden');
                        }, 3000);
                    })
                    .finally(() => {
                        // 恢复按钮状态
                        submitBtn.disabled = false;
                        document.getElementById('submitBtnText').classList.remove('hidden');
                        document.getElementById('submitBtnLoader').classList.add('hidden');
                    });
            });
        })();
    </script>

    <script>
        (function () {
            function injectSidebar() {
                var t = document.getElementById('pjax-sidebar-html');
                var c = document.getElementById('sidebar-container');
                if (t && c) {
                    if (window.PJAX || window.jQuery) {
                        try {
                            document.dispatchEvent(new CustomEvent('pjax:sidebarReady'));
                        } catch (_) {
                        }
                    }
                    c.innerHTML = t.innerHTML || '';
                }
            }

            injectSidebar();
            document.addEventListener('page:ready', injectSidebar);
        })();
    </script>

    <style>
        /* 闪烁边框动画 */
        /* 使用全局动画系统 */
        .blink-border {
            animation: blink 0.5s ease-in-out 3;
        }

        .rotate-180 {
            transform: rotate(180deg);
        }
    </style>
</div>
