<title>{{ page_title|default('风屿雨博客') }}</title>
<div id="pjax-container">
<div class="max-w-full mx-auto">
<!-- PJAX 隐藏侧栏片段：完成后注入到布局右侧栏 -->
<div id="pjax-sidebar-html" style="display:none">
    {% if sidebar is defined and sidebar.widgets is defined %}
        {% for widget in sidebar.widgets %}
            {% if widget.enabled and widget.html is defined %}
                <div class="sidebar-widget" data-widget-key="{{ widget.key ?? widget.id ?? widget.slug ?? widget.name ?? loop.index }}" data-widget-type="{{ widget.type ?? '' }}">
                    {{ widget.html|raw }}
                </div>
            {% endif %}
        {% endfor %}
    {% endif %}
</div>
    <article class="bg-white rounded-xl shadow-md overflow-hidden no-animation">
        <!-- 文章头部 -->
        <div class="p-6 border-b border-gray-100">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">{{ post.title }}</h1>
            <div class="flex items-center text-gray-500 text-sm space-x-4">
                <span class="flex items-center">
                    <i class="far fa-calendar-alt mr-1"></i>
                    {{ post.created_at|date('Y-m-d') }}
                </span>
                <span class="flex items-center">
                    <i class="far fa-user mr-1"></i>
                    <span class="font-medium text-blue-600 hover:text-blue-800 transition-colors cursor-pointer" title="查看作者详情">
                        {{ author }}
                    </span>
                </span>
                {% if post.primaryAuthor.first().avatar %}
                <span class="flex items-center">
                    <img src="{{ post.primaryAuthor.first().avatar }}" alt="{{ author }}" class="w-6 h-6 rounded-full mr-1 object-cover" loading="lazy" decoding="async" fetchpriority="low">
                </span>
                {% endif %}
            </div>
            <div class="mt-3 text-sm text-gray-600 space-x-2 flex flex-wrap px-6">
                {% if post.categories|length > 0 %}
                    <span class="text-gray-500">分类：</span>
                    {% for c in post.categories %}
                        <a href="/category/{{ c.slug }}.html" class="inline-flex items-center px-2 py-1 bg-blue-50 text-blue-700 rounded hover:bg-blue-100 mr-2">#{{ c.name }}</a>
                    {% endfor %}
                {% endif %}
                {% if post.tags|length > 0 %}
                    <span class="text-gray-500 ml-3">标签：</span>
                    {% for t in post.tags %}
                        <a href="/tag/{{ t.slug }}.html" class="inline-flex items-center px-2 py-1 bg-purple-50 text-purple-700 rounded hover:bg-purple-100 mr-2">#{{ t.name }}</a>
                    {% endfor %}
                {% endif %}
            </div>
        </div>

        <!-- 文章内容 -->
        <div class="p-6">
            <div class="prose max-w-none fade-in-on-scroll no-animation" id="post-container">加载中...</div>
        </div>

        <!-- 文章底部 -->
        <div class="p-6 border-t border-gray-100">
            <div class="flex justify-between items-center">
                <a href="/"
                   class="inline-flex items-center text-blue-600 hover:text-blue-800 font-medium">
                    <i class="fas fa-arrow-left mr-1"></i>
                    返回首页
                </a>
                <div class="text-sm text-gray-500">
                    <i class="far fa-clock mr-1"></i>
                    最后更新: {{ post.updated_at|date('Y-m-d') }}
                </div>
            </div>
        </div>
    </article>
</div>

<div hidden="hidden" id="raw_md">{{ post.content|raw }}</div>
<script>
    function renderPost() {
        const container = document.getElementById('post-container');
        const raw = document.getElementById('raw_md');
        if (!container || !raw) return;

        // 先显示骨架占位，保证首屏快速可见
        container.innerHTML = '<div class="animate-pulse space-y-3"><div class="h-6 bg-blue-100 rounded w-2/3"></div><div class="h-4 bg-blue-100 rounded w-full"></div><div class="h-4 bg-blue-100 rounded w-5/6"></div><div class="h-4 bg-blue-100 rounded w-3/4"></div></div>';

        // 将渲染推迟到首帧之后，避免阻塞页面呈现
        function doPreview() {
            if (!window.Vditor) {
                window.__rpTry = (window.__rpTry || 0) + 1;
                if (window.__rpTry < 60) { setTimeout(doPreview, 50); }
                return;
            }
            Vditor.preview(container, raw.innerHTML, {
                mode: 'light',
                lang: 'zh_CN',
                anchor: 1,
                lazyLoadImage: 'https://cdn.jsdelivr.net/npm/vditor/dist/images/img-loading.svg',
                after() {
                    try { raw.remove(); } catch (e) {}
                    // 文章渲染完成，进度到100并隐藏
                    if (window.PjaxProgress && typeof window.PjaxProgress.complete === 'function') {
                        window.PjaxProgress.complete();
                    }
                }
            });
        }

        // 使用 rAF + setTimeout(0) 让骨架先渲染，再执行预览
        if (window.requestAnimationFrame) {
            requestAnimationFrame(function () { setTimeout(doPreview, 0); });
        } else {
            setTimeout(doPreview, 0);
        }
    }
    (function () {
        function injectSidebar() {
            var t = document.getElementById('pjax-sidebar-html');
            var c = document.getElementById('sidebar-container');
            if (!t || !c) return;
            if (window.PJAX || window.jQuery) {
                try { document.dispatchEvent(new CustomEvent('pjax:sidebarReady')); } catch (_) {}
            } else {
                c.innerHTML = t.innerHTML || '';
            }
        }
        // 在页面就绪时同时渲染文章与注入侧栏
        document.addEventListener('page:ready', function () {
            injectSidebar();
            renderPost();
        });
        // 初次加载也执行一次
        injectSidebar();
        renderPost();
    })();
</script>
</div>