# 数据库迁移说明

本文档说明如何将 WindBlog 从 MySQL 迁移到 PostgreSQL。

## 迁移步骤

### 1. 准备工作

确保已安装 Phinx：
```bash
composer require robmorgan/phinx
```

确保已安装 dotenv：
```bash
composer require vlucas/phpdotenv
```

### 2. 配置数据库连接

复制 [.env.example](file:///d%3A/codes/windblog_webman/.env.example) 文件为 [.env](file:///d%3A/codes/windblog_webman/.env) 并根据实际情况修改数据库连接信息：

```env

# 数据库配置 - PostgreSQL
DB_PGSQL_HOST=localhost
DB_PGSQL_PORT=5432
DB_PGSQL_DATABASE=windblog
DB_PGSQL_USERNAME=root
DB_PGSQL_PASSWORD=root

# 默认数据库
DB_DEFAULT=pgsql
```

在 [phinx.php](file:///d%3A/codes/windblog_webman/phinx.php) 文件中已经配置了两个环境：
- `dev` - MySQL 环境
- `pgsql` - PostgreSQL 环境

### 3. 执行迁移

#### 3.1 在 MySQL 中创建初始结构

```bash
php vendor/bin/phinx migrate -e dev
```

#### 3.2 将数据从 MySQL 导出到 PostgreSQL

这一步需要使用其他工具，比如:
- 使用 mysqldump 导出数据
- 使用 pgloader 工具直接迁移
- 手动导出导入数据

#### 3.3 在 PostgreSQL 中执行迁移

```bash
php vendor/bin/phinx migrate -e pgsql
```

## 注意事项

1. 迁移脚本使用 Phinx 标准语法编写，兼容 MySQL 和 PostgreSQL
2. 由于 Phinx 在 PostgreSQL 中不支持 `enum` 类型，已将其替换为 `string` 类型
3. 时间戳和日期字段在两个数据库中处理方式略有不同，请注意验证
4. 外键约束在迁移中已正确定义
5. 如果需要回滚，可以使用 `php vendor/bin/phinx rollback` 命令
6. 迁移文件已移除 MySQL 特定语句（如 `SET NAMES utf8mb4`），确保与 PostgreSQL 兼容
7. 应用程序代码需要确保正确处理以字符串形式存储的枚举值
8. 设置表（settings）的值存储方式已从序列化字符串更改为 JSONB（PostgreSQL）或 JSON（MySQL）
9. [blog_config](file:///d%3A/codes/windblog_webman/app/functions.php#L121-L236) 函数已更新，直接存储和读取值，无需序列化和反序列化

## 验证迁移

迁移完成后，请验证以下内容：
1. 所有表都已正确创建
2. 表之间的外键关系正确
3. 数据完整性得到保持
4. 应用程序可以正常连接到新数据库并运行