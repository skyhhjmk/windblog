# 插件系统使用说明

本文档说明 WindBlog 插件系统的接入方式、钩子与权限约定、示例插件的声明与授权流程，以及中间件触发与统计可观测性。

> 有关插件开发的详细信息，请参阅 [插件开发指南](../规范/插件开发指南.md)

## 一、中间件接入

- 中间件文件：`app/middleware/PluginSupport.php`
- 注册位置：`config/middleware.php` 的全局中间件队列，已加入：
  - `app\middleware\PluginSupport::class`

中间件流程（Webman MiddlewareInterface）：
1. 请求进入时触发动作钩子：`request_enter`，传入 `Request`
2. 执行业务处理，得到 `Response`
3. 响应发出前应用过滤器：`response_filter`，传入 `Response` 并返回（未授权时不变更）
4. 响应发出前触发动作钩子：`response_exit`，传入 `Response`

对应实现：
- `PluginService::do_action('request_enter', $request);`
- `$response = PluginService::apply_filters('response_filter', $response);`
- `PluginService::do_action('response_exit', $response);`

## 二、钩子与权限约定

- 动作钩子（Action）：
  - `request_enter`：请求进入阶段
  - `response_exit`：响应发出前阶段
- 过滤器钩子（Filter）：
  - `response_filter`：对响应对象进行过滤（返回新的 `Response` 或原对象）

- 权限名（Permissions）：
  - `request:action`：允许插件在请求/响应阶段执行动作（影响但不修改响应内容）
  - `request:filter`：允许插件通过过滤器修改响应对象（例如添加响应头、内容替换）

默认策略：
- 未授权的一律拒绝（返回值为 false）
- 动作：未授权时不执行对应插件动作逻辑（插件自行在回调内检查）
- 过滤器：未授权时返回原响应对象，不进行修改

## 三、示例插件

- 位置：`app/wind_plugins/sample/plugin.php`
- 权限声明：`app/wind_plugins/sample/plugin.json`
  - 包含 `"permissions": ["request:action"]`
  - 未声明 `request:filter`

示例插件激活时注册的钩子：
- `request_enter` 动作：
  - 若 `PluginService::ensurePermission('sample', 'request:action')` 通过，则在请求对象添加示例标记
- `response_exit` 动作：
  - 若通过 `request:action`，则在响应头添加 `X-Sample-Action: 1`
- `response_filter` 过滤器：
  - 调用 `PluginService::ensurePermission('sample', 'request:filter')`，未授权则直接返回原响应；获得授权后可添加 `X-Sample-Filter: 1`

## 四、后台管理与授权

管理页与 API：
- 控制器：`plugin/admin/app/controller/PluginSystemController.php`
- 页面：`/app/admin/plugin-system/index`
- API 示例：
  - 列表：`/app/admin/plugin-system/list`
  - 启用：`/app/admin/plugin-system/enable`
  - 停用：`/app/admin/plugin-system/disable`
  - 卸载：`/app/admin/plugin-system/uninstall`
  - 权限详情：`/app/admin/plugin-system/permissions?slug=sample`
  - 批量授权：`/app/admin/plugin-system/grantPermissions`
  - 批量撤销：`/app/admin/plugin-system/revokePermissions`

权限管理说明：
- 声明权限来自插件 `plugin.json` 的 `permissions` 字段
- 授权/撤销会自动重置该权限的统计计数
- 未授权权限的实际使用一律拒绝（默认拒绝策略）

预期行为（以 sample 为例）：
- 授权 `request:action` 后：
  - `request_enter` 与 `response_exit` 动作生效（示例：响应头将出现 `X-Sample-Action: 1`）
- 未声明/未授权 `request:filter`：
  - `response_filter` 默认拒绝修改响应（保持原响应）

## 五、可观测性与统计（Redis）

键名约定：
- 累计计数：
  - 调用次数：`plugins:perm:{slug}:{permission}:calls`
  - 拒绝次数：`plugins:perm:{slug}:{permission}:denied`
- 时间窗口分桶：
  - 近24小时（小时桶）：`plugins:perm:{slug}:{permission}:{type}:hour:{yyyyMMddHH}`
  - 近7天（日桶）：`plugins:perm:{slug}:{permission}:{type}:day:{yyyyMMdd}`
- TTL（可配置）：默认设置 8 天，防止键无限增长

统计接口：
- PluginService/PluginManager 提供：
  - `getCounts(slug, permission)`：返回 `{ calls, denied }`
  - `getWindowCounts(slug, permission)`：返回 `{ calls_24h, denied_24h, calls_7d, denied_7d }`

权限变更：
- `grantPermission/revokePermission` 后将调用 `resetCounts(slug, permission)` 清理累计与近期窗口桶

## 六、开发与使用建议

- 插件在动作/过滤器回调内始终通过 `PluginService::ensurePermission(slug, permission)` 进行权限检查，保证行为符合安全策略。
- 仅在确实需要修改响应时才申请并授权 `request:filter`；否则使用动作钩子进行事件记录或非侵入式处理。
- 建议插件作者提供清晰的 `permissions` 清单，避免过度申请能力。
- 如需更多统计（例如分优先级、正则匹配钩子、时间窗细化），可在后续迭代中扩展。