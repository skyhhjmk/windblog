# 插件开发指南

本文档详细说明了 WindBlog 插件系统的开发方式，包括插件结构、接口规范、权限系统和开发最佳实践。

## 一、插件基本结构

WindBlog 插件位于 `app/wind_plugins` 目录下，每个插件作为一个独立的文件夹存在。一个标准的插件包含以下文件：

- `plugin.php` - 插件主文件，必须返回一个实现 [PluginInterface](file:///d%3A/codes/windblog_webman/app/service/plugin/PluginInterface.php#L7-L56) 的匿名类实例
- `plugin.json` - 插件元数据文件，包含插件的基本信息和权限声明

### plugin.php 示例结构

```php
<?php
/**
 * Plugin Name: 插件名称
 * Plugin Slug: 插件标识（英文）
 * Version: 版本号
 * Description: 插件描述
 * Author: 作者名
 * Requires PHP: 8.2
 * Requires at least: 8.2
 */

use app\service\plugin\PluginInterface;
use app\service\plugin\HookManager;
use Webman\Route;
use support\Response;

return new class implements PluginInterface {
    public function activate(HookManager $hooks): void
    {
        // 插件激活时执行的逻辑
    }

    public function deactivate(HookManager $hooks): void
    {
        // 插件停用时执行的逻辑
    }

    public function uninstall(HookManager $hooks): void
    {
        // 插件卸载时执行的逻辑
    }
    
    public function registerMenu(string $type): array
    {
        // 注册插件菜单
        if ($type === 'admin') {
            // 返回后台菜单配置
        } else if ($type === 'app') {
            // 返回前台菜单配置
        }
        return [];
    }
    
    public function registerRoutes(string $pluginSlug): array
    {
        // 注册插件路由
        return [
            [
                'method' => 'get',
                'route' => "/plugin/{$pluginSlug}/index",
                'handler' => function () {
                    return new Response(200, [], 'Hello World');
                },
                'permission' => "plugin:{$pluginSlug}:route:index"
            ]
        ];
    }
};
```

## 二、PluginInterface 接口详解

插件必须实现 [PluginInterface](/app/service/plugin/PluginInterface.php#L7-L56) 接口，该接口定义了以下方法：

### 1. activate(HookManager $hooks): void

插件激活时调用，用于注册钩子、初始化数据等操作。

### 2. deactivate(HookManager $hooks): void

插件停用时调用，用于移除钩子、清理临时数据等操作。

### 3. uninstall(HookManager $hooks): void

插件卸载时调用，用于彻底清理插件相关数据。

### 4. registerMenu(string $type): array

注册插件菜单，支持后台菜单（admin）和前台菜单（app）。

### 5. registerRoutes(string $pluginSlug): array

注册插件路由，返回路由配置数组。

## 三、插件钩子系统

WindBlog 插件系统提供了两种类型的钩子：动作（Action）和过滤器（Filter）。

### 动作钩子（Actions）

动作钩子允许插件在特定时间点执行代码，但不改变系统行为。

使用方法：
```php
\app\service\PluginService::add_action('hook_name', function($param) {
    // 执行插件逻辑
}, 10, 1);
```

可用的动作钩子：
- `request_enter` - 请求进入时触发
- `response_exit` - 响应发送前触发

### 过滤器钩子（Filters）

过滤器钩子允许插件修改传递给它们的数据并返回修改后的数据。

使用方法：
```php
\app\service\PluginService::add_filter('hook_name', function($data) {
    // 修改数据
    return $modified_data;
}, 10, 1);
```

可用的过滤器钩子：
- `response_filter` - 响应过滤器，允许修改响应对象

## 四、插件权限系统

插件权限通过 `plugin.json` 文件声明，并在后台管理系统中进行授权。

### 权限声明示例

```json
{
    "permissions": [
        "request:action",
        "request:filter",
        "plugin:插件标识:menu:admin",
        "plugin:插件标识:menu:app",
        "plugin:插件标识:route:页面标识"
    ]
}
```

### 权限检查

插件在执行敏感操作前应检查权限：

```php
if (\app\service\PluginService::ensurePermission('插件标识', '权限名称')) {
    // 执行需要权限的操作
}
```

### 标准权限列表

- `request:action` - 允许插件在请求/响应阶段执行动作
- `request:filter` - 允许插件通过过滤器修改响应对象
- `plugin:插件标识:menu:admin` - 允许插件在后台显示菜单
- `plugin:插件标识:menu:app` - 允许插件在前台显示菜单
- `plugin:插件标识:route:页面标识` - 允许访问插件的特定路由

## 五、插件菜单系统

插件可以通过 [registerMenu](file:///d%3A/codes/windblog_webman/app/service/plugin/PluginInterface.php#L36-L36) 方法注册后台和前台菜单。

### 后台菜单结构

```php
[
    [
        'title' => '菜单标题',
        'key' => 'menu_key',
        'icon' => 'layui-icon-app',
        'type' => 0, // 0: 分组 1: 链接
        'href' => '', // 当type=1时有效
        'children' => [
            [
                'title' => '子菜单',
                'key' => 'child_key',
                'icon' => '',
                'type' => 1,
                'href' => '/app/admin/plugin/插件标识/页面'
            ]
        ]
    ]
]
```

## 六、插件路由系统

插件可以通过 [registerRoutes](file:///d%3A/codes/windblog_webman/app/service/plugin/PluginInterface.php#L55-L55) 方法注册自定义路由。

### 路由配置结构

```php
[
    [
        'method' => 'get', // 路由方法: get, post, put, delete 等
        'route' => "/plugin/插件标识/页面", // 路由路径
        'handler' => function() { return response('Hello'); }, // 处理函数
        'permission' => 'plugin.插件标识.route.页面' // 路由权限
    ]
]
```

## 七、插件开发最佳实践

1. **权限最小化原则**：只申请必要的权限，避免过度申请
2. **错误处理**：在钩子回调中使用 try-catch 处理异常，避免影响主程序
3. **资源清理**：在 [deactivate](file:///d%3A/codes/windblog_webman/app/service/plugin/PluginInterface.php#L17-L17) 和 [uninstall](file:///d%3A/codes/windblog_webman/app/service/plugin/PluginInterface.php#L22-L22) 方法中清理插件使用的资源
4. **命名规范**：使用清晰的命名空间和权限名称
5. **文档完善**：提供完整的插件说明和使用文档