# 小工具注册系统使用说明

## 概述

WindBlog 现在提供了一个灵活的小工具注册系统，允许开发者通过接口注册自定义小工具，而无需修改核心代码。

## 核心接口

### WidgetService

主要的注册和渲染接口位于 `app/service/WidgetService.php`：

```php
// 注册小工具
WidgetService::registerWidget(string $type, array $config);

// 渲染小工具
WidgetService::renderWidget(array $widget);

// 获取所有已注册的小工具
WidgetService::getRegisteredWidgets();
```

## 注册小工具

### 方法一：在启动文件中注册

在 `app/bootstrap/widgets.php` 中添加注册代码：

```php
use app\service\WidgetService;
use app\service\YourWidgetService;

WidgetService::registerWidget('your_widget_type', [
    'name' => '小工具名称',
    'description' => '小工具描述',
    'render' => [YourWidgetService::class, 'renderMethod']
]);
```

### 方法二：在服务提供者中注册

创建服务提供者并在 `boot` 方法中注册：

```php
namespace app\provider;

use app\service\WidgetService;
use Webman\Bootstrap;

class WidgetServiceProvider implements Bootstrap
{
    public static function start($worker)
    {
        WidgetService::registerWidget('your_widget', [
            'name' => '自定义小工具',
            'description' => '描述信息',
            'render' => [\app\service\YourService::class, 'renderWidget']
        ]);
    }
}
```

然后在 `config/bootstrap.php` 中添加服务提供者。

## 小工具配置参数

注册小工具时需要提供以下配置：

| 参数 | 类型 | 说明 |
|------|------|------|
| type | string | 小工具类型标识（唯一） |
| name | string | 小工具显示名称 |
| description | string | 小工具描述 |
| render | callable | 渲染回调函数 |

## 渲染回调函数

渲染函数应该接受一个数组参数并返回渲染后的数组：

```php
public static function renderWidget(array $widget): array
{
    // 添加渲染逻辑
    $widget['custom_data'] = your_render_logic();
    return $widget;
}
```

## 默认小工具

系统内置了以下默认小工具：

- `about` - 关于博主
- `categories` - 文章分类
- `tags` - 标签云
- `archive` - 文章归档
- `recent_posts` - 最新文章
- `html` - 自定义HTML

## 自定义小工具示例

### 1. 热门文章小工具

```php
// 注册
WidgetService::registerWidget('popular_posts', [
    'name' => '热门文章',
    'description' => '显示浏览量最高的文章',
    'render' => [CustomWidgetService::class, 'renderPopularPostsWidget']
]);

// 渲染方法
public static function renderPopularPostsWidget(array $widget): array
{
    $limit = $widget['limit'] ?? 5;
    $popularPosts = Post::where('status', 'published')
        ->orderBy('views', 'desc')
        ->take($limit)
        ->get(['id', 'title', 'slug', 'views']);
    
    $widget['popular_posts'] = $popularPosts;
    return $widget;
}
```

### 2. 随机文章小工具

```php
// 注册
WidgetService::registerWidget('random_posts', [
    'name' => '随机文章',
    'description' => '显示随机选择的文章',
    'render' => [CustomWidgetService::class, 'renderRandomPostsWidget']
]);

// 渲染方法
public static function renderRandomPostsWidget(array $widget): array
{
    $limit = $widget['limit'] ?? 5;
    $randomPosts = Post::where('status', 'published')
        ->inRandomOrder()
        ->take($limit)
        ->get(['id', 'title', 'slug']);
    
    $widget['random_posts'] = $randomPosts;
    return $widget;
}
```

### 3. 自定义HTML小工具

```php
// 注册
WidgetService::registerWidget('custom_html', [
    'name' => '自定义内容',
    'description' => '显示自定义HTML内容',
    'render' => [CustomWidgetService::class, 'renderCustomHtmlWidget']
]);

// 渲染方法
public static function renderCustomHtmlWidget(array $widget): array
{
    // 直接使用配置中的HTML内容
    if (isset($widget['content'])) {
        $widget['rendered_content'] = $widget['content'];
    }
    return $widget;
}
```

## 小工具配置

在侧边栏配置中，小工具可以包含以下配置选项：

```json
{
    "id": "widget_unique_id",
    "type": "widget_type",
    "title": "小工具标题",
    "enabled": true,
    "limit": 5,
    "content": "自定义内容",
    // 其他自定义配置
}
```

## 最佳实践

1. **错误处理**：在渲染函数中添加 try-catch 块处理异常
2. **性能优化**：对数据库查询进行缓存
3. **配置验证**：验证小工具配置的有效性
4. **向后兼容**：保持小工具接口的稳定性

## 注意事项

1. 小工具类型标识必须唯一
2. 渲染函数必须是静态方法或可调用对象
3. 确保小工具配置包含必要的字段验证
4. 在生产环境中建议对小工具输出进行安全过滤

## 故障排除

如果小工具无法正常显示，请检查：

1. 小工具是否已正确注册
2. 渲染函数是否存在且可访问
3. 小工具配置中的 `enabled` 是否为 true
4. 查看日志文件中的错误信息

## 扩展建议

1. 添加小工具缓存机制
2. 支持小工具的动态配置界面
3. 添加小工具依赖管理
4. 支持小工具的国际化和本地化